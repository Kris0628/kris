<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貸款投資分析表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for drawing charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin CDN for displaying labels on slices -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Increased max-width to accommodate chart */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative; /* Added for positioning children absolutely */
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e7eb;
            padding-bottom: 5px;
        }
        .input-group, .output-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group label {
            flex: 0 0 150px; /* Fixed width for labels to ensure alignment */
            font-weight: 600;
            color: #34495e;
            padding-right: 15px; /* Add some padding to separate from input */
            text-align: left; /* Align label text to the left */
        }
        .input-group input {
            flex: 1; /* Allow inputs to take remaining space */
            max-width: 180px; /* Slightly narrower input fields */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            background-color: #f7fafc;
            color: #2d3748;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            text-align: left; /* Align input content to the left */
        }
        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .input-group input.bg-yellow-100 {
            background-color: #fffacd; /* Light yellow */
        }
        /* Output group styling for left alignment */
        .output-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .output-group .highlight-result {
            flex: 0 0 180px; /* Match input field width */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            background-color: #e0f2fe;
            color: #0056b3;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: left; /* Align number content to the left */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .output-group .result-label {
            flex: 1; /* Take remaining space */
            font-weight: 600;
            color: #34495e;
            padding-left: 15px; /* Space between number and label */
            text-align: left; /* Align label text to the left */
        }
        .output-group .calculation-source {
            font-size: 0.8rem; /* Smaller font for source */
            color: #718096; /* Lighter color for source */
            margin-left: 5px; /* Small margin from label */
        }
        /* Custom style for disabled output fields */
        .output-group .disabled-output {
            background-color: #e9ecef; /* Lighter grey background */
            color: #6c757d; /* Greyer text color */
            cursor: not-allowed; /* Indicate it's not interactive */
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px; /* Increased gap for better separation */
        }
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .note {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 15px;
            padding: 10px;
            background-color: #edf2f7;
            border-left: 4px solid #a0aec0;
            border-radius: 8px;
        }
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f7fafc;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        /* Custom styling for radio buttons and converted value display */
        .radio-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap; /* Allow the label and radio-options to wrap */
        }
        .radio-group label:first-child { /* Target the "分期選項" label */
            font-weight: 600;
            color: #34495e;
            padding-right: 15px; /* Keep some padding */
            text-align: left;
            margin-right: 10px; /* Add space after the label */
        }
        .radio-options {
            display: flex;
            gap: 10px; /* Reduced gap for tighter fit */
            flex-wrap: wrap; /* Ensure radio buttons themselves wrap if needed */
            /* No flex-basis or flex-grow needed here, let it flow */
        }
        .converted-display {
            margin-left: 0; /* Align with the start of the number field */
            margin-top: -5px; /* Pull up closer to input */
            margin-bottom: 15px; /* Space before next group */
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
            padding-left: 165px; /* Add padding to align with the input fields */
        }
        .converted-display span {
            font-weight: bold;
            color: #2c5282;
        }

        /* Bento Box Styling */
        .bento-box-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Distribute items evenly with space around them */
            gap: 20px;
            margin-top: 30px;
            padding: 20px;
            background-color: #e6f0f7; /* Lighter background for the section */
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .bento-item {
            flex: 1 1 calc(33.33% - 20px); /* Adjust flex-basis to try for 3 columns, accounting for gap */
            min-width: 280px; /* Ensure a minimum width for each item before wrapping */
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            justify-content: flex-start; /* Align to top */
            text-align: center;
            border: 1px solid #d1e0ed;
        }
        .bento-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 10px;
        }
        .bento-value {
            font-size: 1.8rem; /* Larger for emphasis */
            font-weight: bold;
            color: #1a73e8; /* A prominent blue */
            background-color: #e8f0fe; /* Very light blue background */
            padding: 8px 15px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        /* New style for smaller unit symbols within bento-value */
        .bento-unit {
            font-size: 0.9rem; /* Smaller font size for units */
            font-weight: normal; /* Less bold for units */
            margin-right: 4px; /* Small space between unit and number */
        }
        .calculation-source-bento {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 5px;
        }

        /* New styles for colored output groups */
        .output-group-section {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px; /* Space between sections */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .output-group-section:last-child {
            margin-bottom: 0;
        }
        .pie-chart-container {
            width: 100%;
            max-width: 300px; /* Increased size to accommodate legend */
            margin: 20px auto 0 auto; /* Center the pie chart */
        }
        /* User Count Display */
        .user-count-display {
            position: absolute; /* Changed from fixed to absolute */
            top: 15px; /* Adjusted position */
            right: 15px; /* Adjusted position */
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            padding: 8px 12px; /* Slightly smaller padding */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: bold;
            font-size: 0.85rem; /* Smaller font size */
            z-index: 1000; /* Ensure it's on top */
            text-align: right; /* Align text to the right within its box */
            line-height: 1.4; /* Adjust line height for stacked text */
        }
        .user-count-display .text-xs {
            font-size: 0.75rem; /* Even smaller for cumulative */
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8); /* Slightly faded for secondary info */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- User Count Display -->
        <div class="user-count-display">
            線上使用者: <span id="onlineUsersCount">0</span><br>
            <span class="text-xs">累積使用者: <span id="cumulativeUsersCount">0</span></span>
        </div>

        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">貸款投資分析表</h1>

        <div class="grid-container">
            <!-- Left Column: Input Fields -->
            <div>
                <div class="section-title">參數輸入區</div>
                <div class="input-group">
                    <label for="expectedAnnualReturn">預計年報酬 (%)</label>
                    <input type="text" id="expectedAnnualReturn" value="5" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="expectedInvestmentTermYears">預計投資年期 (年)</label>
                    <input type="number" id="expectedInvestmentTermYears" value="30" class="bg-yellow-100" step="1" min="1">
                </div>
                <div class="input-group">
                    <label for="loanAmount">借貸金額 (NT$)</label>
                    <input type="text" id="loanAmount" value="1,000,000" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="investmentAmount">預計投資額 (NT$)</label>
                    <input type="text" id="investmentAmount" value="1,000,000" class="bg-yellow-100">
                </div>
                 <div id="investmentAmountWarning" class="text-red-500 text-xs pl-[165px] -mt-2 mb-2" style="display: none;">預計投資額不可超過借貸金額</div>
                <div class="input-group">
                    <label for="handlingFee">開辦費 (NT$)</label>
                    <input type="text" id="handlingFee" value="399" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="loanInterestRate">借款利率 (%)</label>
                    <input type="text" id="loanInterestRate" value="2.40" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="gracePeriodYears">寬限期 (年)</label>
                    <input type="number" id="gracePeriodYears" value="0" class="bg-yellow-100" step="1" min="0">
                </div>

                <!-- Term Selection -->
                <div class="radio-group">
                    <label>分期選項</label>
                    <div class="radio-options">
                        <label class="inline-flex items-center">
                            <input type="radio" name="termOption" value="years" checked class="form-radio text-blue-600" id="radioYears">
                            <span class="ml-2">分期 (年)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="termOption" value="months" class="form-radio text-blue-600" id="radioMonths">
                            <span class="ml-2">分期 (月)</span>
                        </label>
                    </div>
                </div>

                <div id="termInputYearsGroup">
                    <div class="input-group">
                        <label for="loanTermYears">分期 (年)</label>
                        <input type="number" id="loanTermYears" value="30" class="bg-yellow-100" step="1">
                    </div>
                    <div class="converted-display">
                        換算月份: <span id="convertedMonthsValue">360</span> 月 (不可編輯)
                    </div>
                </div>

                <div id="termInputMonthsGroup" style="display: none;">
                    <div class="input-group">
                        <label for="loanTermMonths">分期 (月)</label>
                        <input type="number" id="loanTermMonths" value="360" class="bg-yellow-100" step="1">
                    </div>
                    <div class="converted-display">
                        換算年份: <span id="convertedYearsValue">30</span> 年 (不可編輯)
                    </div>
                </div>

            </div>

            <!-- Right Column: Results and Description -->
            <div>
                <div class="section-title">計算結果</div>

                <!-- Group 1: Suggested Annual Return -->
                <div class="output-group-section bg-gray-50 border border-gray-200">
                    <div class="output-group">
                        <span id="suggestedAnnualReturnDisplay" class="highlight-result">N/A</span>
                        <label class="result-label">投資標的建議年報酬 (%)<span class="calculation-source">(每月需繳本利攤 * 12個月) / 借貸金額</span></label>
                    </div>
                </div>

                <!-- Group 2: Expected Returns -->
                <div class="output-group-section bg-blue-50 border border-blue-200">
                    <div class="output-group">
                        <span id="expectedAnnualReturnDisplay" class="highlight-result">5.00%</span>
                        <label class="result-label">預期年報酬<span class="calculation-source">(來自參數輸入區)</span></label>
                    </div>
                    <div class="output-group">
                        <span id="expectedMonthlyReturnDisplay" class="highlight-result">0.41%</span>
                        <label class="result-label">預期月報酬<span class="calculation-source">(1 + 預計年報酬)^(1/12) - 1</span></label>
                    </div>
                </div>


                <!-- Group 3: Grace Period Payment & Amortization Payment -->
                <div class="output-group-section bg-green-50 border border-green-200">
                    <div class="output-group">
                        <span id="gracePeriodMonthlyPaymentDisplay" class="highlight-result">NT$ 0</span>
                        <label class="result-label">(寬限期)每期繳<span class="calculation-source">(借貸金額 * 月借款利率)</span></label>
                    </div>
                    <div class="output-group">
                        <span id="amortizationMonthlyPaymentDisplay" class="highlight-result">NT$ 0</span>
                        <label class="result-label">本利攤(寬限期後)<span class="calculation-source">(剩餘本金透過本息攤還計算)</span></label>
                    </div>
                </div>

                <!-- Group 4: Total Interest Paid & Total Principal and Interest -->
                <div class="output-group-section bg-purple-50 border border-purple-200">
                    <div class="output-group">
                        <span id="totalInterestPaidDisplay" class="highlight-result">NT$ 4,037,889</span>
                        <label class="result-label">借款所繳利息總和<span class="calculation-source">(借款本利總合 - 借貸金額)</span></label>
                    </div>
                    <div class="output-group">
                        <span id="totalPrincipalAndInterestDisplay" class="highlight-result">NT$ 14,037,889</span>
                        <label class="result-label">借款本利總合<span class="calculation-source">(寬限期利息總和 + 攤還期本息總和)</span></label>
                    </div>
                    <!-- Pie Chart for Principal vs Interest -->
                    <div class="pie-chart-container">
                        <canvas id="principalInterestPieChart"></canvas>
                    </div>
                </div>

                <!-- Group 5: Total Investment Return -->
                <div class="output-group-section bg-orange-50 border border-orange-200">
                    <div class="output-group">
                        <span id="totalInvestmentReturnDisplay" class="highlight-result">NT$ 57,432,620</span>
                        <label class="result-label">投資總報酬<span class="calculation-source">( 預計投資額 * (1 + 預期月報酬)^預計投資總月數 ) - 借款本利總合</span></label>
                    </div>
                    <!-- Pie Chart for Investment Outcome -->
                    <div class="pie-chart-container">
                        <canvas id="investmentOutcomePieChart"></canvas>
                        <div id="investmentOutcomeNoData" class="text-center text-gray-600 text-sm mt-4" style="display: none;">
                            無獲利，不適用圓餅圖
                        </div>
                    </div>
                </div>
                
                <div class="note">
                    <p><strong>說明：</strong>本計算機根據常見的財務模型進行推算，結果可能與您預期的略有差異。若設定寬限期，則寬限期內僅繳利息，之後才開始攤還本金。</p>
                </div>
            </div>
        </div>

        <!-- New sections for Total Profit, ROI, and IRR - Moved outside grid-container -->
        <div class="bento-box-container">
            <div class="bento-item">
                <div class="bento-label">獲利總額</div>
                <div class="bento-value" id="totalProfitDisplay">NT$ 0</div>
                <div class="calculation-source-bento">獲利總額代表整個借款投資策略的最終淨利潤，為投資總報酬扣除開辦費後的結果。</div>
            </div>
            <div class="bento-item">
                <div class="bento-label">投報率</div>
                <div class="bento-value" id="roiDisplay">0.00%</div>
                <div class="calculation-source-bento">(獲利總額 / (預計投資額 + 開辦費)) * 100%<br>一般而言，投報率若能顯著高於借款利率，則可視為較合理的投資。</div>
            </div>
            <div class="bento-item">
                <div class="bento-label">IRR值 (年化)</div>
                <div class="bento-value" id="irrDisplay">N/A</div>
                <div class="calculation-source-bento">(內部報酬率計算，考慮開辦費、每月還款及最終投資價值)<br>IRR值越高，代表該投資的潛在回報越好。</div>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Register the datalabels plugin globally
        Chart.register(ChartDataLabels);

        let principalInterestPieChart; // Declare pie chart variable globally
        let investmentOutcomePieChart; // Declare new pie chart variable globally

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let userPresenceRef = null; // Reference to the current user's presence document
        let presenceInterval; // To hold the interval ID

        // User presence constants
        const USER_PRESENCE_TIMEOUT_MS = 60 * 1000; // 60 seconds for active user
        const USER_PRESENCE_UPDATE_INTERVAL_MS = 30 * 1000; // Update every 30 seconds

        // Initialize Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Sign in using __initial_auth_token if available, else anonymously
            async function authenticateFirebase() {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Authentication failed, trying anonymous sign-in:", error);
                    try {
                        await signInAnonymously(auth);
                        console.log("Successfully signed in anonymously after fallback.");
                    } catch (anonError) {
                        console.error("Anonymous sign-in also failed:", anonError);
                    }
                }
            }

            // Call authentication function immediately
            authenticateFirebase();

            // Set up auth state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase authenticated. User ID:", userId);
                    
                    const onlineUsersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users_online');
                    userPresenceRef = doc(onlineUsersCollectionRef, userId);
                    const cumulativeUserRef = doc(db, 'artifacts', appId, 'public', 'data', 'cumulative_users', userId);

                    // Set initial presence and add to cumulative users
                    await setDoc(userPresenceRef, { lastSeen: serverTimestamp(), userId: userId }, { merge: true });
                    await setDoc(cumulativeUserRef, { firstSeen: serverTimestamp() }, { merge: true });

                    // Clear any existing interval before setting a new one
                    if (presenceInterval) clearInterval(presenceInterval);
                    // Periodically update presence
                    presenceInterval = setInterval(async () => {
                        if (userPresenceRef) {
                            await setDoc(userPresenceRef, { lastSeen: serverTimestamp() }, { merge: true });
                        }
                    }, USER_PRESENCE_UPDATE_INTERVAL_MS);

                    // Listen for online and cumulative users
                    listenForOnlineUsers();
                    listenForCumulativeUsers();

                    // Attempt to remove presence on unload (best effort)
                    window.addEventListener('beforeunload', () => {
                        if (userPresenceRef) {
                            // This runs synchronously, so we can't await. Firestore's offline capabilities will handle it.
                            deleteDoc(userPresenceRef);
                        }
                    });
                } else {
                    console.log("No user authenticated.");
                    if(presenceInterval) clearInterval(presenceInterval); // Stop presence updates if logged out
                }
            });

            function listenForOnlineUsers() {
                const onlineUsersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users_online');
                onSnapshot(onlineUsersCollectionRef, (snapshot) => {
                    const now = Date.now();
                    let activeUsers = 0;
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.lastSeen && data.lastSeen.toDate && (now - data.lastSeen.toDate().getTime()) < USER_PRESENCE_TIMEOUT_MS) {
                            activeUsers++;
                        } else {
                            // Clean up stale presence documents
                            deleteDoc(doc.ref);
                        }
                    });
                    document.getElementById('onlineUsersCount').textContent = activeUsers;
                }, (error) => {
                    console.error("Error listening to online users:", error);
                });
            }

            function listenForCumulativeUsers() {
                const cumulativeUsersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'cumulative_users');
                 onSnapshot(cumulativeUsersCollectionRef, (snapshot) => {
                    document.getElementById('cumulativeUsersCount').textContent = snapshot.size;
                }, (error) => {
                    console.error("Error listening to cumulative users:", error);
                });
            }

        } else {
            console.warn("Firebase config not found. User count feature disabled.");
        }


        // Helper function to format currency with thousand separators
        function formatCurrency(amount) {
            if (isNaN(amount)) return 'N/A';
            return `NT$ ${Math.round(amount).toLocaleString('en-US')}`;
        }
        
        // Helper function to format currency as HTML with smaller unit symbol
        function formatCurrencyHtml(amount) {
            if (isNaN(amount)) return 'N/A';
            return `<span class="bento-unit">NT$</span> ${Math.round(amount).toLocaleString('en-US')}`;
        }


        // Helper function to parse currency input (removes non-numeric characters except dot)
        function parseCurrencyInput(inputString) {
            const parsed = parseFloat(String(inputString).replace(/[^0-9.]/g, ''));
            return isNaN(parsed) ? 0 : parsed; // Return 0 if NaN
        }

        // Helper function to parse percentage input (removes % if present, then converts to decimal)
        function parsePercentageInput(inputString) {
            const parsed = parseFloat(String(inputString).replace(/%/g, '')) / 100;
            return isNaN(parsed) ? 0 : parsed; // Return 0 if NaN
        }

        // Function to calculate IRR using a simple binary search method (more stable than Newton-Raphson)
        function calculateIRR(cashFlows, maxIterations = 1000, tolerance = 1e-7) {
            if (cashFlows.length === 0 || !cashFlows.some(cf => cf > 0) || !cashFlows.some(cf => cf < 0)) {
                return NaN;
            }

            let low = -0.9999; // Lower bound for monthly rate
            let high = 1.0; // Upper bound for monthly rate
            let mid = 0;

            for (let i = 0; i < maxIterations; i++) {
                mid = (low + high) / 2;
                if (mid === -1) return NaN; // Avoid Math.pow issues

                let npv = 0;
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + mid, j);
                }

                if (Math.abs(npv) < tolerance) {
                    return mid; // Found a solution
                } else if (npv > 0) {
                    low = mid;
                } else {
                    high = mid;
                }
            }
            // If it doesn't converge, return the last calculated mid-point, which is an approximation
             return (Math.abs(calculateNPV(mid, cashFlows)) < Math.abs(calculateNPV(NaN, cashFlows))) ? mid : NaN;
        }
        
        function calculateNPV(rate, cashFlows) {
            if (isNaN(rate)) return -Infinity;
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + rate, i);
            }
            return npv;
        }

        // Get elements for term selection
        const radioYears = document.getElementById('radioYears');
        const radioMonths = document.getElementById('radioMonths');
        const termInputYearsGroup = document.getElementById('termInputYearsGroup');
        const termInputMonthsGroup = document.getElementById('termInputMonthsGroup');
        const loanTermYearsInput = document.getElementById('loanTermYears');
        const loanTermMonthsInput = document.getElementById('loanTermMonths');
        const convertedMonthsValueSpan = document.getElementById('convertedMonthsValue');
        const convertedYearsValueSpan = document.getElementById('convertedYearsValue');

        // Function to toggle term input visibility and update converted values
        function toggleTermInputs() {
            if (radioYears.checked) {
                termInputYearsGroup.style.display = 'block';
                termInputMonthsGroup.style.display = 'none';
                updateConvertedMonths();
            } else {
                termInputYearsGroup.style.display = 'none';
                termInputMonthsGroup.style.display = 'block';
                updateConvertedYears();
            }
            calculateAndDisplay();
        }

        function updateConvertedMonths() {
            const years = parseFloat(loanTermYearsInput.value);
            if (!isNaN(years) && years > 0) {
                const months = Math.round(years * 12);
                convertedMonthsValueSpan.textContent = months;
                loanTermMonthsInput.value = months; // Keep hidden input updated
            } else {
                convertedMonthsValueSpan.textContent = '0';
                loanTermMonthsInput.value = '0';
            }
        }

        function updateConvertedYears() {
            const months = parseFloat(loanTermMonthsInput.value);
            if (!isNaN(months) && months > 0) {
                const years = (months / 12).toFixed(2);
                convertedYearsValueSpan.textContent = years;
                loanTermYearsInput.value = Math.round(months / 12); // Keep hidden input updated
            } else {
                convertedYearsValueSpan.textContent = '0';
                loanTermYearsInput.value = '0';
            }
        }

        // Main calculation and display function
        function calculateAndDisplay() {
            // --- 1. Get and Parse Inputs ---
            const expectedAnnualReturn = parsePercentageInput(document.getElementById('expectedAnnualReturn').value);
            const expectedInvestmentTermYears = parseInt(document.getElementById('expectedInvestmentTermYears').value, 10);
            const loanAmount = parseCurrencyInput(document.getElementById('loanAmount').value);
            let investmentAmount = parseCurrencyInput(document.getElementById('investmentAmount').value);
            const handlingFee = parseCurrencyInput(document.getElementById('handlingFee').value);
            const loanInterestRate = parsePercentageInput(document.getElementById('loanInterestRate').value);
            const gracePeriodYears = parseInt(document.getElementById('gracePeriodYears').value, 10);
            const loanTermYears = parseInt(loanTermYearsInput.value, 10);

            // --- VALIDATION: Investment amount cannot exceed loan amount ---
            const warningEl = document.getElementById('investmentAmountWarning');
            if (investmentAmount > loanAmount) {
                investmentAmount = loanAmount;
                document.getElementById('investmentAmount').value = investmentAmount.toLocaleString('en-US');
                warningEl.style.display = 'block'; // Show warning
            } else {
                warningEl.style.display = 'none'; // Hide warning
            }

            // --- 2. Calculate Core Variables ---
            const monthlyLoanInterestRate = loanInterestRate / 12;
            const totalLoanTermMonths = loanTermYears * 12;
            const gracePeriodMonths = gracePeriodYears * 12;
            const amortizationTermMonths = totalLoanTermMonths - gracePeriodMonths;
            const expectedMonthlyReturn = Math.pow(1 + expectedAnnualReturn, 1 / 12) - 1;
            const totalInvestmentTermMonths = expectedInvestmentTermYears * 12;

            // --- 3. Loan Calculations ---
            const gracePeriodMonthlyPayment = gracePeriodMonths > 0 ? loanAmount * monthlyLoanInterestRate : 0;
            
            let amortizationMonthlyPayment = 0;
            if (amortizationTermMonths > 0) {
                 const principalAfterGrace = loanAmount; // Principal doesn't decrease during grace period
                 if (monthlyLoanInterestRate > 0) {
                     amortizationMonthlyPayment = principalAfterGrace * (monthlyLoanInterestRate * Math.pow(1 + monthlyLoanInterestRate, amortizationTermMonths)) / (Math.pow(1 + monthlyLoanInterestRate, amortizationTermMonths) - 1);
                 } else {
                     amortizationMonthlyPayment = principalAfterGrace / amortizationTermMonths; // No interest case
                 }
            }

            const totalGraceInterest = gracePeriodMonthlyPayment * gracePeriodMonths;
            const totalAmortizationPayment = amortizationMonthlyPayment * amortizationTermMonths;
            const totalPrincipalAndInterest = totalGraceInterest + totalAmortizationPayment;
            const totalInterestPaid = totalPrincipalAndInterest - loanAmount;
            
            // Suggested Annual Return (based on amortization payment)
            const suggestedAnnualReturn = amortizationMonthlyPayment > 0 ? (amortizationMonthlyPayment * 12 / loanAmount) : 0;

            // --- 4. Investment Calculations ---
            const initialInvestment = investmentAmount;
            const futureValue = initialInvestment * Math.pow(1 + expectedMonthlyReturn, totalInvestmentTermMonths);
            const totalInvestmentReturn = futureValue - totalPrincipalAndInterest;

            // --- 5. Summary Metrics (Bento Box) ---
            const totalProfit = totalInvestmentReturn - handlingFee;
            const totalInvestmentCost = initialInvestment + handlingFee;
            const roi = totalInvestmentCost > 0 ? (totalProfit / totalInvestmentCost) : 0;

            // IRR Calculation
            const cashFlows = [loanAmount - handlingFee - initialInvestment]; // Net cash at t=0
            for (let m = 1; m <= totalLoanTermMonths; m++) {
                const payment = (m <= gracePeriodMonths) ? gracePeriodMonthlyPayment : amortizationMonthlyPayment;
                cashFlows.push(-payment); // monthly payments (outflows)
            }
            const maxTerm = Math.max(totalLoanTermMonths, totalInvestmentTermMonths);
            while(cashFlows.length <= maxTerm) {
                cashFlows.push(0);
            }
            cashFlows[totalInvestmentTermMonths] += futureValue; // Final value (inflow)
            
            const monthlyIRR = calculateIRR(cashFlows);
            const annualIRR = !isNaN(monthlyIRR) ? (Math.pow(1 + monthlyIRR, 12) - 1) : NaN;


            // --- 6. Update UI Displays ---
            // Group 1 & 2
            document.getElementById('suggestedAnnualReturnDisplay').textContent = `${(suggestedAnnualReturn * 100).toFixed(2)}%`;
            document.getElementById('expectedAnnualReturnDisplay').textContent = `${(expectedAnnualReturn * 100).toFixed(2)}%`;
            document.getElementById('expectedMonthlyReturnDisplay').textContent = `${(expectedMonthlyReturn * 100).toFixed(2)}%`;

            // Group 3
            document.getElementById('gracePeriodMonthlyPaymentDisplay').textContent = formatCurrency(gracePeriodMonthlyPayment);
            document.getElementById('amortizationMonthlyPaymentDisplay').textContent = formatCurrency(amortizationMonthlyPayment);

            // Group 4
            document.getElementById('totalInterestPaidDisplay').textContent = formatCurrency(totalInterestPaid);
            document.getElementById('totalPrincipalAndInterestDisplay').textContent = formatCurrency(totalPrincipalAndInterest);
            
            // Group 5
            document.getElementById('totalInvestmentReturnDisplay').textContent = formatCurrency(totalInvestmentReturn);

            // Bento Box
            document.getElementById('totalProfitDisplay').innerHTML = formatCurrencyHtml(totalProfit);
            document.getElementById('roiDisplay').textContent = `${(roi * 100).toFixed(2)}%`;
            document.getElementById('irrDisplay').textContent = isNaN(annualIRR) ? 'N/A' : `${(annualIRR * 100).toFixed(2)}%`;
            
            // --- 7. Update Charts ---
            updatePrincipalInterestPieChart(loanAmount, totalInterestPaid);
            updateInvestmentOutcomePieChart(totalProfit, totalInterestPaid);
        }

        // --- Chart Update Functions ---

        function updatePrincipalInterestPieChart(principal, interest) {
            const ctx = document.getElementById('principalInterestPieChart').getContext('2d');
            const data = {
                labels: ['貸款本金', '總利息'],
                datasets: [{
                    data: [principal, interest > 0 ? interest : 0], // Ensure interest is not negative
                    backgroundColor: ['#a7f3d0', '#fecaca'], // Light green, light red
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };

            if (principalInterestPieChart) {
                principalInterestPieChart.data = data;
                principalInterestPieChart.update();
            } else {
                principalInterestPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right', // Legend on the right
                                display: true
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => { sum += data; });
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return percentage;
                                },
                                color: '#000', // Black text
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateInvestmentOutcomePieChart(netProfit, totalInterest) {
            const ctx = document.getElementById('investmentOutcomePieChart').getContext('2d');
            const noDataEl = document.getElementById('investmentOutcomeNoData');
            const canvasEl = document.getElementById('investmentOutcomePieChart');

            if (netProfit <= 0) {
                 canvasEl.style.display = 'none';
                 noDataEl.style.display = 'block';
                 if (investmentOutcomePieChart) {
                    investmentOutcomePieChart.destroy();
                    investmentOutcomePieChart = null;
                 }
                 return;
            }
            
            canvasEl.style.display = 'block';
            noDataEl.style.display = 'none';

            const data = {
                labels: ['淨獲利', '總利息支出'], // Updated labels
                datasets: [{
                    data: [netProfit, totalInterest > 0 ? totalInterest : 0], // Updated data
                    backgroundColor: ['#a7f3d0', '#fecaca'], // Light green, light red
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };

            if (investmentOutcomePieChart) {
                investmentOutcomePieChart.data = data;
                investmentOutcomePieChart.update();
            } else {
                investmentOutcomePieChart = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                     options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right', // Legend on the right
                                display: true
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => { sum += data; });
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + '%';
                                    return percentage;
                                },
                                color: '#000', // Black text
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('.bg-yellow-100');
            inputs.forEach(input => {
                input.addEventListener('input', calculateAndDisplay);
            });

            radioYears.addEventListener('change', toggleTermInputs);
            radioMonths.addEventListener('change', toggleTermInputs);

            loanTermYearsInput.addEventListener('input', () => {
                updateConvertedMonths();
                calculateAndDisplay();
            });
            loanTermMonthsInput.addEventListener('input', () => {
                updateConvertedYears();
                calculateAndDisplay();
            });
            
            // Auto-format currency inputs
            ['loanAmount', 'investmentAmount', 'handlingFee'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('blur', (e) => {
                    const value = parseCurrencyInput(e.target.value);
                    e.target.value = value.toLocaleString('en-US');
                    calculateAndDisplay(); // Recalculate on blur to catch validation
                });
            });

            // Initial calculation
            calculateAndDisplay();
        });

    </script>
</body>
</html>
