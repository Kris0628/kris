<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貸款投資分析表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for drawing charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin CDN for displaying labels on slices -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Increased max-width to accommodate chart */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e7eb;
            padding-bottom: 5px;
        }
        .input-group, .output-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group label {
            flex: 0 0 150px; /* Fixed width for labels to ensure alignment */
            font-weight: 600;
            color: #34495e;
            padding-right: 15px; /* Add some padding to separate from input */
            text-align: left; /* Align label text to the left */
        }
        .input-group input {
            flex: 1; /* Allow inputs to take remaining space */
            max-width: 180px; /* Slightly narrower input fields */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            background-color: #f7fafc;
            color: #2d3748;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            text-align: left; /* Align input content to the left */
        }
        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .input-group input.bg-yellow-100 {
            background-color: #fffacd; /* Light yellow */
        }
        /* Output group styling for left alignment */
        .output-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .output-group .highlight-result {
            flex: 0 0 180px; /* Match input field width */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            background-color: #e0f2fe;
            color: #0056b3;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: left; /* Align number content to the left */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .output-group .result-label {
            flex: 1; /* Take remaining space */
            font-weight: 600;
            color: #34495e;
            padding-left: 15px; /* Space between number and label */
            text-align: left; /* Align label text to the left */
        }
        .output-group .calculation-source {
            font-size: 0.8rem; /* Smaller font for source */
            color: #718096; /* Lighter color for source */
            margin-left: 5px; /* Small margin from label */
        }
        /* Custom style for disabled output fields */
        .output-group .disabled-output {
            background-color: #e9ecef; /* Lighter grey background */
            color: #6c757d; /* Greyer text color */
            cursor: not-allowed; /* Indicate it's not interactive */
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px; /* Increased gap for better separation */
        }
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .note {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 15px;
            padding: 10px;
            background-color: #edf2f7;
            border-left: 4px solid #a0aec0;
            border-radius: 8px;
        }
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f7fafc;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        /* Custom styling for radio buttons and converted value display */
        .radio-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .radio-group label {
            flex: 0 0 150px;
            font-weight: 600;
            color: #34495e;
            padding-right: 15px;
            text-align: left;
        }
        .radio-options {
            display: flex;
            gap: 20px;
        }
        .converted-display {
            margin-left: 0; /* Align with the start of the number field */
            margin-top: -5px; /* Pull up closer to input */
            margin-bottom: 15px; /* Space before next group */
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
            padding-left: 165px; /* Add padding to align with the input fields */
        }
        .converted-display span {
            font-weight: bold;
            color: #2c5282;
        }

        /* Bento Box Styling */
        .bento-box-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Distribute items evenly with space around them */
            gap: 20px;
            margin-top: 30px;
            padding: 20px;
            background-color: #e6f0f7; /* Lighter background for the section */
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .bento-item {
            flex: 1 1 calc(33.33% - 20px); /* Adjust flex-basis to try for 3 columns, accounting for gap */
            min-width: 280px; /* Ensure a minimum width for each item before wrapping */
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            justify-content: flex-start; /* Align to top */
            text-align: center;
            border: 1px solid #d1e0ed;
        }
        .bento-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 10px;
        }
        .bento-value {
            font-size: 1.8rem; /* Larger for emphasis */
            font-weight: bold;
            color: #1a73e8; /* A prominent blue */
            background-color: #e8f0fe; /* Very light blue background */
            padding: 8px 15px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        .calculation-source-bento {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 5px;
        }

        /* New styles for colored output groups */
        .output-group-section {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px; /* Space between sections */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .output-group-section:last-child {
            margin-bottom: 0;
        }
        .pie-chart-container {
            width: 100%;
            max-width: 200px; /* Made smaller */
            margin: 20px auto 0 auto; /* Center the pie chart */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">貸款投資分析表</h1>

        <div class="grid-container">
            <!-- Left Column: Input Fields -->
            <div>
                <div class="section-title">參數輸入區</div>
                <div class="input-group">
                    <label for="expectedAnnualReturn">預計年報酬 (%)</label>
                    <input type="text" id="expectedAnnualReturn" value="5" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="expectedInvestmentTermYears">預計投資年期 (年)</label>
                    <input type="number" id="expectedInvestmentTermYears" value="30" class="bg-yellow-100" step="1" min="1">
                </div>
                <div class="input-group">
                    <label for="loanAmount">借多少錢 (NT$)</label>
                    <input type="text" id="loanAmount" value="1,000,000" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="handlingFee">開辦費 (NT$)</label>
                    <input type="text" id="handlingFee" value="399" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="loanInterestRate">借款利率 (%)</label>
                    <input type="text" id="loanInterestRate" value="2.40" class="bg-yellow-100">
                </div>
                <div class="input-group">
                    <label for="gracePeriodYears">寬限期 (年)</label>
                    <input type="number" id="gracePeriodYears" value="0" class="bg-yellow-100" step="1" min="0">
                </div>

                <!-- Term Selection -->
                <div class="radio-group">
                    <label>分期選項</label>
                    <div class="radio-options">
                        <label class="inline-flex items-center">
                            <input type="radio" name="termOption" value="years" checked class="form-radio text-blue-600" id="radioYears">
                            <span class="ml-2">分期 (年)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="termOption" value="months" class="form-radio text-blue-600" id="radioMonths">
                            <span class="ml-2">分期 (月)</span>
                        </label>
                    </div>
                </div>

                <div id="termInputYearsGroup">
                    <div class="input-group">
                        <label for="loanTermYears">分期 (年)</label>
                        <input type="number" id="loanTermYears" value="30" class="bg-yellow-100" step="1">
                    </div>
                    <div class="converted-display">
                        換算月份: <span id="convertedMonthsValue">360</span> 月 (不可編輯)
                    </div>
                </div>

                <div id="termInputMonthsGroup" style="display: none;">
                    <div class="input-group">
                        <label for="loanTermMonths">分期 (月)</label>
                        <input type="number" id="loanTermMonths" value="360" class="bg-yellow-100" step="1">
                    </div>
                    <div class="converted-display">
                        換算年份: <span id="convertedYearsValue">30</span> 年 (不可編輯)
                    </div>
                </div>

            </div>

            <!-- Right Column: Results and Description -->
            <div>
                <div class="section-title">計算結果</div>

                <!-- Group 1: Suggested Annual Return & Expected Monthly Return -->
                <div class="output-group-section bg-blue-50 border border-blue-200">
                    <div class="output-group">
                        <span id="suggestedAnnualReturnDisplay" class="highlight-result">N/A</span>
                        <label class="result-label">投資標的建議年報酬 (%)<span class="calculation-source">(每月需繳本利攤 * 12個月) / 借款總額</span></label>
                    </div>
                    <div class="output-group">
                        <span id="expectedMonthlyReturnDisplay" class="highlight-result">0.49%</span>
                        <label class="result-label">預期月報酬<span class="calculation-source">(1 + 預計年報酬)^(1/12) - 1</span></label>
                    </label>
                    </div>
                </div>

                <!-- Group 2: Grace Period Payment & Amortization Payment -->
                <div class="output-group-section bg-green-50 border border-green-200">
                    <div class="output-group">
                        <span id="gracePeriodMonthlyPaymentDisplay" class="highlight-result">NT$ 0</span>
                        <label class="result-label">(寬限期)每期繳<span class="calculation-source">(借款金額 * 月借款利率)</span></label>
                    </div>
                    <div class="output-group">
                        <span id="amortizationMonthlyPaymentDisplay" class="highlight-result">NT$ 0</span>
                        <label class="result-label">本利攤(寬限期後)<span class="calculation-source">(剩餘本金透過本息攤還計算)</span></label>
                    </div>
                </div>

                <!-- Group 3: Total Interest Paid & Total Principal and Interest -->
                <div class="output-group-section bg-purple-50 border border-purple-200">
                    <div class="output-group">
                        <span id="totalInterestPaidDisplay" class="highlight-result">NT$ 4,037,889</span>
                        <label class="result-label">借款所繳利息總和<span class="calculation-source">(借款本利總合 - 借款金額)</span></label>
                    </div>
                    <div class="output-group">
                        <span id="totalPrincipalAndInterestDisplay" class="highlight-result">NT$ 14,037,889</span>
                        <label class="result-label">借款本利總合<span class="calculation-source">(寬限期利息總和 + 攤還期本息總和)</span></label>
                    </div>
                    <!-- Pie Chart for Principal vs Interest -->
                    <div class="pie-chart-container">
                        <canvas id="principalInterestPieChart"></canvas>
                    </div>
                </div>

                <!-- Group 4: Total Investment Return -->
                <div class="output-group-section bg-orange-50 border border-orange-200">
                    <div class="output-group">
                        <span id="totalInvestmentReturnDisplay" class="highlight-result">NT$ 57,432,620</span>
                        <label class="result-label">投資總報酬<span class="calculation-source">( (借款金額 - 開辦費) * (1 + 預期月報酬)^預計投資總月數 ) - 借款本利總合 - 開辦費</span></label>
                    </div>
                    <!-- Pie Chart for Investment Outcome -->
                    <div class="pie-chart-container">
                        <canvas id="investmentOutcomePieChart"></canvas>
                        <div id="investmentOutcomeNoData" class="text-center text-gray-600 text-sm mt-4" style="display: none;">
                            無獲利，不適用圓餅圖
                        </div>
                    </div>
                </div>
                
                <div class="note">
                    <p><strong>說明：</strong>本計算機根據常見的財務模型進行推算，結果可能與您預期的略有差異。若設定寬限期，則寬限期內僅繳利息，之後才開始攤還本金。</p>
                </div>
            </div>
        </div>

        <!-- New sections for Total Profit, ROI, and IRR - Moved outside grid-container -->
        <div class="bento-box-container">
            <div class="bento-item">
                <div class="bento-label">獲利總額</div>
                <div class="bento-value" id="totalProfitDisplay">NT$ 0</div>
                <div class="calculation-source-bento">獲利總額代表整個借款投資策略的最終淨利潤，為投資總報酬扣除開辦費後的結果。</div>
            </div>
            <div class="bento-item">
                <div class="bento-label">投報率</div>
                <div class="bento-value" id="roiDisplay">0.00%</div>
                <div class="calculation-source-bento">(獲利總額 / (借款金額 - 開辦費)) * 100%<br>一般而言，投報率若能顯著高於借款利率，則可視為較合理的投資。長期而言，超過通貨膨脹率或銀行定存利率的投報率較具吸引力。</div>
            </div>
            <div class="bento-item">
                <div class="bento-label">IRR值 (年化)</div>
                <div class="bento-value" id="irrDisplay">N/A</div>
                <div class="calculation-source-bento">(內部報酬率計算，考慮開辦費、每月還款及最終投資價值)<br>一般而言，IRR值若能顯著高於借款利率，且高於其他可替代投資（如定存、通膨率），則可視為較合理的投資。IRR值越高，代表該投資的潛在回報越好。</div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-container">
            <h3 class="text-xl font-bold text-gray-700 mb-4 text-center">投資成長與借款還款圖表</h3>
            <canvas id="investmentChart"></canvas>
        </div>
    </div>

    <script>
        // Register the datalabels plugin globally
        Chart.register(ChartDataLabels);

        let investmentChart; // Declare chart variable globally
        let principalInterestPieChart; // Declare pie chart variable globally
        let investmentOutcomePieChart; // Declare new pie chart variable globally

        // Helper function to format currency with thousand separators
        function formatCurrency(amount) {
            if (isNaN(amount)) return 'N/A';
            return `NT$ ${Math.round(amount).toLocaleString('en-US')}`;
        }

        // Helper function to parse currency input (removes non-numeric characters except dot)
        function parseCurrencyInput(inputString) {
            const parsed = parseFloat(inputString.replace(/[^0-9.]/g, ''));
            return isNaN(parsed) ? 0 : parsed; // Return 0 if NaN
        }

        // Helper function to parse percentage input (removes % if present, then converts to decimal)
        function parsePercentageInput(inputString) {
            const parsed = parseFloat(inputString.replace(/%/g, '')) / 100;
            return isNaN(parsed) ? 0 : parsed; // Return 0 if NaN
        }

        // Function to calculate NPV for a given rate and cash flows
        function calculateNPV(rate, cashFlows) {
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + rate, i);
            }
            return npv;
        }

        // Function to calculate IRR using Newton-Raphson method
        function calculateIRR(cashFlows, guess = 0.005) { // Changed default guess to a more reasonable monthly rate
            const MAX_ITERATIONS = 1000;
            const PRECISION = 1e-7;

            // Handle edge cases for cash flows
            if (cashFlows.length === 0) return NaN;
            if (cashFlows.every(cf => cf === 0)) return 0; // All zeros
            
            // Check if there are both positive and negative cash flows (required for a meaningful IRR)
            const hasPositive = cashFlows.some(cf => cf > 0);
            const hasNegative = cashFlows.some(cf => cf < 0);
            if (!hasPositive || !hasNegative) return NaN; // IRR cannot be calculated without both inflows and outflows

            let irr = guess;

            for (let i = 0; i < MAX_ITERATIONS; i++) {
                let npv = 0;
                let derivative = 0;

                for (let t = 0; t < cashFlows.length; t++) {
                    // Check for non-finite values in cashFlows or irr before calculation
                    if (!Number.isFinite(cashFlows[t]) || !Number.isFinite(irr)) {
                        console.warn("IRR calculation: Non-finite cash flow or rate encountered.");
                        return NaN;
                    }

                    const denominator = Math.pow(1 + irr, t);
                    if (denominator === 0) { // Avoid division by zero if (1+irr) is 0
                        // This can happen if irr is -1 and t > 0
                        console.warn("IRR calculation: Denominator became zero (1+irr=0).");
                        return NaN;
                    }
                    npv += cashFlows[t] / denominator;
                    derivative -= cashFlows[t] * t / (denominator * (1 + irr)); // Simplified derivative
                }

                if (Math.abs(npv) < PRECISION) {
                    return irr;
                }

                if (derivative === 0) { // Avoid division by zero
                    console.warn("IRR calculation: Derivative became zero.");
                    return NaN;
                }

                irr = irr - npv / derivative;

                // Basic check to prevent IRR from going to extreme values
                if (!Number.isFinite(irr) || Math.abs(irr) > 100) { // If irr becomes too large/small, it's likely not converging
                    console.warn("IRR calculation: Rate diverged to extreme value.");
                    return NaN;
                }
            }
            console.warn("IRR calculation: Did not converge within MAX_ITERATIONS.");
            return NaN; // Could not converge
        }


        // Get elements for term selection
        const radioYears = document.getElementById('radioYears');
        const radioMonths = document.getElementById('radioMonths');
        const termInputYearsGroup = document.getElementById('termInputYearsGroup');
        const termInputMonthsGroup = document.getElementById('termInputMonthsGroup');
        const loanTermYearsInput = document.getElementById('loanTermYears');
        const loanTermMonthsInput = document.getElementById('loanTermMonths');
        const convertedMonthsValueSpan = document.getElementById('convertedMonthsValue');
        const convertedYearsValueSpan = document.getElementById('convertedYearsValue');
        const gracePeriodYearsInput = document.getElementById('gracePeriodYears'); // Get grace period input
        const expectedInvestmentTermYearsInput = document.getElementById('expectedInvestmentTermYears'); // New investment term input

        // Function to toggle term input visibility and update converted values
        function toggleTermInputs() {
            if (radioYears.checked) {
                termInputYearsGroup.style.display = 'block';
                termInputMonthsGroup.style.display = 'none';
                // Update converted months value based on years input
                const years = parseFloat(loanTermYearsInput.value);
                if (!isNaN(years)) {
                    convertedMonthsValueSpan.textContent = Math.round(years * 12);
                    loanTermMonthsInput.value = Math.round(years * 12); // Keep hidden input updated
                } else {
                    convertedMonthsValueSpan.textContent = '';
                    loanTermMonthsInput.value = '';
                }
            } else {
                termInputYearsGroup.style.display = 'none';
                termInputMonthsGroup.style.display = 'block';
                // Update converted years value based on months input
                const months = parseFloat(loanTermMonthsInput.value);
                if (!isNaN(months)) {
                    convertedYearsValueSpan.textContent = Math.round(months / 12);
                    loanTermYearsInput.value = Math.round(months / 12); // Keep hidden input updated
                } else {
                    convertedYearsValueSpan.textContent = '';
                    loanTermYearsInput.value = '';
                }
            }
            calculate(); // Recalculate after toggling
        }

        // Event listeners for radio buttons
        radioYears.addEventListener('change', toggleTermInputs);
        radioMonths.addEventListener('change', toggleTermInputs);

        // Event listener for "分期(年)" input (updates converted months)
        loanTermYearsInput.addEventListener('input', function() {
            const years = parseFloat(this.value);
            if (!isNaN(years)) {
                convertedMonthsValueSpan.textContent = Math.round(years * 12);
                loanTermMonthsInput.value = Math.round(years * 12); // Keep hidden input updated
            } else {
                convertedMonthsValueSpan.textContent = '';
                loanTermMonthsInput.value = '';
            }
            calculate(); // Recalculate when years change
        });

        // Event listener for "分期(月)" input (updates converted years)
        loanTermMonthsInput.addEventListener('input', function() {
            const months = parseFloat(this.value);
            if (!isNaN(months)) {
                convertedYearsValueSpan.textContent = Math.round(months / 12);
                loanTermYearsInput.value = Math.round(months / 12); // Keep hidden input updated
            } else {
                convertedYearsValueSpan.textContent = '';
                loanTermYearsInput.value = '';
            }
            calculate(); // Recalculate when months change
        });

        // Event listener for "寬限期 (年)" input
        gracePeriodYearsInput.addEventListener('input', calculate);
        // Event listener for "預計投資年期 (年)" input
        expectedInvestmentTermYearsInput.addEventListener('input', calculate);


        // Get all input elements for focus and Enter key behavior
        const inputs = document.querySelectorAll('.input-group input');

        inputs.forEach((input, index) => {
            // Add onfocus to select all text and handle specific formatting for currency/percentage
            input.addEventListener('focus', function() {
                if (this.id === 'expectedAnnualReturn' || this.id === 'loanInterestRate') {
                    // For percentage inputs, remove '%' on focus
                    let value = this.value.trim();
                    if (value.endsWith('%')) {
                        this.value = value.slice(0, -1);
                    }
                } else if (this.id === 'loanAmount' || this.id === 'handlingFee') {
                    // For currency inputs, remove thousand separators on focus
                    this.value = this.value.replace(/,/g, ''); // Just remove commas
                }
                this.select(); // Select all text
            });

            // Add blur event listener to format inputs back
            input.addEventListener('blur', function() {
                if (this.id === 'expectedAnnualReturn' || this.id === 'loanInterestRate') {
                    // For percentage inputs, add '%' on blur if value is not empty AND is a valid number
                    let value = parseFloat(this.value.trim());
                    if (!isNaN(value) && this.value.trim() !== '') {
                        this.value = value + '%';
                    } else if (this.value.trim() === '') {
                        this.value = ''; // Ensure it's truly empty if user cleared it
                    }
                } else if (this.id === 'loanAmount' || this.id === 'handlingFee') {
                    // For currency inputs, format with thousand separators on blur
                    let value = parseFloat(this.value.replace(/,/g, '')); // Parse with commas removed
                    if (!isNaN(value) && this.value.trim() !== '') {
                        this.value = `${value.toLocaleString('en-US')}`;
                    } else if (this.value.trim() === '') {
                        this.value = ''; // Ensure it's truly empty if user cleared it
                    }
                }
                calculate(); // Recalculate on blur
            });

            // Add keydown listener for Enter key
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission

                    // Find the next input field in the correct order, skipping hidden/disabled ones
                    let nextInput = null;
                    let currentInputIndex = Array.from(inputs).indexOf(this);

                    for (let i = currentInputIndex + 1; i < inputs.length; i++) {
                        const candidateInput = inputs[i];
                        // Check if the input is visible and not disabled (for term inputs)
                        // Also check if its parent group is displayed
                        const parentGroupStyle = candidateInput.closest('div[id$="Group"]')?.style.display;
                        if (candidateInput.closest('.input-group').style.display !== 'none' &&
                            (parentGroupStyle === 'block' || parentGroupStyle === undefined) && /* Check if term group is visible, or if it's not a term group */
                            !candidateInput.disabled) {
                            nextInput = candidateInput;
                            break;
                        }
                    }

                    // If no next visible input found, loop back to the first visible input
                    if (!nextInput) {
                        for (let i = 0; i < inputs.length; i++) {
                            const candidateInput = inputs[i];
                            const parentGroupStyle = candidateInput.closest('div[id$="Group"]')?.style.display;
                            if (candidateInput.closest('.input-group').style.display !== 'none' &&
                                (parentGroupStyle === 'block' || parentGroupStyle === undefined) &&
                                !candidateInput.disabled) {
                                nextInput = candidateInput;
                                break;
                            }
                        }
                    }

                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            });
        });


        function calculate() {
            try {
                // Get input values
                const expectedAnnualReturn = parsePercentageInput(document.getElementById('expectedAnnualReturn').value);
                let expectedInvestmentTermYears = parseFloat(document.getElementById('expectedInvestmentTermYears').value);
                
                const loanAmount = parseCurrencyInput(document.getElementById('loanAmount').value);
                const handlingFee = parseCurrencyInput(document.getElementById('handlingFee').value);
                const loanInterestRate = parsePercentageInput(document.getElementById('loanInterestRate').value);
                let gracePeriodYears = parseFloat(document.getElementById('gracePeriodYears').value);
                let gracePeriodMonths = Math.round(gracePeriodYears * 12);


                // Determine loanTermMonths based on which radio button is selected
                let loanTermYears;
                let loanTermMonths;
                if (radioYears.checked) {
                    loanTermYears = parseFloat(loanTermYearsInput.value);
                    loanTermMonths = isNaN(loanTermYears) ? 360 : Math.round(loanTermYears * 12);
                } else { // radioMonths.checked
                    loanTermMonths = parseFloat(loanTermMonthsInput.value);
                    loanTermYears = isNaN(loanTermMonths) ? 30 : Math.round(loanTermMonths / 12);
                }

                // Ensure loanTermMonths is a valid number
                if (isNaN(loanTermMonths) || loanTermMonths <= 0) {
                    loanTermMonths = 360; // Default to 360 months if invalid
                    loanTermYears = 30;
                    // Update the visible input and converted display if default is applied
                    if (radioYears.checked) {
                        loanTermYearsInput.value = 30;
                        convertedMonthsValueSpan.textContent = 360;
                    } else {
                        loanTermMonthsInput.value = 360;
                        convertedYearsValueSpan.textContent = 30;
                    }
                }

                // Validation for expectedInvestmentTermYears: cannot be greater than loanTermYears
                if (expectedInvestmentTermYears > loanTermYears) {
                    expectedInvestmentTermYears = loanTermYears;
                    document.getElementById('expectedInvestmentTermYears').value = loanTermYears; // Update input field
                }
                let expectedInvestmentTermMonths = Math.round(expectedInvestmentTermYears * 12);


                // Ensure grace period does not exceed total loan term
                if (gracePeriodMonths > loanTermMonths) {
                    gracePeriodMonths = loanTermMonths; // Grace period cannot be longer than loan term
                    document.getElementById('gracePeriodYears').value = Math.round(gracePeriodMonths / 12); // Update input field
                }

                // Derived rates
                const expectedMonthlyReturn = Math.pow(1 + expectedAnnualReturn, 1/12) - 1;
                const monthlyLoanRate = loanInterestRate / 12;

                // --- Calculations ---
                let gracePeriodMonthlyPayment = 0;
                let amortizationMonthlyPayment = 0;
                let totalPrincipalAndInterestCalculated = 0;
                let totalInterestPaidCalculated = 0;
                let cashFlows = [];
                let remainingLoanTermMonths = loanTermMonths - gracePeriodMonths; // Declare here

                // Determine the maximum period for cash flows (either loan term or investment term)
                const maxPeriodMonths = Math.max(loanTermMonths, expectedInvestmentTermMonths);
                // Initialize cashFlows array with zeros up to maxPeriodMonths
                for (let i = 0; i <= maxPeriodMonths; i++) {
                    cashFlows.push(0);
                }

                // Initial outflow (t=0)
                cashFlows[0] = -handlingFee; 


                if (loanTermMonths === 0) {
                    // Immediate transaction, no loan term, no payments
                    // All values remain 0 as initialized, except for investment return
                } else {
                    let currentPrincipalBalance = loanAmount; // Track principal balance for accurate interest calculation
                    const monthlyInterestDuringGrace = currentPrincipalBalance * monthlyLoanRate;
                    gracePeriodMonthlyPayment = monthlyInterestDuringGrace;

                    // Cash flows during grace period (interest only)
                    for (let i = 1; i <= gracePeriodMonths; i++) {
                        cashFlows[i] -= monthlyInterestDuringGrace;
                        totalInterestPaidCalculated += monthlyInterestDuringGrace;
                    }

                    if (remainingLoanTermMonths > 0) {
                        // Calculate amortized payment for the remaining term
                        if (monthlyLoanRate === 0) {
                            amortizationMonthlyPayment = currentPrincipalBalance / remainingLoanTermMonths;
                        } else {
                            amortizationMonthlyPayment = currentPrincipalBalance * (monthlyLoanRate * Math.pow(1 + monthlyLoanRate, remainingLoanTermMonths)) / (Math.pow(1 + monthlyLoanRate, remainingLoanTermMonths) - 1);
                        }

                        // Cash flows during amortization period (principal + interest)
                        for (let i = gracePeriodMonths + 1; i <= loanTermMonths; i++) {
                            const interestThisMonth = currentPrincipalBalance * monthlyLoanRate;
                            const principalPaidThisMonth = amortizationMonthlyPayment - interestThisMonth;
                            currentPrincipalBalance -= principalPaidThisMonth; // Update principal balance

                            cashFlows[i] -= amortizationMonthlyPayment;
                            totalInterestPaidCalculated += interestThisMonth;
                        }
                    } else if (gracePeriodMonths > 0 && gracePeriodMonths === loanTermMonths) {
                        // If entire loan is grace period, principal is paid at the end as balloon.
                        // This principal repayment is added to the cash flow at loanTermMonths
                        // The total interest paid is already calculated as monthlyInterestDuringGrace * loanTermMonths
                        cashFlows[loanTermMonths] -= loanAmount; // Add the principal repayment as an outflow
                    }
                }

                totalPrincipalAndInterestCalculated = totalInterestPaidCalculated + loanAmount;

                // Suggested Annual Return for Investment Target calculation
                let suggestedAnnualReturn = 0;
                if (loanAmount > 0) {
                    // Use amortizationMonthlyPayment if it's calculated, otherwise fall back to gracePeriodMonthlyPayment if grace period covers entire loan
                    let effectiveMonthlyPayment = amortizationMonthlyPayment;
                    if (loanTermMonths > 0 && remainingLoanTermMonths <= 0 && gracePeriodMonths > 0) {
                        // If loan is entirely grace period, or grace period ends at loan end, use grace period payment for this calculation
                        effectiveMonthlyPayment = gracePeriodMonthlyPayment;
                    }

                    if (!isNaN(effectiveMonthlyPayment) && effectiveMonthlyPayment > 0) {
                        suggestedAnnualReturn = (effectiveMonthlyPayment * 12) / loanAmount;
                    }
                }
                document.getElementById('suggestedAnnualReturnDisplay').textContent = `${(suggestedAnnualReturn * 100).toFixed(2)}%`;


                // Grace period monthly payment display logic
                const gracePeriodMonthlyPaymentDisplayElement = document.getElementById('gracePeriodMonthlyPaymentDisplay');
                if (gracePeriodMonths === 0) {
                    gracePeriodMonthlyPaymentDisplayElement.textContent = formatCurrency(0);
                    gracePeriodMonthlyPaymentDisplayElement.classList.add('disabled-output');
                } else {
                    gracePeriodMonthlyPaymentDisplayElement.textContent = formatCurrency(gracePeriodMonthlyPayment);
                    gracePeriodMonthlyPaymentDisplayElement.classList.remove('disabled-output');
                }

                document.getElementById('amortizationMonthlyPaymentDisplay').textContent = formatCurrency(amortizationMonthlyPayment);
                document.getElementById('totalPrincipalAndInterestDisplay').textContent = formatCurrency(totalPrincipalAndInterestCalculated);
                document.getElementById('totalInterestPaidDisplay').textContent = formatCurrency(totalInterestPaidCalculated);

                // 計算 fvOfInitialInvestedAmount (投資所得的總價值)
                const fvOfInitialInvestedAmount = (loanAmount - handlingFee) * Math.pow(1 + expectedMonthlyReturn, expectedInvestmentTermMonths);
                
                // 投資總報酬 (Total Investment Return) - 扣除借貸本利攤後的淨利，再扣除開辦費
                const totalInvestmentReturn = fvOfInitialInvestedAmount - totalPrincipalAndInterestCalculated - handlingFee;
                document.getElementById('totalInvestmentReturnDisplay').textContent = formatCurrency(totalInvestmentReturn);

                // --- Bento Box Calculations ---
                // 獲利總額 (Total Profit) - 最終淨利潤，與投資總報酬相同
                const totalProfit = totalInvestmentReturn; // This is now the same as totalInvestmentReturn
                document.getElementById('totalProfitDisplay').textContent = formatCurrency(totalProfit);

                // ROI calculation
                const initialInvestedCapital = loanAmount - handlingFee; // The capital actually put into investment
                let roi = 0;
                if (initialInvestedCapital > 0) {
                    roi = (totalProfit / initialInvestedCapital) * 100;
                } else if (totalProfit > 0) {
                    roi = Infinity; // Infinite return if no initial invested capital and profit
                } else if (totalProfit === 0) {
                    roi = 0;
                } else {
                    roi = NaN; // Negative profit with zero initial invested capital
                }
                document.getElementById('roiDisplay').textContent = `${roi.toFixed(2)}%`;

                // Add final investment value to the last cash flow for IRR
                // This is the liquidation of the investment at the end of the investment term.
                cashFlows[expectedInvestmentTermMonths] = (cashFlows[expectedInvestmentTermMonths] || 0) + fvOfInitialInvestedAmount;
                
                const irrMonthly = calculateIRR(cashFlows);
                let irrAnnual = NaN;
                if (!isNaN(irrMonthly)) {
                    irrAnnual = (Math.pow(1 + irrMonthly, 12) - 1) * 100; // Annualize the monthly IRR
                }
                document.getElementById('irrDisplay').textContent = isNaN(irrAnnual) ? 'N/A' : `${irrAnnual.toFixed(2)}%`;


                // --- Chart Data Preparation ---
                const chartLabels = [];
                const chartInvestmentGrowthData = [];
                const chartAnnualLoanBalanceData = []; // New dataset for annual loan balance

                const initialInvestmentForChart = loanAmount - handlingFee;
                const totalYearsForChart = Math.max(
                    Math.ceil(loanTermMonths / 12),
                    Math.ceil(expectedInvestmentTermMonths / 12)
                );

                let currentPrincipalBalanceAtStartOfYear = loanAmount; // For loan balance tracking

                for (let year = 0; year <= totalYearsForChart; year++) {
                    const currentMonthEnd = year * 12;
                    chartLabels.push(`${year}年`);

                    // Investment Growth Data (Line)
                    if (year === 0) {
                        chartInvestmentGrowthData.push(initialInvestmentForChart);
                    } else if (currentMonthEnd <= expectedInvestmentTermMonths) {
                        const fvAtYearEnd = initialInvestmentForChart * Math.pow(1 + expectedMonthlyReturn, currentMonthEnd);
                        chartInvestmentGrowthData.push(fvAtYearEnd);
                    } else {
                        // If investment term ended, maintain the last value
                        chartInvestmentGrowthData.push(chartInvestmentGrowthData[chartInvestmentGrowthData.length - 1]);
                    }

                    // Annual Loan Balance Data (Bars)
                    if (year === 0) {
                        chartAnnualLoanBalanceData.push(loanAmount); // Initial loan amount at year 0
                    } else {
                        let principalRepaidInThisYear = 0;
                        const startMonth = (year - 1) * 12 + 1;
                        const endMonth = year * 12;

                        let tempPrincipalBalance = currentPrincipalBalanceAtStartOfYear; // Use a temp variable for monthly calculations within the year

                        for (let month = startMonth; month <= endMonth; month++) {
                            if (month <= loanTermMonths) {
                                if (month <= gracePeriodMonths) {
                                    // No principal repayment during grace period
                                } else {
                                    // Amortization period
                                    const interestThisMonth = tempPrincipalBalance * monthlyLoanRate;
                                    const principalPaidThisMonth = amortizationMonthlyPayment - interestThisMonth;
                                    principalRepaidInThisYear += principalPaidThisMonth;
                                    tempPrincipalBalance -= principalPaidThisMonth; // Update temp balance for next month's calculation
                                }
                            } else {
                                break; // Loan term ended before this month
                            }
                        }
                        currentPrincipalBalanceAtStartOfYear = Math.max(0, currentPrincipalBalanceAtStartOfYear - principalRepaidInThisYear); // Update for next year's start, ensure non-negative
                        chartAnnualLoanBalanceData.push(currentPrincipalBalanceAtStartOfYear);
                    }
                }

                // Ensure the first data point for investment is accurate if loanAmount - handlingFee is 0 or negative.
                if (initialInvestmentForChart <= 0 && chartInvestmentGrowthData.length > 0) {
                    chartInvestmentGrowthData[0] = 0;
                }


                const ctx = document.getElementById('investmentChart').getContext('2d');

                if (investmentChart) {
                    investmentChart.destroy(); // Destroy existing chart before creating a new one
                }

                investmentChart = new Chart(ctx, {
                    type: 'bar', // Set default type to bar
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: '逐年借款餘額 (Annual Loan Balance)', // New dataset label
                                data: chartAnnualLoanBalanceData,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)', // Blue for loan balance
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                type: 'bar', // Explicitly define as bar
                                order: 2 // Render after line
                            },
                            {
                                label: '投資成長曲線 (Investment Growth)',
                                data: chartInvestmentGrowthData,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1,
                                fill: false,
                                type: 'line', // Explicitly define as line
                                order: 1 // Render first (behind bars)
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '投資成長與借款還款圖表', // Updated chart title
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: { // Add datalabels plugin configuration
                                display: false // Hide data labels on the chart elements
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '時間 (年)'
                                },
                                ticks: {
                                    display: false // Hide x-axis tick labels
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '金額 (NT$)'
                                },
                                beginAtZero: true,
                                ticks: {
                                    display: false, // Hide y-axis tick labels
                                    callback: function(value, index, values) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // --- Pie Chart for Principal vs Interest ---
                const pieCtx = document.getElementById('principalInterestPieChart').getContext('2d');

                if (principalInterestPieChart) {
                    principalInterestPieChart.destroy(); // Destroy existing pie chart
                }

                // Data for the pie chart
                const pieChartData = [];
                const pieChartLabels = [];
                const pieChartColors = [];

                if (loanAmount > 0 || totalInterestPaidCalculated > 0) {
                    if (loanAmount > 0) {
                        pieChartData.push(loanAmount);
                        pieChartLabels.push('本金');
                        pieChartColors.push('rgba(173, 216, 230, 0.7)'); // Light Blue
                    }
                    if (totalInterestPaidCalculated > 0) {
                        pieChartData.push(totalInterestPaidCalculated);
                        pieChartLabels.push('利息');
                        pieChartColors.push('rgba(144, 238, 144, 0.7)'); // Light Green
                    }
                } else {
                    // If both are zero, show a "No Data" slice or just an empty chart
                    pieChartData.push(1); // A dummy value to show an empty circle
                    pieChartLabels.push('無數據');
                    pieChartColors.push('rgba(200, 200, 200, 0.5)');
                }


                principalInterestPieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: pieChartLabels,
                        datasets: [{
                            data: pieChartData,
                            backgroundColor: pieChartColors,
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false, // Hide legend as labels are directly on slices
                            },
                            title: {
                                display: true,
                                text: '本金與利息佔比',
                                font: {
                                    size: 14
                                }
                            },
                            datalabels: {
                                color: '#000', // Black text for better contrast inside slices
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(0) : 0; // Changed to toFixed(0)
                                    return `${percentage}%`; // Only percentage inside
                                }
                            }
                        }
                    }
                });

                // --- Pie Chart for Investment Outcome ---
                const investmentOutcomeCanvas = document.getElementById('investmentOutcomePieChart');
                const investmentOutcomeNoData = document.getElementById('investmentOutcomeNoData');
                let investmentOutcomePieCtx = null;

                if (investmentOutcomeCanvas) {
                    investmentOutcomePieCtx = investmentOutcomeCanvas.getContext('2d');
                }

                if (investmentOutcomePieChart) {
                    investmentOutcomePieChart.destroy(); // Destroy existing pie chart
                }

                // Calculate total loan cost (principal + total interest paid)
                const totalLoanCost = loanAmount + totalInterestPaidCalculated;
                
                if (totalProfit > 0 && totalLoanCost > 0 && investmentOutcomeCanvas && investmentOutcomeNoData) {
                    investmentOutcomeNoData.style.display = 'none'; // Hide no data message
                    investmentOutcomeCanvas.style.display = 'block'; // Show canvas element itself

                    const investmentOutcomeData = [totalLoanCost, totalProfit];
                    const investmentOutcomeLabels = ['借款總成本', '投資淨獲利'];
                    const investmentOutcomeColors = ['rgba(255, 218, 185, 0.7)', 'rgba(221, 160, 221, 0.7)']; // Blanched Almond (light orange), Plum (light purple)

                    investmentOutcomePieChart = new Chart(investmentOutcomePieCtx, {
                        type: 'pie',
                        data: {
                            labels: investmentOutcomeLabels,
                            datasets: [{
                                data: investmentOutcomeData,
                                backgroundColor: investmentOutcomeColors,
                                borderColor: '#fff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false, // Hide legend as labels are directly on slices
                                },
                                title: {
                                    display: true,
                                    text: '投資策略成果佔比',
                                    font: {
                                        size: 14
                                    }
                                },
                                datalabels: {
                                    color: '#000', // Black text for better contrast inside slices
                                    font: {
                                        weight: 'bold',
                                        size: 12
                                    },
                                    formatter: (value, context) => {
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(0) : 0; // Changed to toFixed(0)
                                        return `${percentage}%`; // Only percentage inside
                                    }
                                }
                            }
                        }
                    });
                } else {
                    if (investmentOutcomeNoData) {
                        investmentOutcomeNoData.style.display = 'block'; // Show no data message
                    }
                    if (investmentOutcomeCanvas) {
                        investmentOutcomeCanvas.style.display = 'none'; // Hide canvas
                    }
                }


            } catch (error) {
                console.error("計算時發生錯誤:", error);
                // Optionally, update output fields to indicate error
                document.getElementById('totalProfitDisplay').textContent = '錯誤';
                document.getElementById('roiDisplay').textContent = '錯誤';
                document.getElementById('irrDisplay').textContent = '錯誤';
            }
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleTermInputs(); // Set initial visibility based on radio selection
            calculate(); // Perform initial calculation
        });

        // Add input event listeners for general real-time updates (e.g., paste, programmatic changes)
        document.querySelectorAll('input').forEach(input => {
            // Only add input listener if it's not one of the percentage or currency fields,
            // as blur event already handles calculation for them.
            // Also exclude term inputs as their specific listeners handle it.
            if (input.id !== 'expectedAnnualReturn' && input.id !== 'loanInterestRate' &&
                input.id !== 'loanAmount' && input.id !== 'handlingFee' &&
                input.id !== 'loanTermYears' && input.id !== 'loanTermMonths' &&
                input.id !== 'gracePeriodYears' && input.id !== 'expectedInvestmentTermYears') {
                input.addEventListener('input', calculate);
            }
        });
    </script>
</body>
</html>
