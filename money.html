<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融洞察儀表板</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* 純黑色底 */
            color: #E0E0E0; /* 淺灰色文字 */
            overflow-x: hidden; /* 防止水平滾動 */
        }

        /* 自定義滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #4A4A4A;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666666;
        }

        /* Bento Grid Item Animation Base */
        .bento-item {
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        .bento-item.animate-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* 高亮色自身透明度漸變 */
        .gradient-overlay-cyan {
            background: linear-gradient(to bottom, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0)); /* cyan-400 透明度漸變 */
        }
        .gradient-overlay-purple {
            background: linear-gradient(to bottom, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0)); /* purple-500 透明度漸變 */
        }
        .gradient-overlay-green {
            background: linear-gradient(to bottom, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0)); /* green-400 透明度漸變 */
        }
        .gradient-overlay-blue {
            background: linear-gradient(to bottom, rgba(96, 165, 250, 0.2), rgba(96, 165, 250, 0)); /* blue-400 透明度漸變 */
        }


        /* 勾線圖形化 - 簡單的圓圈 */
        .outline-circle {
            border: 2px solid;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 確保 Chart.js 圖表背景透明 */
        canvas {
            background-color: transparent !important;
        }

        /* Input field styling */
        .input-field {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #E0E0E0;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        .input-field:focus {
            outline: none;
            border-color: #60A5FA; /* blue-400 */
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
        }
    </style>
</head>
<body class="bg-black text-gray-100">
    <div class="min-h-screen flex flex-col items-center justify-center p-8 relative overflow-hidden">
        <!-- 主標題區塊 -->
        <div class="text-center mb-16 relative z-10">
            <h1 class="text-6xl md:text-8xl font-extrabold text-white leading-tight mb-4 animate-fade-in-up">
                <span class="text-cyan-400">洞察</span>您的財務未來
            </h1>
            <p class="text-xl md:text-2xl text-gray-400 max-w-3xl mx-auto animate-fade-in-up delay-200">
                Uncover the potential of your integrated investment strategy.
            </p>
        </div>

        <!-- 輸入參數區塊 -->
        <section id="input-section" class="w-full max-w-4xl mx-auto py-12 px-8 bg-gray-900/40 backdrop-blur-sm rounded-3xl shadow-lg mb-24 relative z-10 bento-item">
            <h2 class="text-4xl font-bold mb-8 text-white text-center">輸入您的參數</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">

                <!-- 房貸部分 -->
                <div class="md:col-span-2 mb-4">
                    <h3 class="text-2xl font-bold text-cyan-300 mb-4 border-b border-gray-700 pb-2">房貸資訊</h3>
                </div>
                <div>
                    <label for="mortgageAmount" class="block text-gray-300 text-lg font-medium mb-2">房貸金額 (萬)</label>
                    <input type="number" id="mortgageAmount" value="200" class="input-field">
                </div>
                <div>
                    <label for="mortgageRate" class="block text-gray-300 text-lg font-medium mb-2">房貸年利率 (%)</label>
                    <input type="number" id="mortgageRate" value="2.8" step="0.1" class="input-field">
                </div>
                <div class="md:col-span-2">
                    <div class="block text-gray-300 text-lg font-medium mb-2">房貸還款方式</div>
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="mortgageType" value="amortized" id="mortgageTypeAmortized" class="form-radio text-cyan-500" checked>
                            <span class="ml-2 text-gray-200">本利攤</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="mortgageType" value="grace" id="mortgageTypeGrace" class="form-radio text-cyan-500">
                            <span class="ml-2 text-gray-200">利息寬限期</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="mortgageYears" class="block text-gray-300 text-lg font-medium mb-2">房貸年限 (年)</label>
                    <input type="number" id="mortgageYears" value="20" class="input-field">
                </div>
                <div id="mortgageGracePeriodContainer" class="hidden">
                    <label for="mortgageGracePeriod" class="block text-gray-300 text-lg font-medium mb-2">房貸寬限期年限 (年)</label>
                    <input type="number" id="mortgageGracePeriod" value="3" class="input-field">
                </div>

                <!-- 現金貸款部分 -->
                <div class="md:col-span-2 mt-8 mb-4">
                    <h3 class="text-2xl font-bold text-purple-300 mb-4 border-b border-gray-700 pb-2">現金貸款資訊</h3>
                </div>
                <div class="md:col-span-2 mb-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="noCashLoanCheckbox" class="form-checkbox text-purple-500 rounded">
                        <span class="ml-2 text-gray-200">暫無現金貸款需求</span>
                    </label>
                </div>

                <div id="cashLoanInputs" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 md:col-span-2">
                    <div>
                        <label for="cashLoanAmount" class="block text-gray-300 text-lg font-medium mb-2">現金貸款金額 (萬)</label>
                        <input type="number" id="cashLoanAmount" value="500" class="input-field">
                    </div>
                    <div>
                        <label for="cashLoanRate" class="block text-gray-300 text-lg font-medium mb-2">現金貸款年利率 (%)</label>
                        <input type="number" id="cashLoanRate" value="2.4" step="0.1" class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label for="cashLoanGracePeriod" class="block text-gray-300 text-lg font-medium mb-2">現金貸款寬限期 (年)</label>
                        <input type="number" id="cashLoanGracePeriod" value="3" class="input-field">
                    </div>
                </div>

                <!-- ETF 及試算期間 -->
                <div id="etfAndPeriodSection" class="md:col-span-2 mt-8 mb-4">
                    <h3 class="text-2xl font-bold text-green-300 mb-4 border-b border-gray-700 pb-2">投資與試算設定</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <label for="etfYield" class="block text-gray-300 text-lg font-medium mb-2">ETF預期年化殖利率 (%)</label>
                            <input type="number" id="etfYield" value="5.5" step="0.1" class="input-field">
                        </div>
                        <div>
                            <label for="analysisPeriod" class="block text-gray-300 text-lg font-medium mb-2">試算期間 (年)</label>
                            <input type="number" id="analysisPeriod" value="3" class="input-field">
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-10">
                <button id="calculateBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-500 focus:ring-opacity-50">
                    計算結果
                </button>
            </div>
        </section>

        <!-- 數據總覽區塊 -->
        <section id="section-overview" class="w-full max-w-6xl mx-auto py-24 min-h-screen flex flex-col justify-center items-center relative z-10 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                <!-- 核心數據卡片 1: 總投入資金 -->
                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-cyan opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-4 text-cyan-400">總投入資金</h2>
                        <p class="text-gray-300 text-sm mb-6">Total Capital Deployed</p>
                        <div class="text-6xl md:text-7xl font-extrabold text-white mb-4">
                            <span class="text-cyan-400" id="displayTotalCapital">700</span>萬
                        </div>
                        <p class="text-gray-400 text-sm" id="displayCapitalBreakdown">
                            房貸: <span id="displayMortgageAmount">200</span>萬<br>
                            現金貸: <span id="displayCashLoanAmount">500</span>萬
                        </p>
                    </div>
                </div>

                <!-- 核心數據卡片 2: 預期年化殖利率 (可隱藏) -->
                <div id="overviewEtfYieldCard" class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-purple opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-4 text-purple-400">預期年化殖利率</h2>
                        <p class="text-gray-300 text-sm mb-6">Expected Annual Yield (ETF)</p>
                        <div class="text-6xl md:text-7xl font-extrabold text-white mb-4">
                            <span class="text-purple-400" id="displayEtfYield">5.5</span>%
                        </div>
                        <p class="text-gray-400 text-sm">平均預估值</p>
                    </div>
                </div>

                <!-- 核心數據卡片 3: 預估淨收益 (可隱藏) -->
                <div id="overviewNetGainCard" class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-green opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-4 text-green-400">預估淨收益</h2>
                        <p class="text-gray-300 text-sm mb-6">Estimated Net Gain (<span id="displayPeriodNetGain">3</span> Years)</p>
                        <div class="text-6xl md:text-7xl font-extrabold text-white mb-4">
                            <span class="text-green-400" id="displayNetGain">29.7</span>萬
                        </div>
                        <p class="text-gray-400 text-sm">基於目前數據計算</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 詳細數據分析區塊 -->
        <section id="section-details" class="w-full max-w-6xl mx-auto py-24 min-h-screen flex flex-col justify-center items-center relative z-10 hidden">
            <h2 class="text-5xl md:text-6xl font-extrabold text-white mb-16 text-center bento-item">
                <span class="text-cyan-400">詳細數據</span>分析
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                <!-- 左側：貸款成本分析 -->
                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-purple opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-bold mb-6 text-purple-400">貸款成本預估</h3>
                        <p class="text-gray-300 text-sm mb-8">Estimated Loan Costs</p>

                        <div class="flex items-center mb-6">
                            <div class="outline-circle w-16 h-16 text-purple-400 border-purple-400 mr-4 text-2xl font-bold">1</div>
                            <div>
                                <p class="text-2xl font-bold text-white">房貸利息支出</p>
                                <p class="text-gray-400 text-sm">Mortgage Interest (<span id="displayMortgagePeriod">3</span> Years)</p>
                                <p class="text-4xl font-extrabold text-purple-300 mt-2"><span id="displayMortgageInterest">16.8</span>萬</p>
                                <p class="text-gray-500 text-xs mt-1">還款方式: <span id="displayMortgageRepaymentType">本利攤</span></p>
                                <p class="text-gray-500 text-xs mt-1 hidden" id="displayMortgageGracePeriodText">寬限期: <span id="displayMortgageGracePeriod">3</span> 年</p>
                            </div>
                        </div>

                        <div class="flex items-center mb-6">
                            <div class="outline-circle w-16 h-16 text-purple-400 border-purple-400 mr-4 text-2xl font-bold">2</div>
                            <div>
                                <p class="text-2xl font-bold text-white">現金貸款利息支出</p>
                                <p class="text-gray-400 text-sm">Cash Loan Interest (<span id="displayCashLoanPeriod">3</span> Years)</p>
                                <p class="text-4xl font-extrabold text-purple-300 mt-2"><span id="displayCashLoanInterest">36</span>萬</p>
                                <p class="text-gray-500 text-xs mt-1">寬限期: <span id="displayCashLoanGracePeriod">3</span> 年</p>
                            </div>
                        </div>

                        <div class="flex items-center">
                            <div class="outline-circle w-16 h-16 text-purple-400 border-purple-400 mr-4 text-2xl font-bold">Σ</div>
                            <div>
                                <p class="text-2xl font-bold text-white">總利息成本</p>
                                <p class="text-gray-400 text-sm">Total Interest Cost</p>
                                <p class="text-5xl font-extrabold text-purple-400 mt-2"><span id="displayTotalInterest">52.8</span>萬</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側：房貸每月平均還款 -->
                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-green opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-bold mb-6 text-green-400">房貸每月平均還款</h3>
                        <p class="text-gray-300 text-sm mb-8">Average Monthly Mortgage Repayment</p>

                        <div class="flex items-center mb-6">
                            <div class="outline-circle w-16 h-16 text-green-400 border-green-400 mr-4 text-2xl font-bold">✓</div>
                            <div>
                                <p class="text-2xl font-bold text-white">每月平均利息</p>
                                <p class="text-gray-400 text-sm">Avg. Monthly Interest</p>
                                <p class="text-4xl font-extrabold text-green-300 mt-2"><span id="displayAvgMonthlyInterest">0</span>元</p>
                            </div>
                        </div>

                        <div class="flex items-center mb-6">
                            <div class="outline-circle w-16 h-16 text-green-400 border-green-400 mr-4 text-2xl font-bold">✓</div>
                            <div>
                                <p class="text-2xl font-bold text-white">每月還款本金</p>
                                <p class="text-gray-400 text-sm">Avg. Monthly Principal</p>
                                <p class="text-4xl font-extrabold text-green-300 mt-2"><span id="displayAvgMonthlyPrincipal">0</span>元</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 房貸還款圖表區塊 -->
        <section id="section-mortgage-repayment-chart" class="w-full max-w-6xl mx-auto py-24 min-h-screen flex flex-col justify-center items-center relative z-10 hidden">
            <h2 class="text-5xl md:text-6xl font-extrabold text-white mb-16 text-center bento-item">
                <span class="text-blue-400">房貸</span>還款圖表
            </h2>

            <div class="grid grid-cols-1 w-full">
                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-blue opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-bold mb-6 text-blue-400">房貸償還趨勢</h3>
                        <p class="text-gray-300 text-sm mb-8">Mortgage Repayment Trend (總年期)</p>

                        <div class="mt-8">
                            <canvas id="mortgageRepaymentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 總結與風險提示區塊 -->
        <section id="section-summary" class="w-full max-w-6xl mx-auto py-24 min-h-screen flex flex-col justify-center items-center relative z-10 hidden">
            <h2 class="text-5xl md:text-6xl font-extrabold text-white mb-16 text-center bento-item">
                <span class="text-cyan-400">總結與</span>風險提示
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group col-span-1 md:col-span-2">
                    <div class="absolute inset-0 gradient-overlay-cyan opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-bold mb-4 text-cyan-400">整合策略效益</h3>
                        <p class="text-gray-300 text-sm mb-6">Integrated Strategy Benefits</p>
                        <p class="text-xl text-gray-200 leading-relaxed mb-6">
                            透過槓桿投資，您有機會在 <span id="displaySummaryPeriod">3</span> 年內獲得 <span class="text-cyan-300 font-bold" id="displayTotalReturn">約 4.24% 的總投報率</span>。這顯示了在特定市場條件下，借貸投資的潛在效益。
                            <br>
                            This leveraged investment strategy could yield an estimated <span class="text-cyan-300 font-bold" id="displayTotalReturnEn">4.24% total return over <span id="displaySummaryPeriodEn">3</span> years</span>, highlighting the potential benefits of debt-financed investment under specific market conditions.
                        </p>
                        <div class="flex items-center justify-center mt-8">
                            <svg class="w-20 h-20 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-purple opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-bold mb-4 text-purple-400">重要風險提示</h3>
                        <p class="text-gray-300 text-sm mb-6">Important Risk Disclaimer</p>
                        <ul class="list-disc list-inside text-gray-300 text-lg leading-relaxed space-y-3">
                            <li><span class="font-bold text-white">市場波動：</span>ETF淨值可能下跌，影響實際收益。 <span class="text-sm text-gray-400">Market Volatility: ETF values can decline.</span></li>
                            <li><span class="font-bold text-white">利率變動：</span>貸款利率若上升，成本將增加。 <span class="text-sm text-gray-400">Interest Rate Risk: Rising rates increase costs.</span></li>
                            <li><span class="font-bold text-white">流動性風險：</span>緊急資金需求可能導致虧損賣出。 <span class="text-sm text-gray-400">Liquidity Risk: Forced sales may incur losses.</span></li>
                            <li><span class="font-bold text-white">稅務考量：</span>股利收入與利息抵扣可能影響最終淨利。 <span class="text-sm text-gray-400">Tax Implications: Affects net profit.</span></li>
                        </ul>
                    </div>
                </div>

                <div class="bento-item bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 gradient-overlay-green opacity-50 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-bold mb-4 text-green-400">建議與下一步</h3>
                        <p class="text-gray-300 text-sm mb-6">Recommendations & Next Steps</p>
                        <p class="text-xl text-gray-200 leading-relaxed mb-6">
                            在做出任何決策前，請務必 <span class="font-bold text-white">諮詢專業財務顧問</span>，並根據您的風險承受能力和財務目標進行綜合評估。
                            <br>
                            Before any decisions, <span class="font-bold text-white">consult a professional financial advisor</span> and assess based on your risk tolerance and financial goals.
                        </p>
                        <div class="flex items-center justify-center mt-8">
                            <svg class="w-20 h-20 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.747 0-3.332.477-4.5 1.253"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 頁腳 (可選) -->
        <footer class="w-full text-center text-gray-600 text-sm py-10 relative z-10 mt-20">
            &copy; 2025 金融洞察. All rights reserved.
        </footer>
    </div>

    <script>
        let myChart; // Global variable to hold the Chart.js instance

        /**
         * Calculates cumulative interest and principal paid for a mortgage over a specified period.
         * Supports both amortized and interest-only grace period repayment types.
         * @param {number} principal - Loan principal amount (in base units, e.g., cents or dollars).
         * @param {number} annualRate - Annual interest rate (e.g., 2.8 for 2.8%).
         * @param {number} totalLoanYears - Total duration of the loan in years.
         * @param {number} gracePeriodYears - Duration of the interest-only grace period in years.
         * @param {number} periodToCalculate - The period (in years) for which to calculate cumulative values.
         * @param {boolean} isGracePeriodSelected - True if interest-only grace period is selected, false for amortized.
         * @returns {{totalInterest: number, totalPrincipal: number}} - Object containing cumulative interest and principal paid.
         */
        function calculateMortgagePayments(principal, annualRate, totalLoanYears, gracePeriodYears, periodToCalculate, isGracePeriodSelected) {
            if (principal <= 0 || annualRate < 0 || totalLoanYears <= 0 || periodToCalculate <= 0) {
                return { totalInterest: 0, totalPrincipal: 0 };
            }

            const monthlyRate = annualRate / 12 / 100;
            const totalMonths = totalLoanYears * 12;
            const periodMonths = periodToCalculate * 12;

            let cumulativeInterest = 0;
            let cumulativePrincipal = 0;
            let currentPrincipalBalance = principal; // Tracks the principal balance over time

            if (!isGracePeriodSelected || gracePeriodYears === 0) {
                // Scenario: Principal and Interest (本利攤)
                // Calculate monthly payment (PMT) for the entire loan term
                const pmt = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -totalMonths));

                for (let m = 1; m <= periodMonths; m++) {
                    if (currentPrincipalBalance <= 0) { // Loan paid off
                        break;
                    }
                    const interestPayment = currentPrincipalBalance * monthlyRate;
                    let principalPayment = pmt - interestPayment;

                    // Ensure principal payment doesn't exceed remaining balance
                    if (principalPayment > currentPrincipalBalance) {
                        principalPayment = currentPrincipalBalance;
                    }

                    cumulativeInterest += interestPayment;
                    cumulativePrincipal += principalPayment;
                    currentPrincipalBalance -= principalPayment;
                }
            } else {
                // Scenario: Interest-Only Grace Period (利息寬限期)
                const actualGraceMonths = Math.min(gracePeriodYears * 12, totalMonths); // Grace period cannot exceed total loan term

                // Phase 1: Grace Period
                for (let m = 1; m <= periodMonths && m <= actualGraceMonths; m++) {
                    const interestPayment = currentPrincipalBalance * monthlyRate;
                    cumulativeInterest += interestPayment;
                    // Principal remains unchanged during grace period
                }

                // Phase 2: Amortization after Grace Period
                const monthsAfterGraceStarts = actualGraceMonths; // The month amortization starts
                const remainingLoanMonthsAfterGrace = totalMonths - actualGraceMonths;

                if (remainingLoanMonthsAfterGrace > 0) {
                    // Calculate PMT for the amortization phase based on original principal and remaining loan months
                    const pmtAmortization = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -remainingLoanMonthsAfterGrace));
                    
                    for (let m = monthsAfterGraceStarts + 1; m <= periodMonths; m++) {
                        if (currentPrincipalBalance <= 0) { // Loan paid off
                            break;
                        }
                        const interestPayment = currentPrincipalBalance * monthlyRate;
                        let principalPayment = pmtAmortization - interestPayment;

                        // Ensure principal payment doesn't exceed remaining balance
                        if (principalPayment > currentPrincipalBalance) {
                            principalPayment = currentPrincipalBalance;
                        }

                        cumulativeInterest += interestPayment;
                        cumulativePrincipal += principalPayment;
                        currentPrincipalBalance -= principalPayment;
                    }
                }
            }
            return { totalInterest: cumulativeInterest, totalPrincipal: cumulativePrincipal };
        }


        // Function to update all displayed values and chart
        function updateDashboard() {
            // Get values from input fields
            const mortgageAmount = parseFloat(document.getElementById('mortgageAmount').value) || 0;
            const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) || 0;
            const mortgageYears = parseFloat(document.getElementById('mortgageYears').value) || 0;
            const isMortgageGracePeriodSelected = document.getElementById('mortgageTypeGrace').checked;
            const mortgageGracePeriod = parseFloat(document.getElementById('mortgageGracePeriod').value) || 0;

            const noCashLoanChecked = document.getElementById('noCashLoanCheckbox').checked;

            let cashLoanAmount = 0;
            let cashLoanRate = 0;
            let cashLoanGracePeriod = 0;
            let etfYield = 0;

            if (!noCashLoanChecked) {
                cashLoanAmount = parseFloat(document.getElementById('cashLoanAmount').value) || 0;
                cashLoanRate = parseFloat(document.getElementById('cashLoanRate').value) || 0;
                cashLoanGracePeriod = parseFloat(document.getElementById('cashLoanGracePeriod').value) || 0;
                etfYield = parseFloat(document.getElementById('etfYield').value) || 0;
            }

            const analysisPeriod = parseFloat(document.getElementById('analysisPeriod').value) || 0;

            // --- Calculations ---
            // Mortgage Payments for analysis period
            const mortgagePaymentsForAnalysis = calculateMortgagePayments(
                mortgageAmount * 10000,
                mortgageRate,
                mortgageYears,
                mortgageGracePeriod,
                analysisPeriod,
                isMortgageGracePeriodSelected
            );
            const mortgageInterest = mortgagePaymentsForAnalysis.totalInterest / 10000; // Convert back to ten thousands

            // Calculate average monthly mortgage payments for display in the card
            let avgMonthlyInterest = 0;
            let avgMonthlyPrincipal = 0;
            if (mortgageAmount > 0 && mortgageYears > 0) {
                const totalMortgageMonths = mortgageYears * 12;
                const fullMortgagePayments = calculateMortgagePayments(
                    mortgageAmount * 10000,
                    mortgageRate,
                    mortgageYears,
                    mortgageGracePeriod,
                    mortgageYears, // Calculate for the full loan term
                    isMortgageGracePeriodSelected
                );
                avgMonthlyInterest = fullMortgagePayments.totalInterest / totalMortgageMonths;
                avgMonthlyPrincipal = fullMortgagePayments.totalPrincipal / totalMortgageMonths;
            }


            // Cash Loan Interest (in ten thousands)
            let cashLoanInterest = 0;
            if (!noCashLoanChecked) {
                if (analysisPeriod <= cashLoanGracePeriod) {
                    cashLoanInterest = (cashLoanAmount * (cashLoanRate / 100) * analysisPeriod);
                } else {
                    // For simplicity, if analysis period exceeds grace period, assume interest-only on original principal
                    cashLoanInterest = (cashLoanAmount * (cashLoanRate / 100) * analysisPeriod);
                }
            }

            // Total Interest Cost (in ten thousands)
            const totalInterestCost = mortgageInterest + cashLoanInterest;

            // ETF Income (in ten thousands)
            const etfIncome = (cashLoanAmount * (etfYield / 100) * analysisPeriod);

            // Net Gain (in ten thousands)
            const netGain = etfIncome - totalInterestCost;

            // Total Capital for Return calculation (only include cash loan if it's active)
            const totalCapitalForReturn = mortgageAmount + (noCashLoanChecked ? 0 : cashLoanAmount); 
            // Total Return Percentage
            const totalReturn = (totalCapitalForReturn > 0) ? (netGain / totalCapitalForReturn) * 100 : 0;


            // --- Update Displayed Values ---
            const displayTotalCapitalElem = document.getElementById('displayTotalCapital');
            if (displayTotalCapitalElem) displayTotalCapitalElem.textContent = (mortgageAmount + (noCashLoanChecked ? 0 : cashLoanAmount)).toFixed(0); // Adjusted totalCapital display

            const displayMortgageAmountElem = document.getElementById('displayMortgageAmount');
            if (displayMortgageAmountElem) displayMortgageAmountElem.textContent = mortgageAmount.toFixed(0);
            const displayCashLoanAmountElem = document.getElementById('displayCashLoanAmount');
            if (displayCashLoanAmountElem) displayCashLoanAmountElem.textContent = cashLoanAmount.toFixed(0); // Will be 0 if noCashLoanChecked

            // Conditional display for overview cards
            const overviewEtfYieldCard = document.getElementById('overviewEtfYieldCard');
            const overviewNetGainCard = document.getElementById('overviewNetGainCard');
            if (noCashLoanChecked) {
                if (overviewEtfYieldCard) overviewEtfYieldCard.classList.add('hidden');
                if (overviewNetGainCard) overviewNetGainCard.classList.add('hidden');
            } else {
                if (overviewEtfYieldCard) overviewEtfYieldCard.classList.remove('hidden');
                if (overviewNetGainCard) overviewNetGainCard.classList.remove('hidden');
            }

            const displayEtfYieldElem = document.getElementById('displayEtfYield');
            if (displayEtfYieldElem) displayEtfYieldElem.textContent = etfYield.toFixed(1);
            const displayPeriodNetGainElem = document.getElementById('displayPeriodNetGain');
            if (displayPeriodNetGainElem) displayPeriodNetGainElem.textContent = analysisPeriod.toFixed(0);
            const displayNetGainElem = document.getElementById('displayNetGain');
            if (displayNetGainElem) displayNetGainElem.textContent = netGain.toFixed(1);

            const displayMortgagePeriodElem = document.getElementById('displayMortgagePeriod');
            if (displayMortgagePeriodElem) displayMortgagePeriodElem.textContent = analysisPeriod.toFixed(0);
            const displayMortgageInterestElem = document.getElementById('displayMortgageInterest');
            if (displayMortgageInterestElem) displayMortgageInterestElem.textContent = mortgageInterest.toFixed(1);

            const displayMortgageRepaymentTypeElem = document.getElementById('displayMortgageRepaymentType');
            const displayMortgageGracePeriodTextElem = document.getElementById('displayMortgageGracePeriodText');
            const displayMortgageGracePeriodElem = document.getElementById('displayMortgageGracePeriod');

            if (displayMortgageRepaymentTypeElem) {
                if (isMortgageGracePeriodSelected) {
                    displayMortgageRepaymentTypeElem.textContent = '利息寬限期';
                    if (displayMortgageGracePeriodTextElem) displayMortgageGracePeriodTextElem.classList.remove('hidden');
                    if (displayMortgageGracePeriodElem) displayMortgageGracePeriodElem.textContent = mortgageGracePeriod.toFixed(0);
                } else {
                    displayMortgageRepaymentTypeElem.textContent = '本利攤';
                    if (displayMortgageGracePeriodTextElem) displayMortgageGracePeriodTextElem.classList.add('hidden');
                }
            }

            const displayCashLoanPeriodElem = document.getElementById('displayCashLoanPeriod');
            if (displayCashLoanPeriodElem) displayCashLoanPeriodElem.textContent = analysisPeriod.toFixed(0);
            const displayCashLoanInterestElem = document.getElementById('displayCashLoanInterest');
            if (displayCashLoanInterestElem) displayCashLoanInterestElem.textContent = cashLoanInterest.toFixed(1);
            const displayCashLoanGracePeriodElem = document.getElementById('displayCashLoanGracePeriod');
            if (displayCashLoanGracePeriodElem) displayCashLoanGracePeriodElem.textContent = cashLoanGracePeriod.toFixed(0); // Will be 0 if noCashLoanChecked
            const displayTotalInterestElem = document.getElementById('displayTotalInterest');
            if (displayTotalInterestElem) displayTotalInterestElem.textContent = totalInterestCost.toFixed(1);

            const displayEtfPeriodElem = document.getElementById('displayEtfPeriod');
            if (displayEtfPeriodElem) displayEtfPeriodElem.textContent = etfIncome.toFixed(1); // Changed to show income instead of period
            const displayEtfIncomeElem = document.getElementById('displayEtfIncome');
            if (displayEtfIncomeElem) displayEtfIncomeElem.textContent = etfIncome.toFixed(1); // Redundant, removed in next iteration

            // Update Average Monthly Mortgage Repayment section
            const displayAvgMonthlyInterestElem = document.getElementById('displayAvgMonthlyInterest');
            if (displayAvgMonthlyInterestElem) displayAvgMonthlyInterestElem.textContent = avgMonthlyInterest.toFixed(0);
            const displayAvgMonthlyPrincipalElem = document.getElementById('displayAvgMonthlyPrincipal');
            if (displayAvgMonthlyPrincipalElem) displayAvgMonthlyPrincipalElem.textContent = avgMonthlyPrincipal.toFixed(0);


            // --- Update Mortgage Repayment Chart ---
            const chartLabels = [];
            const cumulativeMortgageInterestData = [];
            const cumulativeMortgagePrincipalData = [];
            const cumulativeEtfIncomeData = [];
            const cumulativeNetProfitData = [];
            const cumulativeTotalCostData = [];


            for (let i = 1; i <= mortgageYears; i++) { // Chart spans full mortgage loan term
                chartLabels.push(`第${i}年`);

                // Mortgage payments up to current year 'i'
                const mortgagePaymentsForChart = calculateMortgagePayments(
                    mortgageAmount * 10000,
                    mortgageRate,
                    mortgageYears,
                    mortgageGracePeriod,
                    i, // Calculate for current year 'i'
                    isMortgageGracePeriodSelected
                );
                cumulativeMortgageInterestData.push((mortgagePaymentsForChart.totalInterest / 10000).toFixed(1));
                cumulativeMortgagePrincipalData.push((mortgagePaymentsForChart.totalPrincipal / 10000).toFixed(1));

                // Cash Loan and ETF data (only if not "no cash loan")
                let currentCashLoanInterestCumulative = 0;
                let currentEtfIncomeCumulative = 0;

                if (!noCashLoanChecked) {
                    if (i <= cashLoanGracePeriod) {
                        currentCashLoanInterestCumulative = (cashLoanAmount * (cashLoanRate / 100) * i);
                    } else {
                        currentCashLoanInterestCumulative = (cashLoanAmount * (cashLoanRate / 100) * i);
                    }
                    currentEtfIncomeCumulative = (cashLoanAmount * (etfYield / 100) * i);
                }

                cumulativeTotalCostData.push(((mortgagePaymentsForChart.totalInterest / 10000) + currentCashLoanInterestCumulative).toFixed(1));
                cumulativeEtfIncomeData.push(currentEtfIncomeCumulative.toFixed(1));
                cumulativeNetProfitData.push((currentEtfIncomeCumulative - ((mortgagePaymentsForChart.totalInterest / 10000) + currentCashLoanInterestCumulative)).toFixed(1));
            }

            const ctx = document.getElementById('mortgageRepaymentChart');
            if (!ctx) return;

            // Destroy existing chart instance if it exists
            if (myChart) {
                myChart.destroy();
            }

            const datasets = [
                {
                    label: '累積償還利息 (萬)',
                    data: cumulativeMortgageInterestData,
                    borderColor: 'rgba(168, 85, 247, 0.8)', // Purple for interest
                    backgroundColor: 'rgba(168, 85, 247, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(168, 85, 247, 1)',
                    pointBorderColor: '#000',
                    pointBorderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: '累積償還本金 (萬)',
                    data: cumulativeMortgagePrincipalData,
                    borderColor: 'rgba(6, 182, 212, 0.8)', // Cyan for principal
                    backgroundColor: 'rgba(6, 182, 212, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(6, 182, 212, 1)',
                    pointBorderColor: '#000',
                    pointBorderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ];

            if (!noCashLoanChecked) {
                datasets.push({
                    label: '累積 ETF 收益 (萬)',
                    data: cumulativeEtfIncomeData,
                    borderColor: 'rgba(74, 222, 128, 0.8)', // Green for income
                    backgroundColor: 'rgba(74, 222, 128, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(74, 222, 128, 1)',
                    pointBorderColor: '#000',
                    pointBorderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                });
                datasets.push({
                    label: '累積淨利 (萬)',
                    data: cumulativeNetProfitData,
                    borderColor: 'rgba(96, 165, 250, 0.8)', // Blue for net profit
                    backgroundColor: 'rgba(96, 165, 250, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(96, 165, 250, 1)',
                    pointBorderColor: '#000',
                    pointBorderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                });
            }


            myChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0', // 圖例文字顏色
                                font: {
                                    family: 'Inter',
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#E0E0E0',
                            bodyColor: '#E0E0E0',
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)', // X軸網格線顏色
                                drawBorder: false
                            },
                            ticks: {
                                color: '#E0E0E0', // X軸標籤顏色
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)', // Y軸網格線顏色
                                drawBorder: false
                            },
                            ticks: {
                                color: '#E0E0E0', // Y軸標籤顏色
                                font: {
                                    family: 'Inter'
                                }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 滾動動畫邏輯 (保持不變)
        const bentoItems = document.querySelectorAll('.bento-item');

        const observerOptions = {
            root: null, // 觀察整個視窗
            rootMargin: '0px',
            threshold: 0.2 // 當元素20%進入視窗時觸發
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-in');
                    observer.unobserve(entry.target); // 元素進入後停止觀察
                }
            });
        }, observerOptions);

        // Event listeners for mortgage type radio buttons
        document.getElementById('mortgageTypeAmortized').addEventListener('change', function() {
            document.getElementById('mortgageGracePeriodContainer').classList.add('hidden');
        });

        document.getElementById('mortgageTypeGrace').addEventListener('change', function() {
            document.getElementById('mortgageGracePeriodContainer').classList.remove('hidden');
        });

        // Event listener for "No cash loan" checkbox
        document.getElementById('noCashLoanCheckbox').addEventListener('change', function() {
            const cashLoanInputsDiv = document.getElementById('cashLoanInputs');
            const etfAndPeriodSection = document.getElementById('etfAndPeriodSection');
            if (this.checked) {
                cashLoanInputsDiv.classList.add('hidden');
                etfAndPeriodSection.classList.add('hidden');
            } else {
                cashLoanInputsDiv.classList.remove('hidden');
                etfAndPeriodSection.classList.remove('hidden');
            }
        });

        // Event listener for the calculate button
        const calculateButton = document.getElementById('calculateBtn');
        calculateButton.addEventListener('click', () => {
            updateDashboard(); // 計算並更新數據

            // 顯示結果區塊
            document.getElementById('section-overview').classList.remove('hidden');
            document.getElementById('section-details').classList.remove('hidden');
            document.getElementById('section-mortgage-repayment-chart').classList.remove('hidden'); // 顯示房貸還款圖表區塊
            document.getElementById('section-summary').classList.remove('hidden');

            // 重新觀察 bento items 以觸發動畫
            bentoItems.forEach(item => {
                item.classList.remove('animate-in'); // 重置動畫狀態
                observer.unobserve(item); // 停止舊的觀察
                observer.observe(item); // 開始新的觀察
            });

            // 平滑滾動到結果區塊
            document.getElementById('section-overview').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        });

        // Add event listener for Enter key on the document
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                calculateButton.click(); // Simulate a click on the calculate button
            }
        });


        // Initial setup on page load: observe bento items for animation, but don't show results yet
        document.addEventListener('DOMContentLoaded', () => {
            bentoItems.forEach(item => {
                observer.observe(item); // 觀察所有 bento items，包括輸入區塊
            });
            // Ensure initial state of mortgage grace period input is correct
            if (document.getElementById('mortgageTypeAmortized').checked) {
                document.getElementById('mortgageGracePeriodContainer').classList.add('hidden');
            } else {
                document.getElementById('mortgageGracePeriodContainer').classList.remove('hidden');
            }
            // Ensure initial state of cash loan inputs and ETF section is correct based on checkbox
            const noCashLoanCheckbox = document.getElementById('noCashLoanCheckbox');
            const cashLoanInputsDiv = document.getElementById('cashLoanInputs');
            const etfAndPeriodSection = document.getElementById('etfAndPeriodSection');
            if (noCashLoanCheckbox.checked) {
                cashLoanInputsDiv.classList.add('hidden');
                etfAndPeriodSection.classList.add('hidden');
            } else {
                cashLoanInputsDiv.classList.remove('hidden');
                etfAndPeriodSection.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
