<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>充電站(樁)投資效益分析 (v13.0.0 - 精簡版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans TC', 'Inter', sans-serif; background-color: #f8fafc; }
        .input-field { background-color: white; color: #1f2937; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.65rem 0.85rem; text-align: center; width: 100%; transition: all 0.3s ease; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); }
        .input-field.readonly, input:disabled { background-color: #e5e7eb; color: #6b7280; cursor: not-allowed; }
        .label-text { font-weight: 600; color: #374151; }
        .card { border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); padding: 1.5rem; display: flex; flex-direction: column; }
        .card:not(.fixed-height) { height: 100%; }
        @media (min-width: 768px) { .card { padding: 2rem; } }
        .summary-card { background: linear-gradient(135deg, #4f46e5, #3b82f6); color: white; border-radius: 1rem; padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); height: 100%; }
        .summary-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; display: flex; align-items: baseline; justify-content: center; white-space: nowrap; }
        @media (min-width: 768px) { .summary-value { font-size: 1.625rem; } }
        .summary-value .unit { font-size: 0.875rem; font-weight: 500; }
        .summary-value .unit-prefix { margin-right: 0.5rem; }
        .summary-value .unit-suffix { margin-left: 0.5rem; }
        @media (min-width: 768px) { .summary-value .unit { font-size: 1rem; } }
        .summary-label { font-size: 1rem; opacity: 0.9; font-weight: 500; margin-bottom: 0.75rem; }
        @media (min-width: 768px) { .summary-label { font-size: 1.125rem; } }
        .summary-card.alt-color {
            background: linear-gradient(135deg, #059669, #10b981);
        }
        .summary-card.sortable-ghost {
            opacity: 0.4;
            background: #dbeafe;
        }
        .table-header { background-color: rgba(0,0,0,0.04); color: #374151; font-weight: 700; }
        .table-cell { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        @media (min-width: 768px) { .table-cell { padding: 0.9rem 1.2rem; } }
        .table-cell-year { font-weight: 700; color: #1f2937; text-align: left; }
        #pnlTableBody tr:nth-child(even), #kwhStatsTableBody tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.6); }
        #pnlTableBody tr.pnl-row:hover, #kwhStatsTableBody tr.kwh-row:hover { background-color: #eff6ff; transition: background-color 0.2s ease; }
        #pnlTableBody tr.pnl-row, #kwhStatsTableBody tr.kwh-row { cursor: pointer; }
        .details-row td { padding: 0; background-color: #f8fafc; border-bottom: 1px solid #e5e7eb; }
        #pnlTableBody .details-row td { background-color: #f0fdf4; }
        .details-container { padding: 1.5rem; max-width: 64rem; margin: auto; }
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 1024px) { .details-grid { grid-template-columns: 1fr 1fr; gap: 1rem 2.5rem; } }
        .details-section h4 { font-weight: 700; color: #111827; margin-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .details-item { display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: baseline; font-size: 0.875rem; padding: 0.3rem 0; }
        .details-item span:first-child { color: #6b7280; text-align: left; }
        .details-item span:last-child { color: #1f2937; font-weight: 500; text-align: right; }
        .choice-label { display: inline-flex; align-items: center; cursor: pointer; margin-right: 1.25rem; user-select: none; }
        .choice-label input { display: none; }
        .choice-label span { padding: 0.4rem 1rem; border-radius: 9999px; background-color: #e5e7eb; color: #4b5563; transition: all 0.2s ease; font-weight: 500; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .choice-label input:checked + span { background-color: #4f46e5; color: white; font-weight: 600; box-shadow: 0 2px 5px 0 rgba(79, 70, 229, 0.3); }
        .choice-label input:disabled + span { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .hidden-section { display: none; }
        .input-section { padding: 1rem; border-radius: 0.75rem; transition: background-color 0.3s ease; }
        .input-section.bg-blue-50 { background-color: #eff6ff; }
        .input-section.bg-green-50 { background-color: #f0fdf4; }
        .input-section.bg-yellow-50 { background-color: #fefce8; }
        .input-section.bg-purple-50 { background-color: #f5f3ff; }
        .input-section.bg-slate-50 { background-color: #f8fafc; }
        .input-section.bg-pink-50 { background-color: #fdf2f8; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease-out forwards; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); animation: slideIn 0.3s ease-out forwards; }
        @media (min-width: 768px) { .modal-content { padding: 2rem; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        @media (min-width: 768px) { .modal-title { font-size: 1.5rem; } }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; transition: color 0.2s ease; line-height: 1; }
        .modal-close-btn:hover { color: #374151; }
        .modal-table-input { width: 100%; text-align: right; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; }
        .modal-table-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .modal-table-input.readonly { background-color: #e5e7eb; color: #6b7280; cursor: not-allowed; }
        .modal-action-button { background-color: #4f46e5; color: white; padding: 0.75rem 1.75rem; border-radius: 0.6rem; font-weight: 600; transition: background-color 0.2s ease, transform 0.1s ease; border: none; cursor: pointer; }
        .modal-action-button:hover { background-color: #4338ca; transform: translateY(-1px); }
        .modal-action-button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .modal-message { margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; font-weight: 500; text-align: center; display: none; }
        .modal-message.error { background-color: #fee2e2; color: #ef4444; }
        .modal-message.success { background-color: #d1fae5; color: #10b981; }
        .password-section-compact { font-size: 0.9rem; }
        .password-section-compact .grid { gap: 0.5rem 1rem; }
        .password-section-compact .input-field { padding: 0.5rem 0.75rem; }
        .modal-tabs { border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem; }
        .modal-tab-btn { padding: 0.75rem 1.25rem; border: none; background: none; font-size: 1rem; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .modal-tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }
        .salvage-display { color: #ef4444; font-weight: 500; vertical-align: middle; }
        #explanationList li { align-items: baseline; }
        #explanationList li[data-target] { cursor: pointer; transition: color 0.2s ease, background-color 0.2s ease; padding: 0.25rem 0.5rem; border-radius: 0.375rem; margin: 0 -0.5rem; }
        #explanationList li[data-target]:hover { color: #4f46e5; background-color: #eef2ff; }
        .explainer-grid { display: grid; grid-template-columns: auto 1fr auto; gap: 0 1.5rem; align-items: baseline; }
        .explainer-grid > span { padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; }
        .explainer-grid > span:nth-child(3n+1) { font-weight: 500; color: #374151; }
        .explainer-grid > span:nth-child(3n+2) { color: #6b7280; font-size: 0.875rem; }
        .explainer-grid > span:nth-child(3n+3) { font-weight: 600; text-align: right; }
        .explainer-total-row { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: baseline; padding-top: 0.75rem; margin-top: 0.75rem; border-top: 2px solid #e5e7eb; font-weight: 700; font-size: 1.125rem; color: #111827; }
        #touGridEditor { user-select: none; }
        .tou-controls { display: flex; flex-direction: column; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; }
        .tou-rate-type-label { padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; border: 2px solid transparent; transition: all 0.2s ease; }
        .tou-rate-type-label span { font-weight: 500; opacity: 0.8; }
        .tou-rate-type-label.peak { background-color: #fee2e2; color: #b91c1c; }
        .tou-rate-type-label.offpeak { background-color: #dcfce7; color: #166534; }
        .tou-rate-type-label.holiday { background-color: #dbeafe; color: #1e40af; }
        .tou-controls input[type="radio"] { display: none; }
        input[name="touRateType"]:checked + .peak { border-color: #dc2626; }
        input[name="touRateType"]:checked + .offpeak { border-color: #16a34a; }
        input[name="touRateType"]:checked + .holiday { border-color: #2563eb; }
        #touGridContainer { display: grid; grid-template-columns: 2.5rem repeat(7, minmax(35px, 1fr)); gap: 2px; min-width: 420px; }
        .tou-grid-cell { background-color: #e5e7eb; cursor: pointer; transition: all 0.1s ease; text-align: center; font-size: 0.7rem; line-height: 1.5rem; border-radius: 4px; }
        .tou-grid-header { font-weight: bold; text-align: center; padding: 0.5rem 0; background-color: #f3f4f6; border-radius: 4px;}
        .tou-grid-time { font-size: 0.75rem; color: #6b7280; display: flex; align-items: center; justify-content: center; }
        .tou-grid-cell.peak { background-color: #fecaca; }
        .tou-grid-cell.offpeak { background-color: #bbf7d0; }
        .tou-grid-cell.holiday { background-color: #bfdbfe; }
        .tou-grid-cell.painting { transform: scale(0.9); filter: brightness(1.1); }
        .equipment-row { display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; }
        .equipment-row .count-label { font-size: 0.875rem; text-align: right; padding-right: 0.5rem; }
        .equipment-row .equipment-count { width: 60px; }
        .remove-equip-btn { background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.5rem; border-radius: 999px; line-height: 1; transition: background-color 0.2s; }
        .remove-equip-btn:hover { background-color: #fee2e2; }
        .header-actions button { background-color: #fff; border: 1px solid #d1d5db; color: #374151; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .header-actions button:hover { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .record-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, box-shadow 0.2s; cursor: pointer; }
        .record-list-item:nth-child(odd) { background-color: #f9fafb; }
        .record-list-item:hover { background-color: #eff6ff; }
        .record-list-item.selected { background-color: #e0e7ff; box-shadow: inset 4px 0 0 0 #4f46e5; }
        .record-name { font-weight: 600; color: #374151; pointer-events: none; }
        .load-btn { padding: 0.25rem 1rem !important; font-size: 0.875rem !important; font-weight: 600 !important; line-height: 1.25rem !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #kwhTableIcon.rotate-180 { transform: rotate(180deg); }
        .center-text-input { text-align: center !important; }
        
        /* This class is no longer needed */
        /* .force-collapse {
            max-height: 0px !important;
            overflow: hidden !important;
            transition: none !important;
        } */

        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print, .lg\:col-span-1, .header-actions, #openAdvancedModalBtn, .modal-overlay, #toggleKwhTableBtn svg, .remove-equip-btn, #addEquipmentBtn, .card > div > #explanationList, .card > div > div > button, .details-row,
            #cumulativePnlChartLegend, #revenueCostChartLegend, #rentChartLegend, #managementChartLegend, #openSensitivityModalBtn {
                display: none !important;
            }
            body, .card, .bg-amber-100 {
                background: #ffffff !important;
                box-shadow: none !important;
                border: 1px solid #eee !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                page-break-inside: avoid;
            }
            
            .max-w-7xl {
                max-width: 100%;
                padding: 0 !important;
            }
            
            header {
                border-bottom: 2px solid #333;
                padding-bottom: 1rem !important;
                margin-bottom: 2rem !important;
            }

            .lg\:col-span-2 {
                grid-column: span 3 / span 3;
            }
            #kwhTableContainer {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .summary-card {
                background-color: #f3f4f6 !important;
                color: #1f2937 !important;
                border: 1px solid #e5e7eb;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            
            .grid { display: grid !important; }
            .lg\:grid-cols-3 { grid-template-columns: 1fr; }
            .lg\:col-span-2 > .grid:first-child { grid-template-columns: 1fr 1fr 1fr !important; }

            #print-charts-grid {
                display: grid !important;
                grid-template-columns: 1fr; /* Force single column layout */
                gap: 2rem;
                margin-top: 1.5rem;
            }
            .card.bg-sky-50 {
                display: flex !important;
                page-break-inside: avoid;
                border: 1px solid #ddd !important;
                margin-bottom: 2rem !important; /* Add margin between charts */
            }
            .flex-grow.h-80 {
                height: 250px !important;
            }

            @page {
                size: A4;
                margin: 1.5cm;
            }
        }
        .sensitivity-table {
            width: 100%;
            margin-top: 1.5rem;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .sensitivity-table th, .sensitivity-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            text-align: center;
        }
        .sensitivity-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .sensitivity-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .sensitivity-table .base-case {
            background-color: #eef2ff;
            font-weight: 700;
            color: #4f46e5;
        }
        select option:disabled {
            text-decoration: line-through;
            color: #9ca3af;
        }
    </style>
    </head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-10">
            <div class="text-center">
                <h1 class="text-3xl md:text-5xl font-extrabold text-gray-800 leading-tight">充電站(樁)投資效益分析</h1>
                <p class="text-lg md:text-xl text-gray-600 mt-3">互動式損益評估工具 (v13.0.0 - 精簡版)</p>
            </div>
            <div class="flex flex-col sm:flex-row justify-between items-center mt-6 bg-amber-100 p-3 rounded-xl shadow-sm gap-4">
                <div><h2 id="siteNameDisplay" class="text-lg sm:text-xl font-bold text-gray-700">未命名站點</h2></div>
                <div class="flex gap-2 header-actions">
                    <button id="saveBtn">儲存</button>
                    <button id="recordsBtn">紀錄</button>
                    <button id="newAnalysisBtn">重置分析</button>
                    <button id="exportPdfBtn">輸出PDF</button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card bg-white">
                    <div class="flex justify-between items-center mb-5 pb-3 border-b border-gray-200">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">設置參數</h2>
                        <button id="addEquipmentBtn" class="text-sm bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition-all duration-200 ease-in-out shadow-sm hover:shadow-md flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            新增設備
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div id="equipmentListContainer" class="space-y-3"></div>
                        <hr class="border-gray-200 my-2"/>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text text-left">總槍數(車格)</span>
                            <input type="number" id="parkingSpaces" class="input-field readonly" readonly>
                        </div>
                         <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text text-left">設備費用(未稅)</span>
                            <input type="text" id="equipmentCostDisplayMain" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text text-left">勞務工程</span>
                            <input type="text" id="infrastructureCostMain" class="input-field" value="500,000">
                        </div>
                        <hr class="border-gray-200 my-2"/>
                        <div>
                            <label class="choice-label w-full justify-center"><input type="checkbox" id="financingToggle"><span>融資借貸</span></label>
                            <div id="financingSection" class="hidden-section input-section bg-blue-50 space-y-4 mt-3">
                                <div class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">貸款 (%)</span><input type="number" id="loanPercentage" class="input-field" value="70">
                                </div>
                                <div class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">利息 (%)</span><input type="number" id="interestRate" class="input-field" value="3.5" step="0.01">
                                </div>
                                <div class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">貸款年期</span><input type="number" id="loanTerm" class="input-field" value="7">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-white">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">營運&成本設定</h2>
                    <div class="space-y-4">
                        <div id="acSettingsBlock" class="input-section bg-green-50 space-y-4 hidden-section"> <!-- CHANGED: bg-blue-50 to bg-green-50 -->
                            <h3 class="text-xl font-bold text-gray-700 pb-2 border-b border-green-200">AC 慢充設定</h3> <!-- CHANGED: border-blue-200 to border-green-200 -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 text-left">收費方式</h4>
                                <p class="text-sm text-red-600 mt-1 mb-2">AC不以尖離峰方式計費</p>
                                <div class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text text-left">每度電收費 (元)</span>
                                    <input type="number" id="chargeFeePerKwhAC" class="input-field" value="7.5" step="0.1">
                                </div>
                            </div>
                            <div class="pt-4 mt-4 border-t border-blue-200">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 text-left">基礎參數</h4>
                                <p class="text-sm text-gray-500 mb-3">* 僅當「每日車次/槍」初始設定低於2時，才會套用需求年增率，且成長上限為2台車。</p>
                                <div>
                                    <div class="flex flex-wrap gap-3">
                                        <label class="choice-label"><input type="radio" name="revenueMethodAC" value="byCars" checked><span>依車次</span></label>
                                        <label class="choice-label"><input type="radio" name="revenueMethodAC" value="byKwh"><span>依度數</span></label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 items-center gap-4 mt-3">
                                    <div>
                                        <span class="label-text text-left">每日車次/槍</span>
                                        <span class="block text-xs text-red-500 font-normal">(上限2車/次)</span>
                                    </div>
                                    <input type="number" id="carsPerGunPerDayAC" class="input-field" value="0.5" max="2" step="0.1">
                                </div>
                                <div class="grid grid-cols-2 items-center gap-4 mt-3">
                                   <div>
                                        <span class="label-text text-left">每月度數/槍</span>
                                        <span class="block text-xs text-red-500 font-normal">(上限1800度/月)</span>
                                    </div>
                                   <input type="number" id="kwhPerGunPerMonthAC" class="input-field" value="1800" max="1800" step="10">
                                </div>
                            </div>
                        </div>
                        
                        <div id="dcSettingsBlock" class="input-section bg-blue-50 space-y-4 hidden-section"> <!-- CHANGED: bg-green-50 to bg-blue-50 -->
                            <h3 class="text-xl font-bold text-gray-700 pb-2 border-b border-blue-200">DC 快充設定</h3> <!-- CHANGED: border-green-200 to border-blue-200 -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 text-left">收費方式</h4>
                                <div>
                                    <div class="flex flex-wrap gap-3">
                                        <label class="choice-label"><input type="radio" name="billingMethodDC" value="fixed" checked><span>固定費率</span></label>
                                        <label class="choice-label"><input type="radio" name="billingMethodDC" value="tou"><span>尖離峰</span></label>
                                    </div>
                                </div>
                                <div id="fixedRateSectionDC" class="grid grid-cols-2 items-center gap-4 mt-3">
                                    <span class="label-text text-left">每度電收費 (元)</span>
                                    <input type="number" id="chargeFeePerKwhDC" class="input-field" value="10" step="0.1">
                                </div>
                                <div id="touRateSectionDC" class="hidden-section space-y-4 mt-3">
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <span class="label-text font-bold text-indigo-600 text-left">尖離峰均價</span>
                                        <input type="text" id="avgTouRate" class="input-field readonly font-bold text-indigo-600" readonly>
                                    </div>
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <div class="text-left"><span class="label-text block">尖峰費率 (元)</span></div>
                                        <input type="number" id="peakRate" class="input-field" value="13.5" step="0.1">
                                    </div>
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <div class="text-left"><span class="label-text block">離峰費率 (元)</span></div>
                                        <input type="number" id="offPeakRate" class="input-field" value="6.9" step="0.1">
                                    </div>
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <div class="text-left"><span class="label-text block">假日費率 (元)</span></div>
                                        <input type="number" id="holidayRate" class="input-field" value="8.5" step="0.1">
                                    </div>
                                    <div class="flex items-center gap-4 mt-2">
                                        <div id="touPieChartContainer" class="w-24 h-24 flex-shrink-0">
                                            <canvas id="touPieChart"></canvas>
                                        </div>
                                        <div class="flex-grow space-y-2">
                                            <div class="grid grid-cols-3 items-center gap-2">
                                                <label for="peakUsageRatio" class="text-sm font-bold text-red-500">尖峰 %</label>
                                                <input type="number" id="peakUsageRatio" class="input-field readonly col-span-2" value="18" readonly>
                                            </div>
                                            <div class="grid grid-cols-3 items-center gap-2">
                                                <label for="offPeakUsageRatio" class="text-sm font-bold text-green-600">離峰 %</label>
                                                <input type="number" id="offPeakUsageRatio" class="input-field readonly col-span-2" value="54" readonly>
                                            </div>
                                            <div class="grid grid-cols-3 items-center gap-2">
                                                <label for="holidayUsageRatio" class="text-sm font-bold text-blue-500">假日 %</label>
                                                <input type="number" id="holidayUsageRatio" class="input-field readonly col-span-2" value="28" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 mt-4 border-t border-green-200">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 text-left">基礎參數</h4>
                                <div>
                                    <div class="flex flex-wrap gap-3">
                                        <label class="choice-label"><input type="radio" name="revenueMethodDC" value="byCars" checked><span>依車次</span></label>
                                        <label class="choice-label"><input type="radio" name="revenueMethodDC" value="byKwh"><span>依度數</span></label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 items-center gap-4 mt-3">
                                    <span class="label-text text-left">每日車次/槍</span><input type="number" id="carsPerGunPerDayDC" class="input-field" value="3" step="0.5">
                                </div>
                                <div class="grid grid-cols-2 items-center gap-4 mt-3">
                                   <span class="label-text text-left">每月度數/槍</span><input type="text" id="kwhPerGunPerMonthDC" class="input-field" value="2,700">
                                </div>
                            </div>
                        </div>

                        <div class="input-section bg-yellow-50 space-y-4">
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text text-left">每車平均充電 (kWh)</span>
                                <input type="number" id="avgKwhPerCar" class="input-field" value="30">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text text-left">需求年增率 (%)</span><input type="number" id="demandGrowthRate" class="input-field" value="20">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text text-left">預計營運期 (年)</span><input type="number" id="operationYears" class="input-field" value="15" min="1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text text-left">建置期 (月)</span><input type="number" id="constructionPeriod" class="input-field" value="6" min="0">
                            </div>
                        </div>
                        
                        <div class="input-section bg-purple-50 space-y-4">
                            <div>
                                <span class="label-text mb-3 block">設備折舊攤提</span>
                                <div class="flex flex-wrap gap-3">
                                    <label class="choice-label"><input type="radio" name="depreciationMethod" value="straightLine" checked><span>直線法</span></label>
                                    <label class="choice-label"><input type="radio" name="depreciationMethod" value="syd"><span>年數合計法</span></label>
                                    <label class="choice-label"><input type="radio" name="depreciationMethod" value="none"><span>淨利累計法</span></label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text text-left">折舊攤提年限</span><input type="number" id="depreciationYears" class="input-field" value="5" min="1">
                            </div>
                        </div>

                        <div class="input-section bg-slate-50 space-y-4">
                            <div>
                                <span class="label-text mb-3 block">租金&分潤</span>
                                <div class="flex flex-wrap gap-3 mb-3">
                                    <label class="choice-label"><input type="radio" name="rentMethod" value="bySpace" checked><span>依車格</span></label>
                                    <label class="choice-label"><input type="radio" name="rentMethod" value="byLand"><span>依土地</span></label>
                                    <label class="choice-label"><input type="radio" name="rentMethod" value="byKwhShare"><span>度電分潤</span></label>
                                    <label class="choice-label"><input type="radio" name="rentMethod" value="byRevenueShare"><span>營收(%)分潤</span></label>
                                    <label class="choice-label"><input type="radio" name="rentMethod" value="byKwhTier"><span>度電級距(分潤)</span></label>
                                    <label class="choice-label"><input type="radio" name="rentMethod" value="none"><span>無</span></label>
                                </div>
                                <div class="space-y-4">
                                    <div id="rentBySpaceSection" class="grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">車格租金/月</span><input type="text" id="rentPerSpace" class="input-field" value="500">
                                    </div>
                                    <div id="rentByLandSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">土地租金/月</span><input type="text" id="rentPerLand" class="input-field" value="15,000">
                                    </div>
                                    <div id="rentByKwhShareSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">每度電分潤 (元)</span><input type="number" id="rentPerKwh" class="input-field" value="1" step="0.1">
                                    </div>
                                    <div id="rentByRevenueShareSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">營收分潤 (%)</span><input type="number" id="rentPercentage" class="input-field" value="10" step="1">
                                    </div>
                                    <div id="rentByKwhTierSection" class="hidden-section space-y-3">
                                        <div class="grid grid-cols-2 items-center gap-4">
                                            <span class="label-text text-left">總度數門檻/月</span>
                                            <input type="text" id="rentKwhThreshold" class="input-field" value="5,000">
                                        </div>
                                         <div class="flex flex-wrap gap-3 mt-3">
                                            <label class="choice-label text-sm"><input type="radio" name="rentTierType" value="byKwh" checked><span>依度電</span></label>
                                            <label class="choice-label text-sm"><input type="radio" name="rentTierType" value="byRevenue"><span>依營收</span></label>
                                        </div>
                                        <div class="p-3 border border-gray-200 rounded-lg space-y-2">
                                            <span class="label-text text-sm text-green-600 block text-left">▲ 當月總度數 > 門檻</span>
                                            <div id="rentTierAboveKwh" class="grid grid-cols-2 items-center gap-4">
                                                <span class="label-text text-sm text-left">每度電分潤 (元)</span>
                                                <input type="number" id="rentTierAboveValueKwh" class="input-field" value="1.2" step="0.1">
                                            </div>
                                            <div id="rentTierAboveRevenue" class="hidden-section grid grid-cols-2 items-center gap-4">
                                                <span class="label-text text-sm text-left">營收分潤 (%)</span>
                                                <input type="number" id="rentTierAboveValueRevenue" class="input-field" value="12" step="1">
                                            </div>
                                        </div>
                                        <div class="p-3 border border-gray-200 rounded-lg space-y-2">
                                            <span class="label-text text-sm text-red-600 block text-left">▼ 當月總度數 &lt;= 門檻</span>
                                            <div id="rentTierBelowKwh" class="grid grid-cols-2 items-center gap-4">
                                                <span class="label-text text-sm text-left">每度電分潤 (元)</span>
                                                <input type="number" id="rentTierBelowValueKwh" class="input-field" value="0.8" step="0.1">
                                            </div>
                                            <div id="rentTierBelowRevenue" class="hidden-section grid grid-cols-2 items-center gap-4">
                                                <span class="label-text text-sm text-left">營收分潤 (%)</span>
                                                <input type="number" id="rentTierBelowValueRevenue" class="input-field" value="8" step="1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card bg-white">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">維運代管方式</h2>
                    <div class="input-section bg-pink-50 space-y-4">
                        <div>
                            <span class="label-text mb-3 block">維運代管方式</span>
                            <div class="flex flex-wrap gap-3 mb-3">
                                <label class="choice-label"><input type="checkbox" id="profitShareByAmount"><span>依度電(元)</span></label>
                                <label class="choice-label"><input type="checkbox" id="profitShareByPercentage"><span>依營收(%)</span></label>
                                <label class="choice-label"><input type="checkbox" id="profitShareBySite"><span>站點計費</span></label>
                                <label class="choice-label"><input type="checkbox" id="profitShareNone" checked><span>無</span></label>
                            </div>
                            <div class="space-y-3">
                                <div id="profitShareByAmountSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                                    <span class="label-text text-left">每度電分潤 (元)</span><input type="number" id="profitShareAmount" class="input-field center-text-input" value="1" step="0.1">
                                </div>
                                <div id="profitShareByPercentageSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                                    <span class="label-text text-left">營收分潤 (%)</span><input type="number" id="profitSharePercentage" class="input-field center-text-input" value="10" step="1">
                                </div>
                                <div id="profitShareBySiteSection" class="hidden-section space-y-3">
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">每站收費(月)</span><input type="number" id="siteFeeMonthly" class="input-field center-text-input" value="3000">
                                    </div>
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">槍數基準</span><input type="number" id="gunCountThreshold" class="input-field center-text-input" value="5">
                                    </div>
                                    <div class="grid grid-cols-2 items-center gap-4">
                                        <span class="label-text text-left">每槍計費(月)</span><input type="number" id="siteFeePerGunMonthly" class="input-field center-text-input" value="600">
                                    </div>
                                    <div id="siteFeeValidationMessage" class="text-xs text-red-600 mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 grid grid-cols-1 gap-6 auto-rows-min">
                <div id="summaryCardContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 grid-auto-rows-fr">
                    <div class="summary-card"><div class="summary-label">總投資額</div><div id="totalInvestment" class="summary-value"></div></div>
                    <div class="summary-card"><div class="summary-label">營運年期</div><div id="operationPeriodSummary" class="summary-value"></div></div>
                    <div class="summary-card"><div class="summary-label">預計回收年限</div><div id="paybackPeriod" class="summary-value"></div></div>
                    
                    <div class="summary-card"><div class="summary-label">總營收(營運期)</div><div id="totalRevenueSummary" class="summary-value"></div></div>
                    <div class="summary-card"><div class="summary-label">總成本(營運期)</div><div id="totalCostSummary" class="summary-value"></div></div>
                    <div class="summary-card"><div class="summary-label">總淨利(營運期)</div><div id="totalNetProfitSummary" class="summary-value"></div></div>
                    
                    <div class="summary-card"><div class="summary-label">本金 / 自有資金</div><div id="equitySummary" class="summary-value"></div></div>
                    <div class="summary-card"><div class="summary-label">融資總利息</div><div id="totalInterestSummary" class="summary-value"></div></div>
                    <div class="summary-card"><div class="summary-label">IRR (內部報酬率)</div><div id="irrSummary" class="summary-value"></div></div>
                    
                    <div class="summary-card"><div class="summary-label">專案總報酬率 (ROI)</div><div id="roiSummary" class="summary-value"></div></div>
                </div>
                <div id="print-charts-grid" class="grid grid-cols-1 gap-6">
                    <div class="card bg-sky-50 fixed-height">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-2">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800">累積損益趨勢</h2>
                            <span class="text-sm font-medium text-gray-500 mt-1 sm:mt-0">單位：元</span>
                        </div>
                        <div id="cumulativePnlChartLegend" class="flex flex-wrap gap-x-4 gap-y-1 justify-center mb-3"></div>
                        <div class="flex-grow h-80"><canvas id="cumulativePnlChart"></canvas></div>
                    </div>
                    <div class="card bg-sky-50 fixed-height">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-2">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800">營收、成本、淨利(年)</h2>
                            <span class="text-sm font-medium text-gray-500 mt-1 sm:mt-0">單位：元</span>
                        </div>
                        <div id="revenueCostChartLegend" class="flex flex-wrap gap-x-4 gap-y-1 justify-center mb-3"></div>
                        <div class="flex-grow h-80"><canvas id="revenueCostChart"></canvas></div>
                    </div>
                     <div class="card bg-sky-50 fixed-height">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-2">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800">租金&分潤</h2>
                            <span class="text-sm font-medium text-gray-500 mt-1 sm:mt-0">單位：元</span>
                        </div>
                        <div id="rentChartLegend" class="flex flex-wrap gap-x-4 gap-y-1 justify-center mb-3"></div>
                        <div class="flex-grow h-80"><canvas id="rentChart"></canvas></div>
                    </div>
                     <div class="card bg-sky-50 fixed-height">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-2">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800">維運代管圖表</h2>
                            <span class="text-sm font-medium text-gray-500 mt-1 sm:mt-0">單位：元</span>
                        </div>
                        <div id="managementChartLegend" class="flex flex-wrap gap-x-4 gap-y-1 justify-center mb-3"></div>
                        <div class="flex-grow h-80"><canvas id="managementChart"></canvas></div>
                    </div>
                    <!-- REMOVED CHART: Total Cost Structure -->
                </div>
            </div>
        </div>

        <div class="mt-8 space-y-8">
            <div class="card bg-gradient-to-br from-blue-50 to-blue-100">
                <div class="flex justify-between items-center" id="toggleKwhTableBtn"> <!-- REMOVED cursor-pointer -->
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">預估充電度數</h2>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium text-gray-500">單位：kWh</span>
                        <!-- REMOVED Button/Icon -->
                    </div>
                </div>
                <div id="kwhTableContainer" class=""> <!-- REMOVED classes and inline style -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200 mt-5">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header"><tr><th class="table-cell text-left">年度</th><th class="table-cell">充電度數/日 (平均)</th><th class="table-cell">充電度數/月 (平均)</th><th class="table-cell">充電度數/年</th></tr></thead>
                            <tbody id="kwhStatsTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-red-50 to-red-100">
                <div class="flex justify-between items-center mb-5"><h2 class="text-xl md:text-2xl font-bold text-gray-800">充電收支/年</h2><span class="text-sm font-medium text-gray-500">單位：元</span></div>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header"><tr><th class="table-cell text-left">年度</th><th class="table-cell">總營收</th><th class="table-cell">總成本</th><th class="table-cell">充電淨利</th><th class="table-cell">累積稅前淨利</th></tr></thead>
                        <tbody id="pnlTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <div class="mt-8 pt-5 border-t border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-3">計算方式說明</h3>
                            <ul id="explanationList" class="text-gray-700 space-y-2">
                                <li data-target="investment"><strong>總投資額：</strong><span id="explainerTotalInvestment" class="font-semibold text-blue-700"></span><span class="text-gray-500 text-sm ml-2">{建置充電站所需的所有初期花費。}</span></li>
                                <li id="explainerEquityItem" class="hidden-section" data-target="equity"><strong>本金：</strong><span id="explainerEquity" class="font-semibold text-gray-700"></span><span class="text-gray-500 text-sm ml-2">{自有資金投入金額。}</span></li>
                                <li id="explainerLoanItem" class="hidden-section" data-target="loan"><strong>融資：</strong><span id="explainerLoan" class="font-semibold text-gray-700"></span><span class="text-gray-500 text-sm ml-2">{貸款金額。}</span></li>
                                <li id="explainerTotalInterestItem" class="hidden-section" data-target="interest"><strong>利息總額：</strong><span id="explainerTotalInterest" class="font-semibold text-red-700"></span><span class="text-gray-500 text-sm ml-2">{貸款期間需支付的總利息。}</span></li>
                                <li data-target="revenue"><strong>總營收：</strong><span id="explainerTotalRevenue" class="font-semibold text-green-700"></span><span class="text-gray-500 text-sm ml-2">{營運期間的總收入。}</span></li>
                                <li data-target="cost"><strong>總成本：</strong><span id="explainerTotalCost" class="font-semibold text-red-700"></span><span class="text-gray-500 text-sm ml-2">{營運期間的所有開銷。}</span></li>
                                <li id="explainerTotalManagementCostItem" data-target="management"><strong>維運代管總成本：</strong><span id="explainerTotalManagementCost" class="font-semibold text-purple-700"></span><span class="text-gray-500 text-sm ml-2">{營運期間的維運代管總開銷。}</span></li>
                                <li data-target="payback"><strong>預計回收年限：</strong><span id="explainerPaybackPeriod" class="font-semibold text-gray-700"></span><span class="text-gray-500 text-sm ml-2">{含建置期，從專案啟動到回本的總時間。}</span></li>
                            </ul>
                        </div>
                        <div class="text-right mt-2 flex justify-end gap-2">
                            <button id="openSensitivityModalBtn" class="text-sm bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition-all duration-200 ease-in-out shadow-md hover:shadow-md no-print">📊 敏感性分析</button>
                            <button id="openAdvancedModalBtn" class="text-sm bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition-all duration-200 ease-in-out shadow-md hover:shadow-md">⚙️ 進階設定</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="advancedModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">進階設定</h3><button class="modal-close-btn">&times;</button></div>
            <div id="advancedContentSection" class="block">
                <div class="modal-tabs">
                    <button class="modal-tab-btn active" data-tab="specs">設備規格</button>
                    <button class="modal-tab-btn" data-tab="investment">建置成本</button>
                    <button class="modal-tab-btn" data-tab="annual_costs">年度成本</button>
                    <button class="modal-tab-btn" data-tab="tou">尖離峰時段</button>
                </div>
                <div id="tab-specs" class="modal-tab-content active">
                    <div class="flex justify-between items-center mb-4"><h4 class="text-xl font-bold text-gray-800">設備價格設定</h4><span class="text-sm font-medium text-gray-500">單位：元</span></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border-collapse">
                            <thead class="table-header"><tr><th class="p-2 text-left w-[20%]">規格名稱</th><th class="p-2 text-left w-[15%]">組件</th><th class="p-2 text-right w-[16%]">設備成本(未稅)</th><th class="p-2 text-right w-[16%]">設備成本 (含稅)</th><th class="p-2 text-right w-[16%]">設定殘值%</th><th class="p-2 text-right w-[17%]">預估殘值</th></tr></thead>
                            <tbody id="specsModalTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 text-left text-sm text-gray-500">
                        <p><strong>說明：</strong>180kW 跟 360kW 比較：</p>
                        <ul class="list-disc list-inside ml-4"><li>當設置小於等於3樁(6車格)時, 180kW較划算。</li><li>若超過3樁時則 360kW較划算。</li></ul>
                    </div>
                </div>
                <div id="tab-investment" class="modal-tab-content"><h4 class="text-xl font-bold text-gray-800 mb-4">建置成本參數</h4><div id="investmentFormulaContainer" class="space-y-3"></div></div>
                <div id="tab-annual_costs" class="modal-tab-content"><h4 class="text-xl font-bold text-gray-800 mb-4">年度成本參數</h4><div id="annualFormulaContainer" class="space-y-3"></div></div>
                <div id="tab-tou" class="modal-tab-content">
                    <div id="touGridEditor">
                        <div class="tou-controls flex-col items-start">
                            <div class="flex flex-wrap gap-4">
                                <input type="radio" name="touRateType" value="peak" id="tou-type-peak" checked>
                                <label for="tou-type-peak" class="tou-rate-type-label peak">尖峰 <span id="peakPercentDisplay" class="font-normal opacity-75"></span></label>
                                <input type="radio" name="touRateType" value="offpeak" id="tou-type-offpeak">
                                <label for="tou-type-offpeak" class="tou-rate-type-label offpeak">離峰 <span id="offpeakPercentDisplay" class="font-normal opacity-75"></span></label>
                                <input type="radio" name="touRateType" value="holiday" id="tou-type-holiday">
                                <label for="tou-type-holiday" class="tou-rate-type-label holiday">假日 <span id="holidayPercentDisplay" class="font-normal opacity-75"></span></label>
                            </div>
                            <span class="text-sm text-gray-500 w-full text-left mt-2">點選費率後，在下方格子上塗抹</span>
                        </div>
                        <div class="overflow-x-auto"><div id="touGridContainer"></div></div>
                    </div>
                    <div id="touEditorMessage" class="modal-message mt-2"></div>
                </div>
                <div id="tab-password" class="modal-tab-content">
                    <!-- This content is now hidden as the tab is removed -->
                </div>
                <div class="mt-8 text-right"><button id="saveAdvancedBtn" class="modal-action-button">儲存設定並關閉</button></div>
            </div>
        </div>
    </div>
    <div id="explanationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="explanationModalTitle" class="modal-title">計算方式說明</h3><button class="modal-close-btn">&times;</button></div>
            <div id="explanationModalBody" class="mt-4 text-gray-700"></div>
        </div>
    </div>
    <div id="saveRecordModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <div class="modal-header"><h3 class="modal-title">儲存分析</h3><button class="modal-close-btn">&times;</button></div>
            <p class="text-gray-600 mb-4">請輸入此分析表的站點名稱。</p>
            <input type="text" id="recordNameInput" class="input-field w-full text-left" placeholder="例如：總部B1停車場 - 方案A">
            <div id="saveRecordMessage" class="modal-message"></div>
            <div class="mt-6 flex justify-end gap-3">
                   <button id="cancelSaveBtn" class="header-actions">取消</button>
                <button id="confirmSaveBtn" class="modal-action-button">確認儲存</button>
            </div>
        </div>
    </div>
    <div id="recordsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">已儲存的紀錄</h3><button class="modal-close-btn">&times;</button></div>
            <div id="recordsList" class="space-y-2"></div>
        </div>
    </div>
    <div id="newAnalysisConfirmModal" class="modal-overlay">
        <div class="modal-content max-w-sm text-center">
            <h3 class="modal-title mb-4">確認重置</h3>
            <p class="text-gray-600 mb-6">您確定要清空目前的分析表並開始一個新的分析嗎？所有未儲存的變更將會遺失。</p>
            <div class="flex justify-center gap-4">
                <button id="cancelNewAnalysisBtn" class="header-actions">取消</button>
                <button id="confirmNewAnalysisBtn" class="modal-action-button bg-red-600 hover:bg-red-700">確認重置</button>
            </div>
        </div>
    </div>
    
    <div id="sensitivityModal" class="modal-overlay">
        <div class="modal-content max-w-3xl"> <!-- Wider modal -->
            <div class="modal-header">
                <h3 class="modal-title">敏感性分析</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <div>
                    <label for="targetVariable" class="label-text mb-2 block">分析目標 (Y 軸)</label>
                    <select id="targetVariable" class="input-field w-full text-center">
                        <option value="paybackPeriod">預計回收年限 (年)</option>
                        <option value="roi">專案總報酬率 (ROI %)</option>
                        <option value="irr">IRR (內部報酬率 %)</option>
                        <option value="totalNetProfitSummary">總淨利 (元)</option>
                    </select>
                </div>
                <div>
                    <label for="analysisVariable" class="label-text mb-2 block">分析變因 (X 軸)</label>
                    <select id="analysisVariable" class="input-field w-full text-center">
                        <option value="totalKwh">總充電度數/月(平均)</option>
                        <option value="taipowerFee">台電平均電費 (元)</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="runSensitivityAnalysis" class="modal-action-button" style="display: none;">執行分析</button>
            </div>
            <div id="sensitivityTableContainer" class="mt-6">
                <!-- Results will be injected here -->
            </div>
            <div id="sensitivityChartContainer" class="mt-6 h-72">
                <canvas id="sensitivityChart"></canvas>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    (function() {

        const steps = [0.8, 0.9, 1.0, 1.1, 1.2]; // -20%, -10%, Base, +10%, +20%

        /**
         * =================================================================
         * APP MODULE: Main Controller
         * =================================================================
         */
        const App = {
            init() {
                UI.init();
                Persistence.init();
                
                // Initialize Sortable.js for summary cards
                if (UI.elements.summaryCardContainer) {
                    new Sortable(UI.elements.summaryCardContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost', // Class for the drop placeholder
                    });
                }

                this.setupEventListeners();
                this.update();

                // --- REMOVED setTimeout FIX ---
            },

            setupEventListeners() {
                // Listen for any change on inputs/selects/checkboxes to trigger an update
                document.querySelector('.lg\\:col-span-1').addEventListener('input', () => this.update());
                document.querySelector('.lg\\:col-span-1').addEventListener('change', () => this.update());
                
                UI.elements.interestRate.addEventListener('blur', (e) => {
                    const value = UI.getNumericValue(e.target, 3.5);
                    e.target.value = value.toFixed(2);
                });

                // Specific button clicks
                // UI.elements.toggleKwhTableBtn.addEventListener('click', UI.toggleKwhTable); // REMOVED
                UI.elements.pnlTableBody.addEventListener('click', (e) => { const row = e.target.closest('.pnl-row'); if (row) UI.togglePnlDetails(row, Calculator.getLastResults()); });
                UI.elements.kwhStatsTableBody.addEventListener('click', (e) => { const row = e.target.closest('.kwh-row'); if (row) UI.toggleKwhDetails(row, Calculator.getLastResults()); });
                UI.elements.explanationList.addEventListener('click', (e) => this.handleExplanationClick(e));
                
                // Header & Modal Actions
                UI.elements.saveBtn.addEventListener('click', () => UI.openModal(UI.elements.saveRecordModal));
                UI.elements.recordsBtn.addEventListener('click', () => { UI.renderRecordsList(); UI.openModal(UI.elements.recordsModal); });
                UI.elements.newAnalysisBtn.addEventListener('click', () => UI.openModal(UI.elements.newAnalysisConfirmModal));
                UI.elements.exportPdfBtn.addEventListener('click', () => window.print());
                UI.elements.openAdvancedModalBtn.addEventListener('click', () => {
                    UI.populateSpecsModal(Config.deviceSpecs, Config.calculationParams);
                    UI.populateFormulasModal(Config.calculationParams);
                    TouEditor.init();
                    UI.openModal(UI.elements.advancedModal);
                });
                UI.elements.saveAdvancedBtn.addEventListener('click', () => this.saveAdvancedSettings());
                
                // ADDED: Sensitivity Modal Listeners
                UI.elements.openSensitivityModalBtn.addEventListener('click', () => {
                    UI.openModal(UI.elements.sensitivityModal);
                    this.runSensitivityAnalysis(); // Run analysis on open
                });
                UI.elements.targetVariable.addEventListener('change', () => this.runSensitivityAnalysis());
                UI.elements.analysisVariable.addEventListener('change', () => this.runSensitivityAnalysis());

                UI.elements.confirmSaveBtn.addEventListener('click', () => this.saveRecord());
                UI.elements.confirmNewAnalysisBtn.addEventListener('click', () => this.newAnalysis());

                // Add Enter key listener for password change (if elements exist, though tab is hidden)
                [UI.elements.oldPassword, UI.elements.newPassword, UI.elements.confirmNewPassword].forEach(el => {
                    if (el) { // Check if element exists
                        el.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                if(UI.elements.changePasswordBtn) UI.elements.changePasswordBtn.click(); // Check if button exists
                                e.target.blur();
                            }
                        });
                    }
                });
                if (UI.elements.changePasswordBtn) { // Check if button exists
                     UI.elements.changePasswordBtn.addEventListener('click', () => this.changePassword());
                }


                // Universal modal close buttons
                document.querySelectorAll('.modal-close-btn, #cancelSaveBtn, #cancelNewAnalysisBtn').forEach(btn => {
                    btn.addEventListener('click', () => UI.closeModal(btn.closest('.modal-overlay')));
                });
                document.querySelectorAll('.modal-overlay:not(#advancedModal)').forEach(modal => {
                    modal.addEventListener('click', (e) => { if (e.target === modal) UI.closeModal(modal); });
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal-overlay').forEach(modal => {
                            if (modal.style.display === 'flex') UI.closeModal(modal);
                        });
                    }
                });
                
                // Handle chart animations for printing
                window.addEventListener('beforeprint', () => {
                    Object.values(Charts.instances).forEach(chart => {
                        chart.options.animation = false;
                        chart.resize();
                    });
                });

                window.addEventListener('afterprint', () => {
                    Object.values(Charts.instances).forEach(chart => {
                        chart.options.animation = {};
                        chart.resize();
                    });
                });

                // Special input formatting and constraints
                ['infrastructureCostMain', 'rentPerSpace', 'rentPerLand', 'kwhPerGunPerMonthDC', 'rentKwhThreshold'].forEach(id => {
                    UI.elements[id]?.addEventListener('blur', (e) => UI.formatNumericInput(e.target)); // CHANGED 'input' to 'blur'
                });
                const enforceMax = (el, max) => { if (UI.getNumericValue(el, 0) > max) el.value = max; };
                UI.elements.carsPerGunPerDayAC.addEventListener('input', () => enforceMax(UI.elements.carsPerGunPerDayAC, 2));
                UI.elements.kwhPerGunPerMonthAC.addEventListener('input', () => enforceMax(UI.elements.kwhPerGunPerMonthAC, 1800));
            },

            update() {
                UI.updateUIVisibility();
                let inputs = UI.getInputs();
                UI.updateLinkedInputs(inputs);
                
                inputs = UI.getInputs(); // Re-fetch inputs after linking
                const results = Calculator.run(inputs, Config.calculationParams, Config.deviceSpecs);
                UI.updateDisplay(inputs, results);
                Charts.update(inputs, results);
                Persistence.saveSession();
            },
            
            handleAdvancedLogin() {
                // No password logic, directly show content
                UI.showAdvancedContent(true);
                UI.populateSpecsModal(Config.deviceSpecs, Config.calculationParams);
                UI.populateFormulasModal(Config.calculationParams);
                TouEditor.init();
            },

            saveAdvancedSettings(closeModal = true) {
                TouEditor.saveAndApply();
                document.querySelectorAll('#specsModalTableBody input.cost-input, #specsModalTableBody input.salvage-percent-input').forEach(input => {
                    const row = input.closest('tr');
                    const costInput = row.querySelector('.cost-input');
                    const percentInput = row.querySelector('.salvage-percent-input');
                    
                    const { power, type } = costInput.dataset;
                    const spec = Config.deviceSpecs[power];
                    
                    if (type === 'cost' && spec) {
                        spec.cost = UI.getNumericValue(costInput, 0);
                    } else if (type === 'cabinetCost' && spec) {
                        spec.cabinetCost = UI.getNumericValue(costInput, 0);
                    } else if (type === 'terminalCost' && spec) {
                        spec.terminalCost = UI.getNumericValue(costInput, 0);
                    }

                    const cost = (type === 'cabinetCost') ? spec.cabinetCost : (type === 'terminalCost') ? spec.terminalCost : spec.cost;
                    const percent = UI.getNumericValue(percentInput, 10);
                    const newSalvage = Math.round((cost * percent) / 100);
                    
                    if (type === 'cost' && spec) {
                        spec.salvage = newSalvage;
                    } else if (type === 'cabinetCost' && spec) {
                        spec.cabinetSalvage = newSalvage;
                    } else if (type === 'terminalCost' && spec) {
                        spec.terminalSalvage = newSalvage;
                    }
                });

                document.querySelectorAll('#investmentFormulaContainer input, #annualFormulaContainer input').forEach(input => {
                    const { key } = input.dataset;
                    const param = Config.calculationParams[key];
                    if (!param) return;
                    if (input.type === 'checkbox') {
                        param.enabled = input.checked;
                    } else if (input.type === 'text' && !param.readonly) {
                        const numVal = UI.getNumericValue(input, 0);
                        param.value = param.unit === '%' ? numVal / 100 : numVal;
                    }
                });
                this.update();
                if (closeModal) {
                    UI.closeModal(UI.elements.advancedModal);
                }
            },

            handleAdvancedEnterSave() {
                this.saveAdvancedSettings(false); // Pass false to not close the modal
                const btn = UI.elements.saveAdvancedBtn;
                const originalText = btn.textContent;
                const originalClasses = btn.className;

                btn.textContent = '已儲存 ✓';
                btn.className = 'modal-action-button bg-green-600';
                btn.disabled = true;

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.className = originalClasses;
                    btn.disabled = false;
                }, 1500);
            },
            
            changePassword() {
                // This function is no longer used but kept to prevent errors if called
                if (UI.elements.passwordChangeMessage) {
                     UI.showModalMessage(UI.elements.passwordChangeMessage, '密碼功能已移除。');
                }
            },

            handleExplanationClick(e) {
                const targetLi = e.target.closest('li[data-target]');
                if (targetLi) {
                    UI.openExplanationModal(targetLi.dataset.target, Calculator.getLastResults(), UI.getInputs());
                }
            },

            saveRecord() {
                const name = UI.elements.recordNameInput.value.trim();
                if (!name) {
                    UI.showModalMessage(UI.elements.saveRecordMessage, '站點名稱不能為空。');
                    return;
                }
                const allData = Persistence.getCurrentState();
                allData.siteName = name;
                Persistence.saveRecord(name, allData);
                UI.elements.siteNameDisplay.textContent = name;
                UI.closeModal(UI.elements.saveRecordModal);
                UI.elements.recordNameInput.value = '';
            },

            newAnalysis() {
                Persistence.deleteSession();
                UI.resetForm();
                this.update();
                UI.closeModal(UI.elements.newAnalysisConfirmModal);
            },

            runSensitivityAnalysis() {
                UI.updateSensitivityOptions();
                
                const targetVar = UI.elements.targetVariable.value;
                const analysisVar = UI.elements.analysisVariable.value;
                
                const baseInputs = UI.getInputs();
                const labels = ["-20%", "-10%", "基準", "+10%", "+20%"];
                
                const results = [];
                let baseValue = 0; 

                // Determine base value and key to modify
                let isPercentage = false;
                let isParam = false;
                
                if (analysisVar === 'taipowerFee') {
                    baseValue = Config.calculationParams.taipowerFee.value;
                    isParam = true;
                } else if (analysisVar === 'totalKwh') {
                    // This is the new logic. 'baseValue' isn't a single number.
                    // We'll use 1.0 as the base for 'step' calculation, and handle labels specially.
                    baseValue = 1.0; 
                } else {
                    // Fallback for any other variable (though none are left)
                    baseValue = baseInputs[analysisVar];
                }

                steps.forEach(step => {
                    // Deep copy base inputs
                    const modifiedInputs = JSON.parse(JSON.stringify(baseInputs));
                    
                    // Modify the single variable
                    if (isParam) {
                        // Modify Taipower Fee
                        const originalParamValue = Config.calculationParams[analysisVar].value;
                        Config.calculationParams[analysisVar].value = baseValue * step;
                        
                        const res = Calculator.run(modifiedInputs, Config.calculationParams, Config.deviceSpecs);
                        
                        // Restore original param value
                        Config.calculationParams[analysisVar].value = originalParamValue;
                        results.push(res);

                    } else if (analysisVar === 'totalKwh') {
                        // NEW LOGIC for totalKwh
                        // We must force 'byKwh' mode for this analysis to make sense
                        modifiedInputs.revenueMethodAC = 'byKwh';
                        modifiedInputs.revenueMethodDC = 'byKwh';
                        
                        // Scale the kWh values
                        modifiedInputs.kwhPerGunPerMonthAC *= step;
                        modifiedInputs.kwhPerGunPerMonthDC *= step;

                        // CRITICAL: Update the linked 'carsPer...' inputs based on new kWh
                        UI.updateLinkedInputs(modifiedInputs); 

                        const res = Calculator.run(modifiedInputs, Config.calculationParams, Config.deviceSpecs);
                        results.push(res);
                        
                    } else {
                        // This block is now for legacy/other variables (none left, but good to keep)
                        modifiedInputs[analysisVar] = baseValue * step;
                        UI.updateLinkedInputs(modifiedInputs);
                        const res = Calculator.run(modifiedInputs, Config.calculationParams, Config.deviceSpecs);
                        results.push(res);
                    }
                });

                UI.renderSensitivityTable(targetVar, analysisVar, labels, results, baseValue, isPercentage, isParam);
                
                const targetText = UI.elements.targetVariable.querySelector(`option[value="${targetVar}"]`).textContent;
                const analysisText = UI.elements.analysisVariable.querySelector(`option[value="${analysisVar}"]`).textContent;
                
                // Prepare data for the chart
                const chartData = results.map(res => {
                    switch(targetVar) {
                        case 'paybackPeriod':
                            // Use null for 'N/A' to create gaps in line
                            if (res.paybackPeriod === 'N/A') {
                                // Plot "N/A" as a value slightly worse than the max operation years
                                return -(baseInputs.operationYears + 1); 
                            }
                            const payback = parseFloat(res.paybackPeriod.replace(' 年', ''));
                            return isNaN(payback) ? null : -payback; // INVERT THE VALUE
                        case 'roi':
                            return isNaN(res.roi) ? null : res.roi;
                        case 'irr':
                            return isNaN(res.irr) ? null : res.irr;
                        case 'totalNetProfitSummary':
                            return res.totalNetProfit;
                        default:
                            return null;
                    }
                });

                const chartXLabels_Percent = labels; // ["-20%", "-10%", "基準", "+10%", "+20%"]
                
                // Recalculate baseValue for 'totalKwh' for labeling
                let labelBaseValue;
                if(analysisVar === 'totalKwh') {
                    // Calculate total base kWh/month for labeling
                    const acGuns = baseInputs.equipmentList.reduce((sum, e) => e.spec.type === 'AC' ? sum + e.gunCount : sum, 0);
                    const dcGuns = baseInputs.equipmentList.reduce((sum, e) => e.spec.type !== 'AC' ? sum + e.gunCount : sum, 0);
                    labelBaseValue = (baseInputs.kwhPerGunPerMonthAC * acGuns) + (baseInputs.kwhPerGunPerMonthDC * dcGuns);
                } else if (isParam) {
                    labelBaseValue = Config.calculationParams[analysisVar].value;
                } else {
                    labelBaseValue = baseInputs[analysisVar];
                }

                const chartXLabels_Value = steps.map(step => {
                    let val = (analysisVar === 'totalKwh') ? labelBaseValue * step : baseValue * step;
                    
                    if (isPercentage) {
                        return `${val.toFixed(1)}%`;
                    } else if (isParam) {
                        return `${UI.formatCurrency(val, 2, false, true)}`;
                    } else if (analysisVar === 'totalKwh') {
                        return `${UI.formatCurrency(val, 0, false, true)} kWh/月`;
                    } else {
                         return `${val.toLocaleString('en-US', {maximumFractionDigits: 1})}`;
                    }
                });

                // Store full labels for tooltip
                if (Charts.instances.sensitivity) {
                    Charts.instances.sensitivity.fullXLabels = chartXLabels_Value;
                    
                    Charts.instances.sensitivity.data = {
                        labels: chartXLabels_Percent, // Show percentages on X-axis
                        datasets: [{
                            label: targetText,
                            data: chartData,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.1,
                            spanGaps: false, // Do not connect line across 'null' (N/A) points
                        }]
                    };
                    
                    // Customize Y-axis label
                    Charts.instances.sensitivity.options.scales.y.title = {
                        display: true,
                        text: targetText
                    };
                    
                    // Customize X-axis label
                    Charts.instances.sensitivity.options.scales.x.title = {
                        display: true,
                        text: analysisText
                    };

                    Charts.instances.sensitivity.update();
                }
            }
        };

        /**
         * =================================================================
         * CONFIG MODULE: Data and Parameters
         * =================================================================
         */
        const Config = {
            passwords: { advanced: '0000' },
            deviceSpecs: {
                '7': { name: 'AC 7kW Smart', cost: 29900, power: 7, type: 'AC', salvage: 2990 },
                '30': { name: 'DC 30kW', cost: 310000, power: 30, type: 'DC', salvage: 31000 },
                '120': { name: 'DC 120kW', cost: 810000, power: 120, type: 'DC', salvage: 81000 },
                '180': { name: 'DC 180kW', cost: 950000, power: 180, type: 'DC', salvage: 95000 },
                '360': { name: 'DC 360kW', power: 360, type: 'DC_360', cabinetCost: 1500000, terminalCost: 480000, cabinetSalvage: 150000, terminalSalvage: 48000 }
            },
            touSchedule: {}, // Will be populated
            calculationParams: {
                deviceCost: { value: 0, label: '設備總成本 (未稅)', unit: '元', description: '所有充電樁的未稅總成本 (自動計算)。', enabled: true, category: 'investment', readonly: true },
                lineSubsidyPerKw: { value: 500, label: '台電線路補助費/kW', unit: '元', description: '台電線補費，每kW收取的一次性費用。', enabled: true, category: 'investment' },
                technicianFee: { value: 150000, label: '技師簽證費', unit: '元', description: '台電外包技師費用(一次性)。', enabled: true, category: 'investment' },
                distributionPanelFee: { value: 300000, label: '高/低壓配電盤', unit: '元', description: '高壓或低壓配電盤費用(一次性)。', enabled: true, category: 'investment' },
                constructionFee: { value: 500000, label: '勞務工程', unit: '元', description: '場地土木、基礎、裝修等工程費用(一次性)。', enabled: true, category: 'investment', readonly: true },
                siteLayoutFee: { value: 50000, label: '場佈費用', unit: '元', description: '場地裝潢、標線、指示牌等費用(一次性)。', enabled: true, category: 'investment' },
                equipmentServiceFeeRate: { value: 0.05, label: '設備技術服務費', unit: '%', description: '依設備未稅總成本的百分比計算。', enabled: true, category: 'investment' },
                laborCostInvestment: { value: 0.01, label: '建置人力成本', unit: '%', description: '建置所需的人力成本，為總投資額的百分比。', enabled: true, category: 'investment' },
                miscCostInvestment: { value: 0.01, label: '建置雜項成本', unit: '%', description: '建置過程中的雜項開銷，為總投資額的百分比。', enabled: true, category: 'investment' },
                contingencyInvestment: { value: 0.05, label: '建置專案裕度', unit: '%', description: '專案的風險準備金或裕度，為總投資額的百分比。', enabled: true, category: 'investment' },
                meterFeeBase: { value: 12000, label: '電錶費用(基本)', unit: '元', description: '台電電表基本費用(僅DC樁, 一次性)。', enabled: true, category: 'investment' },
                meterFeePerGun: { value: 700, label: '電錶費用/槍', unit: '元', description: '每增加一槍の電表費用(僅DC樁, 一次性)。', enabled: true, category: 'investment' },
                taxRate: { value: 0.05, label: '營業稅率', unit: '%', description: '設備購買及相關服務の營業稅率。', enabled: false, category: 'investment' },
                taipowerFee: { value: 4.2, label: '台電平均電費', unit: '元', description: '向台電購電の每度平均成本。', enabled: true, category: 'annual' },
                monthlyCapacityFee: { value: 30000, label: '每月基本電費(契約容量)', unit: '元', description: '台電收取的固定月費(DC樁適用)。', enabled: true, category: 'annual' },
                electricalTechnicianFee: { value: 20000, label: '高壓用電技術人員/年', unit: '元', description: '每年收取一次技師檢定費。', enabled: true, category: 'annual' },
                maintenanceFee: { value: 37000, label: '維運&客服/年', unit: '元', description: '年度場域維護與線上客服費用。', enabled: false, category: 'annual' },
                transactionFeeRate: { value: 0.03, label: '金流手續費', unit: '%', description: '支付給金流服務商の每筆交易手續費率。', enabled: true, category: 'annual' },
                insuranceFee: { value: 8500, label: '意外保險費/年', unit: '元', description: '場域年度意外險費用。', enabled: true, category: 'annual' },
                electronicInvoiceFeePerTransaction: { value: 1.5, label: '電子發票/張', unit: '元', description: '每筆交易の電子發票成本。', enabled: true, category: 'annual' },
                repairPartsRate: { value: 0.01, label: '設備維護備品', unit: '%', description: '年度維修備品費用，為設備未稅總成本の百分比。', enabled: true, category: 'annual' },
                extendedWarrantyPerPile: { value: 0.02, label: '保固延保', unit: '%', description: '年度延長保固費用，為設備未稅總成本の百分比。', enabled: true, category: 'annual' },
                extendedWarrantyStartYear: { value: 2, label: '保固起始年', unit: '年', description: '延長保固費用從第幾年開始計算。', enabled: true, category: 'annual' },
                laborCost: { value: 60000, label: '勞務成本/年', unit: '元', description: '年度人力、巡檢等相關勞務成本。', enabled: false, category: 'annual' },
                internetFee: { value: 500, label: '網路費/月', unit: '元', description: '場域每月の網路通訊費用。', enabled: true, category: 'annual' },
                tdxUploadFee: { value: 299, label: 'TDX上傳費(槍/月)', unit: '元', description: '每支槍每月上傳資料至交通部TDX平台の費用。', enabled: false, category: 'annual' },
                powerLossRate: { value: 0.10, label: '充電電損率', unit: '%', description: '電力在傳輸和轉換過程中の損耗率。', enabled: true, category: 'annual' },
            }
        };

        /**
         * =================================================================
         * UI MODULE: DOM Manipulation and User Interface
         * =================================================================
         */
        const UI = {
            elements: {},
            init() {
                // Auto-cache all elements with an ID
                document.querySelectorAll('[id]').forEach(el => this.elements[el.id] = el);
                
                // --- REMOVED init FIX ---

                this.updateUIVisibility();
                this.elements.addEquipmentBtn.addEventListener('click', () => { this.addEquipmentRow(); App.update(); });
                document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.addEventListener('click', this.handleTabSwitch));
                
                // Management checkboxes logic
                const managementCheckboxes = [this.elements.profitShareByAmount, this.elements.profitShareByPercentage, this.elements.profitShareBySite];
                const noneCheckbox = this.elements.profitShareNone;

                managementCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            noneCheckbox.checked = false;
                        } else if (!managementCheckboxes.some(cb => cb.checked)) {
                            noneCheckbox.checked = true;
                        }
                        App.update();
                    });
                });

                noneCheckbox.addEventListener('change', () => {
                    if (noneCheckbox.checked) {
                        managementCheckboxes.forEach(cb => cb.checked = false);
                    } else if (!managementCheckboxes.some(cb => cb.checked)) {
                        noneCheckbox.checked = true;
                    }
                    App.update();
                });
            },
            getNumericValue(element, defaultValue = 0) {
                if (!element) return defaultValue;
                const value = parseFloat(String(element.value).replace(/,/g, ''));
                return isNaN(value) ? defaultValue : value;
            },
            formatCurrency(value, precision = 0, shorthand = false, unitOnly = false) {
                if (isNaN(value) || value === null) return 'N/A';
                const num = Number(value);
                if (shorthand && !unitOnly) {
                    if (Math.abs(num) >= 1e6) return `NT$ ${(num / 1e6).toFixed(1)}M`;
                    if (Math.abs(num) >= 1e3) return `NT$ ${(num / 1e3).toFixed(0)}K`;
                }
                const numberString = num.toLocaleString('en-US', { minimumFractionDigits: precision, maximumFractionDigits: precision });
                return unitOnly ? numberString : `NT$ ${numberString}`;
            },
            formatNumericInput(element) {
                const value = this.getNumericValue(element, null);
                element.value = (value !== null) ? value.toLocaleString('en-US') : '';
            },
            getInputs() {
                const getCheckedValue = (name) => document.querySelector(`input[name="${name}"]:checked`).value;
                const equipmentList = Array.from(document.querySelectorAll('.equipment-row-wrapper')).map(wrapper => {
                    const powerSelect = wrapper.querySelector('.device-power-select');
                    const countInput = wrapper.querySelector('.equipment-count');
                    const power = powerSelect.value;
                    const spec = Config.deviceSpecs[power];
                    const count = this.getNumericValue(countInput, 1);
                    const pileCount = count;
                    const gunCount = ((spec.type === 'DC' || spec.type === 'DC_360') && spec.power > 30) ? pileCount * 2 : pileCount;
                    const cabinetCount = (spec.type === 'DC_360') ? Math.ceil(pileCount / 6) : 0;
                    return { power, spec, count, pileCount, gunCount, parkingSpaces: gunCount, cabinetCount };
                });

                const financingEnabled = this.elements.financingToggle.checked;
                const profitShareMethods = {
                    byAmount: this.elements.profitShareByAmount.checked,
                    byPercentage: this.elements.profitShareByPercentage.checked,
                    bySite: this.elements.profitShareBySite.checked,
                    none: this.elements.profitShareNone.checked,
                };

                return {
                    equipmentList,
                    chargeFeePerKwhAC: this.getNumericValue(this.elements.chargeFeePerKwhAC),
                    billingMethodDC: getCheckedValue('billingMethodDC'),
                    chargeFeePerKwhDC: this.getNumericValue(this.elements.chargeFeePerKwhDC),
                    peakRate: this.getNumericValue(this.elements.peakRate),
                    offPeakRate: this.getNumericValue(this.elements.offPeakRate),
                    holidayRate: this.getNumericValue(this.elements.holidayRate),
                    revenueMethodDC: getCheckedValue('revenueMethodDC'),
                    carsPerGunPerDayDC: this.getNumericValue(this.elements.carsPerGunPerDayDC),
                    kwhPerGunPerMonthDC: this.getNumericValue(this.elements.kwhPerGunPerMonthDC),
                    revenueMethodAC: getCheckedValue('revenueMethodAC'),
                    carsPerGunPerDayAC: this.getNumericValue(this.elements.carsPerGunPerDayAC),
                    kwhPerGunPerMonthAC: this.getNumericValue(this.elements.kwhPerGunPerMonthAC),
                    avgKwhPerCar: this.getNumericValue(this.elements.avgKwhPerCar),
                    demandGrowthRate: this.getNumericValue(this.elements.demandGrowthRate) / 100,
                    operationYears: this.getNumericValue(this.elements.operationYears, 1),
                    constructionPeriod: this.getNumericValue(this.elements.constructionPeriod, 6),
                    depreciationYears: this.getNumericValue(this.elements.depreciationYears, 1),
                    depreciationMethod: getCheckedValue('depreciationMethod'),
                    infrastructureCostMain: this.getNumericValue(this.elements.infrastructureCostMain),
                    rentMethod: getCheckedValue('rentMethod'),
                    rentPerSpace: this.getNumericValue(this.elements.rentPerSpace),
                    rentPerLand: this.getNumericValue(this.elements.rentPerLand),
                    rentPerKwh: this.getNumericValue(this.elements.rentPerKwh),
                    rentPercentage: this.getNumericValue(this.elements.rentPercentage) / 100,
                    rentKwhThreshold: this.getNumericValue(this.elements.rentKwhThreshold),
                    rentTierType: getCheckedValue('rentTierType'),
                    rentTierAboveValue: getCheckedValue('rentTierType') === 'byKwh' ? this.getNumericValue(this.elements.rentTierAboveValueKwh) : this.getNumericValue(this.elements.rentTierAboveValueRevenue) / 100,
                    rentTierBelowValue: getCheckedValue('rentTierType') === 'byKwh' ? this.getNumericValue(this.elements.rentTierBelowValueKwh) : this.getNumericValue(this.elements.rentTierBelowValueRevenue) / 100,
                    profitShareMethods,
                    profitShareAmount: this.getNumericValue(this.elements.profitShareAmount),
                    profitSharePercentage: this.getNumericValue(this.elements.profitSharePercentage) / 100,
                    siteFeeMonthly: this.getNumericValue(this.elements.siteFeeMonthly),
                    gunCountThreshold: this.getNumericValue(this.elements.gunCountThreshold),
                    siteFeePerGunMonthly: this.getNumericValue(this.elements.siteFeePerGunMonthly),
                    financingEnabled,
                    loanPercentage: financingEnabled ? this.getNumericValue(this.elements.loanPercentage, 0) / 100 : 0,
                    interestRate: financingEnabled ? this.getNumericValue(this.elements.interestRate, 0) / 100 : 0,
                    loanTerm: financingEnabled ? this.getNumericValue(this.elements.loanTerm, 0) : 0,
                    touRatios: {
                        peak: this.getNumericValue(this.elements.peakUsageRatio) / 100,
                        offpeak: this.getNumericValue(this.elements.offPeakUsageRatio) / 100,
                        holiday: this.getNumericValue(this.elements.holidayUsageRatio) / 100,
                    }
                };
            },
            addEquipmentRow(config = {}) {
                const container = this.elements.equipmentListContainer;
                const wrapper = document.createElement('div');
                wrapper.className = 'equipment-row-wrapper p-3 border border-gray-200 rounded-lg space-y-3';
                const powerOptions = Object.entries(Config.deviceSpecs).map(([power, spec]) => `<option value="${power}" ${config.power === power ? 'selected' : ''}>${spec.name}</option>`).join('');

                wrapper.innerHTML = `
                    <div class="equipment-row">
                        <select class="input-field device-power-select">${powerOptions}</select>
                        <div class="flex items-center">
                            <span class="count-label text-gray-600">數量</span>
                            <input type="number" class="input-field equipment-count" value="${config.count || 1}" min="1">
                        </div>
                        <button class="remove-equip-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4 cabinet-count-container" style="display: none;">
                        <span class="label-text">能源櫃數量</span>
                        <input type="number" class="input-field cabinet-count-display readonly" readonly>
                    </div>`;

                container.appendChild(wrapper);
                wrapper.querySelector('.remove-equip-btn').onclick = () => {
                    if (container.children.length > 1) {
                        wrapper.remove();
                        App.update();
                    }
                };
                this.updateEquipmentRowUI(wrapper);
            },
            updateEquipmentRowUI(wrapper) {
                const power = wrapper.querySelector('.device-power-select').value;
                const count = this.getNumericValue(wrapper.querySelector('.equipment-count'), 1);
                const spec = Config.deviceSpecs[power];
                wrapper.querySelector('.count-label').textContent = spec.type === 'DC_360' ? '終端機數' : '充電樁數';
                const cabinetRow = wrapper.querySelector('.cabinet-count-container');
                if (spec.type === 'DC_360') {
                    cabinetRow.style.display = 'grid';
                    wrapper.querySelector('.cabinet-count-display').value = Math.ceil(count / 6);
                } else {
                    cabinetRow.style.display = 'none';
                }
            },
            updateUIVisibility() {
                const inputs = this.getInputs();
                const hasAC = inputs.equipmentList.some(e => e.spec.type === 'AC');
                const hasDC = inputs.equipmentList.some(e => e.spec.type !== 'AC');
                
                const toggleSection = (el, isVisible) => el.style.display = isVisible ? (el.tagName === 'DIV' ? 'block' : 'grid') : 'none';
                
                toggleSection(this.elements.acSettingsBlock, hasAC);
                toggleSection(this.elements.dcSettingsBlock, hasDC);
                this.elements.acSettingsBlock.closest('.card').style.display = (hasAC || hasDC) ? 'flex' : 'none';
                
                toggleSection(this.elements.fixedRateSectionDC, inputs.billingMethodDC === 'fixed');
                toggleSection(this.elements.touRateSectionDC, inputs.billingMethodDC === 'tou');

                this.elements.carsPerGunPerDayDC.readOnly = inputs.revenueMethodDC === 'byKwh';
                this.elements.kwhPerGunPerMonthDC.readOnly = inputs.revenueMethodDC === 'byCars';
                this.elements.carsPerGunPerDayAC.readOnly = inputs.revenueMethodAC === 'byKwh';
                this.elements.kwhPerGunPerMonthAC.readOnly = inputs.revenueMethodAC === 'byCars';
                ['carsPerGunPerDayDC', 'kwhPerGunPerMonthDC', 'carsPerGunPerDayAC', 'kwhPerGunPerMonthAC'].forEach(id => {
                    this.elements[id].classList.toggle('readonly', this.elements[id].readOnly);
                });

                const rentVisibility = {
                    bySpace: this.elements.rentBySpaceSection,
                    byLand: this.elements.rentByLandSection,
                    byKwhShare: this.elements.rentByKwhShareSection,
                    byRevenueShare: this.elements.rentByRevenueShareSection,
                    byKwhTier: this.elements.rentByKwhTierSection,
                };
                Object.values(rentVisibility).forEach(el => el.style.display = 'none');
                if (rentVisibility[inputs.rentMethod]) rentVisibility[inputs.rentMethod].style.display = 'block';

                if (inputs.rentMethod === 'byKwhTier') {
                    toggleSection(this.elements.rentTierAboveKwh, inputs.rentTierType === 'byKwh');
                    toggleSection(this.elements.rentTierAboveRevenue, inputs.rentTierType === 'byRevenue');
                    toggleSection(this.elements.rentTierBelowKwh, inputs.rentTierType === 'byKwh');
                    toggleSection(this.elements.rentTierBelowRevenue, inputs.rentTierType === 'byRevenue');
                }

                const depYearsInput = this.elements.depreciationYears;
                depYearsInput.readOnly = inputs.depreciationMethod === 'none';
                depYearsInput.classList.toggle('readonly', depYearsInput.readOnly);
                if (depYearsInput.readOnly) depYearsInput.value = 0;
                
                toggleSection(this.elements.profitShareByAmountSection, inputs.profitShareMethods.byAmount);
                toggleSection(this.elements.profitShareByPercentageSection, inputs.profitShareMethods.byPercentage);
                toggleSection(this.elements.profitShareBySiteSection, inputs.profitShareMethods.bySite);
                toggleSection(this.elements.financingSection, inputs.financingEnabled);
                
                this.validateSiteFeeInputs();
            },
            validateSiteFeeInputs() {
                if (!this.elements.profitShareBySite.checked) {
                    this.elements.siteFeeValidationMessage.textContent = '';
                    return;
                }
                const threshold = this.getNumericValue(this.elements.gunCountThreshold);
                const perGunFee = this.getNumericValue(this.elements.siteFeePerGunMonthly);
                const siteFee = this.getNumericValue(this.elements.siteFeeMonthly);
                this.elements.siteFeeValidationMessage.textContent = (threshold * perGunFee < siteFee) ? '警告：級距計費總額低於基本站點費。' : '';
            },
            updateLinkedInputs(inputs) {
                if (inputs.revenueMethodDC === 'byCars') {
                    this.elements.kwhPerGunPerMonthDC.value = this.formatCurrency(inputs.carsPerGunPerDayDC * inputs.avgKwhPerCar * 30, 0, false, true);
                } else {
                    this.elements.carsPerGunPerDayDC.value = inputs.avgKwhPerCar > 0 ? (this.getNumericValue(this.elements.kwhPerGunPerMonthDC) / 30 / inputs.avgKwhPerCar).toFixed(1) : 0;
                }
                if (inputs.revenueMethodAC === 'byCars') {
                    this.elements.kwhPerGunPerMonthAC.value = Math.min(1800, Math.round(inputs.carsPerGunPerDayAC * inputs.avgKwhPerCar * 30));
                } else {
                    this.elements.carsPerGunPerDayAC.value = inputs.avgKwhPerCar > 0 ? Math.min(2, this.getNumericValue(this.elements.kwhPerGunPerMonthAC) / 30 / inputs.avgKwhPerCar).toFixed(1) : 0;
                }
            },
            updateDisplay(inputs, results) {
                const renderSummary = (el, value, unit = '') => { el.innerHTML = `<div>${value}<span class="unit unit-suffix">${unit}</span></div>`; };
                const renderCurrency = (el, value) => { el.innerHTML = `<div>${this.formatCurrency(value, 0, false).replace('NT$', '<span class="unit unit-prefix">NT$</span>')}</div>`; };

                renderCurrency(this.elements.totalInvestment, results.totalInvestment);
                renderCurrency(this.elements.totalRevenueSummary, results.totalChargingRevenue);
                renderCurrency(this.elements.totalNetProfitSummary, results.totalNetProfit);
                
                // ADDED LOGIC START
                const totalCost = results.annualData.reduce((sum, d) => sum + d.cost, 0);
                renderCurrency(this.elements.totalCostSummary, totalCost);
                renderCurrency(this.elements.equitySummary, results.equity);
                // ADDED LOGIC END
                
                renderSummary(this.elements.operationPeriodSummary, inputs.operationYears, ' 年');
                this.elements.paybackPeriod.innerHTML = `<div>${results.paybackPeriod === 'N/A' ? '無法回收' : results.paybackPeriod.replace(' 年', `<span class="unit unit-suffix"> 年</span>`)}</div>`;
                this.elements.roiSummary.innerHTML = `<div>${isNaN(results.roi) ? 'N/A' : `${results.roi.toFixed(1)}<span class="unit unit-suffix">%</span>`}</div>`;
                renderCurrency(this.elements.totalInterestSummary, results.totalInterestPaid);
                this.elements.irrSummary.innerHTML = `<div>${isNaN(results.irr) ? 'N/A' : `${results.irr.toFixed(2)}<span class="unit unit-suffix">%</span>`}</div>`;
                
                // Toggle interest card visibility
                this.elements.totalInterestSummary.closest('.summary-card').style.display = inputs.financingEnabled ? 'flex' : 'none';

                this.elements.parkingSpaces.value = inputs.equipmentList.reduce((sum, item) => sum + item.gunCount, 0);
                if (inputs.billingMethodDC === 'tou') this.elements.avgTouRate.value = this.formatCurrency(results.avgChargeFeeDC, 2, false, true);
                this.elements.equipmentCostDisplayMain.value = this.formatCurrency(results.costBreakdown.totalDeviceCostUntaxed, 0, false, true);

                this.populateTable(this.elements.kwhStatsTableBody, results.annualData, d => `<tr class="kwh-row" data-year="${d.year}"><td class="table-cell table-cell-year">第 ${d.year} 年</td><td class="table-cell text-green-600 font-semibold">${d.kwhPerDay.toLocaleString('en-US',{maximumFractionDigits:1})}</td><td class="table-cell text-blue-600 font-semibold">${d.kwhPerMonth.toLocaleString('en-US',{maximumFractionDigits:0})}</td><td class="table-cell text-red-600 font-semibold">${d.kwhPerYear.toLocaleString('en-US',{maximumFractionDigits:0})}</td></tr>`);
                this.populateTable(this.elements.pnlTableBody, results.annualData, d => `<tr class="pnl-row" data-year="${d.year}"><td class="table-cell table-cell-year">第 ${d.year} 年</td><td class="table-cell">${this.formatCurrency(d.revenue,0,false,true)}</td><td class="table-cell">${this.formatCurrency(d.cost,0,false,true)}</td><td class="table-cell ${d.pnl>=0?'':'text-red-600'}">${this.formatCurrency(d.pnl,0,false,true)}</td><td class="table-cell font-semibold ${d.cumulativePnl>=0?'text-blue-600':'text-red-600'}">${this.formatCurrency(d.cumulativePnl,0,false,true)}</td></tr>`);

                this.elements.explainerTotalInvestment.textContent = this.formatCurrency(results.totalInvestment);
                this.elements.explainerTotalRevenue.textContent = this.formatCurrency(results.totalChargingRevenue);
                this.elements.explainerTotalCost.textContent = this.formatCurrency(results.annualData.reduce((sum, d) => sum + d.cost, 0));
                this.elements.explainerPaybackPeriod.textContent = results.paybackPeriod;
                this.elements.explainerTotalManagementCost.textContent = this.formatCurrency(results.totalManagementCost);
                
                const showFinancingInfo = (show) => {
                    this.elements.explainerEquityItem.classList.toggle('hidden-section', !show);
                    this.elements.explainerLoanItem.classList.toggle('hidden-section', !show);
                    this.elements.explainerTotalInterestItem.classList.toggle('hidden-section', !show);
                };
                showFinancingInfo(inputs.financingEnabled);
                if (inputs.financingEnabled) {
                    this.elements.explainerEquity.textContent = this.formatCurrency(results.equity);
                    this.elements.explainerLoan.textContent = this.formatCurrency(results.loanAmount);
                    this.elements.explainerTotalInterest.textContent = this.formatCurrency(results.totalInterestPaid);
                }
                this.elements.explainerTotalManagementCostItem.classList.toggle('hidden-section', inputs.profitShareMethods.none);
            },
            populateTable(tbody, data, rowTemplate) {
                tbody.innerHTML = data.map(rowTemplate).join('');
            },
            /* REMOVED toggleKwhTable function */
            toggleDetails(tbody, row, results, detailHtmlFunction, colspan) {
                const year = parseInt(row.dataset.year);
                const currentlyOpen = tbody.querySelector('.details-row');
                const isClosingCurrent = currentlyOpen && parseInt(currentlyOpen.dataset.year) === year;

                if (currentlyOpen) {
                    currentlyOpen.remove();
                }

                if (!isClosingCurrent) {
                    const yearData = results.annualData.find(d => d.year === year);
                    if (yearData?.details) {
                        const newRow = document.createElement('tr');
                        newRow.className = 'details-row';
                        newRow.dataset.year = year;
                        newRow.innerHTML = `<td colspan="${colspan}">${detailHtmlFunction(yearData, results)}</td>`;
                        row.after(newRow);
                    }
                }
                
                // --- FIX ---
                // REMOVED the old logic block that adjusted kwhTableContainer.
                // It's no longer needed as the container height is auto.
                // --- END FIX ---
            },
            togglePnlDetails(row, results) {
                this.toggleDetails(this.elements.pnlTableBody, row, results, (yearData, res) => this.createDetailsHtml(yearData, res), 5);
            },
            toggleKwhDetails(row, results) {
                this.toggleDetails(this.elements.kwhStatsTableBody, row, results, (yearData) => this.createKwhDetailsHtml(yearData, this.getInputs()), 4);
            },
            createKwhDetailsHtml(yearData, inputs) {
                const { details, year, kwhPerYear, kwhPerDay, kwhPerMonth } = yearData;
                const acGuns = inputs.equipmentList.filter(e => e.spec.type === 'AC').reduce((s, e) => s + e.gunCount, 0);
                const dcGuns = inputs.equipmentList.filter(e => e.spec.type !== 'AC').reduce((s, e) => s + e.gunCount, 0);
                
                const hasAC = details.kwh.ac > 0;
                const hasDC = details.kwh.dc > 0;

                // Calculate individual components
                const kwhPerDayAC = hasAC ? details.kwh.ac / 365 : 0;
                const kwhPerDayDC = hasDC ? details.kwh.dc / 365 : 0;
                const kwhPerMonthAC = hasAC ? details.kwh.ac / 12 : 0;
                const kwhPerMonthDC = hasDC ? details.kwh.dc / 12 : 0;

                let html = `<div class="details-container"><div class="details-section"><h4>第 ${year} 年充電度數計算</h4>`;

                // --- REMOVED Source Grid ---

                // --- Build Details Grid ---
                let detailsGrid = '<div class="explainer-grid">';

                // AC Details
                if (hasAC) {
                    const acFormula = `${this.formatCurrency(inputs.kwhPerGunPerMonthAC, 0, false, true)}kWh x ${acGuns}槍 x 12月`;
                    detailsGrid += `
                        <span class="font-semibold col-span-3 pb-2" style="font-size: 1.125rem; line-height: 1.75rem; color: #059669; border-bottom: none !important; padding-bottom: 0.5rem !important; text-align: left;">AC 慢充</span>
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">充電度數/日(平均)</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(details.kwh.ac, 0, false, true)} / 365</span>
                        <span style="font-weight: 600; text-align: right; color: #059669;">${this.formatCurrency(kwhPerDayAC, 1, false, true)} kWh</span>
                        
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">充電度數/月(平均)</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(details.kwh.ac, 0, false, true)} / 12</span>
                        <span style="font-weight: 600; text-align: right; color: #059669;">${this.formatCurrency(kwhPerMonthAC, 0, false, true)} kWh</span>
                        
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">年度總度數</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${acFormula}</span>
                        <span style="font-weight: 600; text-align: right; color: #059669;">${this.formatCurrency(details.kwh.ac, 0, false, true)} kWh</span>
                    `;
                }

                // DC Details
                if (hasDC) {
                    const dcFormula = `${this.formatCurrency(inputs.kwhPerGunPerMonthDC, 0, false, true)}kWh x ${dcGuns}槍 x 12月 x ${Math.pow(1 + inputs.demandGrowthRate, year - 1).toFixed(2)}`;
                    detailsGrid += `
                        <span class="font-semibold col-span-3 pt-4 pb-2 ${hasAC ? 'border-t border-gray-200' : ''}" style="font-size: 1.125rem; line-height: 1.75rem; color: #2563EB; border-bottom: none !important; padding-bottom: 0.5rem !important; text-align: left;">DC 快充</span>
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">充電度數/日(平均)</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(details.kwh.dc, 0, false, true)} / 365</span>
                        <span style="font-weight: 600; text-align: right; color: #2563EB;">${this.formatCurrency(kwhPerDayDC, 1, false, true)} kWh</span>
                        
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">充電度數/月(平均)</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(details.kwh.dc, 0, false, true)} / 12</span>
                        <span style="font-weight: 600; text-align: right; color: #2563EB;">${this.formatCurrency(kwhPerMonthDC, 0, false, true)} kWh</span>
                        
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">年度總度數</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${dcFormula}</span>
                        <span style="font-weight: 600; text-align: right; color: #2563EB;">${this.formatCurrency(details.kwh.dc, 0, false, true)} kWh</span>
                    `;
                }

                // Total Details (only if both AC and DC exist)
                if (hasAC && hasDC) {
                    detailsGrid += `
                        <span class="font-bold text-gray-800 col-span-3 pt-4 pb-2 border-t-2 border-gray-300 mt-2" style="font-size: 1.125rem; line-height: 1.75rem; border-bottom: none !important; padding-bottom: 0.5rem !important; text-align: left;">總計</span>
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">總充電度數/日(平均)</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(kwhPerDayAC, 1, false, true)} + ${this.formatCurrency(kwhPerDayDC, 1, false, true)}</span>
                        <span style="font-weight: 600; text-align: right; color: #1F2937;">${this.formatCurrency(kwhPerDay, 1, false, true)} kWh</span>
                        
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">總充電度數/月(平均)</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(kwhPerMonthAC, 0, false, true)} + ${this.formatCurrency(kwhPerMonthDC, 0, false, true)}</span>
                        <span style="font-weight: 600; text-align: right; color: #1F2937;">${this.formatCurrency(kwhPerMonth, 0, false, true)} kWh</span>
                        
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">年度總度數</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${this.formatCurrency(details.kwh.ac, 0, false, true)} + ${this.formatCurrency(details.kwh.dc, 0, false, true)}</span>
                        <span style="font-weight: 600; text-align: right; color: #1F2937;">${this.formatCurrency(kwhPerYear, 0, false, true)} kWh</span>
                    `;
                }

                detailsGrid += '</div>';
                html += detailsGrid;

                html += '</div></div>';
                return html;
            },
            createDetailsHtml(yearData, results) {
                const buildGrid = (items, total, totalLabel = '總計', isCost = false) => {
                    let gridHtml = '<div class="explainer-grid">';
                    gridHtml += items.map(item => `
                        <span style="font-weight: 500; color: #374151; font-size: 0.9rem; text-align: left;">${item.label}</span>
                        <span style="color: #6B7280; font-size: 0.875rem; text-align: left;">${item.formula}</span>
                        <span style="font-weight: 600; text-align: right; ${isCost ? 'color: #DC2626;' : 'color: #1F2937;'}">${this.formatCurrency(item.value, 0, false, true)}</span>
                    `).join('');
                    gridHtml += '</div>';
                    gridHtml += `<div class="explainer-total-row"><span>${totalLabel}</span><span style="${isCost ? 'color: #DC2626;' : 'color: #111827;'}">${this.formatCurrency(total, 0, false, true)}</span></div>`;
                    return gridHtml;
                }

                const revenueItems = Calculator.getRevenueBreakdown(yearData, this.getInputs(), results);
                const revenueHtml = `<div class="details-section"><h4>總營收細項</h4>${buildGrid(revenueItems, yearData.revenue, '總計', false)}</div>`;
                
                let costItems = yearData.details.costBreakdownItems.filter(item => !(this.getInputs().financingEnabled && this.getInputs().depreciationMethod !== 'none' && item.key === 'principal'));
                const costsHtml = `<div class="details-section"><h4>總成本細項</h4>${buildGrid(costItems, yearData.cost, '總計', true)}</div>`;

                return `<div class="details-container"><div class="details-grid">${revenueHtml}${costsHtml}</div></div>`;
            },
            // Modal and other UI helpers
            openModal(modal) { modal.style.display = 'flex'; },
            closeModal(modal) {
                if (!modal) return;
                modal.style.display = 'none';
                if (modal.id === 'advancedModal') {
                    // Password section reset is no longer needed
                }
            },
            showModalMessage(element, message, isError = true, hide = false) {
                if (hide) { element.style.display = 'none'; return; }
                element.textContent = message;
                element.className = `modal-message ${isError ? 'error' : 'success'}`;
                element.style.display = 'block';
            },
            showAdvancedContent(show) {
                this.elements.advancedPasswordSection.style.display = show ? 'none' : 'block';
                this.elements.advancedContentSection.style.display = show ? 'block' : 'none';
            },
            handleTabSwitch(event) {
                const tabId = event.target.dataset.tab;
                event.target.closest('.modal-tabs').querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.closest('.modal-content').querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
            },
            populateSpecsModal(deviceSpecs, calculationParams) {
                const tableBody = this.elements.specsModalTableBody;
                tableBody.innerHTML = '';
                const taxRate = calculationParams.taxRate.value;
                Object.entries(deviceSpecs).forEach(([power, spec]) => {
                    if (spec.type === 'DC_360') {
                        const createRow = (component, cost, salvage) => {
                            const costTaxed = cost * (1 + taxRate);
                            const salvagePercentage = cost > 0 ? (salvage / cost * 100).toFixed(1) : 10;
                            return `<td>${component}</td><td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="${component.toLowerCase()}Cost" value="${cost.toLocaleString('en-US')}"></td><td class="text-right p-2 cost-taxed-display">${this.formatCurrency(costTaxed, 0, false, true)}</td><td><div class="flex items-center justify-end"><input type="number" class="modal-table-input salvage-percent-input w-20" value="${salvagePercentage}"><span class="ml-2 text-gray-500">%</span></div></td><td class="text-right salvage-display p-2" data-power="${power}" data-type="${component.toLowerCase()}Salvage">${salvage.toLocaleString('en-US')}</td>`;
                        };
                        tableBody.insertAdjacentHTML('beforeend', `<tr><td class="font-semibold align-middle" rowspan="2">${spec.name}</td>${createRow('Cabinet', spec.cabinetCost, spec.cabinetSalvage)}</tr><tr>${createRow('Terminal', spec.terminalCost, spec.terminalSalvage)}</tr>`);
                    } else {
                        const costTaxed = spec.cost * (1 + taxRate);
                        const salvagePercentage = spec.cost > 0 ? (spec.salvage / spec.cost * 100).toFixed(1) : 10;
                        tableBody.insertAdjacentHTML('beforeend', `<tr><td class="font-semibold align-middle">${spec.name}</td><td>充電樁</td><td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="cost" value="${spec.cost.toLocaleString('en-US')}"></td><td class="text-right p-2 cost-taxed-display">${this.formatCurrency(costTaxed, 0, false, true)}</td><td><div class="flex items-center justify-end"><input type="number" class="modal-table-input salvage-percent-input w-20" value="${salvagePercentage}"><span class="ml-2 text-gray-500">%</span></div></td><td class="text-right salvage-display p-2" data-power="${power}" data-type="salvage">${spec.salvage.toLocaleString('en-US')}</td></tr>`);
                    }
                });
                this.addSpecInputListeners(tableBody);
            },
            addSpecInputListeners(tableBody) {
                const focusable = Array.from(tableBody.querySelectorAll('.cost-input, .salvage-percent-input'));
                focusable.forEach((input, index) => {
                    input.addEventListener('focus', (e) => e.target.dataset.originalValue = e.target.value);
                    input.addEventListener('keydown', (e) => {
                        switch (e.key) {
                            case 'Enter': 
                                e.preventDefault(); 
                                App.handleAdvancedEnterSave();
                                e.target.blur();
                                break;
                            case 'ArrowDown': e.preventDefault(); focusable[(index + 1) % focusable.length].select(); break;
                            case 'ArrowUp': e.preventDefault(); focusable[(index - 1 + focusable.length) % focusable.length].select(); break;
                            case 'Escape': e.preventDefault(); e.target.value = e.target.dataset.originalValue; e.target.blur(); break;
                        }
                    });
                    input.addEventListener('input', (e) => {
                        const row = e.target.closest('tr');
                        const costInput = row.querySelector('.cost-input');
                        const percentInput = row.querySelector('.salvage-percent-input');
                        const salvageValueDisplay = row.querySelector('.salvage-display');
                        const costTaxedDisplay = row.querySelector('.cost-taxed-display');
                        if (costInput && percentInput && salvageValueDisplay && costTaxedDisplay) {
                            const cost = parseFloat(costInput.value.replace(/,/g,'')) || 0;
                            const percent = parseFloat(percentInput.value) || 0;
                            salvageValueDisplay.textContent = Math.round((cost * percent) / 100).toLocaleString('en-US');
                            const taxRate = Config.calculationParams.taxRate.value; // taxRate is always enabled now, just hidden.
                            costTaxedDisplay.textContent = UI.formatCurrency(cost * (1 + taxRate), 0, false, true);
                        }
                    });
                    input.addEventListener('blur', (e) => { 
                        const value = parseFloat(e.target.value.replace(/,/g, '')) || 0;
                        if (e.target.classList.contains('cost-input')) {
                             e.target.value = value.toLocaleString('en-US');
                        } else {
                            e.target.value = value;
                        }
                    });
                });
            },
            populateFormulasModal(calculationParams) {
                const investmentContainer = this.elements.investmentFormulaContainer;
                const annualContainer = this.elements.annualFormulaContainer;
                investmentContainer.innerHTML = '';
                annualContainer.innerHTML = '';
                const lastResults = Calculator.getLastResults();
                const inputs = this.getInputs();

                Object.entries(calculationParams).forEach(([key, param]) => {
                    if (key === 'taxRate') return; 
                    const container = param.category === 'investment' ? investmentContainer : annualContainer;
                    if(container){
                        const isPercentage = param.unit === '%';
                        let formattedValue;
                        if (key === 'deviceCost') formattedValue = this.formatCurrency(lastResults.costBreakdown?.totalDeviceCostUntaxed || 0, 0, false, true);
                        else if (key === 'constructionFee') formattedValue = this.formatCurrency(inputs.infrastructureCostMain, 0, false, true);
                        else {
                            const displayValue = isPercentage ? param.value * 100 : param.value;
                            formattedValue = displayValue.toLocaleString('en-US', {maximumFractionDigits: 2});
                        }
                        
                        const unitText = isPercentage ? '%' : param.unit;
                        const inputHtml = `
                                <input type="text" id="input_${key}" data-key="${key}" value="${formattedValue}" class="modal-table-input ${param.readonly ? 'readonly' : ''}" ${param.readonly ? 'readonly' : ''}>
                                <span class="ml-2 text-gray-600 w-10 text-left">${unitText}</span>
                            `;

                        container.insertAdjacentHTML('beforeend', `<div class="grid grid-cols-1 md:grid-cols-12 items-center gap-2 border-b border-gray-100 py-3"><div class="md:col-span-4 flex items-center"><input type="checkbox" id="check_${key}" data-key="${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3" ${param.enabled ? 'checked' : ''}><label for="check_${key}" class="font-medium text-gray-800">${param.label}</label></div><div class="md:col-span-5"><p class="text-sm text-gray-500">${param.description}</p></div><div class="md:col-span-3 flex items-center">${inputHtml}</div></div>`);
                    }
                });

                document.querySelectorAll('#investmentFormulaContainer input[type="text"], #annualFormulaContainer input[type="text"]').forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            App.handleAdvancedEnterSave();
                            e.target.blur();
                        }
                    });
                });
            },
            openExplanationModal(type, results, inputs) {
                const { calculationParams } = Config; const body = this.elements.explanationModalBody; let title = ''; let contentHtml = '';
                const buildGrid = (items, total, title = '總計') => { let gridHtml = '<div class="explainer-grid">'; items.forEach(item => { gridHtml += `<span>${item.label}</span><span>${item.formula}</span><span class="font-semibold ${item.value < 0 ? 'text-red-500' : ''}">${this.formatCurrency(item.value, 0, false, true)}</span>`; }); gridHtml += '</div>'; gridHtml += `<div class="explainer-total-row"><span>${title}</span><span>${this.formatCurrency(total, 0, false, true)}</span></div>`; return gridHtml; };
                switch (type) {
                    case 'investment': title = '總投資額 計算說明'; const investmentItems = Calculator.getInvestmentBreakdown(inputs, calculationParams); contentHtml = buildGrid(investmentItems, results.totalInvestment); break;
                    case 'revenue': title = '總營收 計算說明 (營運期間總計)'; const totalRevenueItems = Calculator.getOverallRevenueBreakdown(results, inputs); contentHtml = buildGrid(totalRevenueItems, results.totalChargingRevenue); break;
                    case 'cost': title = '總成本 計算說明 (營運期間總計)'; const totalCostItems = Calculator.getOverallCostBreakdown(results, inputs); const totalCost = results.annualData.reduce((sum, d) => sum + d.cost, 0); contentHtml = buildGrid(totalCostItems, totalCost); break;
                    case 'equity': 
                        title = '本金 計算說明';
                        const equityItems = [ 
                            { label: '總投資額', value: results.totalInvestment, formula: '(所有建置成本加總)' }, 
                            { label: '融資金額', value: -results.loanAmount, formula: `(${this.formatCurrency(results.totalInvestment, 0, false, true)} x ${inputs.loanPercentage * 100}%)` } 
                        ]; 
                        contentHtml = buildGrid(equityItems, results.equity, '本金 (自有資金)'); 
                        break;
                    case 'loan': 
                        title = '融資 計算說明'; 
                        let loanGridHtml = '<div class="explainer-grid">'; 
                        loanGridHtml += `<span>總投資額</span><span>所有建置成本加總</span><span class="font-semibold">${this.formatCurrency(results.totalInvestment, 0, false, true)}</span>`; 
                        loanGridHtml += `<span>貸款比例</span><span>使用者設定</span><span class="font-semibold">${(inputs.loanPercentage * 100).toFixed(0)}%</span>`; 
                        loanGridHtml += '</div>'; 
                        loanGridHtml += `<div class="explainer-total-row"><span>融資金額</span><span>${this.formatCurrency(results.loanAmount, 0, false, true)}</span></div>`; 
                        contentHtml = loanGridHtml; 
                        break;
                    case 'interest': 
                        title = '利息總額 計算說明'; 
                        const interestItems = []; 
                        let tempRemainingPrincipal = results.loanAmount; 
                        const firstYearInterest = tempRemainingPrincipal * inputs.interestRate;
                        interestItems.push({ label: `第 1 年利息 (估)`, value: firstYearInterest, formula: `${this.formatCurrency(tempRemainingPrincipal, 0, false, true)} x ${parseFloat((inputs.interestRate * 100).toFixed(2))}%` });
                        
                        let lastYearInterest = 0;
                        for (let year = 1; year <= inputs.loanTerm; year++) { 
                            if (tempRemainingPrincipal <= 0) break; 
                            const interestPayment = tempRemainingPrincipal * inputs.interestRate;
                            lastYearInterest = interestPayment;
                            const monthlyPayment = (tempRemainingPrincipal * (inputs.interestRate / 12)) / (1 - Math.pow(1 + (inputs.interestRate / 12), - (inputs.loanTerm - year + 1) * 12)); 
                            const principalPayment = (monthlyPayment * 12) - interestPayment; 
                            tempRemainingPrincipal -= principalPayment; 
                        }
                        
                        if (inputs.loanTerm > 1) {
                            interestItems.push({ label: `...`, value: 0, formula: `利息逐年遞減` });
                            interestItems.push({ label: `第 ${inputs.loanTerm} 年利息 (估)`, value: lastYearInterest, formula: `依剩餘本金計算` });
                        }
                        
                        contentHtml = buildGrid(interestItems, results.totalInterestPaid, '利息總額'); 
                        break;
                    case 'management': title = '維運代管總成本 計算說明'; const managementItems = Calculator.getOverallManagementCostBreakdown(results, inputs); contentHtml = buildGrid(managementItems, results.totalManagementCost); break;
                    case 'payback':
                        title = '預計回收年限 計算說明';
                        let cumulativePnl = -results.totalInvestment;
                        let lastNegativeCumulativePnl = cumulativePnl;
                        let paybackYear = 0;
                        let pnlInPaybackYear = 0;
                        let paybackFound = results.paybackPeriod !== 'N/A';

                        let yearByYearHtml = `
                            <div class="space-y-2" id="paybackExplanationBody">
                                <div class="flex justify-between items-baseline p-3 bg-gray-100 rounded-lg">
                                    <span class="font-bold">期初 (總投資額)</span>
                                    <span class="font-bold text-red-600 text-lg">${this.formatCurrency(cumulativePnl, 0)}</span>
                                </div>
                        `;

                        for (const yearData of results.annualData) {
                            lastNegativeCumulativePnl = cumulativePnl;
                            cumulativePnl += yearData.pnl;

                            yearByYearHtml += `
                                <div class="p-3 border border-gray-200 rounded-lg payback-year-row cursor-pointer transition-colors hover:bg-gray-50" data-year="${yearData.year}">
                                    <div class="flex justify-between items-baseline font-bold text-gray-800">
                                        <span>第 ${yearData.year} 年</span>
                                        <span class="font-bold text-lg ${cumulativePnl >= 0 ? 'text-blue-600' : 'text-red-600'}">${this.formatCurrency(cumulativePnl, 0)}</span>
                                    </div>
                                    <div class="pl-4 mt-2 border-l-2 border-gray-200 space-y-1 text-sm payback-details" style="display: none;">
                                         <div class="flex justify-between items-baseline">
                                            <span class="text-gray-500">前期累積:</span>
                                            <span class="font-mono">${this.formatCurrency(lastNegativeCumulativePnl, 0)}</span>
                                        </div>
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-gray-500">年度淨利:</span>
                                            <span class="font-mono font-semibold ${yearData.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">${this.formatCurrency(yearData.pnl, 0)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            if (cumulativePnl >= 0 && paybackYear === 0) {
                                paybackYear = yearData.year;
                                pnlInPaybackYear = yearData.pnl;
                                if (paybackFound) break; 
                            }
                        }
                        
                        yearByYearHtml += '</div>';
                        contentHtml = yearByYearHtml;


                        if (!paybackFound) {
                            contentHtml += `<div class="mt-6 p-4 bg-red-50 rounded-lg">
                                <h4 class="font-bold text-lg text-red-800 mb-2">無法回收原因分析</h4>
                                <p class="text-gray-700">初期總投資額為 ${this.formatCurrency(results.totalInvestment, 0)}。</p>
                                <p class="text-gray-700">在營運 ${inputs.operationYears} 年後，累積淨利為 <span class="font-bold text-red-600">${this.formatCurrency(cumulativePnl, 0)}</span>。</p>
                                <p class="text-gray-700 mt-2">由於營運期結束時累積淨利仍為負數，表示總利潤尚不足以彌補初期投資，因此無法在此期間內回收成本。</p>
                                <p class="text-gray-700 mt-1">尚有 <strong class="text-red-600">${this.formatCurrency(Math.abs(cumulativePnl), 0)}</strong> 的虧損未彌補。</p>
                            </div>`;
                        } else {
                            const fractionOfYear = pnlInPaybackYear > 0 ? (-lastNegativeCumulativePnl / pnlInPaybackYear) : 0;
                            const operatingPayback = paybackYear - 1 + fractionOfYear;
                            const constructionPeriodInYears = inputs.constructionPeriod / 12;
                            const finalTotalPayback = operatingPayback + constructionPeriodInYears;

                            contentHtml += `<div class="mt-6 p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-bold text-lg text-blue-800 mb-2">最終計算</h4>
                                <p class="text-gray-700">在第 ${paybackYear - 1} 年底時，仍虧損 ${this.formatCurrency(Math.abs(lastNegativeCumulativePnl), 0)}。</p>
                                <p class="text-gray-700">第 ${paybackYear} 年的淨利為 ${this.formatCurrency(pnlInPaybackYear, 0)}。</p>
                                <p class="text-gray-700 mt-2">因此，在第 ${paybackYear} 年中需要的營運時間為：</p>
                                <p class="text-center font-mono text-lg my-2 p-2 bg-white rounded">${this.formatCurrency(Math.abs(lastNegativeCumulativePnl), 0)} / ${this.formatCurrency(pnlInPaybackYear, 0)} = ${fractionOfYear.toFixed(2)} 年</p>
                                <hr class="my-3 border-blue-200">
                                <p class="text-gray-700">營運回收年限 = ${paybackYear - 1} + ${fractionOfYear.toFixed(2)} = ${operatingPayback.toFixed(2)} 年</p>
                                <p class="text-gray-700">加上建置期 ${inputs.constructionPeriod} 個月 (${constructionPeriodInYears.toFixed(2)} 年)</p>
                                <p class="font-bold text-gray-800 mt-2">總回收年限 = ${operatingPayback.toFixed(2)} + ${constructionPeriodInYears.toFixed(2)} = ${finalTotalPayback.toFixed(1)} 年</p>
                            </div>`;
                        }
                        this.elements.explanationModalTitle.textContent = title; 
                        body.innerHTML = contentHtml;

                        body.querySelector('#paybackExplanationBody').addEventListener('click', (e) => {
                            const row = e.target.closest('.payback-year-row');
                            if (!row) return;

                            const details = row.querySelector('.payback-details');
                            const isOpening = details.style.display === 'none';
                            
                            // Close any currently open details
                            body.querySelectorAll('.payback-details').forEach(d => d.style.display = 'none');
                            
                            // Toggle the clicked one
                            if (isOpening) {
                                details.style.display = 'block';
                            }
                        });

                        this.openModal(this.elements.explanationModal);
                        break;
                }
                if (type !== 'payback') {
                    this.elements.explanationModalTitle.textContent = title; 
                    body.innerHTML = contentHtml; 
                    this.openModal(this.elements.explanationModal);
                }
            },
            renderRecordsList() {
                const container = this.elements.recordsList;
                const records = Persistence.getRecordList();
                if (records.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">尚無儲存紀錄。</p>';
                    return;
                }
                container.innerHTML = records.map(name => `
                    <div class="record-list-item" data-name="${name}">
                        <span class="record-name">${name}</span>
                        <div class="record-actions flex items-center gap-2">
                            <button class="remove-equip-btn" data-name="${name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>`).join('');
                
                container.querySelectorAll('.record-list-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.remove-equip-btn')) return;
                        const isSelected = e.currentTarget.classList.contains('selected');
                        container.querySelectorAll('.record-list-item').forEach(el => {
                            el.classList.remove('selected');
                            el.querySelector('.load-btn')?.remove();
                        });
                        if (!isSelected) {
                            e.currentTarget.classList.add('selected');
                            const loadBtn = document.createElement('button');
                            loadBtn.textContent = '載入';
                            loadBtn.className = 'load-btn modal-action-button';
                            loadBtn.onclick = () => { Persistence.loadRecord(item.dataset.name); this.closeModal(this.elements.recordsModal); };
                            e.currentTarget.querySelector('.record-actions').prepend(loadBtn);
                        }
                    });
                    item.querySelector('.remove-equip-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        Persistence.deleteRecord(e.currentTarget.dataset.name);
                        this.renderRecordsList();
                    });
                });
            },
            resetForm() {
                this.elements.siteNameDisplay.textContent = '未命名站點';
                this.elements.equipmentListContainer.innerHTML = '';
                // Reset simple inputs to their default values
                const defaults = {
                    infrastructureCostMain: '500,000', chargeFeePerKwhAC: 7.5, chargeFeePerKwhDC: 10, peakRate: 13.5, offPeakRate: 6.9, holidayRate: 8.5, carsPerGunPerDayDC: 3, kwhPerGunPerMonthDC: '2,700', carsPerGunPerDayAC: 0.5, kwhPerGunPerMonthAC: 1800, avgKwhPerCar: 30, demandGrowthRate: 20, operationYears: 15, constructionPeriod: 6, depreciationYears: 5, rentPerSpace: '500', rentPerLand: '15,000', rentPerKwh: 1, rentPercentage: 10, rentKwhThreshold: '5,000', rentTierAboveValueKwh: 1.2, rentTierAboveValueRevenue: 12, rentTierBelowValueKwh: 0.8, rentTierBelowValueRevenue: 8, profitShareAmount: 1, profitSharePercentage: 10, siteFeeMonthly: 3000, gunCountThreshold: 5, siteFeePerGunMonthly: 600, loanPercentage: 70, interestRate: 3.5, loanTerm: 7
                };
                Object.entries(defaults).forEach(([id, value]) => { if (this.elements[id]) this.elements[id].value = value; });
                // Reset radio/checkboxes
                const radioDefaults = {
                    billingMethodDC: 'fixed', revenueMethodAC: 'byCars', revenueMethodDC: 'byCars', depreciationMethod: 'straightLine', rentMethod: 'bySpace', rentTierType: 'byKwh'
                };
                Object.entries(radioDefaults).forEach(([name, value]) => {
                    const el = document.querySelector(`input[name="${name}"][value="${value}"]`);
                    if (el) el.checked = true;
                });
                ['profitShareByAmount', 'profitShareByPercentage', 'profitShareBySite', 'financingToggle'].forEach(id => this.elements[id].checked = false);
                this.elements.profitShareNone.checked = true;
                Persistence.loadDefaultState();
            },
            
            // ADDED THIS NEW FUNCTION
            updateSensitivityOptions() {
                const inputs = this.getInputs();
                const hasAC = inputs.equipmentList.some(e => e.spec.type === 'AC');
                const hasDC = inputs.equipmentList.some(e => e.spec.type !== 'AC');

                const optionsMap = {
                    'totalKwh': 'AC_OR_DC', // New key
                    'taipowerFee': 'ALL'
                };

                const select = this.elements.analysisVariable;
                if (!select) return;

                let firstEnabledOption = null;

                for (const option of select.options) {
                    const type = optionsMap[option.value];
                    let shouldBeDisabled = false;

                    if (type === 'AC_OR_DC' && !hasAC && !hasDC) { // Disable if no guns at all
                        shouldBeDisabled = true;
                    }
                    // 'ALL' type is never disabled

                    option.disabled = shouldBeDisabled;
                    
                    option.style.textDecoration = shouldBeDisabled ? 'line-through' : 'none';

                    if (!shouldBeDisabled && !firstEnabledOption) {
                        firstEnabledOption = option.value;
                    }
                }

                if (select.options[select.selectedIndex].disabled && firstEnabledOption) {
                    select.value = firstEnabledOption;
                }
            },

            // ADDED: renderSensitivityTable function
            renderSensitivityTable(targetVar, analysisVar, labels, results, baseValue, isPercentage, isParam) {
                const container = this.elements.sensitivityTableContainer;
                
                // Get friendly names
                const targetText = this.elements.targetVariable.querySelector(`option[value="${targetVar}"]`).textContent;
                const analysisText = this.elements.analysisVariable.querySelector(`option[value="${analysisVar}"]`).textContent;

                let tableHtml = `<table class="sensitivity-table">`;

                // Header Row 1: Variable Name
                tableHtml += `<thead><tr><th class="text-left">${analysisText}</th>`;
                steps.forEach((step, index) => {
                    tableHtml += `<th>${labels[index]}</th>`;
                });
                tableHtml += `</tr>`;

                // Header Row 2: Variable Values
                tableHtml += `<tr><th class="text-left text-gray-600">值</th>`;
                
                // Recalculate baseValue for 'totalKwh' for labeling
                let labelBaseValue;
                if(analysisVar === 'totalKwh') {
                    const baseInputs = UI.getInputs(); // Get fresh inputs
                    const acGuns = baseInputs.equipmentList.reduce((sum, e) => e.spec.type === 'AC' ? sum + e.gunCount : sum, 0);
                    const dcGuns = baseInputs.equipmentList.reduce((sum, e) => e.spec.type !== 'AC' ? sum + e.gunCount : sum, 0);
                    labelBaseValue = (baseInputs.kwhPerGunPerMonthAC * acGuns) + (baseInputs.kwhPerGunPerMonthDC * dcGuns);
                } else if (isParam) {
                    labelBaseValue = Config.calculationParams[analysisVar].value;
                } else {
                    labelBaseValue = UI.getInputs()[analysisVar];
                }

                steps.forEach((step, index) => {
                    let valueDisplay = "";
                    let val = (analysisVar === 'totalKwh') ? labelBaseValue * step : baseValue * step;
                    
                    if (isPercentage) {
                        valueDisplay = `${val.toFixed(1)}%`;
                    } else if (isParam) {
                        valueDisplay = `${UI.formatCurrency(val, 2, false, true)}`;
                    } else if (analysisVar === 'totalKwh') {
                        valueDisplay = `${UI.formatCurrency(val, 0, false, true)}`;
                    } else {
                         valueDisplay = `${val.toLocaleString('en-US', {maximumFractionDigits: 1})}`;
                    }
                    tableHtml += `<th class="${index === 2 ? 'base-case' : ''}">${valueDisplay}</th>`;
                });
                tableHtml += `</tr></thead>`;

                // Data Row: Target Variable Results
                tableHtml += `<tbody><tr><td class="font-semibold text-left">${targetText}</td>`;
                results.forEach((res, index) => {
                    let resultValue = "";
                    switch(targetVar) {
                        case 'paybackPeriod':
                            resultValue = res.paybackPeriod === 'N/A' ? '無法回收' : res.paybackPeriod;
                            break;
                        case 'roi':
                            resultValue = isNaN(res.roi) ? 'N/A' : `${res.roi.toFixed(1)}%`;
                            break;
                        case 'irr':
                            resultValue = isNaN(res.irr) ? 'N/A' : `${res.irr.toFixed(1)}%`;
                            break;
                        case 'totalNetProfitSummary':
                            resultValue = UI.formatCurrency(res.totalNetProfit, 0);
                            break;
                    }
                    tableHtml += `<td class="${index === 2 ? 'base-case' : ''}">${resultValue}</td>`;
                });
                tableHtml += `</tr></tbody>`;
                
                tableHtml += `</table>`;
                container.innerHTML = tableHtml;
            }
        };

        /**
         * =================================================================
         * CALCULATOR MODULE: Business Logic
         * =================================================================
         */
        const Calculator = {
            lastResults: {},
            run(inputs, params, deviceSpecs) {
                const results = { annualData: [], totalInvestment: 0, paybackPeriod: 'N/A', costBreakdown: {}, avgChargeFeeAC: 0, avgChargeFeeDC: 0, totalChargingRevenue: 0, totalNetProfit: 0, totalInterestPaid: 0, roi: NaN, irr: NaN, totalManagementCost: 0 }; // REMOVED totalCostBreakdown
                const investmentBreakdown = this.getInvestmentBreakdown(inputs, params);
                results.totalInvestment = investmentBreakdown.reduce((sum, item) => sum + item.value, 0);
                const equipmentCostItem = investmentBreakdown.find(i => i.key === 'deviceCost');
                results.costBreakdown = { equipmentCost: equipmentCostItem?.value || 0, totalDeviceCostUntaxed: equipmentCostItem?.untaxedValue || 0, totalSalvageValue: this.calculateSalvageValue(inputs, deviceSpecs) };
                
                const loanAmount = inputs.financingEnabled ? results.totalInvestment * inputs.loanPercentage : 0;
                const equity = results.totalInvestment - loanAmount;
                results.loanAmount = loanAmount;
                results.equity = equity;

                // ******** PAYBACK PERIOD MODIFICATION APPLIED HERE ********
                let cumulativePnl = -results.totalInvestment;

                let paybackFound = false;
                const cashFlows = [-equity];
                let remainingLoanPrincipal = loanAmount;

                results.avgChargeFeeAC = inputs.chargeFeePerKwhAC;
                results.avgChargeFeeDC = (inputs.billingMethodDC === 'fixed') ? inputs.chargeFeePerKwhDC : (inputs.peakRate * inputs.touRatios.peak) + (inputs.offPeakRate * inputs.touRatios.offpeak) + (inputs.holidayRate * inputs.touRatios.holiday);

                for (let year = 1; year <= inputs.operationYears; year++) {
                    const demandMultiplier = Math.pow(1 + inputs.demandGrowthRate, year - 1);
                    const acGuns = inputs.equipmentList.reduce((sum, e) => e.spec.type === 'AC' ? sum + e.gunCount : sum, 0);
                    const dcGuns = inputs.equipmentList.reduce((sum, e) => e.spec.type !== 'AC' ? sum + e.gunCount : sum, 0);

                    // AC Calculation with conditional growth
                    let kwhAC = acGuns > 0 ? (inputs.kwhPerGunPerMonthAC * acGuns * 12) : 0;
                    // Apply growth rate only if the initial setting is below the max of 2 cars/day
                    if (inputs.carsPerGunPerDayAC < 2) {
                        // Calculate the max kwh equivalent to 2 cars/day
                        const maxKwhAC = (2 * inputs.avgKwhPerCar * 30) * acGuns * 12;
                        // Apply multiplier and then cap it at the max
                        kwhAC = Math.min(kwhAC * demandMultiplier, maxKwhAC);
                    }
                    
                    // DC Calculation with growth
                    const kwhDC = dcGuns > 0 ? (inputs.kwhPerGunPerMonthDC * dcGuns * 12 * demandMultiplier) : 0;

                    const totalKwhSold = kwhAC + kwhDC;
                    const revenue = (kwhAC * results.avgChargeFeeAC) + (kwhDC * results.avgChargeFeeDC);
                    
                    const costBreakdown = this.getCostBreakdown(results, inputs, year, totalKwhSold, revenue, remainingLoanPrincipal);
                    const principalPayment = costBreakdown.find(item => item.key === 'principal')?.value || 0;
                    const depreciation = costBreakdown.find(item => item.key === 'depreciation')?.value || 0;
                    
                    let costItemsForPNL = costBreakdown.filter(item => !(inputs.financingEnabled && inputs.depreciationMethod !== 'none' && item.key === 'principal'));
                    const totalAnnualCostForPNL = costItemsForPNL.reduce((sum, item) => sum + item.value, 0);
                    const finalAnnualCostForDisplay = inputs.depreciationMethod === 'none' ? (totalAnnualCostForPNL - depreciation) : totalAnnualCostForPNL;
                    const pnl = revenue - finalAnnualCostForDisplay;

                    cumulativePnl += pnl;

                    const interestPayment = costBreakdown.find(item => item.key === 'interest')?.value || 0;
                    remainingLoanPrincipal -= principalPayment;
                    const cashFlow = revenue - ((finalAnnualCostForDisplay - depreciation) + principalPayment);
                    cashFlows.push(cashFlow);

                    results.annualData.push({ year, revenue, cost: finalAnnualCostForDisplay, pnl, cumulativePnl, kwhPerYear: totalKwhSold, kwhPerMonth: totalKwhSold / 12, kwhPerDay: totalKwhSold / 365, details: { revenue: { '總營收': revenue }, kwh: { ac: kwhAC, dc: kwhDC * demandMultiplier }, costBreakdownItems: costBreakdown } });

                    if (cumulativePnl >= 0 && !paybackFound) {
                        const prevCumulativePnl = results.annualData[year - 2]?.cumulativePnl || -results.totalInvestment;
                        const fractionOfYear = pnl > 0 ? (-prevCumulativePnl / pnl) : 0;
                        const operatingPayback = year - 1 + fractionOfYear;
                        const constructionPeriodInYears = inputs.constructionPeriod / 12;
                        const totalPayback = operatingPayback + constructionPeriodInYears;
                        results.paybackPeriod = `${totalPayback.toFixed(1)} 年`;
                        paybackFound = true;
                    }
                }

                // --- REMOVED: Calculate Total Cost Breakdown ---
                
                results.totalNetProfit = results.annualData.reduce((sum, d) => sum + d.pnl, 0);
                results.totalChargingRevenue = results.annualData.reduce((sum, d) => sum + d.revenue, 0);
                results.totalInterestPaid = cashFlows.length > 1 ? results.annualData.reduce((sum, d) => sum + (d.details.costBreakdownItems.find(i => i.key === 'interest')?.value || 0), 0) : 0;
                results.totalManagementCost = results.annualData.reduce((sum, d) => sum + d.details.costBreakdownItems.filter(i => i.key.startsWith('management_')).reduce((s, i) => s + i.value, 0), 0);
                if (results.totalInvestment > 0) results.roi = ((results.totalNetProfit + results.totalInterestPaid) / results.totalInvestment) * 100;
                results.irr = this.calculateIRR(cashFlows) * 100;
                
                this.lastResults = results;
                return results;
            },
            // Other calculator methods like calculateSalvageValue, getInvestmentBreakdown, etc. remain here...
            // These functions are complex and less prone to simple line-count reduction without losing readability.
            // The logic from the original file for these functions should be pasted here.
            calculateSalvageValue(inputs, deviceSpecs) { return inputs.equipmentList.reduce((sum, item) => { const { spec, count, cabinetCount } = item; const salvage = (spec.type === 'DC_360') ? (cabinetCount * spec.cabinetSalvage) + (count * spec.terminalSalvage) : count * spec.salvage; return sum + salvage; }, 0); },
            getInvestmentBreakdown(inputs, params) {
                const baseItems = [];
                
                // 1. Calculate base hardware and fixed fee costs
                let totalDeviceCostUntaxed = 0, totalPowerKw = 0, totalGunCount = 0, hasAC = false, hasDC = false;
                let deviceCostFormulaParts = [];
                inputs.equipmentList.forEach(item => {
                    const { spec, count, pileCount, gunCount, cabinetCount } = item;
                    if (spec.type === 'AC') hasAC = true; else hasDC = true;
                    let itemCost = 0;
                    if (spec.type === 'DC_360') {
                        itemCost = (cabinetCount * spec.cabinetCost) + (count * spec.terminalCost);
                        deviceCostFormulaParts.push(`(${UI.formatCurrency(spec.cabinetCost, 0, false, true)} x ${cabinetCount}櫃 + ${UI.formatCurrency(spec.terminalCost, 0, false, true)} x ${count}樁)`);
                    } else {
                        itemCost = pileCount * spec.cost;
                        deviceCostFormulaParts.push(`(${UI.formatCurrency(spec.cost, 0, false, true)} x ${count}樁)`);
                    }
                    totalDeviceCostUntaxed += itemCost;
                    totalPowerKw += spec.power * (spec.type === 'DC_360' ? cabinetCount : pileCount);
                    totalGunCount += gunCount;
                });

                if (params.deviceCost.enabled) baseItems.push({ key: 'deviceCost', label: '設備總成本 (未稅)', value: totalDeviceCostUntaxed, untaxedValue: totalDeviceCostUntaxed, formula: deviceCostFormulaParts.join(' + ') || '無設備'});

                if (params.equipmentServiceFeeRate.enabled) {
                    const serviceFee = totalDeviceCostUntaxed * params.equipmentServiceFeeRate.value;
                    baseItems.push({
                        key: 'equipmentServiceFeeRate',
                        label: params.equipmentServiceFeeRate.label,
                        value: serviceFee,
                        formula: `${UI.formatCurrency(totalDeviceCostUntaxed, 0, false, true)} x ${(params.equipmentServiceFeeRate.value * 100).toFixed(0)}%`
                    });
                }

                if (hasDC) {
                    if (params.lineSubsidyPerKw.enabled) baseItems.push({ key: 'lineSubsidyPerKw', label: params.lineSubsidyPerKw.label, value: params.lineSubsidyPerKw.value * totalPowerKw, formula: `${UI.formatCurrency(params.lineSubsidyPerKw.value,0,false,true)} x ${totalPowerKw} kW`});
                    if (params.technicianFee.enabled) baseItems.push({ key: 'technicianFee', label: params.technicianFee.label, value: params.technicianFee.value, formula: `${UI.formatCurrency(params.technicianFee.value,0,false,true)}` });
                    if (params.meterFeeBase.enabled) baseItems.push({ key: 'meterFeeBase', label: params.meterFeeBase.label, value: params.meterFeeBase.value, formula: `${UI.formatCurrency(params.meterFeeBase.value,0,false,true)}` });
                    if (params.meterFeePerGun.enabled) baseItems.push({ key: 'meterFeePerGun', label: params.meterFeePerGun.label, value: params.meterFeePerGun.value * totalGunCount, formula: `${UI.formatCurrency(params.meterFeePerGun.value,0,false,true)} x ${totalGunCount} 槍` });
                }

                if (params.distributionPanelFee.enabled) {
                    const fee = hasAC && !hasDC ? 30000 : params.distributionPanelFee.value;
                    baseItems.push({ key: 'distributionPanelFee', label: params.distributionPanelFee.label, value: fee, formula: `${UI.formatCurrency(fee,0,false,true)}` });
                }

                if (params.constructionFee.enabled) baseItems.push({ key: 'constructionFee', label: params.constructionFee.label, value: inputs.infrastructureCostMain, formula: `${UI.formatCurrency(inputs.infrastructureCostMain,0,false,true)}` });

                if (params.siteLayoutFee.enabled) baseItems.push({ key: 'siteLayoutFee', label: params.siteLayoutFee.label, value: params.siteLayoutFee.value, formula: `${UI.formatCurrency(params.siteLayoutFee.value,0,false,true)}` });

                // 2. Sum up all base costs to get 'A'
                const baseInvestmentSubtotal = baseItems.reduce((sum, item) => sum + item.value, 0);

                // 3. Get the percentages for the new items
                const laborPercent = params.laborCostInvestment.enabled ? params.laborCostInvestment.value : 0;
                const miscPercent = params.miscCostInvestment.enabled ? params.miscCostInvestment.value : 0;
                const contingencyPercent = params.contingencyInvestment.enabled ? params.contingencyInvestment.value : 0;
                const totalPercent = laborPercent + miscPercent + contingencyPercent;

                // 4. Calculate the final Total Investment
                const finalTotalInvestment = (totalPercent < 1) ? baseInvestmentSubtotal / (1 - totalPercent) : baseInvestmentSubtotal;

                // 5. Now calculate the actual values for the new percentage-based items and add them
                const finalItems = [...baseItems];

                if (params.laborCostInvestment.enabled) {
                    const laborCost = finalTotalInvestment * laborPercent;
                    finalItems.push({ key: 'laborCostInvestment', label: params.laborCostInvestment.label, value: laborCost, formula: `${UI.formatCurrency(finalTotalInvestment, 0, false, true)} x ${(laborPercent * 100).toFixed(0)}%` });
                }
                if (params.miscCostInvestment.enabled) {
                    const miscCost = finalTotalInvestment * miscPercent;
                    finalItems.push({ key: 'miscCostInvestment', label: params.miscCostInvestment.label, value: miscCost, formula: `${UI.formatCurrency(finalTotalInvestment, 0, false, true)} x ${(miscPercent * 100).toFixed(0)}%` });
                }
                if (params.contingencyInvestment.enabled) {
                    const contingency = finalTotalInvestment * contingencyPercent;
                    finalItems.push({ key: 'contingencyInvestment', label: params.contingencyInvestment.label, value: contingency, formula: `${UI.formatCurrency(finalTotalInvestment, 0, false, true)} x ${(contingencyPercent * 100).toFixed(0)}%` });
                }

                return finalItems;
            },
            getRevenueBreakdown(yearData, inputs, results) { const items = []; const { details } = yearData; if (details.kwh.ac > 0) { items.push({ label: 'AC 充電服務費', value: details.kwh.ac * results.avgChargeFeeAC, formula: `${UI.formatCurrency(details.kwh.ac, 0, false, true)} kWh x ${UI.formatCurrency(results.avgChargeFeeAC, 2, false, true)}元` }); } if (details.kwh.dc > 0) { items.push({ label: 'DC 充電服務費', value: details.kwh.dc * results.avgChargeFeeDC, formula: `${UI.formatCurrency(details.kwh.dc, 0, false, true)} kWh x ${UI.formatCurrency(results.avgChargeFeeDC, 2, false, true)}元 (均價)` }); } return items; },
            getOverallRevenueBreakdown(results, inputs) { const totalRevenueItems = { 'AC 充電服務費': { value: 0, totalKwh: 0 }, 'DC 充電服務費': { value: 0, totalKwh: 0 }, }; results.annualData.forEach(yearData => { totalRevenueItems['AC 充電服務費'].value += (yearData.details.kwh.ac || 0) * results.avgChargeFeeAC; totalRevenueItems['AC 充電服務費'].totalKwh += yearData.details.kwh.ac || 0; totalRevenueItems['DC 充電服務費'].value += (yearData.details.kwh.dc || 0) * results.avgChargeFeeDC; totalRevenueItems['DC 充電服務費'].totalKwh += yearData.details.kwh.dc || 0; }); const finalItems = []; if (totalRevenueItems['AC 充電服務費'].value > 0) { finalItems.push({ label: 'AC 充電服務費', value: totalRevenueItems['AC 充電服務費'].value, formula: `${UI.formatCurrency(totalRevenueItems['AC 充電服務費'].totalKwh, 0, false, true)} kWh x ${UI.formatCurrency(results.avgChargeFeeAC, 2, false, true)}元` }); } if (totalRevenueItems['DC 充電服務費'].value > 0) { finalItems.push({ label: 'DC 充電服務費', value: totalRevenueItems['DC 充電服務費'].value, formula: `${UI.formatCurrency(totalRevenueItems['DC 充電服務費'].totalKwh, 0, false, true)} kWh x ${UI.formatCurrency(results.avgChargeFeeDC, 2, false, true)}元 (均價)` }); } return finalItems; },
            getOverallCostBreakdown(results, inputs) { const totalCostItemsMap = new Map(); const p = Config.calculationParams; const totalKwh = results.annualData.reduce((sum, d) => sum + d.kwhPerYear, 0); const totalTransactions = results.annualData.reduce((sum, d) => sum + (d.kwhPerYear / (inputs.avgKwhPerCar || 1)), 0); const totalRevenue = results.totalChargingRevenue; const totalGunCount = inputs.equipmentList.reduce((sum, item) => sum + item.gunCount, 0); results.annualData.forEach(yearData => { let costItems = yearData.details.costBreakdownItems; if (inputs.financingEnabled && inputs.depreciationMethod !== 'none') { costItems = costItems.filter(item => item.key !== 'principal'); } costItems.forEach(item => { if (totalCostItemsMap.has(item.label)) { totalCostItemsMap.get(item.label).value += item.value; } else { totalCostItemsMap.set(item.label, { value: item.value, formula: item.formula }); } }); }); return Array.from(totalCostItemsMap, ([label, data]) => ({ label, ...data })); },
            getOverallManagementCostBreakdown(results, inputs) { const items = []; const totalKwh = results.annualData.reduce((sum, d) => sum + d.kwhPerYear, 0); const totalRevenue = results.totalChargingRevenue; if (inputs.profitShareMethods.byAmount) { items.push({ label: '維運代管 (依度電)', value: results.annualData.reduce((sum, d) => sum + (d.details.costBreakdownItems.find(item => item.key === 'management_byAmount')?.value || 0), 0), formula: `${UI.formatCurrency(totalKwh, 0, false, true)} kWh x ${inputs.profitShareAmount} 元` }); } if (inputs.profitShareMethods.byPercentage) { items.push({ label: '維運代管 (依營收%)', value: results.annualData.reduce((sum, d) => sum + (d.details.costBreakdownItems.find(item => item.key === 'management_byPercentage')?.value || 0), 0), formula: `${UI.formatCurrency(totalRevenue, 0, false, true)} x ${inputs.profitSharePercentage * 100}%` }); } if (inputs.profitShareMethods.bySite) { items.push({ label: '維運代管 (站點計費)', value: results.annualData.reduce((sum, d) => sum + (d.details.costBreakdownItems.find(item => item.key === 'management_bySite')?.value || 0), 0), formula: `各年度加總` }); } return items; },
            getCostBreakdown(results, inputs, year, totalKwhSold, revenue, remainingLoanPrincipal) {
                const items = [];
                const p = Config.calculationParams;
                const numberOfTransactions = inputs.avgKwhPerCar > 0 ? totalKwhSold / inputs.avgKwhPerCar : 0;
                const totalGunCount = inputs.equipmentList.reduce((sum, item) => sum + item.gunCount, 0);
                const hasDC = inputs.equipmentList.some(item => item.spec.type !== 'AC');

                if (p.taipowerFee.enabled) {
                    const powerLoss = 1 + (p.powerLossRate.enabled ? p.powerLossRate.value : 0);
                    items.push({
                        key: 'taipowerFee',
                        label: p.taipowerFee.label,
                        value: totalKwhSold * p.taipowerFee.value * powerLoss,
                        formula: `${UI.formatCurrency(totalKwhSold, 0, false, true)}kWh x ${UI.formatCurrency(p.taipowerFee.value, 2, false, true)}元 x ${powerLoss.toFixed(2)} (含電損)`
                    });
                }

                if (p.monthlyCapacityFee.enabled && hasDC) {
                    items.push({
                        key: 'monthlyCapacityFee',
                        label: p.monthlyCapacityFee.label,
                        value: p.monthlyCapacityFee.value * 12,
                        formula: `${UI.formatCurrency(p.monthlyCapacityFee.value, 0, false, true)}元/月 x 12月`
                    });
                }

                if (inputs.rentMethod !== 'none') {
                    let rentCost = 0;
                    let formula = '';
                    switch(inputs.rentMethod) {
                        case 'bySpace':
                            const parkingSpaces = inputs.equipmentList.reduce((s, i) => s + i.parkingSpaces, 0);
                            rentCost = inputs.rentPerSpace * parkingSpaces * 12;
                            formula = `${UI.formatCurrency(inputs.rentPerSpace)}/車格 x ${parkingSpaces}車格 x 12月`;
                            break;
                        case 'byLand':
                            rentCost = inputs.rentPerLand * 12;
                            formula = `${UI.formatCurrency(inputs.rentPerLand)}/月 x 12月`;
                            break;
                        case 'byKwhShare':
                            rentCost = totalKwhSold * inputs.rentPerKwh;
                            formula = `${UI.formatCurrency(totalKwhSold, 0, false, true)} kWh x ${UI.formatCurrency(inputs.rentPerKwh)}元`;
                            break;
                        case 'byRevenueShare':
                            rentCost = revenue * inputs.rentPercentage;
                            formula = `${UI.formatCurrency(revenue, 0, false, true)}元 x ${inputs.rentPercentage * 100}%`;
                            break;
                        case 'byKwhTier':
                            const monthlyKwh = totalKwhSold / 12;
                            if (monthlyKwh > inputs.rentKwhThreshold) {
                                rentCost = inputs.rentTierType === 'byKwh' ? totalKwhSold * inputs.rentTierAboveValue : revenue * inputs.rentTierAboveValue;
                                formula = `度數>門檻, ${inputs.rentTierType === 'byKwh' ? '依度電' : '依營收'}`;
                            } else {
                                rentCost = inputs.rentTierType === 'byKwh' ? totalKwhSold * inputs.rentTierBelowValue : revenue * inputs.rentTierBelowValue;
                                formula = `度數<=門檻, ${inputs.rentTierType === 'byKwh' ? '依度電' : '依營收'}`;
                            }
                            break;
                    }
                    items.push({ key: 'rent', label: '租金', value: rentCost, formula });
                }

                if (!inputs.profitShareMethods.none) {
                    if (inputs.profitShareMethods.byAmount) {
                        items.push({
                            key: 'management_byAmount',
                            label: '維運代管 (依度電)',
                            value: totalKwhSold * inputs.profitShareAmount,
                            formula: `${UI.formatCurrency(totalKwhSold, 0, false, true)} kWh x ${inputs.profitShareAmount}元`
                        });
                    }
                    if (inputs.profitShareMethods.byPercentage) {
                        items.push({
                            key: 'management_byPercentage',
                            label: '維運代管 (依營收%)',
                            value: revenue * inputs.profitSharePercentage,
                            formula: `${UI.formatCurrency(revenue, 0, false, true)}元 x ${inputs.profitSharePercentage * 100}%`
                        });
                    }
                    if (inputs.profitShareMethods.bySite) {
                        let cost = (totalGunCount > inputs.gunCountThreshold) ? totalGunCount * inputs.siteFeePerGunMonthly * 12 : inputs.siteFeeMonthly * 12;
                        let formula = (totalGunCount > inputs.gunCountThreshold) ? `${totalGunCount}槍 x ${UI.formatCurrency(inputs.siteFeePerGunMonthly)}/月 x 12月` : `基本月費 ${UI.formatCurrency(inputs.siteFeeMonthly)} x 12月`;
                        items.push({
                            key: 'management_bySite',
                            label: '維運代管 (站點計費)',
                            value: cost,
                            formula
                        });
                    }
                }
                
                if (p.transactionFeeRate.enabled) {
                    items.push({ key: 'transactionFee', label: p.transactionFeeRate.label, value: revenue * p.transactionFeeRate.value, formula: `${UI.formatCurrency(revenue, 0, false, true)}元 x ${p.transactionFeeRate.value * 100}%` });
                }
                if (p.electronicInvoiceFeePerTransaction.enabled) {
                    items.push({ key: 'invoiceFee', label: p.electronicInvoiceFeePerTransaction.label, value: numberOfTransactions * p.electronicInvoiceFeePerTransaction.value, formula: `${Math.round(numberOfTransactions)}張 x ${UI.formatCurrency(p.electronicInvoiceFeePerTransaction.value, 1)}元` });
                }
                if (p.repairPartsRate.enabled) {
                    items.push({ key: 'repairFee', label: p.repairPartsRate.label, value: results.costBreakdown.totalDeviceCostUntaxed * p.repairPartsRate.value, formula: `${UI.formatCurrency(results.costBreakdown.totalDeviceCostUntaxed, 0, false, true)}元 x ${p.repairPartsRate.value * 100}%` });
                }
                if (p.electricalTechnicianFee.enabled && hasDC) {
                    items.push({ key: 'electricalTechFee', label: p.electricalTechnicianFee.label, value: p.electricalTechnicianFee.value, formula: '年度固定費用' });
                }
                if (p.maintenanceFee.enabled) {
                    items.push({ key: 'maintenanceFee', label: p.maintenanceFee.label, value: p.maintenanceFee.value, formula: '年度固定費用' });
                }
                if (p.insuranceFee.enabled) {
                    items.push({ key: 'insuranceFee', label: p.insuranceFee.label, value: p.insuranceFee.value, formula: '年度固定費用' });
                }
                if (p.extendedWarrantyPerPile.enabled && year >= p.extendedWarrantyStartYear.value) {
                    items.push({ key: 'warrantyFee', label: p.extendedWarrantyPerPile.label, value: results.costBreakdown.totalDeviceCostUntaxed * p.extendedWarrantyPerPile.value, formula: `${UI.formatCurrency(results.costBreakdown.totalDeviceCostUntaxed, 0, false, true)}元 x ${p.extendedWarrantyPerPile.value * 100}%` });
                }
                if (p.laborCost.enabled) {
                    items.push({ key: 'laborCost', label: p.laborCost.label, value: p.laborCost.value, formula: '年度固定費用' });
                }
                if (p.internetFee.enabled) {
                    items.push({ key: 'internetFee', label: '網路費', value: p.internetFee.value * 12, formula: `${UI.formatCurrency(p.internetFee.value)}元/月 x 12月` });
                }
                if (p.tdxUploadFee.enabled) {
                    items.push({ key: 'tdxFee', label: 'TDX上傳費', value: p.tdxUploadFee.value * totalGunCount * 12, formula: `${UI.formatCurrency(p.tdxUploadFee.value)}元/槍 x ${totalGunCount}槍 x 12月` });
                }
                
                if (inputs.financingEnabled && year <= inputs.loanTerm && remainingLoanPrincipal > 0) {
                    const interestPayment = remainingLoanPrincipal * inputs.interestRate;
                    const monthlyPayment = (remainingLoanPrincipal * (inputs.interestRate / 12)) / (1 - Math.pow(1 + (inputs.interestRate / 12), -(inputs.loanTerm - year + 1) * 12));
                    const principalPayment = (monthlyPayment * 12) - interestPayment;
                    items.push({ key: 'interest', label: '利息支出', value: interestPayment, formula: `剩餘本金 ${UI.formatCurrency(remainingLoanPrincipal, 0, false, true)} x ${inputs.interestRate * 100}%` });
                    items.push({ key: 'principal', label: '本金攤還', value: principalPayment, formula: '年度總還款 - 年度利息' });
                }
                
                if (inputs.depreciationMethod !== 'none' && year <= inputs.depreciationYears) {
                    const depreciableBase = results.costBreakdown.equipmentCost - results.costBreakdown.totalSalvageValue;
                    let depreciation = 0;
                    let formula = '';
                    if (inputs.depreciationMethod === 'straightLine') {
                        depreciation = depreciableBase / inputs.depreciationYears;
                        formula = `(設備成本 - 殘值) / ${inputs.depreciationYears}年`;
                    } else if (inputs.depreciationMethod === 'syd') {
                        const n = inputs.depreciationYears;
                        const sydDenominator = n * (n + 1) / 2;
                        depreciation = depreciableBase * ((n - year + 1) / sydDenominator);
                        formula = `年數合計法計算`;
                    }
                    items.push({ key: 'depreciation', label: '折舊', value: depreciation, formula });
                }
                return items;
            },
            calculateIRR(cashFlows) { let guess = 0.1; for (let i = 0; i < 100; i++) { let npv = 0, derivative = 0; for (let t = 0; t < cashFlows.length; t++) { npv += cashFlows[t] / Math.pow(1 + guess, t); if (t > 0) derivative -= t * cashFlows[t] / Math.pow(1 + guess, t + 1); } if (Math.abs(derivative) < 1e-7) break; const newGuess = guess - npv / derivative; if (Math.abs(newGuess - guess) < 1e-7) return newGuess; guess = newGuess; } return NaN; },
            getLastResults() { return this.lastResults; }
        };

        /**
         * =================================================================
         * CHARTS MODULE: Chart.js Integration
         * =================================================================
         */
        const Charts = {
            instances: {},
            init() {
                const yAxisTickFormatter = (v) => { if (isNaN(v)) return ''; const n = Number(v); if (Math.abs(n) >= 1e6) return `${(n / 1e6).toFixed(1)}M`; if (Math.abs(n) >= 1e3) return `${(n / 1e3).toFixed(0)}K`; return n.toLocaleString('en-US'); };
                const commonOptions = { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${UI.formatCurrency(c.raw)}` } } } };
                
                this.instances.revenueCost = new Chart(UI.elements.revenueCostChart, { type: 'bar', data: {}, options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { ticks: { callback: yAxisTickFormatter } } } } });
                this.instances.management = new Chart(UI.elements.managementChart, { type: 'bar', data: {}, options: { ...commonOptions, scales: { x: { grid: { display: false }, stacked: true }, y: { ticks: { callback: yAxisTickFormatter }, stacked: true } } } });
                this.instances.rent = new Chart(UI.elements.rentChart, { type: 'bar', data: {}, options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { ticks: { callback: yAxisTickFormatter } } } } });
                this.instances.cumulative = new Chart(UI.elements.cumulativePnlChart, { type: 'line', data: {}, options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { ticks: { callback: yAxisTickFormatter } } } } });
                this.instances.tou = new Chart(UI.elements.touPieChart, { type: 'doughnut', data: {}, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${c.raw}%` } } } } });
                
                // REMOVED: Initialize Cost Structure Chart
                
                // ADDED:
                if (UI.elements.sensitivityChart) { // Check if it exists (it's in a modal)
                    this.instances.sensitivity = new Chart(UI.elements.sensitivityChart, {
                        type: 'line',
                        data: {},
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (c) => {
                                            let label = c.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (c.raw === null) {
                                                label += '無法回收';
                                            } else if (c.parsed.y !== null) {
                                                const targetVar = UI.elements.targetVariable.value;
                                                if (targetVar === 'paybackPeriod') {
                                                    // Check if it's the "N/A" value
                                                    if (c.raw <= -UI.getInputs().operationYears) {
                                                        label += '無法回收';
                                                    } else {
                                                        label += `${(c.parsed.y * -1).toFixed(1)} 年`; // RE-INVERT for display
                                                    }
                                                } else if (targetVar === 'roi' || targetVar === 'irr') {
                                                    label += `${c.parsed.y.toFixed(1)}%`;
                                                } else {
                                                    label += UI.formatCurrency(c.parsed.y);
                                                }
                                            }
                                            return label;
                                        },
                                        title: (c) => {
                                            // X-axis label (e.g., -20%)
                                            return c[0].label;
                                        },
                                        afterTitle: (c) => {
                                            // Get the corresponding value from the chart object
                                            const chart = Charts.instances.sensitivity; // Use 'Charts.instances' to get the correct scope
                                            if (chart && chart.fullXLabels) {
                                                return chart.fullXLabels[c[0].dataIndex];
                                            }
                                            return '';
                                        }
                                    }
                                }
                            },
                            // ADDED THIS BLOCK TO SHOW POINTS
                            elements: {
                                point: {
                                    radius: 4,
                                    hoverRadius: 7,
                                    backgroundColor: '#4f46e5',
                                    borderColor: '#ffffff',
                                    borderWidth: 2
                                }
                            },
                            scales: {
                                x: { 
                                    grid: { display: false },
                                    title: { display: true, text: '變因' }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: { display: true, text: '目標' },
                                    ticks: {
                                        callback: (value) => {
                                            // Dynamic formatting for Y-axis
                                            const targetVar = UI.elements.targetVariable ? UI.elements.targetVariable.value : 'paybackPeriod';
                                            if (targetVar === 'paybackPeriod') {
                                                // Check for "N/A" value
                                                if (value <= -UI.getInputs().operationYears) {
                                                    return '無法回收';
                                                }
                                                return `${(value * -1).toFixed(1)} 年`; // RE-INVERT for display
                                            } else if (targetVar === 'roi' || targetVar === 'irr') {
                                                return `${value.toFixed(1)}%`;
                                            } else {
                                                return yAxisTickFormatter(value); // Use existing formatter
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            },
            generateLegend(chart, container) { /* Logic remains complex, kept as is */
                if (!chart || !container) return; container.innerHTML = ''; const legendItems = chart.legend.legendItems; if (!legendItems) return;
                legendItems.forEach((item) => {
                    const li = document.createElement('div'); li.className = 'flex items-center cursor-pointer';
                    const box = document.createElement('span'); box.className = 'h-3 w-3 rounded-sm mr-2';
                    let color = item.fillStyle || item.strokeStyle; box.style.backgroundColor = color; box.style.borderColor = item.strokeStyle; box.style.borderWidth = item.lineWidth + 'px';
                    const text = document.createElement('span'); text.className = 'text-gray-700 text-sm'; text.style.textDecoration = item.hidden ? 'line-through' : ''; text.innerText = item.text;
                    li.append(box, text);
                    li.onclick = () => { chart.isDatasetVisible(item.datasetIndex) ? chart.hide(item.datasetIndex) : chart.show(item.datasetIndex); this.generateLegend(chart, container); };
                    container.appendChild(li);
                });
            },
            update(inputs, results) {
                if (!this.instances.revenueCost) this.init();
                const labels = results.annualData.map(d => `第 ${d.year} 年`);
                
                // Revenue Cost Chart
                this.instances.revenueCost.data = { labels, datasets: [ { type: 'bar', label: '總營收', data: results.annualData.map(d => d.revenue), backgroundColor: 'rgba(59, 130, 246, 0.6)', borderRadius: 5 }, { type: 'bar', label: '總成本', data: results.annualData.map(d => d.cost), backgroundColor: 'rgba(255, 159, 64, 0.6)', borderRadius: 5 }, { type: 'bar', label: '充電淨利', data: results.annualData.map(d => d.pnl), backgroundColor: 'rgba(239, 68, 68, 0.5)', borderRadius: 5 } ] };
                this.instances.revenueCost.update();
                this.generateLegend(this.instances.revenueCost, UI.elements.revenueCostChartLegend);

                // Management Chart
                const managementDatasets = [];
                if (inputs.profitShareMethods.byAmount) managementDatasets.push({ label: '維運代管 (依度電)', data: results.annualData.map(d => d.details.costBreakdownItems.find(i => i.key === 'management_byAmount')?.value || 0), backgroundColor: 'rgba(168, 85, 247, 0.7)', borderRadius: 5 });
                if (inputs.profitShareMethods.byPercentage) managementDatasets.push({ label: '維運代管 (依營收%)', data: results.annualData.map(d => d.details.costBreakdownItems.find(i => i.key === 'management_byPercentage')?.value || 0), backgroundColor: 'rgba(20, 184, 166, 0.7)', borderRadius: 5 });
                if (inputs.profitShareMethods.bySite) managementDatasets.push({ label: '維運代管 (站點計費)', data: results.annualData.map(d => d.details.costBreakdownItems.find(i => i.key === 'management_bySite')?.value || 0), backgroundColor: 'rgba(249, 115, 22, 0.7)', borderRadius: 5 });
                this.instances.management.data = { labels, datasets: managementDatasets };
                this.instances.management.options.scales.x.stacked = false;
                this.instances.management.options.scales.y.stacked = false;
                this.instances.management.update();
                this.generateLegend(this.instances.management, UI.elements.managementChartLegend);
                UI.elements.managementChart.closest('.card').style.display = !inputs.profitShareMethods.none ? 'flex' : 'none';

                // Rent Chart
                const rentData = results.annualData.map(d => d.details.costBreakdownItems.find(item => item.key === 'rent')?.value || 0);
                const rentLabel = results.annualData.find(d => d.details.costBreakdownItems.some(i => i.key === 'rent'))?.details.costBreakdownItems.find(i => i.key === 'rent').label || '租金&分潤';
                this.instances.rent.data = { labels, datasets: [{ label: rentLabel, data: rentData, backgroundColor: 'rgba(34, 197, 94, 0.7)', borderRadius: 5 }] };
                this.instances.rent.update();
                this.generateLegend(this.instances.rent, UI.elements.rentChartLegend);
                UI.elements.rentChart.closest('.card').style.display = rentData.some(d => d > 0) ? 'flex' : 'none';

                // Cumulative PNL Chart
                this.instances.cumulative.data = { labels: ['投資額', ...labels], datasets: [{ label: '累積稅前淨利', data: [-results.totalInvestment, ...results.annualData.map(d => d.cumulativePnl)], borderColor: 'rgba(54, 162, 235, 1)', tension: 0.1, fill: true, backgroundColor: (c) => { const { ctx, chartArea, scales } = c.chart; if (!chartArea) return null; const g = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom); const z = scales.y.getPixelForValue(0); const zp = (z - chartArea.top) / chartArea.height; if (!isFinite(zp)) return 'rgba(219, 234, 254, 0.6)'; const cz = Math.max(0, Math.min(1, zp)); g.addColorStop(0, 'rgba(219, 234, 254, 0.6)'); g.addColorStop(cz, 'rgba(219, 234, 254, 0.6)'); g.addColorStop(cz, 'rgba(254, 226, 226, 0.6)'); g.addColorStop(1, 'rgba(254, 226, 226, 0.6)'); return g; } }] };
                this.instances.cumulative.update();
                this.generateLegend(this.instances.cumulative, UI.elements.cumulativePnlChartLegend);
                
                // TOU Pie Chart
                UI.elements.touPieChartContainer.style.display = inputs.billingMethodDC === 'tou' ? 'block' : 'none';
                if (inputs.billingMethodDC === 'tou') {
                    this.instances.tou.data = { labels: ['尖峰', '離峰', '假日'], datasets: [{ data: [inputs.touRatios.peak * 100, inputs.touRatios.offpeak * 100, inputs.touRatios.holiday * 100].map(v => v.toFixed(0)), backgroundColor: ['#ef4444', '#10b981', '#3b82f6'] }] };
                    this.instances.tou.update();
                }

                // REMOVED: Update Cost Structure Chart
            }
        };

        /**
         * =================================================================
         * TOU EDITOR MODULE: Handles the 7-day Time-of-Use grid editor
         * =================================================================
         */
        const TouEditor = {
            isPainting: false, paintType: 'peak',
            dayKeys: ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'],
            dayNames: { mon: '週一', tue: '週二', wed: '週三', thu: '週四', fri: '週五', sat: '週六', sun: '週日' },
            init() { this.createGrid(); this.addEventListeners(); this.renderGrid(); this.updateDisplayPercentages(); },
            createGrid() { const c = UI.elements.touGridContainer; c.innerHTML = `<div></div>${this.dayKeys.map(k => `<div class="tou-grid-header">${this.dayNames[k]}</div>`).join('')}`; for (let h = 0; h < 24; h++) { c.innerHTML += `<div class="tou-grid-time">${String(h).padStart(2,'0')}:00</div>${this.dayKeys.map(d => `<div class="tou-grid-cell" data-day="${d}" data-hour="${h}"></div>`).join('')}`; } },
            addEventListeners() { const grid = UI.elements.touGridContainer; grid.addEventListener('mousedown', e => { e.preventDefault(); this.isPainting = true; this.paintType = document.querySelector('input[name="touRateType"]:checked').value; this.paintCell(e.target); }); grid.addEventListener('mouseover', e => { if (this.isPainting) this.paintCell(e.target); }); document.addEventListener('mouseup', () => this.isPainting = false); document.addEventListener('mouseleave', () => this.isPainting = false); },
            paintCell(cell) { if (!cell.classList.contains('tou-grid-cell')) return; cell.className = `tou-grid-cell ${this.paintType} painting`; const { day, hour } = cell.dataset; Config.touSchedule[day][hour] = this.paintType; this.updateDisplayPercentages(); },
            renderGrid() { for (const day of this.dayKeys) { for (let h = 0; h < 24; h++) { const cell = document.querySelector(`.tou-grid-cell[data-day="${day}"][data-hour="${h}"]`); if (cell) cell.className = `tou-grid-cell ${Config.touSchedule[day][h]}`; } } },
            updateDisplayPercentages() { const { roundedPeak, roundedOffPeak, roundedHoliday } = this.calculatePercentages(); UI.elements.peakPercentDisplay.textContent = `(${roundedPeak}%)`; UI.elements.offpeakPercentDisplay.textContent = `(${roundedOffPeak}%)`; UI.elements.holidayPercentDisplay.textContent = `(${roundedHoliday}%)`; },
            calculatePercentages() { let totalMinutes = { peak: 0, offpeak: 0, holiday: 0 }; this.dayKeys.forEach(day => Config.touSchedule[day].forEach(type => totalMinutes[type] += 60)); const totalWeekMinutes = 7 * 24 * 60; let peakPercent = (totalMinutes.peak / totalWeekMinutes) * 100; let offpeakPercent = (totalMinutes.offpeak / totalWeekMinutes) * 100; const roundedPeak = Math.round(peakPercent); const roundedOffPeak = Math.round(offpeakPercent); return { roundedPeak, roundedOffPeak, roundedHoliday: 100 - roundedPeak - roundedOffPeak }; },
            saveAndApply() { const { roundedPeak, roundedOffPeak, roundedHoliday } = this.calculatePercentages(); UI.elements.peakUsageRatio.value = roundedPeak; UI.elements.offPeakUsageRatio.value = roundedOffPeak; UI.elements.holidayUsageRatio.value = roundedHoliday; return true; }
        };

        /**
         * =================================================================
         * PERSISTENCE MODULE: Local Storage Access
         * =================================================================
         */
        const Persistence = {
            STORAGE_KEY_PREFIX: 'chargingStationAnalysis_v13_',
            init() {
                const lastSession = localStorage.getItem(`${this.STORAGE_KEY_PREFIX}lastSession`);
                lastSession ? this.applyState(JSON.parse(lastSession)) : this.loadDefaultState();
            },
            getCurrentState() { return { inputs: UI.getInputs(), siteName: UI.elements.siteNameDisplay.textContent, config: { deviceSpecs: Config.deviceSpecs, calculationParams: Config.calculationParams, passwords: Config.passwords, touSchedule: Config.touSchedule } }; },
            saveSession() { localStorage.setItem(`${this.STORAGE_KEY_PREFIX}lastSession`, JSON.stringify(this.getCurrentState())); },
            deleteSession() { localStorage.removeItem(`${this.STORAGE_KEY_PREFIX}lastSession`); },
            saveRecord(name, data) { let list = this.getRecordList(); if (!list.includes(name)) list.push(name); localStorage.setItem(`${this.STORAGE_KEY_PREFIX}recordList`, JSON.stringify(list)); localStorage.setItem(`${this.STORAGE_KEY_PREFIX}record_${name}`, JSON.stringify(data)); },
            loadRecord(name) { const data = localStorage.getItem(`${this.STORAGE_KEY_PREFIX}record_${name}`); if (data) { const parsed = JSON.parse(data); this.applyState(parsed); UI.elements.siteNameDisplay.textContent = parsed.siteName || name; App.update(); } },
            deleteRecord(name) { let list = this.getRecordList(); const index = list.indexOf(name); if (index > -1) list.splice(index, 1); localStorage.setItem(`${this.STORAGE_KEY_PREFIX}recordList`, JSON.stringify(list)); localStorage.removeItem(`${this.STORAGE_KEY_PREFIX}record_${name}`); },
            getRecordList() { return JSON.parse(localStorage.getItem(`${this.STORAGE_KEY_PREFIX}recordList`) || '[]'); },
            loadDefaultState() {
                UI.addEquipmentRow({ power: '7', count: 1 });
                const weekday = Array(24).fill('offpeak');
                for (let i = 15; i < 21; i++) weekday[i] = 'peak';
                const holiday = Array(24).fill('holiday');
                Config.touSchedule = { mon: [...weekday], tue: [...weekday], wed: [...weekday], thu: [...weekday], fri: [...weekday], sat: [...holiday], sun: [...holiday] };
            },
            applyState(state) {
                if (state.config) {
                    if (state.config.deviceSpecs) Object.assign(Config.deviceSpecs, state.config.deviceSpecs);
                    if (state.config.calculationParams) Object.keys(Config.calculationParams).forEach(key => { if (state.config.calculationParams[key]) Object.assign(Config.calculationParams[key], state.config.calculationParams[key]); });
                    if (state.config.passwords) Object.assign(Config.passwords, state.config.passwords);
                    if (state.config.touSchedule) Config.touSchedule = state.config.touSchedule;
                }
                if (state.inputs) {
                    const { inputs } = state;
                    const commaFields = ['infrastructureCostMain', 'rentPerSpace', 'rentPerLand', 'kwhPerGunPerMonthDC', 'rentKwhThreshold'];

                    Object.keys(inputs).forEach(key => {
                        const el = UI.elements[key];
                        const val = inputs[key];
                        if (el && typeof val !== 'object' && typeof val !== 'undefined') {
                            if (el.type === 'checkbox') {
                                el.checked = val;
                            } else if (key.includes('Rate') || key.includes('Percentage')) {
                                el.value = val * 100;
                            } else if (commaFields.includes(key)) {
                                // Apply comma formatting
                                el.value = (val !== null) ? Number(val).toLocaleString('en-US') : '';
                            } else {
                                el.value = val;
                            }
                        } else if (key.startsWith('rentTier') && key.endsWith('Type')) {
                            // This is now obsolete, handled by the loop below
                        }
                    });
                     // Radio buttons
                    ['billingMethodDC', 'revenueMethodAC', 'revenueMethodDC', 'depreciationMethod', 'rentMethod', 'rentTierType'].forEach(name => {
                        if (inputs[name]) {
                            const el = document.querySelector(`input[name="${name}"][value="${inputs[name]}"]`);
                            if(el) el.checked = true;
                        }
                    });
                    // Checkboxes
                    if (inputs.profitShareMethods) Object.entries(inputs.profitShareMethods).forEach(([key, val]) => {
                        const elId = `profitShare${key.charAt(0).toUpperCase() + key.slice(1)}`;
                        if (UI.elements[elId]) UI.elements[elId].checked = val;
                    });

                    UI.elements.equipmentListContainer.innerHTML = '';
                    if (inputs.equipmentList?.length > 0) {
                        inputs.equipmentList.forEach(equip => UI.addEquipmentRow({ power: equip.power, count: equip.count }));
                    } else {
                        UI.addEquipmentRow({ power: '7', count: 1 });
                    }
                }
                if (state.siteName) UI.elements.siteNameDisplay.textContent = state.siteName;
            }
        };

        /**
         * =================================================================
         * APP INITIALIZATION
         * =================================================================
         */
        App.init();

    })();
});
    </script>
</body>
</html>
