<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>充電站投資效益分析 (v6.5 - 介面調整)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f8fafc; /* Updated: slate-50 */
        }
        .input-field {
            background-color: white; 
            color: #1f2937; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            padding: 0.65rem 0.85rem; 
            text-align: center;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); 
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); 
        }
        .input-field.readonly {
            background-color: #e5e7eb; 
            color: #6b7280; 
            cursor: not-allowed;
        }
        .label-text {
            font-weight: 600; 
            color: #374151; 
        }
        .card {
            border-radius: 1rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            padding: 2rem; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .summary-card {
            background: linear-gradient(135deg, #4f46e5, #3b82f6); 
            color: white;
            border-radius: 1rem; 
            padding: 2rem; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .summary-value {
            font-size: 1.75rem; 
            font-weight: 800;
            line-height: 1.2;
            margin-top: 0.25rem; 
        }
        .summary-label {
            font-size: 2.25rem; 
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 700; 
            margin-bottom: 0.25rem; 
        }
        .table-header { 
            background-color: rgba(0,0,0,0.04);
            color: #374151; 
            font-weight: 700; 
        }
        .table-cell { 
            padding: 0.9rem 1.2rem; 
            text-align: right; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .table-cell-year { 
            font-weight: 700; 
            color: #1f2937; 
            text-align: left; 
        }
        #pnlTableBody tr:nth-child(even), #kwhStatsTableBody tr:nth-child(even) {
             background-color: rgba(255, 255, 255, 0.6);
        }
        #pnlTableBody tr.pnl-row:hover, #kwhStatsTableBody tr:hover {
            background-color: #eff6ff; 
            transition: background-color 0.2s ease;
        }
        #pnlTableBody tr.pnl-row {
            cursor: pointer;
        }
        .details-row td {
            padding: 0;
            background-color: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .details-container {
            padding: 1.5rem;
            max-width: 48rem;
            margin: auto;
        }
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem 2.5rem;
        }
        .details-section h4 {
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .details-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            align-items: baseline;
            font-size: 0.875rem;
            padding: 0.3rem 0;
        }
        .details-item span:first-child {
            color: #6b7280;
            text-align: left;
        }
        .details-item span:last-child {
            color: #1f2937;
            font-weight: 500;
            text-align: right;
        }

        .radio-label { 
            display: inline-flex; 
            align-items: center; 
            cursor: pointer; 
            margin-right: 1.25rem; 
            user-select: none; 
        }
        .radio-label input { display: none; }
        .radio-label span { 
            padding: 0.4rem 1rem; 
            border-radius: 9999px; 
            background-color: #e5e7eb; 
            color: #4b5563; 
            transition: all 0.2s ease; 
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .radio-label input:checked + span { 
            background-color: #4f46e5; 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 2px 5px 0 rgba(79, 70, 229, 0.3); 
        }
        .hidden-section { display: none; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out forwards; 
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem; 
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            animation: slideIn 0.3s ease-out forwards; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: #1f2937; }
        .modal-close-btn { 
            background: none; border: none; 
            font-size: 1.5rem;
            cursor: pointer; 
            color: #6b7280; transition: color 0.2s ease;
            line-height: 1;
        }
        .modal-close-btn:hover { color: #374151; }
        .modal-table-input { 
            width: 100%; text-align: right; padding: 0.4rem; 
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            background-color: #f9fafb; 
        }
        .modal-table-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .modal-table-input.readonly {
             background-color: #e5e7eb; 
            color: #6b7280; 
            cursor: not-allowed;
        }
        .modal-action-button {
            background-color: #4f46e5; 
            color: white;
            padding: 0.75rem 1.75rem; 
            border-radius: 0.6rem; 
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
            cursor: pointer;
        }
        .modal-action-button:hover {
            background-color: #4338ca; 
            transform: translateY(-1px); 
        }
        .modal-message {
            margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem;
            font-weight: 500; text-align: center; display: none; 
        }
        .modal-message.error { background-color: #fee2e2; color: #ef4444; }
        .modal-message.success { background-color: #d1fae5; color: #10b981; }
        .password-section-compact { font-size: 0.9rem; }
        .password-section-compact .grid { gap: 0.5rem 1rem; }
        .password-section-compact .input-field { padding: 0.5rem 0.75rem; }
        
        /* Modal Tabs */
        .modal-tabs { border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem; }
        .modal-tab-btn {
            padding: 0.75rem 1.25rem; border: none; background: none;
            font-size: 1rem; font-weight: 600; color: #6b7280;
            cursor: pointer; transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .modal-tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }

        .salvage-display {
            color: #ef4444; /* text-red-500 */
            font-weight: 500;
            vertical-align: middle;
        }

        /* UPDATED: Explainer styles for alignment */
        #explanationList li {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 1rem;
        }
        #explanationList li > div {
            flex-grow: 1;
        }
        #explanationList li > span {
            flex-shrink: 0;
            text-align: right;
        }
        #explanationList li[data-target] {
            cursor: pointer;
            transition: color 0.2s ease, background-color 0.2s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin-left: -0.5rem; /* Offset padding */
        }
        #explanationList li[data-target]:hover {
            color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
        }
        #explanationModalBody .explainer-grid {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0 1.5rem;
            align-items: baseline;
        }
        #explanationModalBody .explainer-grid > span { 
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        #explanationModalBody .explainer-grid > span:nth-child(3n+1) { font-weight: 500; color: #374151; }
        #explanationModalBody .explainer-grid > span:nth-child(3n+2) { color: #6b7280; font-size: 0.875rem; }
        #explanationModalBody .explainer-grid > span:nth-child(3n+3) { font-weight: 600; text-align: right; }
        #explanationModalBody .explainer-total {
            border-top: 2px solid #e5e7eb;
            font-weight: 700;
            font-size: 1.125rem;
            color: #111827;
            border-bottom: none;
        }


        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #kwhTableIcon.rotate-180 { transform: rotate(180deg); }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-800 leading-tight">充電站投資效益分析</h1>
            <p class="text-xl text-gray-600 mt-3">互動式損益評估工具 (v6.4 - 參數調整)</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card bg-white">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">設置參數</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-2">
                            <span class="label-text col-span-1">設備功率</span>
                            <select id="devicePowerSelect" class="input-field col-span-2"></select>
                        </div>
                        <div id="pileCountGroup" class="grid grid-cols-2 items-center gap-4">
                            <!-- Dynamically populated -->
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">車格數值</span>
                            <input type="number" id="parkingSpaces" class="input-field readonly" readonly>
                        </div>
                         <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">設備費用</span>
                            <input type="text" id="equipmentCostDisplayMain" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">設備殘值</span>
                            <input type="text" id="salvageValueDisplay" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">基礎設施工程</span>
                            <input type="text" id="infrastructureCostMain" class="input-field" value="500,000">
                        </div>
                    </div>
                </div>

                <div class="card bg-white">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">營運與成本假設</h2>
                    <div class="space-y-4">
                        <div>
                            <span class="label-text mb-3 block">收費方式</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="billingMethod" value="fixed" checked><span>固定費率</span></label>
                                <label class="radio-label"><input type="radio" name="billingMethod" value="tou"><span>尖離峰</span></label>
                            </div>
                        </div>
                        <div id="fixedRateSection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">每度電收費 (元)</span>
                            <input type="number" id="chargeFeePerKwh" class="input-field" value="10" step="0.1">
                        </div>
                        <div id="touRateSection" class="hidden-section space-y-4">
                             <div class="grid grid-cols-2 items-center gap-4">
                                  <span class="label-text font-bold text-indigo-600">尖離峰均價</span>
                                  <input type="text" id="avgTouRate" class="input-field readonly font-bold text-indigo-600" readonly>
                             </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">尖峰費率 (元)</span><input type="number" id="peakRate" class="input-field" value="12" step="0.1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">離峰費率 (元)</span><input type="number" id="offPeakRate" class="input-field" value="8" step="0.1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">假日費率 (元)</span><input type="number" id="holidayRate" class="input-field" value="10" step="0.1">
                            </div>
                            <div class="flex items-center gap-4 mt-2">
                                <div id="touPieChartContainer" class="w-24 h-24 flex-shrink-0">
                                    <canvas id="touPieChart"></canvas>
                                </div>
                                <div class="flex-grow space-y-2">
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="peakUsageRatio" class="text-sm font-medium">尖峰 %</label>
                                        <input type="number" id="peakUsageRatio" data-tou="peak" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="offPeakUsageRatio" class="text-sm font-medium">離峰 %</label>
                                        <input type="number" id="offPeakUsageRatio" data-tou="offpeak" class="input-field col-span-2 tou-ratio-input" value="80" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="holidayUsageRatio" class="text-sm font-medium">假日 %</label>
                                        <input type="number" id="holidayUsageRatio" data-tou="holiday" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">營收估算方式</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byCars" checked><span>依車次</span></label>
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byKwh"><span>依度數</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">每日車次/槍</span><input type="text" id="carsPerGunPerDay" class="input-field" value="3">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                           <span class="label-text">每月度數/槍</span><input type="text" id="kwhPerGunPerMonth" class="input-field" value="2,700">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">每車平均充電 (kWh)</span>
                            <input type="number" id="avgKwhPerCar" class="input-field" value="30">
                        </div>
                        <hr class="border-gray-200"/>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">需求年增率 (%)</span><input type="number" id="demandGrowthRate" class="input-field" value="20">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">預計營運期 (年)</span><input type="number" id="operationYears" class="input-field" value="15" min="1">
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">折舊攤提方式</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="depreciationMethod" value="straightLine" checked><span>直線法</span></label>
                                <label class="radio-label"><input type="radio" name="depreciationMethod" value="syd"><span>年數合計法</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">折舊攤提年限</span><input type="number" id="depreciationYears" class="input-field" value="5" min="1">
                        </div>
                         <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">租金成本</span>
                            <div class="flex flex-wrap gap-3 mb-3">
                                <label class="radio-label"><input type="radio" name="rentMethod" value="bySpace" checked><span>依車格</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="byLand"><span>依土地</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="none"><span>無</span></label>
                            </div>
                            <div class="space-y-4">
                                <div id="rentBySpaceSection" class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">車格租金/月</span><input type="text" id="rentPerSpace" class="input-field" value="500">
                                </div>
                                <div id="rentByLandSection" class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">土地租金/月</span><input type="text" id="rentPerLand" class="input-field" value="15,000">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="summary-card">
                        <div class="summary-label">總投資額</div>
                        <div id="totalInvestment" class="summary-value">NT$ 0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">預計回收年限</div>
                        <div id="paybackPeriod" class="summary-value">N/A</div>
                    </div>
                </div>
                <div class="card bg-sky-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5">年度充電淨利</h2>
                    <div class="flex-grow h-80">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
                <div class="card bg-sky-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5">累積損益與回收年限</h2>
                    <div class="flex-grow h-80">
                        <canvas id="cumulativePnlChart"></canvas>
                    </div>
                </div>
                <div class="card bg-sky-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5">年度營收與成本圖表</h2>
                    <div class="flex-grow h-80">
                        <canvas id="revenueCostChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 space-y-8">
            <div class="card bg-teal-50">
                <div class="flex justify-between items-center cursor-pointer" id="toggleKwhTableBtn">
                    <h2 class="text-2xl font-bold text-gray-800">預估充電度數</h2>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium text-gray-500">單位：kWh</span>
                        <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg id="kwhTableIcon" class="w-6 h-6 text-gray-600 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="kwhTableContainer" class="overflow-hidden transition-all duration-500 ease-in-out" style="max-height: 0px;">
                    <div class="overflow-x-auto rounded-lg border border-gray-200 mt-5">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header">
                                <tr>
                                    <th class="table-cell text-left">年度</th>
                                    <th class="table-cell">充電度數/日 (平均)</th>
                                    <th class="table-cell">充電度數/月 (平均)</th>
                                    <th class="table-cell">充電度數/年</th>
                                </tr>
                            </thead>
                            <tbody id="kwhStatsTableBody" class="bg-white divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card bg-teal-50">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl font-bold text-gray-800">充電收支/年</h2>
                    <span class="text-sm font-medium text-gray-500">單位：元</span>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="table-cell text-left">年度</th>
                                <th class="table-cell">總營收</th>
                                <th class="table-cell">總成本</th>
                                <th class="table-cell">充電淨利</th>
                                <th class="table-cell">累積稅前淨利</th>
                            </tr>
                        </thead>
                        <tbody id="pnlTableBody" class="bg-white divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <!-- Calculation Explanation Section -->
                <div class="mt-8 pt-5 border-t border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-3">計算方式說明</h3>
                            <ul id="explanationList" class="list-disc list-inside text-gray-700 space-y-2">
                                <li data-target="investment">
                                    <div><strong>總投資額：</strong>建置充電站所需的所有初期花費。</div>
                                    <span id="explainerTotalInvestment" class="font-semibold text-blue-700"></span>
                                </li>
                                <li data-target="revenue">
                                    <div><strong>總營收：</strong>年度收入，依營收模型與需求年增率計算。</div>
                                    <span id="explainerTotalRevenue" class="font-semibold text-green-700"></span>
                                </li>
                                <li data-target="cost">
                                    <div><strong>總成本：</strong>年度營運的所有開銷，含電費、維護、折舊等。</div>
                                    <span id="explainerTotalCost" class="font-semibold text-red-700"></span>
                                </li>
                                <li>
                                    <div><strong>預計回收年限：</strong>「累積稅前淨利」由負轉正的年度。</div>
                                    <span id="explainerPaybackPeriod" class="font-semibold text-gray-700"></span>
                                </li>
                            </ul>
                        </div>
                        <div class="text-right mt-2">
                            <button id="openAdvancedModalBtn" class="text-sm bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition-all duration-200 ease-in-out shadow-md hover:shadow-lg">
                                ⚙️ 進階設定
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Advanced Settings Modal -->
    <div id="advancedModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">進階設定</h3>
                <button id="closeAdvancedModalBtn" class="modal-close-btn">&times;</button>
            </div>
            
            <div id="advancedPasswordSection" class="space-y-4 password-section-compact max-w-sm mx-auto text-center">
                <span class="label-text block mb-2">請輸入管理密碼</span>
                <input type="password" id="advancedPassword" class="input-field" placeholder="預設密碼: 0000">
                <button id="loginAdvancedBtn" class="modal-action-button w-full">登入</button>
                <div id="advancedMessage" class="modal-message"></div>
            </div>

            <div id="advancedContentSection" class="hidden">
                <div class="modal-tabs">
                    <button class="modal-tab-btn active" data-tab="specs">設備規格</button>
                    <button class="modal-tab-btn" data-tab="formulas">計算參數</button>
                    <button class="modal-tab-btn" data-tab="password">修改密碼</button>
                </div>

                <!-- Tab 1: Specs -->
                <div id="tab-specs" class="modal-tab-content active">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl font-bold text-gray-800">設備價格設定</h4>
                        <span class="text-sm font-medium text-gray-500">單位：元</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border-collapse">
                            <thead class="table-header">
                                <tr>
                                    <th class="p-2 text-left w-[20%]">規格名稱</th>
                                    <th class="p-2 text-left w-[15%]">組件</th>
                                    <th class="p-2 text-right w-[16%]">設備成本(未稅)</th>
                                    <th class="p-2 text-right w-[16%]">設備成本 (含稅)</th>
                                    <th class="p-2 text-right w-[16%]">設定殘值%</th>
                                    <th class="p-2 text-right w-[17%]">預估殘值</th>
                                </tr>
                            </thead>
                            <tbody id="specsModalTableBody"></tbody>
                        </table>
                    </div>
                     <div class="mt-4 text-left text-sm text-gray-500">
                        <p><strong>說明：</strong>180kW 跟 360kW 比較：</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>當設置小於等於3樁(6車格)時, 180kW較划算。</li>
                            <li>若超過3樁時則 360kW較划算。</li>
                        </ul>
                    </div>
                </div>

                <!-- Tab 2: Formulas -->
                <div id="tab-formulas" class="modal-tab-content">
                     <h4 class="text-xl font-bold text-gray-800 mb-4">詳細計算參數</h4>
                     <div id="formulaContainer" class="space-y-3"></div>
                </div>

                <!-- Tab 3: Password -->
                <div id="tab-password" class="modal-tab-content">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">修改管理密碼</h4>
                    <div class="space-y-4 password-section-compact max-w-md mx-auto">
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">舊密碼</span>
                            <input type="password" id="oldPassword" class="input-field">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">新密碼</span>
                            <input type="password" id="newPassword" class="input-field">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">確認新密碼</span>
                            <input type="password" id="confirmNewPassword" class="input-field">
                        </div>
                        <div class="text-center">
                            <button id="changePasswordBtn" class="modal-action-button bg-green-600 hover:bg-green-700">確認儲存新密碼</button>
                        </div>
                        <div id="passwordChangeMessage" class="modal-message"></div>
                    </div>
                </div>
                
                <div class="mt-8 text-right">
                    <button id="saveAdvancedBtn" class="modal-action-button">儲存設定並關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="explanationModalTitle" class="modal-title">計算方式說明</h3>
                <button id="closeExplanationModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div id="explanationModalBody" class="mt-4 text-gray-700">
                <!-- Dynamic content goes here -->
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    /**
     * =================================================================
     * APP MODULE: Main Controller
     * Initializes the application, wires up event listeners, and
     * orchestrates the overall workflow.
     * =================================================================
     */
    const App = {
        isAdjustingTou: false, // Flag to prevent recursion in TOU adjustment
        previousRentValues: { bySpace: 500, byLand: 15000 },

        init() {
            Persistence.load();
            UI.init();
            this.setupEventListeners();
            this.update();
        },

        setupEventListeners() {
            // --- Main Input Listeners ---
            const inputsToWatch = [
                'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'carsPerGunPerDay', 
                'kwhPerGunPerMonth', 'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 
                'depreciationYears', 'rentPerSpace', 'rentPerLand', 'infrastructureCostMain'
            ];
            inputsToWatch.forEach(id => UI.elements[id]?.addEventListener('input', () => this.update()));
            
            // Listen for dynamic pile/terminal count inputs
            UI.elements.pileCountGroup.addEventListener('input', (e) => {
                if(e.target.id === 'pileCount' || e.target.id === 'terminalCount') {
                    this.update();
                }
            });

            UI.elements.devicePowerSelect.addEventListener('change', () => {
                UI.updatePileCountUI(Config.deviceSpecs[UI.elements.devicePowerSelect.value]);
                this.update();
            });

            // --- Radio Button Listeners ---
            document.querySelectorAll('input[name="billingMethod"], input[name="revenueMethod"], input[name="rentMethod"], input[name="depreciationMethod"]')
                .forEach(radio => radio.addEventListener('change', () => this.update()));

            // --- TOU Ratio Listeners ---
            document.querySelectorAll('.tou-ratio-input').forEach(input => {
                input.addEventListener('input', (e) => this.handleTouRatioChange(e));
            });
            
            // --- Table & Modal Listeners ---
            UI.elements.toggleKwhTableBtn.addEventListener('click', UI.toggleKwhTable);
            UI.elements.pnlTableBody.addEventListener('click', (e) => {
                const row = e.target.closest('.pnl-row');
                if (row) UI.togglePnlDetails(row, Calculator.getLastResults());
            });

            // --- Advanced Modal Listeners ---
            UI.elements.openAdvancedModalBtn.addEventListener('click', () => UI.openModal(UI.elements.advancedModal));
            UI.elements.closeAdvancedModalBtn.addEventListener('click', () => UI.closeModal(UI.elements.advancedModal));
            UI.elements.loginAdvancedBtn.addEventListener('click', () => this.handleAdvancedLogin());
            UI.elements.advancedPassword.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.handleAdvancedLogin(); });
            UI.elements.saveAdvancedBtn.addEventListener('click', () => this.saveAdvancedSettings());
            UI.elements.changePasswordBtn.addEventListener('click', () => this.changePassword());
            
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                btn.addEventListener('click', UI.handleTabSwitch);
            });

            // --- Explainer Modal Listeners ---
            UI.elements.explanationList.addEventListener('click', (e) => this.handleExplanationClick(e));
            UI.elements.closeExplanationModalBtn.addEventListener('click', () => UI.closeModal(UI.elements.explanationModal));


            // --- Formatting Listeners ---
            ['kwhPerGunPerMonth', 'rentPerSpace', 'rentPerLand', 'infrastructureCostMain'].forEach(id => {
                UI.elements[id]?.addEventListener('blur', (e) => UI.formatNumericInput(e.target));
            });
        },

        /**
         * The main update loop. Triggered by any input change.
         */
        update() {
            const inputs = UI.getInputs(this.previousRentValues);
            
            // Update linked inputs (e.g., cars vs. kWh)
            UI.updateLinkedInputs(inputs);
            
            // Store previous rent values for smart restoration
            if (inputs.rentMethod === 'bySpace') this.previousRentValues.bySpace = inputs.rentPerSpace;
            if (inputs.rentMethod === 'byLand') this.previousRentValues.byLand = inputs.rentPerLand;
            
            const results = Calculator.run(inputs, Config.calculationParams, Config.deviceSpecs);
            UI.updateDisplay(inputs, results);
            Charts.update(inputs, results);
        },

        /**
         * Handles changes in TOU ratio inputs to ensure they always sum to 100.
         */
        handleTouRatioChange(e) {
            if (this.isAdjustingTou) return;
            this.isAdjustingTou = true;

            const changedInput = e.target;
            let changedValue = UI.getNumericValue(changedInput.id, 0, 100);

            const otherInputs = Array.from(document.querySelectorAll('.tou-ratio-input')).filter(el => el !== changedInput);
            let otherTotal = otherInputs.reduce((sum, el) => sum + UI.getNumericValue(el.id), 0);

            if (changedValue + otherTotal > 100) {
                let overflow = (changedValue + otherTotal) - 100;
                for (let input of otherInputs) {
                    let currentValue = UI.getNumericValue(input.id);
                    if (currentValue > 0 && otherTotal > 0) {
                        let reduction = (currentValue / otherTotal) * overflow;
                        let newValue = Math.max(0, currentValue - reduction);
                        input.value = newValue.toFixed(0);
                    }
                }
            }
            
            // Final check to ensure total is exactly 100
            let finalTotal = Array.from(document.querySelectorAll('.tou-ratio-input')).reduce((sum, el) => sum + UI.getNumericValue(el.id), 0);
            let diff = 100 - finalTotal;

            if (diff !== 0) {
                const inputsToAdjust = otherInputs.length > 0 ? otherInputs : [changedInput];
                inputsToAdjust.sort((a, b) => UI.getNumericValue(b.id) - UI.getNumericValue(a.id));
                let largestInput = inputsToAdjust[0];
                largestInput.value = Math.min(100, Math.max(0, UI.getNumericValue(largestInput.id) + diff));
            }

            this.isAdjustingTou = false;
            this.update();
        },
        
        handleAdvancedLogin() {
            if (UI.elements.advancedPassword.value === Config.passwords.advanced) {
                UI.showAdvancedContent(true);
                UI.populateSpecsModal(Config.deviceSpecs, Config.calculationParams);
                UI.populateFormulasModal(Config.calculationParams);
            } else {
                UI.showModalMessage(UI.elements.advancedMessage, '密碼錯誤，請重試。');
            }
        },

        saveAdvancedSettings() {
            // Save specs
            const specInputs = UI.elements.specsModalTableBody.querySelectorAll('input[data-power]');
            specInputs.forEach(input => {
                const power = input.dataset.power;
                const type = input.dataset.type;
                if (Config.deviceSpecs[power] && type) {
                    Config.deviceSpecs[power][type] = parseFloat(input.value.replace(/,/g,'')) || 0;
                }
            });

            // Save formulas (values are already updated by listeners, but we re-read just in case)
            const formulaInputs = UI.elements.formulaContainer.querySelectorAll('input[type="text"]');
            const formulaCheckboxes = UI.elements.formulaContainer.querySelectorAll('input[type="checkbox"]');
            formulaInputs.forEach(input => {
                const key = input.dataset.key;
                if (Config.calculationParams[key] && !Config.calculationParams[key].readonly) {
                    const isPercentage = Config.calculationParams[key].unit === '%';
                    const numVal = parseFloat(input.value.replace(/,/g, ''));
                    if (!isNaN(numVal)) {
                        Config.calculationParams[key].value = isPercentage ? numVal / 100 : numVal;
                    }
                }
            });
            formulaCheckboxes.forEach(checkbox => {
                const key = checkbox.dataset.key;
                if (Config.calculationParams[key]) { // Allow saving readonly checkbox state
                    Config.calculationParams[key].enabled = checkbox.checked;
                }
            });
            
            Persistence.save();
            this.update();
            UI.closeModal(UI.elements.advancedModal);
        },
        
        changePassword() {
            const oldPass = UI.elements.oldPassword.value;
            const newPass = UI.elements.newPassword.value;
            const confirmPass = UI.elements.confirmNewPassword.value;

            if (oldPass !== Config.passwords.advanced) {
                UI.showModalMessage(UI.elements.passwordChangeMessage, '舊密碼不正確。');
                return;
            }
            if (!newPass || newPass.length < 4) {
                UI.showModalMessage(UI.elements.passwordChangeMessage, '新密碼長度至少需要4位數。');
                return;
            }
            if (newPass !== confirmPass) {
                UI.showModalMessage(UI.elements.passwordChangeMessage, '新密碼與確認密碼不相符。');
                return;
            }
            Config.passwords.advanced = newPass;
            Persistence.save();
            UI.showModalMessage(UI.elements.passwordChangeMessage, '密碼已成功更新！', false);
            setTimeout(() => {
                UI.elements.oldPassword.value = '';
                UI.elements.newPassword.value = '';
                UI.elements.confirmNewPassword.value = '';
                UI.elements.passwordChangeMessage.style.display = 'none';
            }, 2000);
        },

        handleExplanationClick(e) {
            const targetLi = e.target.closest('li[data-target]');
            if (!targetLi) return;
            const type = targetLi.dataset.target;
            UI.openExplanationModal(type, Calculator.getLastResults(), UI.getInputs());
        }
    };

    /**
     * =================================================================
     * CONFIG MODULE: Data and Parameters
     * Holds all static and configurable data for the application,
     * such as device specs, calculation parameters, and passwords.
     * =================================================================
     */
    const Config = {
        passwords: {
            advanced: '0000'
        },
        deviceSpecs: {
            '7': { name: 'AC 7kW Smart', cost: 29900, power: 7, type: 'AC', salvage: 2990 },
            '30': { name: 'DC 30kW', cost: 310000, power: 30, type: 'DC', salvage: 31000 },
            '120': { name: 'DC 120kW', cost: 810000, power: 120, type: 'DC', salvage: 81000 },
            '180': { name: 'DC 180kW', cost: 950000, power: 180, type: 'DC', salvage: 95000 },
            '360': { 
                name: 'DC 360kW', power: 360, type: 'DC_360',
                cabinetCost: 1500000, terminalCost: 480000,
                cabinetSalvage: 150000, terminalSalvage: 48000
            }
        },
        calculationParams: {
            // Initial Investment
            deviceCost: { value: 0, label: '設備總成本 (未稅)', unit: '元', description: '所有充電樁的未稅總成本 (自動計算)。', enabled: true, category: 'investment', readonly: true },
            lineSubsidyPerKw: { value: 500, label: '台電線路補助費/kW', unit: '元', description: '台電線補費，每kW收取的一次性費用。', enabled: true, category: 'investment' },
            technicianFee: { value: 150000, label: '技師簽證費', unit: '元', description: '台電外包技師費用(一次性)。', enabled: true, category: 'investment' },
            distributionPanelFee: { value: 300000, label: '高/低壓配電盤', unit: '元', description: '高壓或低壓配電盤費用(一次性)。', enabled: true, category: 'investment' },
            constructionFee: { value: 500000, label: '基礎設施工程', unit: '元', description: '場地土木、基礎、裝修等工程費用(一次性)。', enabled: true, category: 'investment', readonly: true },
            meterFeeBase: { value: 12000, label: '電錶費用(基本)', unit: '元', description: '台電電表基本費用(僅DC樁, 一次性)。', enabled: true, category: 'investment' },
            meterFeePerGun: { value: 1400, label: '電錶費用/槍', unit: '元', description: '每增加一槍的電表費用(僅DC樁, 一次性)。', enabled: true, category: 'investment' },
            taxRate: { value: 0.05, label: '營業稅率', unit: '%', description: '設備購買及相關服務的營業稅率。', enabled: true, category: 'investment' },
            
            // Annual Costs
            taipowerFee: { value: 4, label: '台電平均電費', unit: '元', description: '向台電購電的每度平均成本。', enabled: true, category: 'annual' },
            electricalTechnicianFee: { value: 15000, label: '高壓用電技術人員/年', unit: '元', description: '每年收取一次技師檢定費。', enabled: true, category: 'annual' },
            maintenanceFee: { value: 37000, label: '維運&客服/年', unit: '元', description: '年度場域維護與線上客服費用。', enabled: true, category: 'annual' },
            transactionFeeRate: { value: 0.03, label: '金流手續費', unit: '%', description: '支付給金流服務商的每筆交易手續費率。', enabled: true, category: 'annual' },
            insuranceFee: { value: 8500, label: '意外保險費/年', unit: '元', description: '場域年度意外險費用。', enabled: true, category: 'annual' },
            electronicInvoiceFeePerTransaction: { value: 1.2, label: '電子發票/張', unit: '元', description: '每筆交易的電子發票成本。', enabled: true, category: 'annual' },
            repairPartsRate: { value: 0.01, label: '設備維護備品', unit: '%', description: '年度維修備品費用，為設備含稅總成本的百分比。', enabled: true, category: 'annual' },
            extendedWarrantyPerPile: { value: 1000, label: '保固延保(樁)/年', unit: '元', description: '每支充電樁的年度延長保固費用。', enabled: true, category: 'annual' },
            laborCost: { value: 60000, label: '勞務成本/年', unit: '元', description: '年度人力、巡檢等相關勞務成本。', enabled: true, category: 'annual' },
            internetFee: { value: 500, label: '網路費/月', unit: '元', description: '場域每月的網路通訊費用。', enabled: true, category: 'annual' },
            tdxUploadFee: { value: 299, label: 'TDX上傳費(槍/月)', unit: '元', description: '每支槍每月上傳資料至交通部TDX平台的費用。', enabled: true, category: 'annual' },
            powerLossRate: { value: 0.05, label: '充電電損率', unit: '%', description: '電力在傳輸和轉換過程中的損耗率。', enabled: true, category: 'annual' },
        }
    };

    /**
     * =================================================================
     * UI MODULE: DOM Manipulation and User Interface
     * Handles all interactions with the DOM, such as caching elements,
     * updating values, toggling visibility, and populating modals.
     * =================================================================
     */
    const UI = {
        elements: {},

        init() {
            this.cacheDOMElements();
            this.populateDeviceSelect();
            this.updatePileCountUI(Config.deviceSpecs[this.elements.devicePowerSelect.value]);
            this.updateUIVisibility();
        },

        cacheDOMElements() {
            const ids = [
                'devicePowerSelect', 'pileCountGroup', 'parkingSpaces', 'equipmentCostDisplayMain', 'salvageValueDisplay',
                'infrastructureCostMain',
                'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'avgTouRate', 'carsPerGunPerDay', 'kwhPerGunPerMonth',
                'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 'depreciationYears',
                'fixedRateSection', 'touRateSection',
                'rentPerSpace', 'rentPerLand', 'rentBySpaceSection', 'rentByLandSection',
                'totalInvestment', 'paybackPeriod', 'pnlTableBody', 'cumulativePnlChart', 'touPieChart',
                'touPieChartContainer', 'peakUsageRatio', 'offPeakUsageRatio', 'holidayUsageRatio',
                'kwhStatsTableBody', 'toggleKwhTableBtn', 'kwhTableIcon', 'kwhTableContainer', 'pnlChart',
                'revenueCostChart', // NEW
                // Advanced Modal
                'advancedModal', 'closeAdvancedModalBtn', 'openAdvancedModalBtn',
                'advancedPasswordSection', 'advancedPassword', 'loginAdvancedBtn', 'advancedMessage',
                'advancedContentSection', 'specsModalTableBody', 'formulaContainer',
                'oldPassword', 'newPassword', 'confirmNewPassword', 'changePasswordBtn', 'passwordChangeMessage',
                'saveAdvancedBtn',
                // Explainer
                'explanationList', 'explainerTotalInvestment', 'explainerTotalRevenue', 'explainerTotalCost',
                'explainerPaybackPeriod', // NEW
                'explanationModal', 'explanationModalTitle', 'explanationModalBody', 'closeExplanationModalBtn'
            ];
            ids.forEach(id => this.elements[id] = document.getElementById(id));
        },
        
        getNumericValue(id, defaultValue = 0, max = Infinity) {
            const element = document.getElementById(id);
            if (!element) return defaultValue;
            const value = parseFloat(String(element.value).replace(/,/g, ''));
            return isNaN(value) ? defaultValue : Math.min(value, max);
        },

        formatCurrency(value, precision = 0, shorthand = false, unitOnly = false) {
            if (isNaN(value) || value === null) return 'N/A';
            const num = Number(value);
            if (shorthand) {
                if (Math.abs(num) >= 1e6) return `NT$ ${(num / 1e6).toFixed(1)}M`;
                if (Math.abs(num) >= 1e3) return `NT$ ${(num / 1e3).toFixed(0)}K`;
            }
            const numberString = num.toLocaleString('en-US', { minimumFractionDigits: precision, maximumFractionDigits: precision });
            return unitOnly ? numberString : `NT$ ${numberString}`;
        },

        formatNumericInput(element) {
            const value = this.getNumericValue(element.id, null);
            if (value !== null) {
                element.value = value.toLocaleString('en-US');
            }
        },
        
        getInputs(previousRentValues) {
            const power = this.elements.devicePowerSelect.value;
            const spec = Config.deviceSpecs[power];
            let pileCount = 0, gunCount = 0, cabinetCount = 0, parkingSpaces = 0;

            if (spec.type === 'DC_360') {
                gunCount = this.getNumericValue('terminalCount', 1);
                cabinetCount = Math.ceil(gunCount / 6);
                pileCount = gunCount; // For cost calculation, each terminal is a "pile"
                parkingSpaces = gunCount * 2;
            } else {
                pileCount = this.getNumericValue('pileCount', 1);
                gunCount = (spec.type === 'DC' && spec.power > 30) ? pileCount * 2 : pileCount;
                parkingSpaces = gunCount;
            }

            const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;
            let rentPerSpace = this.getNumericValue('rentPerSpace');
            let rentPerLand = this.getNumericValue('rentPerLand');

            if (rentMethod === 'none') {
                rentPerSpace = 0;
                rentPerLand = 0;
            } else if (rentMethod === 'bySpace') {
                rentPerLand = 0; // Only one value is active
            } else { // byLand
                rentPerSpace = 0; // Only one value is active
            }

            return {
                power, spec, pileCount, gunCount, cabinetCount, parkingSpaces,
                billingMethod: document.querySelector('input[name="billingMethod"]:checked').value,
                chargeFeePerKwh: this.getNumericValue('chargeFeePerKwh'),
                peakRate: this.getNumericValue('peakRate'),
                offPeakRate: this.getNumericValue('offPeakRate'),
                holidayRate: this.getNumericValue('holidayRate'),
                revenueMethod: document.querySelector('input[name="revenueMethod"]:checked').value,
                carsPerGunPerDay: this.getNumericValue('carsPerGunPerDay'),
                kwhPerGunPerMonth: this.getNumericValue('kwhPerGunPerMonth'),
                avgKwhPerCar: this.getNumericValue('avgKwhPerCar'),
                demandGrowthRate: this.getNumericValue('demandGrowthRate') / 100,
                operationYears: this.getNumericValue('operationYears', 1),
                depreciationYears: this.getNumericValue('depreciationYears', 1),
                depreciationMethod: document.querySelector('input[name="depreciationMethod"]:checked').value,
                infrastructureCostMain: this.getNumericValue('infrastructureCostMain'),
                rentMethod, rentPerSpace, rentPerLand,
                touRatios: {
                    peak: this.getNumericValue('peakUsageRatio') / 100,
                    offpeak: this.getNumericValue('offPeakUsageRatio') / 100,
                    holiday: this.getNumericValue('holidayUsageRatio') / 100,
                }
            };
        },

        populateDeviceSelect() {
            Object.keys(Config.deviceSpecs).forEach(power => {
                const option = document.createElement('option');
                option.value = power;
                option.textContent = Config.deviceSpecs[power].name;
                this.elements.devicePowerSelect.appendChild(option);
            });
            this.elements.devicePowerSelect.value = '120'; // Default
        },

        updatePileCountUI(spec) {
            const container = this.elements.pileCountGroup;
            container.innerHTML = ''; 
            if (spec.type === 'DC_360') {
                container.className = 'grid grid-cols-1 items-center gap-4';
                container.innerHTML = `
                    <div class="grid grid-cols-2 items-center gap-2">
                        <span class="label-text">能源櫃</span>
                        <input type="number" id="cabinetCount" class="input-field readonly" value="1" readonly>
                    </div>
                    <div class="grid grid-cols-2 items-center gap-2">
                        <span class="label-text">充電樁(終端機)</span>
                        <input type="number" id="terminalCount" class="input-field" value="2" min="1">
                    </div>`;
            } else {
                container.className = 'grid grid-cols-2 items-center gap-4';
                container.innerHTML = `
                    <span class="label-text">充電樁數量</span>
                    <input type="number" id="pileCount" class="input-field" value="1" min="1">`;
            }
        },

        updateUIVisibility() {
            const billingMethod = document.querySelector('input[name="billingMethod"]:checked').value;
            this.elements.fixedRateSection.style.display = billingMethod === 'fixed' ? 'grid' : 'none';
            this.elements.touRateSection.style.display = billingMethod === 'tou' ? 'block' : 'none';

            const revenueMethod = document.querySelector('input[name="revenueMethod"]:checked').value;
            this.elements.carsPerGunPerDay.readOnly = revenueMethod === 'byKwh';
            this.elements.kwhPerGunPerMonth.readOnly = revenueMethod === 'byCars';
            this.elements.carsPerGunPerDay.classList.toggle('readonly', revenueMethod === 'byKwh');
            this.elements.kwhPerGunPerMonth.classList.toggle('readonly', revenueMethod === 'byCars');
            
            const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;
            this.elements.rentBySpaceSection.style.display = rentMethod === 'bySpace' ? 'grid' : 'none';
            this.elements.rentByLandSection.style.display = rentMethod === 'byLand' ? 'grid' : 'none';
        },
        
        updateLinkedInputs(inputs) {
            if (inputs.revenueMethod === 'byCars') {
                const calculatedKwh = inputs.carsPerGunPerDay * inputs.avgKwhPerCar * 30;
                this.elements.kwhPerGunPerMonth.value = Math.round(calculatedKwh).toLocaleString('en-US');
            } else { // byKwh
                const calculatedCars = inputs.avgKwhPerCar > 0 ? (inputs.kwhPerGunPerMonth / 30) / inputs.avgKwhPerCar : 0;
                this.elements.carsPerGunPerDay.value = calculatedCars.toFixed(1);
            }
        },

        updateDisplay(inputs, results) {
            this.updateUIVisibility();

            // Update summary cards
            this.elements.totalInvestment.textContent = this.formatCurrency(results.totalInvestment);
            this.elements.paybackPeriod.textContent = results.paybackPeriod;

            // Update derived input fields
            this.elements.parkingSpaces.value = inputs.parkingSpaces;
            if (inputs.billingMethod === 'tou') {
                this.elements.avgTouRate.value = this.formatCurrency(results.avgChargeFee, 2, false, true);
            }
            if (inputs.spec.type === 'DC_360') {
                 document.getElementById('cabinetCount').value = inputs.cabinetCount;
            }

            // Update main cost displays
            this.elements.equipmentCostDisplayMain.value = this.formatCurrency(results.costBreakdown.equipmentCost, 0, false, true);
            this.elements.salvageValueDisplay.value = this.formatCurrency(results.costBreakdown.totalSalvageValue, 0, false, true);

            // Update tables
            this.populateTable(this.elements.kwhStatsTableBody, results.annualData, (data) => `
                <tr>
                    <td class="table-cell table-cell-year">第 ${data.year} 年</td>
                    <td class="table-cell text-green-600 font-semibold">${data.kwhPerDay.toLocaleString('en-US', {maximumFractionDigits: 1})}</td>
                    <td class="table-cell text-blue-600 font-semibold">${data.kwhPerMonth.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td class="table-cell text-red-600 font-semibold">${data.kwhPerYear.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                </tr>
            `);

            this.populateTable(this.elements.pnlTableBody, results.annualData, (data) => `
                <tr class="pnl-row" data-year="${data.year}">
                    <td class="table-cell table-cell-year">第 ${data.year} 年</td>
                    <td class="table-cell">${this.formatCurrency(data.revenue, 0, false, true)}</td>
                    <td class="table-cell">${this.formatCurrency(data.cost, 0, false, true)}</td>
                    <td class="table-cell ${data.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">${this.formatCurrency(data.pnl, 0, false, true)}</td>
                    <td class="table-cell font-semibold ${data.cumulativePnl >= 0 ? 'text-blue-600' : 'text-orange-600'}">${this.formatCurrency(data.cumulativePnl, 0, false, true)}</td>
                </tr>
            `);

            // Update explainer section
            this.elements.explainerTotalInvestment.textContent = this.formatCurrency(results.totalInvestment);
            const firstYearData = results.annualData[0];
            if (firstYearData) {
                this.elements.explainerTotalRevenue.textContent = `${this.formatCurrency(firstYearData.revenue)} (第一年)`;
                this.elements.explainerTotalCost.textContent = `${this.formatCurrency(firstYearData.cost)} (第一年)`;
            } else {
                this.elements.explainerTotalRevenue.textContent = 'N/A';
                this.elements.explainerTotalCost.textContent = 'N/A';
            }
            this.elements.explainerPaybackPeriod.textContent = results.paybackPeriod;

            // Update advanced settings modal if it's open
            const advancedDeviceCostInput = document.getElementById('input_deviceCost');
            if(advancedDeviceCostInput) {
                advancedDeviceCostInput.value = this.formatCurrency(results.costBreakdown.totalDeviceCostUntaxed, 0, false, true);
            }
            const advancedInfraCostInput = document.getElementById('input_constructionFee');
            if(advancedInfraCostInput) {
                advancedInfraCostInput.value = this.formatCurrency(inputs.infrastructureCostMain, 0, false, true);
            }
        },
        
        populateTable(tbody, data, rowTemplate) {
            tbody.innerHTML = '';
            data.forEach(item => {
                tbody.insertAdjacentHTML('beforeend', rowTemplate(item));
            });
        },

        toggleKwhTable() {
            const container = UI.elements.kwhTableContainer;
            const icon = UI.elements.kwhTableIcon;
            icon.classList.toggle('rotate-180');
            if (container.style.maxHeight && container.style.maxHeight !== '0px') {
                container.style.maxHeight = '0px';
            } else {
                container.style.maxHeight = container.scrollHeight + 'px';
            }
        },

        togglePnlDetails(row, results) {
            const year = parseInt(row.dataset.year);
            const existingDetailsRow = this.elements.pnlTableBody.querySelector(`.details-row[data-year="${year}"]`);

            // Close all other details rows
            this.elements.pnlTableBody.querySelectorAll('.details-row').forEach(dr => {
                if (dr !== existingDetailsRow) dr.remove();
            });

            if (existingDetailsRow) {
                existingDetailsRow.remove(); // Toggle off
            } else {
                const yearData = results.annualData.find(d => d.year === year);
                if (yearData && yearData.details) {
                    const detailsHtml = this.createDetailsHtml(yearData.details);
                    const newRow = document.createElement('tr');
                    newRow.className = 'details-row';
                    newRow.dataset.year = year;
                    newRow.innerHTML = `<td colspan="5">${detailsHtml}</td>`;
                    row.after(newRow);
                }
            }
        },

        createDetailsHtml(details) {
            const createSection = (title, data) => {
                let itemsHtml = Object.entries(data)
                    .filter(([, value]) => value > 0)
                    .map(([key, value]) => `
                        <div class="details-item">
                            <span>${key.replace(/\/.*$/, '')}</span>
                            <span>${this.formatCurrency(value, 0, false, true)}</span>
                        </div>
                    `).join('');
                return `<div class="details-section"><h4>${title}</h4>${itemsHtml}</div>`;
            };
            const revenueHtml = createSection('總營收細項', details.revenue);
            const costsHtml = createSection('總成本細項', details.costs);
            return `<div class="details-container"><div class="details-grid">${revenueHtml}${costsHtml}</div></div>`;
        },

        // --- Modal Methods ---
        openModal(modal) { modal.style.display = 'flex'; },
        closeModal(modal) {
            modal.style.display = 'none';
            // Specific cleanup for advanced modal
            if (modal.id === 'advancedModal') {
                this.showAdvancedContent(false);
                this.elements.advancedPassword.value = '';
                this.showModalMessage(this.elements.advancedMessage, '', false, true);
            }
        },
        showModalMessage(element, message, isError = true, hide = false) {
            if (hide) {
                element.style.display = 'none';
                return;
            }
            element.textContent = message;
            element.className = `modal-message ${isError ? 'error' : 'success'}`;
            element.style.display = 'block';
        },
        showAdvancedContent(show) {
            this.elements.advancedPasswordSection.style.display = show ? 'none' : 'block';
            this.elements.advancedContentSection.style.display = show ? 'block' : 'none';
        },
        handleTabSwitch(event) {
            const tabId = event.target.dataset.tab;
            document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        },
        populateSpecsModal(deviceSpecs, calculationParams) {
            const tableBody = this.elements.specsModalTableBody;
            tableBody.innerHTML = '';
            const taxRate = calculationParams.taxRate.enabled ? calculationParams.taxRate.value : 0;

            Object.entries(deviceSpecs).forEach(([power, spec]) => {
                if (spec.type === 'DC_360') {
                    const createRow = (component, cost, salvage) => {
                        const costTaxed = cost * (1 + taxRate);
                        const salvagePercentage = cost > 0 ? (salvage / cost * 100).toFixed(1) : 10;
                        return `
                            <td>${component}</td>
                            <td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="${component.toLowerCase()}Cost" value="${cost.toLocaleString('en-US')}"></td>
                            <td class="text-right p-2">${this.formatCurrency(costTaxed, 0, false, true)}</td>
                            <td><input type="number" class="modal-table-input salvage-percent-input" value="${salvagePercentage}"></td>
                            <td class="text-right salvage-display p-2" data-power="${power}" data-type="${component.toLowerCase()}Salvage">${salvage.toLocaleString('en-US')}</td>`;
                    };
                    tableBody.insertAdjacentHTML('beforeend', `
                        <tr><td class="font-semibold align-middle" rowspan="2">${spec.name}</td>${createRow('Cabinet', spec.cabinetCost, spec.cabinetSalvage)}</tr>
                        <tr>${createRow('Terminal', spec.terminalCost, spec.terminalSalvage)}</tr>`);
                } else {
                    const costTaxed = spec.cost * (1 + taxRate);
                    const salvagePercentage = spec.cost > 0 ? (spec.salvage / spec.cost * 100).toFixed(1) : 10;
                    tableBody.insertAdjacentHTML('beforeend', `
                        <tr>
                            <td class="font-semibold align-middle">${spec.name}</td><td>充電樁</td>
                            <td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="cost" value="${spec.cost.toLocaleString('en-US')}"></td>
                            <td class="text-right p-2">${this.formatCurrency(costTaxed, 0, false, true)}</td>
                            <td><input type="number" class="modal-table-input salvage-percent-input" value="${salvagePercentage}"></td>
                            <td class="text-right salvage-display p-2" data-power="${power}" data-type="salvage">${spec.salvage.toLocaleString('en-US')}</td>
                        </tr>`);
                }
            });
            this.addSpecInputListeners(tableBody);
        },
        addSpecInputListeners(tableBody) {
            const focusable = Array.from(tableBody.querySelectorAll('.cost-input, .salvage-percent-input'));
            focusable.forEach((input, index) => {
                input.addEventListener('focus', (e) => {
                    e.target.dataset.originalValue = e.target.value;
                });
                
                input.addEventListener('keydown', (e) => {
                    switch (e.key) {
                        case 'Enter':
                        case 'ArrowDown':
                            e.preventDefault();
                            if (e.key === 'Enter') {
                                e.target.blur(); // Format the number
                            }
                            const nextIndex = (index + 1) % focusable.length;
                            focusable[nextIndex].focus();
                            focusable[nextIndex].select();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            const prevIndex = (index - 1 + focusable.length) % focusable.length;
                            focusable[prevIndex].focus();
                            focusable[prevIndex].select();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            e.target.value = e.target.dataset.originalValue;
                            e.target.blur();
                            break;
                    }
                });

                input.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    const costInput = row.querySelector('.cost-input');
                    const percentInput = row.querySelector('.salvage-percent-input');
                    const salvageValueDisplay = row.querySelector('.salvage-display');
                    
                    const cost = parseFloat(costInput.value.replace(/,/g,'')) || 0;
                    const percent = parseFloat(percentInput.value) || 0;
                    salvageValueDisplay.textContent = Math.round((cost * percent) / 100).toLocaleString('en-US');
                });
                 input.addEventListener('blur', (e) => {
                    const value = parseFloat(e.target.value.replace(/,/g, '')) || 0;
                    e.target.value = value.toLocaleString('en-US');
                });
            });
        },
        populateFormulasModal(calculationParams) {
            const container = this.elements.formulaContainer;
            container.innerHTML = '';
            const categories = { investment: '總投資額項目', annual: '年度成本項目' };
            const lastResults = Calculator.getLastResults();
            const inputs = this.getInputs();

            Object.keys(categories).forEach(catKey => {
                const header = document.createElement('h5');
                header.className = 'text-lg font-bold text-indigo-700 mt-4 pb-2 border-b';
                header.textContent = categories[catKey];
                container.appendChild(header);

                Object.entries(calculationParams).forEach(([key, param]) => {
                    if (param.category === catKey) {
                        const isPercentage = param.unit === '%';
                        
                        let formattedValue;
                        let isReadonly = param.readonly || false;
                        let customClass = isReadonly ? 'readonly' : '';
                        
                        if (key === 'deviceCost') {
                            const untaxedCost = lastResults.costBreakdown ? lastResults.costBreakdown.totalDeviceCostUntaxed : 0;
                            formattedValue = this.formatCurrency(untaxedCost, 0, false, true);
                        } else if (key === 'constructionFee') {
                            formattedValue = this.formatCurrency(inputs.infrastructureCostMain, 0, false, true);
                        }
                        else {
                            const displayValue = isPercentage ? param.value * 100 : param.value;
                            formattedValue = isPercentage ? displayValue : displayValue.toLocaleString('en-US', {maximumFractionDigits: 2});
                        }

                        container.insertAdjacentHTML('beforeend', `
                            <div class="grid grid-cols-1 md:grid-cols-12 items-center gap-2 border-b border-gray-100 pb-3">
                                <div class="md:col-span-4 flex items-center">
                                    <input type="checkbox" id="check_${key}" data-key="${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3" ${param.enabled ? 'checked' : ''}>
                                    <label for="check_${key}" class="font-medium text-gray-800">${param.label}</label>
                                </div>
                                <div class="md:col-span-5"><p class="text-sm text-gray-500">${param.description}</p></div>
                                <div class="md:col-span-3 flex items-center">
                                    <input type="text" id="input_${key}" data-key="${key}" value="${formattedValue}" class="modal-table-input ${customClass}" ${isReadonly ? 'readonly' : ''}>
                                    <span class="ml-2 text-gray-600 w-10 text-left">${param.unit}</span>
                                </div>
                            </div>`);
                    }
                });
            });
            this.addFormulaInputListeners();
        },
        addFormulaInputListeners() {
            const container = this.elements.formulaContainer;
            
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const key = e.target.dataset.key;
                    if (Config.calculationParams[key]) {
                        Config.calculationParams[key].enabled = e.target.checked;
                        Persistence.save();
                        App.update();
                    }
                });
            });

            const textInputs = container.querySelectorAll('input[type="text"]:not([readonly])');
            textInputs.forEach((input, index) => {
                input.addEventListener('focus', (e) => {
                    e.target.dataset.originalValue = e.target.value;
                });

                input.addEventListener('keydown', (e) => {
                    const focusable = Array.from(textInputs);
                    const currentIndex = focusable.indexOf(e.target);

                    switch (e.key) {
                        case 'Enter':
                        case 'ArrowDown':
                            e.preventDefault();
                            if (e.key === 'Enter') {
                                const key = e.target.dataset.key;
                                const param = Config.calculationParams[key];
                                if (param) {
                                    const isPercentage = param.unit === '%';
                                    const numericValue = parseFloat(e.target.value.replace(/,/g, ''));
                                    if (!isNaN(numericValue)) {
                                        param.value = isPercentage ? numericValue / 100 : numericValue;
                                        e.target.value = isPercentage ? numericValue : numericValue.toLocaleString('en-US', { maximumFractionDigits: 2 });
                                        Persistence.save();
                                        App.update();
                                        e.target.style.transition = 'border-color 0.1s ease-in-out';
                                        e.target.style.borderColor = '#10b981';
                                        setTimeout(() => { e.target.style.borderColor = ''; }, 1000);
                                    }
                                }
                            }
                            const nextIndex = (currentIndex + 1) % focusable.length;
                            focusable[nextIndex].focus();
                            focusable[nextIndex].select();
                            break;
                        
                        case 'ArrowUp':
                            e.preventDefault();
                            const prevIndex = (currentIndex - 1 + focusable.length) % focusable.length;
                            focusable[prevIndex].focus();
                            focusable[prevIndex].select();
                            break;

                        case 'Escape':
                            e.preventDefault();
                            e.target.value = e.target.dataset.originalValue;
                            e.target.blur();
                            break;
                    }
                });
            });
        },
        openExplanationModal(type, results, inputs) {
            const { calculationParams } = Config;
            const body = this.elements.explanationModalBody;
            let title = '';
            let contentHtml = '';
            const firstYearData = results.annualData[0];

            const buildGrid = (items, total) => {
                let gridHtml = '<div class="explainer-grid">';
                items.forEach(item => {
                    gridHtml += `
                        <span>${item.label}</span>
                        <span>${item.formula}</span>
                        <span>${this.formatCurrency(item.value)}</span>
                    `;
                });
                gridHtml += `
                    <span class="explainer-total">總計</span>
                    <span class="explainer-total"></span>
                    <span class="explainer-total">${this.formatCurrency(total)}</span>
                `;
                gridHtml += '</div>';
                return gridHtml;
            };

            switch (type) {
                case 'investment':
                    title = '總投資額 計算說明';
                    const investmentItems = Calculator.getInvestmentBreakdown(inputs, calculationParams);
                    contentHtml = buildGrid(investmentItems, results.totalInvestment);
                    break;

                case 'revenue':
                    title = '總營收 計算說明 (第一年)';
                    if (firstYearData) {
                        const revenueItems = Calculator.getRevenueBreakdown(firstYearData, inputs);
                        contentHtml = buildGrid(revenueItems, firstYearData.revenue);
                    } else {
                        contentHtml = '<p>尚無第一年資料可供計算。</p>';
                    }
                    break;

                case 'cost':
                    title = '總成本 計算說明 (第一年)';
                    if (firstYearData) {
                        const totalKwhSold_yr1 = firstYearData.kwhPerYear;
                        const numberOfTransactions_yr1 = inputs.avgKwhPerCar > 0 ? totalKwhSold_yr1 / inputs.avgKwhPerCar : 0;
                        const costItems = Calculator.getCostBreakdown(results, inputs, 1, totalKwhSold_yr1, numberOfTransactions_yr1);
                        contentHtml = buildGrid(costItems, firstYearData.cost);
                    } else {
                        contentHtml = '<p>尚無第一年資料可供計算。</p>';
                    }
                    break;
            }

            this.elements.explanationModalTitle.textContent = title;
            body.innerHTML = contentHtml;
            this.openModal(this.elements.explanationModal);
        }
    };

    /**
     * =================================================================
     * CALCULATOR MODULE: Business Logic
     * Contains the core financial calculation engine. It is a pure
     * function that takes inputs and returns results, with no
     * direct DOM interaction.
     * =================================================================
     */
    const Calculator = {
        lastResults: {},

        run(inputs, params, deviceSpecs) {
            const results = {
                annualData: [],
                totalInvestment: 0,
                paybackPeriod: 'N/A',
                costBreakdown: {},
                avgChargeFee: 0,
            };

            // --- Step 1: Calculate Initial Investment ---
            const investmentBreakdown = this.getInvestmentBreakdown(inputs, params);
            results.totalInvestment = investmentBreakdown.reduce((sum, item) => sum + item.value, 0);
            const equipmentCostItem = investmentBreakdown.find(i => i.key === 'deviceCost');
            results.costBreakdown = { 
                equipmentCost: equipmentCostItem ? equipmentCostItem.value : 0,
                totalDeviceCostUntaxed: equipmentCostItem ? equipmentCostItem.untaxedValue : 0,
                totalSalvageValue: this.calculateSalvageValue(inputs, deviceSpecs)
            };
            
            // --- Step 2: Calculate Annual P&L ---
            let cumulativePnl = -results.totalInvestment;
            let paybackFound = false;

            for (let year = 1; year <= inputs.operationYears; year++) {
                const demandMultiplier = Math.pow(1 + inputs.demandGrowthRate, year - 1);
                const totalKwhSold = (inputs.revenueMethod === 'byCars'
                    ? (inputs.carsPerGunPerDay * inputs.gunCount * 365 * inputs.avgKwhPerCar)
                    : (inputs.kwhPerGunPerMonth * inputs.gunCount * 12)) * demandMultiplier;
                
                const numberOfTransactions = inputs.avgKwhPerCar > 0 ? totalKwhSold / inputs.avgKwhPerCar : 0;

                results.avgChargeFee = (inputs.billingMethod === 'fixed')
                    ? inputs.chargeFeePerKwh
                    : (inputs.peakRate * inputs.touRatios.peak) + (inputs.offPeakRate * inputs.touRatios.offpeak) + (inputs.holidayRate * inputs.touRatios.holiday);
                
                const revenue = totalKwhSold * results.avgChargeFee;

                // Calculate annual costs
                const costBreakdown = this.getCostBreakdown(results, inputs, year, totalKwhSold, numberOfTransactions);
                const totalAnnualCost = costBreakdown.reduce((sum, item) => sum + item.value, 0);
                
                const pnl = revenue - totalAnnualCost;
                cumulativePnl += pnl;

                // Store annual data
                const detailsCosts = costBreakdown.reduce((obj, item) => {
                    obj[item.label] = item.value;
                    return obj;
                }, {});

                results.annualData.push({
                    year, revenue, cost: totalAnnualCost, pnl, cumulativePnl,
                    kwhPerYear: totalKwhSold, kwhPerMonth: totalKwhSold / 12, kwhPerDay: totalKwhSold / 365,
                    details: { revenue: {'充電總度數 (kWh)': totalKwhSold, '平均每度收費': results.avgChargeFee, '總營收': revenue}, costs: detailsCosts }
                });

                // Check for payback period
                if (cumulativePnl >= 0 && !paybackFound) {
                    const prevCumulativePnl = results.annualData[year - 2]?.cumulativePnl || -results.totalInvestment;
                    const fractionOfYear = pnl > 0 ? (-prevCumulativePnl / pnl) : 0;
                    results.paybackPeriod = `${(year - 1 + fractionOfYear).toFixed(1)} 年`;
                    paybackFound = true;
                }
            }
            
            this.lastResults = results;
            return results;
        },

        calculateSalvageValue(inputs, deviceSpecs) {
            if (inputs.spec.type === 'DC_360') {
                return (inputs.cabinetCount * inputs.spec.cabinetSalvage) + (inputs.gunCount * inputs.spec.terminalSalvage);
            } else {
                return inputs.pileCount * inputs.spec.salvage;
            }
        },

        getInvestmentBreakdown(inputs, params) {
            const items = [];
            const { spec, pileCount, gunCount, cabinetCount } = inputs;
            const taxRate = params.taxRate.enabled ? params.taxRate.value : 0;
            const isAC = spec.type === 'AC';

            let totalDeviceCostUntaxed = 0;
            if (spec.type === 'DC_360') {
                totalDeviceCostUntaxed = (cabinetCount * spec.cabinetCost) + (gunCount * spec.terminalCost);
            } else {
                totalDeviceCostUntaxed = pileCount * spec.cost;
            }
            const totalDeviceCostTaxed = totalDeviceCostUntaxed * (1 + taxRate);
            if (params.deviceCost.enabled) items.push({ key: 'deviceCost', label: '設備總成本 (含稅)', value: totalDeviceCostTaxed, untaxedValue: totalDeviceCostUntaxed, formula: `(${UI.formatCurrency(totalDeviceCostUntaxed,0,false,true)}) x (1 + ${taxRate*100}%)`});
            
            if (!isAC) {
                const totalPowerKw = spec.type === 'DC_360' ? cabinetCount * spec.power : pileCount * spec.power;
                if (params.lineSubsidyPerKw.enabled) items.push({ key: 'lineSubsidyPerKw', label: params.lineSubsidyPerKw.label, value: params.lineSubsidyPerKw.value * totalPowerKw, formula: `${UI.formatCurrency(params.lineSubsidyPerKw.value,0,false,true)} x ${totalPowerKw} kW`});
                if (params.technicianFee.enabled) items.push({ key: 'technicianFee', label: params.technicianFee.label, value: params.technicianFee.value, formula: '一次性費用' });
                if (spec.type.startsWith('DC')) {
                    if (params.meterFeeBase.enabled) items.push({ key: 'meterFeeBase', label: params.meterFeeBase.label, value: params.meterFeeBase.value, formula: '一次性費用' });
                    if (params.meterFeePerGun.enabled) items.push({ key: 'meterFeePerGun', label: params.meterFeePerGun.label, value: params.meterFeePerGun.value * gunCount, formula: `${UI.formatCurrency(params.meterFeePerGun.value,0,false,true)} x ${gunCount} 槍` });
                }
            }

            if (params.distributionPanelFee.enabled) {
                const fee = isAC ? 30000 : params.distributionPanelFee.value;
                const formula = isAC ? 'AC 專案費用' : '一次性費用';
                items.push({ key: 'distributionPanelFee', label: params.distributionPanelFee.label, value: fee, formula: formula });
            }

            if (params.constructionFee.enabled) items.push({ key: 'constructionFee', label: params.constructionFee.label, value: inputs.infrastructureCostMain, formula: '由主畫面輸入' });
            
            return items;
        },

        getRevenueBreakdown(yearData, inputs) {
            const items = [];
            items.push({ label: '充電服務費', value: yearData.revenue, formula: `${UI.formatCurrency(yearData.kwhPerYear,0,false,true)} kWh x ${UI.formatCurrency(yearData.details.revenue['平均每度收費'],2,false,true)} 元/kWh` });
            return items;
        },

        getCostBreakdown(results, inputs, year, totalKwhSold, numberOfTransactions) {
            const items = [];
            const p = Config.calculationParams;
            const revenue = totalKwhSold * results.avgChargeFee;

            if (p.taipowerFee.enabled) {
                const val = totalKwhSold * p.taipowerFee.value * (1 + (p.powerLossRate.enabled ? p.powerLossRate.value : 0));
                items.push({ label: p.taipowerFee.label, value: val, formula: `${UI.formatCurrency(totalKwhSold,0,false,true)} kWh x ${p.taipowerFee.value}元 x (1 + ${p.powerLossRate.value*100}%)` });
            }
            if (p.transactionFeeRate.enabled) {
                items.push({ label: p.transactionFeeRate.label, value: revenue * p.transactionFeeRate.value, formula: `${UI.formatCurrency(revenue)} x ${p.transactionFeeRate.value*100}%` });
            }
            if (p.electronicInvoiceFeePerTransaction.enabled) {
                items.push({ label: p.electronicInvoiceFeePerTransaction.label, value: numberOfTransactions * p.electronicInvoiceFeePerTransaction.value, formula: `${UI.formatCurrency(numberOfTransactions,0,false,true)} 張 x ${p.electronicInvoiceFeePerTransaction.value} 元` });
            }
            if (p.repairPartsRate.enabled) {
                items.push({ label: p.repairPartsRate.label, value: results.costBreakdown.equipmentCost * p.repairPartsRate.value, formula: `${UI.formatCurrency(results.costBreakdown.equipmentCost)} x ${p.repairPartsRate.value*100}%` });
            }
            if (p.electricalTechnicianFee.enabled && inputs.spec.type !== 'AC') {
                 items.push({ label: p.electricalTechnicianFee.label, value: p.electricalTechnicianFee.value, formula: '固定年費' });
            }
            if (p.maintenanceFee.enabled) items.push({ label: p.maintenanceFee.label, value: p.maintenanceFee.value, formula: '固定年費' });
            if (p.insuranceFee.enabled) items.push({ label: p.insuranceFee.label, value: p.insuranceFee.value, formula: '固定年費' });
            if (p.extendedWarrantyPerPile.enabled) {
                items.push({ label: p.extendedWarrantyPerPile.label, value: inputs.pileCount * p.extendedWarrantyPerPile.value, formula: `${UI.formatCurrency(p.extendedWarrantyPerPile.value,0,false,true)} x ${inputs.pileCount} 樁` });
            }
            if (p.laborCost.enabled) items.push({ label: p.laborCost.label, value: p.laborCost.value, formula: '固定年費' });
            if (p.internetFee.enabled) {
                 items.push({ label: '網路費', value: p.internetFee.value * 12, formula: `${UI.formatCurrency(p.internetFee.value,0,false,true)} x 12 個月` });
            }
            if (p.tdxUploadFee.enabled) {
                items.push({ label: 'TDX上傳費', value: p.tdxUploadFee.value * inputs.gunCount * 12, formula: `${UI.formatCurrency(p.tdxUploadFee.value,0,false,true)} x ${inputs.gunCount} 槍 x 12 個月` });
            }
            if (inputs.rentMethod !== 'none') {
                let rentCost = 0;
                let formula = '';
                if (inputs.rentMethod === 'bySpace') {
                    rentCost = inputs.rentPerSpace * inputs.parkingSpaces * 12;
                    formula = `${UI.formatCurrency(inputs.rentPerSpace,0,false,true)} x ${inputs.parkingSpaces} 車位 x 12 個月`;
                } else {
                    rentCost = inputs.rentPerLand * 12;
                    formula = `${UI.formatCurrency(inputs.rentPerLand,0,false,true)} x 12 個月`;
                }
                items.push({ label: '租金', value: rentCost, formula });
            }
            
            // Depreciation Calculation
            if (year <= inputs.depreciationYears) {
                const depreciableBase = results.totalInvestment - results.costBreakdown.totalSalvageValue;
                let depreciation = 0;
                let formula = '';
                if (inputs.depreciationMethod === 'straightLine') {
                    depreciation = depreciableBase / inputs.depreciationYears;
                    formula = `(${UI.formatCurrency(results.totalInvestment)} - ${UI.formatCurrency(results.costBreakdown.totalSalvageValue)}) / ${inputs.depreciationYears} 年`;
                } else { // syd
                    const n = inputs.depreciationYears;
                    const sydDenominator = n * (n + 1) / 2;
                    const remainingLife = n - year + 1;
                    depreciation = depreciableBase * (remainingLife / sydDenominator);
                    formula = `(${UI.formatCurrency(results.totalInvestment)} - ${UI.formatCurrency(results.costBreakdown.totalSalvageValue)}) x ${remainingLife}/${sydDenominator}`;
                }
                items.push({ label: '折舊', value: depreciation, formula });
            }

            return items;
        },


        getLastResults() {
            return this.lastResults;
        }
    };

    /**
     * =================================================================
     * CHARTS MODULE: Chart.js Integration
     * Manages the creation and updating of all charts.
     * =================================================================
     */
    const Charts = {
        instances: {},

        init() {
            const yAxisTickFormatter = (value) => {
                if (isNaN(value) || value === null) return '';
                const num = Number(value);
                if (Math.abs(num) >= 1e6) return `${(num / 1e6).toFixed(1)}M`;
                if (Math.abs(num) >= 1e3) return `${(num / 1e3).toFixed(0)}K`;
                return num.toLocaleString('en-US');
            };

            const commonOptions = {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { callbacks: { label: context => `${context.dataset.label}: ${UI.formatCurrency(context.raw)}` } },
                    title: {
                        display: true,
                        text: '單位：元',
                        position: 'top',
                        align: 'start',
                        font: {
                            weight: 'normal'
                        },
                        color: '#6b7280'
                    }
                }
            };
            this.instances.pnl = new Chart(UI.elements.pnlChart, {
                type: 'bar', data: { labels: [], datasets: [] },
                options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { ticks: { callback: yAxisTickFormatter } } } }
            });
            this.instances.revenueCost = new Chart(UI.elements.revenueCostChart, {
                type: 'bar', data: { labels: [], datasets: [] },
                options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { ticks: { callback: yAxisTickFormatter } } } }
            });
            this.instances.cumulative = new Chart(UI.elements.cumulativePnlChart, {
                type: 'line', data: { labels: [], datasets: [] },
                options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { ticks: { callback: yAxisTickFormatter } } } }
            });
            this.instances.tou = new Chart(UI.elements.touPieChart, {
                type: 'doughnut', data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `${context.label}: ${context.raw}%` } } }
                }
            });
        },

        update(inputs, results) {
            if (!this.instances.pnl) this.init();

            const labels = results.annualData.map(d => `第 ${d.year} 年`);
            
            // PNL Chart (Only Net Profit)
            this.instances.pnl.data.labels = labels;
            this.instances.pnl.data.datasets = [
                { 
                    label: '充電淨利', 
                    data: results.annualData.map(d => d.pnl), 
                    backgroundColor: results.annualData.map(d => d.pnl >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
                    borderColor: results.annualData.map(d => d.pnl >= 0 ? 'rgba(22, 163, 74, 1)' : 'rgba(220, 38, 38, 1)'),
                    borderWidth: 1
                }
            ];
            this.instances.pnl.update();

            // Revenue vs Cost Chart
            this.instances.revenueCost.data.labels = labels;
            this.instances.revenueCost.data.datasets = [
                { label: '總營收', data: results.annualData.map(d => d.revenue), backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                { label: '總成本', data: results.annualData.map(d => d.cost), backgroundColor: 'rgba(255, 159, 64, 0.6)' }
            ];
            this.instances.revenueCost.update();

            // Cumulative PNL Chart
            this.instances.cumulative.data.labels = ['投資額', ...labels];
            this.instances.cumulative.data.datasets = [{
                label: '累積稅前淨利', data: [-results.totalInvestment, ...results.annualData.map(d => d.cumulativePnl)],
                borderColor: 'rgba(54, 162, 235, 1)', tension: 0.1, fill: true,
                backgroundColor: (context) => {
                    const { ctx, chartArea, scales } = context.chart;
                    if (!chartArea) return null;
                    const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                    const zero = scales.y.getPixelForValue(0);
                    const zeroPoint = (zero - chartArea.top) / chartArea.height;
                    if (!isFinite(zeroPoint)) return 'rgba(219, 234, 254, 0.6)';
                    const clampedZero = Math.max(0, Math.min(1, zeroPoint));
                    gradient.addColorStop(0, 'rgba(219, 234, 254, 0.6)');
                    gradient.addColorStop(clampedZero, 'rgba(219, 234, 254, 0.6)');
                    gradient.addColorStop(clampedZero, 'rgba(254, 226, 226, 0.6)');
                    gradient.addColorStop(1, 'rgba(254, 226, 226, 0.6)');
                    return gradient;
                }
            }];
            this.instances.cumulative.update();

            // TOU Pie Chart
            UI.elements.touPieChartContainer.style.display = inputs.billingMethod === 'tou' ? 'block' : 'none';
            if (inputs.billingMethod === 'tou') {
                this.instances.tou.data.labels = ['尖峰', '離峰', '假日'];
                this.instances.tou.data.datasets = [{
                    data: [inputs.touRatios.peak * 100, inputs.touRatios.offpeak * 100, inputs.touRatios.holiday * 100].map(v => v.toFixed(0)),
                    backgroundColor: ['#ef4444', '#3b82f6', '#10b981']
                }];
                this.instances.tou.update();
            }
        }
    };

    /**
     * =================================================================
     * PERSISTENCE MODULE: Local Storage
     * Handles saving and loading application state to and from
     * the browser's local storage.
     * =================================================================
     */
    const Persistence = {
        STORAGE_KEY: 'chargingStationAnalysisData_v6.2', // Updated version key

        save() {
            const dataToSave = {
                deviceSpecs: Config.deviceSpecs,
                calculationParams: Config.calculationParams,
                passwords: Config.passwords
            };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(dataToSave));
        },

        load() {
            const savedData = localStorage.getItem(this.STORAGE_KEY);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                if (parsedData.deviceSpecs) Object.assign(Config.deviceSpecs, parsedData.deviceSpecs);
                if (parsedData.calculationParams) {
                    Object.keys(Config.calculationParams).forEach(key => {
                        if(parsedData.calculationParams[key]){
                           Object.assign(Config.calculationParams[key], parsedData.calculationParams[key]);
                        }
                    });
                }
                if (parsedData.passwords) Object.assign(Config.passwords, parsedData.passwords);
            }
        }
    };

    // --- Initialize the Application ---
    App.init();
});
</script>
</body>
</html>
