<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å……é›»ç«™æŠ•è³‡æ•ˆç›Šåˆ†æ (å°ˆæ¥­ç‰ˆ v2.5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .input-field {
            background-color: white; 
            color: #1f2937; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            padding: 0.65rem 0.85rem; 
            text-align: center;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); 
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); 
        }
        .input-field.readonly {
            background-color: #e5e7eb; 
            color: #6b7280; 
            cursor: not-allowed;
        }
        .label-text {
            font-weight: 600; 
            color: #374151; 
        }
        .card {
            background-color: white;
            border-radius: 1rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            padding: 2rem; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .summary-card {
            background: linear-gradient(135deg, #4f46e5, #3b82f6); 
            color: white;
            border-radius: 1rem; 
            padding: 2rem; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .summary-value {
            font-size: 1.75rem; 
            font-weight: 800;
            line-height: 1.2;
            margin-top: 0.25rem; 
        }
        .summary-label {
            font-size: 2.25rem; 
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 700; 
            margin-bottom: 0.25rem; 
        }
        .table-header { 
            background-color: #f3f4f6; 
            color: #374151; 
            font-weight: 700; 
        }
        .table-cell { 
            padding: 0.9rem 1.2rem; 
            text-align: right; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .table-cell-year { 
            font-weight: 700; 
            color: #1f2937; 
            text-align: left; 
        }
        #pnlTableBody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        #pnlTableBody tr:hover {
            background-color: #eff6ff; 
            transition: background-color 0.2s ease;
        }

        .radio-label { 
            display: inline-flex; 
            align-items: center; 
            cursor: pointer; 
            margin-right: 1.25rem; 
            user-select: none; 
        }
        .radio-label input { display: none; }
        .radio-label span { 
            padding: 0.4rem 1rem; 
            border-radius: 9999px; 
            background-color: #e5e7eb; 
            color: #4b5563; 
            transition: all 0.2s ease; 
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .radio-label input:checked + span { 
            background-color: #4f46e5; 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 2px 5px 0 rgba(79, 70, 229, 0.3); 
        }
        .hidden-section { display: none; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out forwards; 
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem; 
            border-radius: 1rem; 
            width: 90%;
            max-width: 900px; 
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            animation: slideIn 0.3s ease-out forwards; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.8rem; font-weight: 700; color: #1f2937; }
        .modal-close-btn { 
            background: none; border: none; 
            font-size: 1.5rem;
            cursor: pointer; 
            color: #6b7280; transition: color 0.2s ease;
            line-height: 1;
        }
        .modal-close-btn:hover { color: #374151; }
        .modal-table-input { 
            width: 100%; text-align: right; padding: 0.4rem; 
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            background-color: #f9fafb; 
        }
        .modal-table-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .modal-content button {
            background-color: #4f46e5; 
            color: white;
            padding: 0.75rem 1.75rem; 
            border-radius: 0.6rem; 
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .modal-content button:hover {
            background-color: #4338ca; 
            transform: translateY(-1px); 
        }
        .modal-content button:active {
            transform: translateY(0);
        }
        .modal-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
            display: none; 
        }
        .modal-message.error {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .modal-message.success {
            background-color: #d1fae5;
            color: #10b981;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* New styles for formula management modal */
        .formula-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            align-items: start;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .formula-item-label {
            grid-column: 2;
            font-weight: 600;
            color: #374151;
        }
        .formula-item-description {
            grid-column: 2;
            font-size: 0.875rem;
            color: #6b7280;
            margin-left: 0.5rem;
        }
        .formula-item-input-group {
            grid-column: 2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        .formula-item-checkbox {
            margin-top: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #4f46e5;
            cursor: pointer;
        }
        .formula-item-checkbox:focus {
            ring: #4f46e5;
        }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-800 leading-tight">å……é›»ç«™æŠ•è³‡æ•ˆç›Šåˆ†æ</h1>
            <p class="text-xl text-gray-600 mt-3">äº’å‹•å¼æç›Šè©•ä¼°å·¥å…· (å°ˆæ¥­ç‰ˆ v2.5)</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">è¨­ç½®åƒæ•¸(è¼¸å…¥å€)</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-2">
                            <span class="label-text col-span-1">è¨­å‚™åŠŸç‡</span>
                            <select id="devicePowerSelect" class="input-field col-span-2"></select>
                        </div>
                        <div id="pileCountGroup" class="grid grid-cols-2 items-center gap-4">
                            <span id="pileCountLabel" class="label-text">æ¨æ•¸</span><input type="number" id="pileCount" class="input-field" value="1" min="1">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è»Šæ ¼æ•¸å€¼</span>
                            <input type="number" id="parkingSpaces" class="input-field readonly" readonly>
                        </div>
                        <div class="flex justify-end">
                            <button id="openSpecsModalBtn" class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out shadow-sm">
                                âš™ï¸ è¦æ ¼è¨­å®š
                            </button>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">æ”¶è²»æ–¹å¼</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="billingMethod" value="fixed" checked><span>å›ºå®šè²»ç‡</span></label>
                                <label class="radio-label"><input type="radio" name="billingMethod" value="tou"><span>å°–é›¢å³°</span></label>
                            </div>
                        </div>
                        <div id="fixedRateSection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æ¯åº¦é›»æ”¶è²» (å…ƒ)</span>
                            <input type="number" id="chargeFeePerKwh" class="input-field" value="10">
                        </div>
                        <div id="touRateSection" class="hidden-section space-y-4">
                             <div class="grid grid-cols-2 items-center gap-4">
                               <span class="label-text font-bold text-indigo-600">å°–é›¢å³°å‡åƒ¹</span>
                               <input type="text" id="avgTouRate" class="input-field readonly font-bold text-indigo-600" readonly>
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                               <span class="label-text">å°–å³°è²»ç‡ (å…ƒ)</span><input type="number" id="peakRate" class="input-field" value="12">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                               <span class="label-text">é›¢å³°è²»ç‡ (å…ƒ)</span><input type="number" id="offPeakRate" class="input-field" value="8">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                               <span class="label-text">å‡æ—¥è²»ç‡ (å…ƒ)</span><input type="number" id="holidayRate" class="input-field" value="10">
                            </div>
                            <div class="flex items-center gap-4 mt-2">
                                <div id="touPieChartContainer" class="w-24 h-24 flex-shrink-0">
                                    <canvas id="touPieChart"></canvas>
                                </div>
                                <div class="flex-grow space-y-2">
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="peakUsageRatio" class="text-sm font-medium">å°–å³° %</label>
                                        <input type="number" id="peakUsageRatio" data-tou="peak" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="offPeakUsageRatio" class="text-sm font-medium">é›¢å³° %</label>
                                        <input type="number" id="offPeakUsageRatio" data-tou="offpeak" class="input-field col-span-2 tou-ratio-input" value="80" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="holidayUsageRatio" class="text-sm font-medium">å‡æ—¥ %</label>
                                        <input type="number" id="holidayUsageRatio" data-tou="holiday" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">ç‡Ÿæ”¶ä¼°ç®—æ–¹å¼</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byCars" checked><span>ä¾è»Šæ¬¡</span></label>
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byKwh"><span>ä¾åº¦æ•¸</span></label>
                            </div>
                        </div>
                        <div id="carsPerDaySection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æ¯æ—¥è»Šæ¬¡/æ§</span><input type="number" id="carsPerGunPerDay" class="input-field" value="3">
                        </div>
                        <div id="kwhPerMonthSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                           <span class="label-text">æ¯æœˆåº¦æ•¸/æ§</span><input type="number" id="kwhPerGunPerMonth" class="input-field" value="2700">
                        </div>
                        <div id="avgKwhPerCarSection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æ¯è»Šå¹³å‡å……é›»åº¦æ•¸ (kWh)</span>
                            <input type="number" id="avgKwhPerCar" class="input-field" value="30">
                        </div>
                        <hr class="border-gray-200"/>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">éœ€æ±‚å¹´å¢ç‡ (%)</span><input type="number" id="demandGrowthRate" class="input-field" value="20">
                        </div>
                           <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">é è¨ˆç‡Ÿé‹æœŸ (å¹´)</span><input type="number" id="operationYears" class="input-field" value="15">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">é ä¼°æˆæœ¬ (è¨­å‚™&è«‹é›»)</h2>
                    <div class="space-y-4">
                           <div id="deviceCostGroup" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è¨­å‚™æˆæœ¬/æ¨</span><input type="number" id="deviceCostPerPile" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">å°é›»å¹³å‡é›»è²»</span><input type="number" id="taipowerFee" class="input-field" value="4">
                        </div>
                        <div id="salvageValueGroup" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è¨­å‚™æ®˜å€¼/æ¨</span><input type="number" id="salvageValuePerPile" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æŠ˜èˆŠå¹´æœŸ</span><input type="number" id="depreciationYears" class="input-field" value="5">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">ç«™é»ç›¸é—œæˆæœ¬ (å…¶å®ƒ)</h2>
                    <div class="space-y-4">
                        <div>
                            <span class="label-text mb-3 block">ç§Ÿé‡‘æˆæœ¬</span>
                            <div class="flex flex-wrap gap-3 mb-3">
                                <label class="radio-label"><input type="radio" name="rentMethod" value="bySpace" checked><span>ä¾è»Šæ ¼</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="byLand"><span>ä¾åœŸåœ°</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="none"><span>ç„¡</span></label>
                            </div>
                            <div id="rentBySpaceSection" class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">è»Šæ ¼ç§Ÿé‡‘/æœˆ</span><input type="number" id="rentPerSpace" class="input-field" value="3000">
                            </div>
                            <div id="rentByLandSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                               <span class="label-text">åœŸåœ°ç§Ÿé‡‘/æœˆ</span><input type="number" id="rentPerLand" class="input-field" value="15000">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æŠ•è³‡é¡</div>
                        <div id="totalInvestment" class="summary-value">NT$ 0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">é è¨ˆå›æ”¶å¹´é™</div>
                        <div id="paybackPeriod" class="summary-value">N/A</div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5" id="pnlChartTitle">å……é›»æ·¨åˆ©åœ–è¡¨</h2>
                    <div class="flex-grow h-80">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5">ç´¯ç©æç›Šèˆ‡å›æ”¶å¹´é™</h2>
                    <div class="flex-grow h-80">
                        <canvas id="cumulativePnlChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <div class="card">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">å……é›»æ”¶æ”¯/å¹´</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="table-cell text-left">å¹´åº¦</th>
                                <th class="table-cell">ç¸½ç‡Ÿæ”¶</th>
                                <th class="table-cell">ç¸½æˆæœ¬</th>
                                <th class="table-cell">å……é›»æ·¨åˆ©</th>
                                <th class="table-cell">ç´¯ç©ç¨…å‰æ·¨åˆ©</th>
                            </tr>
                        </thead>
                        <tbody id="pnlTableBody" class="bg-white divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <!-- Calculation Explanation Section -->
                <div class="mt-8 pt-5 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">è¨ˆç®—æ–¹å¼èªªæ˜</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li>**ç¸½æŠ•è³‡é¡ï¼š** åŒ…å«ç·šè·¯è£œåŠ©è²»ã€æŠ€å¸«è²»ã€é…é›»ç›¤è²»ã€é›»éŒ¶è²»ç”¨(åƒ…DCæ¨)ä»¥åŠå«ç¨…è¨­å‚™ç¸½æˆæœ¬ã€‚</li>
                        <li>**ç¸½ç‡Ÿæ”¶ï¼š** ä¾é¸æ“‡çš„ç‡Ÿæ”¶ä¼°ç®—æ–¹å¼ï¼ˆä¾è»Šæ¬¡æˆ–ä¾åº¦æ•¸ï¼‰è¨ˆç®—ï¼Œä¸¦è€ƒæ…®éœ€æ±‚å¹´å¢ç‡ã€‚</li>
                        <li>**ç¸½æˆæœ¬ï¼š** åŒ…å«å°é›»é›»è²»(å«é›»æ)ã€é‡‘æµæ‰‹çºŒè²»ã€ç¶­é‹å®¢æœã€ç§Ÿé‡‘ã€ä¿éšªã€å‹å‹™ã€ç¶²è·¯ã€é›»å­ç™¼ç¥¨ã€ç¶­ä¿®å‚™å“ã€å»¶ä¿ã€TDXä¸Šå‚³è²»åŠè¨­å‚™æŠ˜èˆŠç­‰ã€‚ (å¯æ–¼ç®¡ç†å…¬å¼ä¸­å‹¾é¸èª¿æ•´)</li>
                        <li>**å……é›»æ·¨åˆ©ï¼š** ç¸½ç‡Ÿæ”¶æ¸›å»ç¸½æˆæœ¬ã€‚</li>
                        <li>**ç´¯ç©ç¨…å‰æ·¨åˆ©ï¼š** æ¯å¹´å……é›»æ·¨åˆ©çš„ç´¯åŠ ï¼Œå¾åˆå§‹æŠ•è³‡é¡é–‹å§‹è¨ˆç®—ã€‚</li>
                        <li>**é è¨ˆå›æ”¶å¹´é™ï¼š** ç´¯ç©ç¨…å‰æ·¨åˆ©é¦–æ¬¡è½‰ç‚ºæ­£å€¼çš„å¹´åº¦ã€‚</li>
                    </ul>
                    <div class="mt-4 text-right">
                        <button id="openManagementModalBtn" class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out shadow-sm">
                            ğŸ”‘ ç®¡ç†è¨ˆç®—å…¬å¼
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Specs Modal -->
    <div id="specsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¨­å‚™è¦æ ¼èˆ‡åƒ¹æ ¼è¨­å®š</h3>
                <button id="closeSpecsModalBtn" class="modal-close-btn">&times;</button>
            </div>
            
            <div id="specsPasswordInputSection" class="space-y-4">
                <div class="grid grid-cols-2 items-center gap-4">
                    <span class="label-text">è¼¸å…¥å¯†ç¢¼</span>
                    <input type="password" id="specsPassword" class="input-field" placeholder="é è¨­å¯†ç¢¼: 0000">
                </div>
                <div class="text-center">
                    <button id="specsLoginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ç™»å…¥</button>
                </div>
                <div id="specsMessage" class="modal-message"></div>
            </div>

            <div id="specsContentSection" class="hidden-section">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border-collapse">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left w-[20%]">è¦æ ¼åç¨±</th>
                                <th class="p-3 text-left w-[15%]">çµ„ä»¶</th>
                                <th class="p-3 text-right w-[20%]">è¨­å‚™æˆæœ¬(æœªç¨…)</th>
                                <th class="p-3 text-right w-[20%]">è¨­å‚™æˆæœ¬ (å«ç¨…)</th>
                                <th class="p-3 text-right w-[20%]">é ä¼°æ®˜å€¼</th>
                            </tr>
                        </thead>
                        <tbody id="specsModalTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 text-right">
                    <button id="saveSpecsBtn">å„²å­˜ä¸¦é—œé–‰</button>
                </div>

                <hr class="my-6 border-gray-200"/>

                <h4 class="text-xl font-bold text-gray-800 mb-3 mt-6">ä¿®æ”¹è¦æ ¼è¨­å®šå¯†ç¢¼</h4>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">èˆŠå¯†ç¢¼</span>
                        <input type="password" id="oldSpecsPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">æ–°å¯†ç¢¼</span>
                        <input type="password" id="newSpecsPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">ç¢ºèªæ–°å¯†ç¢¼</span>
                        <input type="password" id="confirmNewSpecsPassword" class="input-field">
                    </div>
                    <div class="text-center">
                        <button id="changeSpecsPasswordBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ç¢ºèªå„²å­˜æ–°å¯†ç¢¼</button>
                    </div>
                    <div id="specsPasswordChangeMessage" class="modal-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç®¡ç†è¨ˆç®—å…¬å¼</h3>
                <button id="closeManagementModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div id="passwordInputSection" class="space-y-4">
                <div class="grid grid-cols-2 items-center gap-4">
                    <span class="label-text">è¼¸å…¥å¯†ç¢¼</span>
                    <input type="password" id="managementPassword" class="input-field" placeholder="é è¨­å¯†ç¢¼: 0000">
                </div>
                <div class="text-center">
                    <button id="loginManagementBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ç™»å…¥</button>
                </div>
                <div id="managementMessage" class="modal-message"></div>
            </div>

            <div id="formulasSection" class="hidden-section space-y-6 mt-6">
                <h4 class="text-xl font-bold text-gray-800 mb-3">è©³ç´°è¨ˆç®—åƒæ•¸</h4>
                <div id="formulaContainer" class="space-y-4">
                    <!-- All rows will be generated here by JS -->
                </div>
                <div class="mt-6 text-center">
                    <button id="saveFormulasBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">å„²å­˜è¨ˆç®—åƒæ•¸</button>
                </div>

                <hr class="my-6 border-gray-200"/>

                <h4 class="text-xl font-bold text-gray-800 mb-3">ä¿®æ”¹å¯†ç¢¼</h4>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">èˆŠå¯†ç¢¼</span>
                        <input type="password" id="oldPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">æ–°å¯†ç¢¼</span>
                        <input type="password" id="newPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">ç¢ºèªæ–°å¯†ç¢¼</span>
                        <input type="password" id="confirmNewPassword" class="input-field">
                    </div>
                    <div class="text-center">
                        <button id="changePasswordBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ç¢ºèªå„²å­˜æ–°å¯†ç¢¼</button>
                    </div>
                    <div id="passwordChangeMessage" class="modal-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Definitions ---
        let deviceSpecs = {
            '7': { name: 'AC 7kW Smart', cost: 31395, power: 7, salvage: 5000, type: 'AC' },
            '30': { name: 'DC 30kW', cost: 325500, power: 30, salvage: 50000, type: 'DC' },
            '120': { name: 'DC 120kW', cost: 850500, power: 120, salvage: 150000, type: 'DC' },
            '180': { name: 'DC 180kW', cost: 997500, power: 180, salvage: 200000, type: 'DC' },
            '360': { 
                name: 'DC 360kW', 
                power: 360, // Power per cabinet
                cabinetCost: 1575000, 
                terminalCost: 504000, 
                cabinetSalvage: 300000, 
                terminalSalvage: 50000, 
                type: 'DC_360' 
            }
        };

        let pnlChart = null;
        let cumulativePnlChart = null;
        let touPieChart = null;
        let DOMElements = {}; 
        let currentManagementPassword = '0000';
        let currentSpecsPassword = '0000';
        let isAdjustingTou = false; // Flag to prevent recursion in TOU adjustment

        let calculationParams = {
            // Initial Investment
            lineSubsidyPerKw: { value: 550, label: 'ç·šè·¯è£œåŠ©è²»/kW', unit: 'å…ƒ', description: 'å°é›»ç·šè£œè²»ï¼Œæ¯kWæ”¶å–çš„ä¸€æ¬¡æ€§è²»ç”¨ã€‚', enabled: true },
            technicianFee: { value: 150000, label: 'æŠ€å¸«è²»', unit: 'å…ƒ', description: 'å°é›»å¤–åŒ…æŠ€å¸«è²»ç”¨(ä¸€æ¬¡æ€§)ã€‚', enabled: true },
            distributionPanelFee: { value: 300000, label: 'é…é›»ç›¤è²»', unit: 'å…ƒ', description: 'é«˜å£“æˆ–ä½å£“é…é›»ç›¤è²»ç”¨(ä¸€æ¬¡æ€§)ã€‚', enabled: true },
            meterFeeBase: { value: 12000, label: 'é›»éŒ¶è²»ç”¨(åŸºæœ¬)', unit: 'å…ƒ', description: 'å°é›»é›»è¡¨åŸºæœ¬è²»ç”¨(åƒ…DCæ¨, ä¸€æ¬¡æ€§)ã€‚', enabled: true },
            meterFeePerGun: { value: 1400, label: 'é›»éŒ¶è²»ç”¨/æ§', unit: 'å…ƒ', description: 'æ¯å¢åŠ ä¸€æ§çš„é›»è¡¨è²»ç”¨(åƒ…DCæ¨, ä¸€æ¬¡æ€§)ã€‚', enabled: true },
            taxRate: { value: 0.05, label: 'ç‡Ÿæ¥­ç¨…ç‡', unit: '%', description: 'è¨­å‚™è³¼è²·åŠç›¸é—œæœå‹™çš„ç‡Ÿæ¥­ç¨…ç‡ã€‚', enabled: true },
            
            // Annual Costs
            maintenanceFee: { value: 37000, label: 'ç¶­é‹&å®¢æœ/å¹´', unit: 'å…ƒ', description: 'å¹´åº¦å ´åŸŸç¶­è­·èˆ‡ç·šä¸Šå®¢æœè²»ç”¨ã€‚', enabled: true },
            transactionFeeRate: { value: 0.03, label: 'é‡‘æµè²»ç‡', unit: '%', description: 'æ”¯ä»˜çµ¦é‡‘æµæœå‹™å•†çš„æ¯ç­†äº¤æ˜“æ‰‹çºŒè²»ç‡ã€‚', enabled: true },
            insuranceFee: { value: 8500, label: 'æ„å¤–ä¿éšªè²»/å¹´', unit: 'å…ƒ', description: 'å ´åŸŸå¹´åº¦æ„å¤–éšªè²»ç”¨ã€‚', enabled: true },
            electronicInvoiceFee: { value: 2, label: 'é›»å­ç™¼ç¥¨(å…ƒ/å¼µ)', unit: 'å…ƒ', description: 'æ¯ç­†å……é›»äº¤æ˜“(æ¯å¼µç™¼ç¥¨)çš„æˆæœ¬ã€‚', enabled: true },
            repairPartsRate: { value: 0.01, label: 'ç¶­ä¿®å‚™å“(è³‡æœ¬æ”¯å‡º%)/å¹´', unit: '%', description: 'å¹´åº¦ç¶­ä¿®å‚™å“è²»ç”¨ï¼Œç‚ºè¨­å‚™å«ç¨…ç¸½æˆæœ¬çš„ç™¾åˆ†æ¯”ã€‚', enabled: true },
            extendedWarrantyPerPile: { value: 1000, label: 'ä¿å›ºå»¶ä¿(æ¨)/å¹´', unit: 'å…ƒ', description: 'æ¯æ”¯å……é›»æ¨çš„å¹´åº¦å»¶é•·ä¿å›ºè²»ç”¨ã€‚', enabled: true },
            laborCost: { value: 60000, label: 'å‹å‹™æˆæœ¬/å¹´', unit: 'å…ƒ', description: 'å¹´åº¦äººåŠ›ã€å·¡æª¢ç­‰ç›¸é—œå‹å‹™æˆæœ¬ã€‚', enabled: true },
            internetFee: { value: 500, label: 'ç¶²è·¯è²»/æœˆ', unit: 'å…ƒ', description: 'å ´åŸŸæ¯æœˆçš„ç¶²è·¯é€šè¨Šè²»ç”¨ã€‚', enabled: true },
            tdxUploadFee: { value: 100, label: 'TDXä¸Šå‚³è²»(æ§/æœˆ)', unit: 'å…ƒ', description: 'æ¯æ”¯æ§æ¯æœˆä¸Šå‚³è³‡æ–™è‡³äº¤é€šéƒ¨TDXå¹³å°çš„è²»ç”¨ã€‚', enabled: true },
            powerLossRate: { value: 0.05, label: 'é›»æ%', unit: '%', description: 'é›»åŠ›åœ¨å‚³è¼¸å’Œè½‰æ›éç¨‹ä¸­çš„æè€—ç‡ã€‚', enabled: true },
        };
        
        // Separate object for TOU ratios to manage them easily
        let touRatios = {
            peak: { value: 0.1, label: 'å°–å³°ç”¨é›»æ¯”ä¾‹' },
            offpeak: { value: 0.8, label: 'é›¢å³°ç”¨é›»æ¯”ä¾‹' },
            holiday: { value: 0.1, label: 'å‡æ—¥ç”¨é›»æ¯”ä¾‹' }
        };

        /**
         * Caches all necessary DOM elements for quick access.
         */
        function cacheDOMElements() {
            const ids = [
                'devicePowerSelect', 'pileCount', 'pileCountLabel', 'parkingSpaces', 'openSpecsModalBtn',
                'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'carsPerGunPerDay', 'kwhPerGunPerMonth',
                'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 'deviceCostPerPile', 'taipowerFee',
                'salvageValuePerPile', 'depreciationYears', 'deviceCostGroup', 'salvageValueGroup',
                'fixedRateSection', 'touRateSection', 'carsPerDaySection', 'kwhPerMonthSection', 'avgKwhPerCarSection',
                'totalInvestment', 'paybackPeriod', 'pnlChartTitle', 'pnlChart', 'cumulativePnlChart', 'pnlTableBody',
                'openManagementModalBtn',
                // Rent costs
                'rentBySpaceSection', 'rentByLandSection', 'rentPerSpace', 'rentPerLand',
                // TOU Ratio elements
                'touPieChart', 'peakUsageRatio', 'offPeakUsageRatio', 'holidayUsageRatio', 'avgTouRate',
                // Specs Modal
                'specsModal', 'closeSpecsModalBtn', 'specsPasswordInputSection', 'specsPassword', 'specsLoginBtn', 'specsMessage',
                'specsContentSection', 'specsModalTableBody', 'saveSpecsBtn', 'oldSpecsPassword', 'newSpecsPassword',
                'confirmNewSpecsPassword', 'changeSpecsPasswordBtn', 'specsPasswordChangeMessage',
                // Management Modal
                'managementModal', 'closeManagementModalBtn', 'passwordInputSection', 'managementPassword', 'loginManagementBtn',
                'managementMessage', 'formulasSection', 'formulaContainer', 'saveFormulasBtn', 'oldPassword',
                'newPassword', 'confirmNewPassword', 'changePasswordBtn', 'passwordChangeMessage'
            ];
            ids.forEach(id => {
                DOMElements[id] = document.getElementById(id);
            });
        }

        /**
         * Gathers all input values from the form.
         * @returns {object} An object containing all parsed input values.
         */
        function getInputs() {
            return {
                selectedKey: DOMElements.devicePowerSelect.value,
                billingMethod: document.querySelector('input[name="billingMethod"]:checked').value,
                revenueMethod: document.querySelector('input[name="revenueMethod"]:checked').value,
                rentMethod: document.querySelector('input[name="rentMethod"]:checked').value,
                chargeFeePerKwh: parseFloat(DOMElements.chargeFeePerKwh.value) || 0,
                peakRate: parseFloat(DOMElements.peakRate.value) || 0,
                offPeakRate: parseFloat(DOMElements.offPeakRate.value) || 0,
                holidayRate: parseFloat(DOMElements.holidayRate.value) || 0,
                carsPerGunPerDay: parseFloat(DOMElements.carsPerGunPerDay.value) || 0,
                kwhPerGunPerMonth: parseFloat(DOMElements.kwhPerGunPerMonth.value) || 0,
                avgKwhPerCar: parseFloat(DOMElements.avgKwhPerCar.value) || 0,
                demandGrowthRate: parseFloat(DOMElements.demandGrowthRate.value) / 100 || 0,
                operationYears: parseInt(DOMElements.operationYears.value) || 15,
                pileCount: parseInt(DOMElements.pileCount.value) || 1,
                taipowerFee: parseFloat(DOMElements.taipowerFee.value) || 0,
                depreciationYears: parseInt(DOMElements.depreciationYears.value) || 5,
                rentPerSpace: parseFloat(DOMElements.rentPerSpace.value) || 0,
                rentPerLand: parseFloat(DOMElements.rentPerLand.value) || 0,
            };
        }
        
        /**
         * Helper function to get a parameter's value if it's enabled.
         */
        function getParamValue(key) {
            const param = calculationParams[key];
            return param && param.enabled ? param.value : 0;
        }


        /**
         * Performs all financial calculations.
         */
        function calculate() {
            const inputs = getInputs();
            const selectedSpec = deviceSpecs[inputs.selectedKey];

            // --- Initial Investment Calculation ---
            let totalDeviceCostUntaxed = 0;
            let totalPower = 0;
            let totalSalvage = 0;
            let meterFee = 0;

            if (selectedSpec.type === 'DC_360') {
                const numTerminals = inputs.pileCount;
                const numCabinets = Math.ceil(numTerminals / 6);
                totalDeviceCostUntaxed = (selectedSpec.terminalCost * numTerminals) + (selectedSpec.cabinetCost * numCabinets);
                totalPower = selectedSpec.power * numCabinets;
                totalSalvage = (selectedSpec.terminalSalvage * numTerminals) + (selectedSpec.cabinetSalvage * numCabinets);
                meterFee = getParamValue('meterFeeBase') + (getParamValue('meterFeePerGun') * numTerminals);
            } else {
                totalDeviceCostUntaxed = selectedSpec.cost * inputs.pileCount;
                totalPower = selectedSpec.power * inputs.pileCount;
                totalSalvage = selectedSpec.salvage * inputs.pileCount;
                if (selectedSpec.type === 'DC') {
                     meterFee = getParamValue('meterFeeBase') + (getParamValue('meterFeePerGun') * inputs.pileCount);
                }
            }

            const totalDeviceCostTaxed = totalDeviceCostUntaxed * (1 + getParamValue('taxRate'));
            
            const totalInvestment = totalDeviceCostTaxed +
                                    (getParamValue('lineSubsidyPerKw') * totalPower) +
                                    getParamValue('technicianFee') +
                                    getParamValue('distributionPanelFee') +
                                    meterFee;

            // --- Annual Calculations ---
            const results = [];
            let cumulativePnl = -totalInvestment;
            let paybackPeriod = "ç„¡æ³•å›æ”¶";
            let foundPayback = false;

            for (let year = 1; year <= inputs.operationYears; year++) {
                const demandMultiplier = Math.pow(1 + inputs.demandGrowthRate, year - 1);
                
                // --- Revenue ---
                let totalKwhPerYear;
                if (inputs.revenueMethod === 'byCars') {
                    const carsPerYear = inputs.carsPerGunPerDay * inputs.pileCount * 365 * demandMultiplier;
                    totalKwhPerYear = carsPerYear * inputs.avgKwhPerCar;
                } else { // byKwh
                    totalKwhPerYear = inputs.kwhPerGunPerMonth * inputs.pileCount * 12 * demandMultiplier;
                }

                let totalRevenue;
                if (inputs.billingMethod === 'fixed') {
                    totalRevenue = totalKwhPerYear * inputs.chargeFeePerKwh;
                } else { // tou
                    const peakKwh = totalKwhPerYear * touRatios.peak.value;
                    const offPeakKwh = totalKwhPerYear * touRatios.offpeak.value;
                    const holidayKwh = totalKwhPerYear * touRatios.holiday.value;
                    totalRevenue = (peakKwh * inputs.peakRate) + (offPeakKwh * inputs.offPeakRate) + (holidayKwh * inputs.holidayRate);
                }

                // --- Costs ---
                const electricityCost = totalKwhPerYear * inputs.taipowerFee * (1 + getParamValue('powerLossRate'));
                const transactionFee = totalRevenue * getParamValue('transactionFeeRate');
                
                let rentCost = 0;
                if (inputs.rentMethod === 'bySpace') {
                    const parkingSpaces = DOMElements.parkingSpaces.value;
                    rentCost = inputs.rentPerSpace * parkingSpaces * 12;
                } else if (inputs.rentMethod === 'byLand') {
                    rentCost = inputs.rentPerLand * 12;
                }

                const totalTransactions = (inputs.revenueMethod === 'byCars') 
                    ? inputs.carsPerGunPerDay * inputs.pileCount * 365 * demandMultiplier
                    : (inputs.avgKwhPerCar > 0 ? totalKwhPerYear / inputs.avgKwhPerCar : 0);
                
                const electronicInvoiceCost = totalTransactions * getParamValue('electronicInvoiceFee');

                const annualDepreciation = (year <= inputs.depreciationYears) 
                    ? (totalDeviceCostTaxed - totalSalvage) / inputs.depreciationYears
                    : 0;

                const annualCosts = electricityCost +
                                    transactionFee +
                                    getParamValue('maintenanceFee') +
                                    rentCost +
                                    getParamValue('insuranceFee') +
                                    getParamValue('laborCost') +
                                    (getParamValue('internetFee') * 12) +
                                    (getParamValue('tdxUploadFee') * inputs.pileCount * 12) +
                                    electronicInvoiceCost +
                                    (totalDeviceCostTaxed * getParamValue('repairPartsRate')) +
                                    (getParamValue('extendedWarrantyPerPile') * inputs.pileCount) +
                                    annualDepreciation;

                // --- P&L ---
                const annualPnl = totalRevenue - annualCosts;
                cumulativePnl += annualPnl;

                if (cumulativePnl > 0 && !foundPayback) {
                    const prevCumulativePnl = cumulativePnl - annualPnl;
                    if (annualPnl > 0) {
                        const fractionalYear = (0 - prevCumulativePnl) / annualPnl;
                        paybackPeriod = `${(year - 1 + fractionalYear).toFixed(1)} å¹´`;
                    }
                    foundPayback = true;
                }

                results.push({
                    year,
                    revenue: Math.round(totalRevenue),
                    cost: Math.round(annualCosts),
                    pnl: Math.round(annualPnl),
                    cumulativePnl: Math.round(cumulativePnl)
                });
            }

            return {
                totalInvestment,
                paybackPeriod,
                annualData: results
            };
        }

        /**
         * Updates the entire UI with new calculation results.
         */
        function updateUI(results) {
            DOMElements.totalInvestment.textContent = formatCurrency(results.totalInvestment);
            DOMElements.paybackPeriod.textContent = results.paybackPeriod;

            // Update table
            const tableBody = DOMElements.pnlTableBody;
            tableBody.innerHTML = ''; // Clear previous results
            results.annualData.forEach(data => {
                const row = `
                    <tr class="text-right">
                        <td class="table-cell table-cell-year">ç¬¬ ${data.year} å¹´</td>
                        <td class="table-cell">${formatCurrency(data.revenue)}</td>
                        <td class="table-cell text-red-600">${formatCurrency(data.cost)}</td>
                        <td class="table-cell ${data.pnl >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">${formatCurrency(data.pnl)}</td>
                        <td class="table-cell ${data.cumulativePnl >= 0 ? 'text-blue-600' : 'text-orange-600'} font-bold">${formatCurrency(data.cumulativePnl)}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Update charts
            const labels = results.annualData.map(d => `ç¬¬ ${d.year} å¹´`);
            const pnlData = results.annualData.map(d => d.pnl);
            const cumulativePnlData = results.annualData.map(d => d.cumulativePnl);
            
            updatePnlChart(labels, pnlData);
            updateCumulativePnlChart(labels, cumulativePnlData, results.totalInvestment);
            updateTouPieChart();
            calculateAndDisplayAverageTouPrice();
        }

        /**
         * Creates or updates the annual profit/loss chart.
         */
        function updatePnlChart(labels, pnlData) {
            const ctx = DOMElements.pnlChart.getContext('2d');
            if (pnlChart) {
                pnlChart.data.labels = labels;
                pnlChart.data.datasets[0].data = pnlData;
                pnlChart.data.datasets[0].backgroundColor = pnlData.map(p => p >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)');
                pnlChart.data.datasets[0].borderColor = pnlData.map(p => p >= 0 ? 'rgba(22, 163, 74, 1)' : 'rgba(220, 38, 38, 1)');
                pnlChart.update();
            } else {
                pnlChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å¹´åº¦æ·¨åˆ©',
                            data: pnlData,
                            backgroundColor: pnlData.map(p => p >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
                            borderColor: pnlData.map(p => p >= 0 ? 'rgba(22, 163, 74, 1)' : 'rgba(220, 38, 38, 1)'),
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { ticks: { callback: value => formatCurrency(value, 0) } } },
                        plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}` } } }
                    }
                });
            }
        }

        /**
         * Creates or updates the cumulative profit/loss chart.
         */
        function updateCumulativePnlChart(labels, cumulativePnlData, totalInvestment) {
            const ctx = DOMElements.cumulativePnlChart.getContext('2d');
            const dataWithInitial = [-totalInvestment, ...cumulativePnlData];
            const labelsWithInitial = ['åˆå§‹æŠ•è³‡', ...labels];

            if (cumulativePnlChart) {
                cumulativePnlChart.data.labels = labelsWithInitial;
                cumulativePnlChart.data.datasets[0].data = dataWithInitial;
                cumulativePnlChart.update();
            } else {
                cumulativePnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labelsWithInitial,
                        datasets: [{
                            label: 'ç´¯ç©ç¨…å‰æ·¨åˆ©',
                            data: dataWithInitial,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            tension: 0.1,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { ticks: { callback: value => formatCurrency(value, 0) } } },
                        plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}` } } }
                    }
                });
            }
        }
        
        /**
         * Creates or updates the TOU ratio pie chart.
         */
        function updateTouPieChart() {
            const ctx = DOMElements.touPieChart.getContext('2d');
            const data = [touRatios.peak.value, touRatios.offpeak.value, touRatios.holiday.value];

            if (touPieChart) {
                touPieChart.data.datasets[0].data = data;
                touPieChart.update();
            } else {
                touPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['å°–å³°', 'é›¢å³°', 'å‡æ—¥'],
                        datasets: [{
                            data: data,
                            backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
                            borderWidth: 2,
                            borderColor: '#f1f5f9'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.label}: ${(context.raw * 100).toFixed(0)}%`
                                }
                            }
                        }
                    }
                });
            }
        }
        
        /**
         * Calculates and displays the weighted average TOU price.
         */
        function calculateAndDisplayAverageTouPrice() {
            const inputs = getInputs();
            const avgPrice = (inputs.peakRate * touRatios.peak.value) +
                             (inputs.offPeakRate * touRatios.offpeak.value) +
                             (inputs.holidayRate * touRatios.holiday.value);
            DOMElements.avgTouRate.value = formatCurrency(avgPrice, 2);
        }

        /**
         * Populates the device power selection dropdown.
         */
        function populateDeviceSelect() {
            const select = DOMElements.devicePowerSelect;
            select.innerHTML = '';
            for (const key in deviceSpecs) {
                const spec = deviceSpecs[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = spec.type === 'DC_360' ? spec.name : `${spec.name} (${spec.power} kW)`;
                select.appendChild(option);
            }
        }
        
        /**
         * Updates read-only fields based on the selected device.
         */
        function updateDeviceDependentFields() {
            const selectedKey = DOMElements.devicePowerSelect.value;
            const pileCount = parseInt(DOMElements.pileCount.value) || 1;
            const spec = deviceSpecs[selectedKey];

            if (!spec) return;
            
            DOMElements.deviceCostGroup.style.display = 'grid';
            DOMElements.salvageValueGroup.style.display = 'grid';

            if (spec.type === 'DC_360') {
                DOMElements.pileCountLabel.textContent = 'çµ‚ç«¯æ©Ÿæ•¸';
                DOMElements.parkingSpaces.value = pileCount;
                // For 360, cost is complex, so we hide the per-pile display fields
                DOMElements.deviceCostGroup.style.display = 'none';
                DOMElements.salvageValueGroup.style.display = 'none';
            } else {
                DOMElements.pileCountLabel.textContent = 'æ¨æ•¸';
                DOMElements.parkingSpaces.value = pileCount;
                const costWithTax = spec.cost * (1 + (getParamValue('taxRate') || 0));
                DOMElements.deviceCostPerPile.value = Math.round(costWithTax);
                DOMElements.salvageValuePerPile.value = spec.salvage;
            }
        }

        /**
         * Toggles visibility of input sections based on radio button selections.
         */
        function toggleInputSections() {
            const billingMethod = document.querySelector('input[name="billingMethod"]:checked').value;
            DOMElements.fixedRateSection.style.display = billingMethod === 'fixed' ? 'grid' : 'none';
            DOMElements.touRateSection.style.display = billingMethod === 'tou' ? 'block' : 'none';

            const revenueMethod = document.querySelector('input[name="revenueMethod"]:checked').value;
            DOMElements.carsPerDaySection.style.display = revenueMethod === 'byCars' ? 'grid' : 'none';
            DOMElements.kwhPerMonthSection.style.display = revenueMethod === 'byKwh' ? 'grid' : 'none';
            DOMElements.avgKwhPerCarSection.style.display = revenueMethod === 'byCars' ? 'grid' : 'none';

            const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;
            DOMElements.rentBySpaceSection.style.display = rentMethod === 'bySpace' ? 'grid' : 'none';
            DOMElements.rentByLandSection.style.display = rentMethod === 'byLand' ? 'grid' : 'none';
        }

        /**
         * Formats a number into a currency string (NT$).
         */
        function formatCurrency(num, digits = 0) {
            if (isNaN(num)) return 'N/A';
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: digits,
                maximumFractionDigits: digits
            }).format(num);
        }

        /**
         * Saves data to localStorage.
         */
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Failed to save to localStorage", e);
            }
        }

        /**
         * Loads data from localStorage.
         */
        function loadFromLocalStorage(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error("Failed to load from localStorage", e);
                return defaultValue;
            }
        }

        /**
         * Sets up all modal-related event listeners and logic.
         */
        function setupModals() {
            const toggleModal = (modal, show) => {
                modal.style.display = show ? 'flex' : 'none';
                if (show) {
                    modal.querySelectorAll('input[type="password"]').forEach(p => p.value = '');
                    modal.querySelectorAll('.modal-message').forEach(m => { m.style.display = 'none'; m.textContent = ''; });
                    const passwordSection = modal.querySelector('[id$="PasswordInputSection"]');
                    const contentSection = modal.querySelector('[id$="ContentSection"], [id$="formulasSection"]');
                    if(passwordSection && contentSection) {
                        passwordSection.style.display = 'block';
                        contentSection.style.display = 'none';
                    }
                }
            };
            
            DOMElements.openSpecsModalBtn.addEventListener('click', () => toggleModal(DOMElements.specsModal, true));
            DOMElements.closeSpecsModalBtn.addEventListener('click', () => toggleModal(DOMElements.specsModal, false));
            DOMElements.specsLoginBtn.addEventListener('click', () => {
                if (DOMElements.specsPassword.value === currentSpecsPassword) {
                    DOMElements.specsPasswordInputSection.style.display = 'none';
                    DOMElements.specsContentSection.style.display = 'block';
                    populateSpecsModalTable();
                    DOMElements.specsMessage.style.display = 'none';
                } else {
                    DOMElements.specsMessage.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼';
                    DOMElements.specsMessage.className = 'modal-message error';
                    DOMElements.specsMessage.style.display = 'block';
                }
            });
            DOMElements.saveSpecsBtn.addEventListener('click', () => {
                saveSpecsFromModal();
                toggleModal(DOMElements.specsModal, false);
            });
            DOMElements.changeSpecsPasswordBtn.addEventListener('click', changeSpecsPassword);

            DOMElements.openManagementModalBtn.addEventListener('click', () => toggleModal(DOMElements.managementModal, true));
            DOMElements.closeManagementModalBtn.addEventListener('click', () => toggleModal(DOMElements.managementModal, false));
            DOMElements.loginManagementBtn.addEventListener('click', () => {
                if (DOMElements.managementPassword.value === currentManagementPassword) {
                    DOMElements.passwordInputSection.style.display = 'none';
                    DOMElements.formulasSection.style.display = 'block';
                    populateFormulasModal();
                    DOMElements.managementMessage.style.display = 'none';
                } else {
                    DOMElements.managementMessage.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼';
                    DOMElements.managementMessage.className = 'modal-message error';
                    DOMElements.managementMessage.style.display = 'block';
                }
            });
            DOMElements.saveFormulasBtn.addEventListener('click', () => {
                saveFormulasFromModal();
                toggleModal(DOMElements.managementModal, false);
            });
            DOMElements.changePasswordBtn.addEventListener('click', changeManagementPassword);
        }

        function populateSpecsModalTable() {
            const tbody = DOMElements.specsModalTableBody;
            tbody.innerHTML = '';
            const taxRate = getParamValue('taxRate');
            for (const key in deviceSpecs) {
                const spec = deviceSpecs[key];
                let rowHtml = '';
                if (spec.type === 'DC_360') {
                    const cabinetCostTaxed = spec.cabinetCost * (1 + taxRate);
                    const terminalCostTaxed = spec.terminalCost * (1 + taxRate);
                    rowHtml = `
                        <tr class="border-b border-gray-200 bg-indigo-50">
                            <td class="p-3 text-left font-medium text-gray-800 align-top" rowspan="2">${spec.name}</td>
                            <td class="p-3 text-left">èƒ½æºæ«ƒ</td>
                            <td class="p-3 text-right"><input type="number" data-key="${key}" data-field="cabinetCost" value="${spec.cabinetCost}" class="modal-table-input"></td>
                            <td class="p-3 text-right text-gray-600">${formatCurrency(cabinetCostTaxed, 0)}</td>
                            <td class="p-3 text-right"><input type="number" data-key="${key}" data-field="cabinetSalvage" value="${spec.cabinetSalvage}" class="modal-table-input"></td>
                        </tr>
                        <tr class="border-b border-gray-200 bg-indigo-50">
                            <td class="p-3 text-left">çµ‚ç«¯æ©Ÿ</td>
                            <td class="p-3 text-right"><input type="number" data-key="${key}" data-field="terminalCost" value="${spec.terminalCost}" class="modal-table-input"></td>
                            <td class="p-3 text-right text-gray-600">${formatCurrency(terminalCostTaxed, 0)}</td>
                            <td class="p-3 text-right"><input type="number" data-key="${key}" data-field="terminalSalvage" value="${spec.terminalSalvage}" class="modal-table-input"></td>
                        </tr>
                    `;
                } else {
                    const costWithTax = spec.cost * (1 + taxRate);
                    rowHtml = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="p-3 text-left font-medium text-gray-800">${spec.name} (${spec.power} kW)</td>
                            <td class="p-3 text-left">-</td>
                            <td class="p-3 text-right"><input type="number" data-key="${key}" data-field="cost" value="${spec.cost}" class="modal-table-input"></td>
                            <td class="p-3 text-right text-gray-600">${formatCurrency(costWithTax, 0)}</td>
                            <td class="p-3 text-right"><input type="number" data-key="${key}" data-field="salvage" value="${spec.salvage}" class="modal-table-input"></td>
                        </tr>
                    `;
                }
                tbody.insertAdjacentHTML('beforeend', rowHtml);
            }
        }
        
        function saveSpecsFromModal() {
            const inputs = DOMElements.specsModalTableBody.querySelectorAll('input[data-key]');
            inputs.forEach(input => {
                const { key, field } = input.dataset;
                if (deviceSpecs[key]) {
                    deviceSpecs[key][field] = parseFloat(input.value) || 0;
                }
            });
            saveToLocalStorage('deviceSpecs', deviceSpecs);
            populateDeviceSelect();
            runAnalysis();
        }

        function changeSpecsPassword() {
            const oldPass = DOMElements.oldSpecsPassword.value;
            const newPass = DOMElements.newSpecsPassword.value;
            const confirmPass = DOMElements.confirmNewSpecsPassword.value;
            const messageEl = DOMElements.specsPasswordChangeMessage;

            if (oldPass !== currentSpecsPassword) {
                messageEl.textContent = 'èˆŠå¯†ç¢¼ä¸æ­£ç¢ºï¼';
                messageEl.className = 'modal-message error';
            } else if (!newPass || newPass.length < 4) {
                messageEl.textContent = 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦4å€‹å­—å…ƒï¼';
                messageEl.className = 'modal-message error';
            } else if (newPass !== confirmPass) {
                messageEl.textContent = 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦ï¼';
                messageEl.className = 'modal-message error';
            } else {
                currentSpecsPassword = newPass;
                saveToLocalStorage('specsPassword', currentSpecsPassword);
                messageEl.textContent = 'è¦æ ¼è¨­å®šå¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼';
                messageEl.className = 'modal-message success';
            }
            messageEl.style.display = 'block';
            setTimeout(() => messageEl.style.display = 'none', 3000);
        }

        function populateFormulasModal() {
            const container = DOMElements.formulaContainer;
            container.innerHTML = '';
            for (const key in calculationParams) {
                const param = calculationParams[key];
                const value = param.unit === '%' ? param.value * 100 : param.value;
                const row = `
                    <div class="formula-item">
                        <input type="checkbox" id="check-${key}" data-key="${key}" class="formula-item-checkbox" ${param.enabled ? 'checked' : ''}>
                        <label for="param-${key}" class="formula-item-label">${param.label}</label>
                        <div class="formula-item-input-group">
                           <input type="number" id="param-${key}" data-key="${key}" value="${value}" class="input-field w-full">
                           <span class="text-gray-500 font-mono text-sm w-20 text-left">${param.unit}</span>
                        </div>
                        <p class="formula-item-description">${param.description}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', row);
            }
        }
        
        function saveFormulasFromModal() {
            const inputs = DOMElements.formulaContainer.querySelectorAll('input[type="number"][data-key]');
            const checkboxes = DOMElements.formulaContainer.querySelectorAll('input[type="checkbox"][data-key]');

            checkboxes.forEach(checkbox => {
                const { key } = checkbox.dataset;
                if (calculationParams[key]) {
                    calculationParams[key].enabled = checkbox.checked;
                }
            });

            inputs.forEach(input => {
                const { key } = input.dataset;
                if (calculationParams[key]) {
                    let value = parseFloat(input.value) || 0;
                    if (calculationParams[key].unit === '%') {
                        value /= 100;
                    }
                    calculationParams[key].value = value;
                }
            });
            saveToLocalStorage('calculationParams', calculationParams);
            runAnalysis();
        }

        function changeManagementPassword() {
            const oldPass = DOMElements.oldPassword.value;
            const newPass = DOMElements.newPassword.value;
            const confirmPass = DOMElements.confirmNewPassword.value;
            const messageEl = DOMElements.passwordChangeMessage;

            if (oldPass !== currentManagementPassword) {
                messageEl.textContent = 'èˆŠå¯†ç¢¼ä¸æ­£ç¢ºï¼';
                messageEl.className = 'modal-message error';
            } else if (!newPass || newPass.length < 4) {
                messageEl.textContent = 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦4å€‹å­—å…ƒï¼';
                messageEl.className = 'modal-message error';
            } else if (newPass !== confirmPass) {
                messageEl.textContent = 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦ï¼';
                messageEl.className = 'modal-message error';
            } else {
                currentManagementPassword = newPass;
                saveToLocalStorage('managementPassword', currentManagementPassword);
                messageEl.textContent = 'ç®¡ç†å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼';
                messageEl.className = 'modal-message success';
            }
            messageEl.style.display = 'block';
            setTimeout(() => messageEl.style.display = 'none', 3000);
        }
        
        function adjustTouRatios(changedInput) {
            if (isAdjustingTou) return; 
            isAdjustingTou = true;

            const changedKey = changedInput.dataset.tou;
            let newValue = parseFloat(changedInput.value) / 100;
            newValue = Math.max(0, Math.min(1, newValue));

            const oldValue = touRatios[changedKey].value;
            const delta = newValue - oldValue;
            touRatios[changedKey].value = newValue;

            const otherKeys = Object.keys(touRatios).filter(k => k !== changedKey);
            let otherTotal = otherKeys.reduce((sum, k) => sum + touRatios[k].value, 0);

            if (otherTotal > 0) {
                for (const key of otherKeys) {
                    const proportion = touRatios[key].value / otherTotal;
                    touRatios[key].value -= delta * proportion;
                }
            } else {
                 for (const key of otherKeys) {
                    touRatios[key].value -= delta / otherKeys.length;
                }
            }
            
            let currentSum = 0;
            for (const key in touRatios) {
                touRatios[key].value = Math.max(0, touRatios[key].value);
                currentSum += touRatios[key].value;
            }
            if (currentSum > 0) {
                 for (const key in touRatios) {
                    touRatios[key].value /= currentSum;
                }
            }

            DOMElements.peakUsageRatio.value = (touRatios.peak.value * 100).toFixed(0);
            DOMElements.offPeakUsageRatio.value = (touRatios.offpeak.value * 100).toFixed(0);
            DOMElements.holidayUsageRatio.value = (touRatios.holiday.value * 100).toFixed(0);

            saveToLocalStorage('touRatios', touRatios);
            runAnalysis();
            
            isAdjustingTou = false;
        }

        /**
         * Main function to run the analysis and update the UI.
         */
        function runAnalysis() {
            updateDeviceDependentFields();
            const results = calculate();
            updateUI(results);
        }

        /**
         * Adds all event listeners to the page.
         */
        function addEventListeners() {
            const inputs = document.querySelectorAll('.input-field, input[type="radio"]');
            inputs.forEach(input => {
                if (!input.classList.contains('tou-ratio-input')) {
                    input.addEventListener('change', runAnalysis);
                    if(input.type === 'number') {
                        input.addEventListener('input', runAnalysis);
                    }
                }
            });
            
            document.querySelectorAll('input[name="billingMethod"], input[name="revenueMethod"], input[name="rentMethod"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    toggleInputSections();
                    runAnalysis();
                });
            });
            
            document.querySelectorAll('.tou-ratio-input').forEach(input => {
                input.addEventListener('change', (e) => adjustTouRatios(e.target));
            });
        }
        
        /**
         * Initializes the application.
         */
        function init() {
            cacheDOMElements();
            
            deviceSpecs = loadFromLocalStorage('deviceSpecs', deviceSpecs);
            calculationParams = loadFromLocalStorage('calculationParams', calculationParams);
            touRatios = loadFromLocalStorage('touRatios', touRatios);
            currentManagementPassword = loadFromLocalStorage('managementPassword', '0000');
            currentSpecsPassword = loadFromLocalStorage('specsPassword', '0000');

            DOMElements.peakUsageRatio.value = (touRatios.peak.value * 100).toFixed(0);
            DOMElements.offPeakUsageRatio.value = (touRatios.offpeak.value * 100).toFixed(0);
            DOMElements.holidayUsageRatio.value = (touRatios.holiday.value * 100).toFixed(0);

            populateDeviceSelect();
            addEventListeners();
            setupModals();
            toggleInputSections();
            runAnalysis();
        }

        // --- Run Application ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
