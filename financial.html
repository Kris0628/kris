<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>充電站投資效益分析 (專業版 v2.9)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .input-field {
            background-color: white; 
            color: #1f2937; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            padding: 0.65rem 0.85rem; 
            text-align: center;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); 
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); 
        }
        .input-field.readonly {
            background-color: #e5e7eb; 
            color: #6b7280; 
            cursor: not-allowed;
        }
        .label-text {
            font-weight: 600; 
            color: #374151; 
        }
        .card {
            background-color: white;
            border-radius: 1rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            padding: 2rem; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .summary-card {
            background: linear-gradient(135deg, #4f46e5, #3b82f6); 
            color: white;
            border-radius: 1rem; 
            padding: 2rem; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .summary-value {
            font-size: 1.75rem; 
            font-weight: 800;
            line-height: 1.2;
            margin-top: 0.25rem; 
        }
        .summary-label {
            font-size: 2.25rem; 
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 700; 
            margin-bottom: 0.25rem; 
        }
        .table-header { 
            background-color: #f3f4f6; 
            color: #374151; 
            font-weight: 700; 
        }
        .table-cell { 
            padding: 0.9rem 1.2rem; 
            text-align: right; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .table-cell-year { 
            font-weight: 700; 
            color: #1f2937; 
            text-align: left; 
        }
        #pnlTableBody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        #pnlTableBody tr:hover {
            background-color: #eff6ff; 
            transition: background-color 0.2s ease;
        }

        .radio-label { 
            display: inline-flex; 
            align-items: center; 
            cursor: pointer; 
            margin-right: 1.25rem; 
            user-select: none; 
        }
        .radio-label input { display: none; }
        .radio-label span { 
            padding: 0.4rem 1rem; 
            border-radius: 9999px; 
            background-color: #e5e7eb; 
            color: #4b5563; 
            transition: all 0.2s ease; 
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .radio-label input:checked + span { 
            background-color: #4f46e5; 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 2px 5px 0 rgba(79, 70, 229, 0.3); 
        }
        .hidden-section { display: none; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out forwards; 
        }
        .modal-content {
            background-color: white;
            padding: 2rem; /* Reduced */
            border-radius: 1rem; 
            width: 90%;
            max-width: 800px; /* Reduced */
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            animation: slideIn 0.3s ease-out forwards; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: #1f2937; } /* Reduced */
        .modal-close-btn { 
            background: none; border: none; 
            font-size: 1.5rem;
            cursor: pointer; 
            color: #6b7280; transition: color 0.2s ease;
            line-height: 1;
        }
        .modal-close-btn:hover { color: #374151; }
        .modal-table-input { 
            width: 100%; text-align: right; padding: 0.4rem; 
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            background-color: #f9fafb; 
        }
        .modal-table-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .modal-content button {
            background-color: #4f46e5; 
            color: white;
            padding: 0.75rem 1.75rem; 
            border-radius: 0.6rem; 
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
            cursor: pointer;
        }
        .modal-content button:hover {
            background-color: #4338ca; 
            transform: translateY(-1px); 
        }
        .modal-content button:active {
            transform: translateY(0);
        }
        .modal-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
            display: none; 
        }
        .modal-message.error {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .modal-message.success {
            background-color: #d1fae5;
            color: #10b981;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Compact Modal Styles */
        #specsModal th, #specsModal td {
            padding: 0.6rem 0.8rem;
            font-size: 0.875rem;
        }
        #specsModal .modal-table-input {
            padding: 0.3rem 0.4rem;
            font-size: 0.875rem;
        }
        .formula-item {
            padding-bottom: 0.75rem;
            gap: 0.5rem 1rem;
            align-items: center;
        }
        .formula-item-label {
            font-size: 0.9rem;
        }
        .formula-item-description {
            font-size: 0.8rem;
            margin-left: 0;
        }
        .formula-item-input-group {
            margin-top: 0;
        }
        .formula-item-checkbox {
            margin-top: 0;
        }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-800 leading-tight">充電站投資效益分析</h1>
            <p class="text-xl text-gray-600 mt-3">互動式損益評估工具 (專業版 v2.9)</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">設置參數(輸入區)</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-2">
                            <span class="label-text col-span-1">設備功率</span>
                            <select id="devicePowerSelect" class="input-field col-span-2"></select>
                        </div>
                        <div id="pileCountGroup" class="grid grid-cols-2 items-center gap-4">
                            <!-- This will be dynamically populated -->
                        </div>
                        <div class="flex justify-end mt-2">
                            <button id="openSpecsModalBtn" class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out shadow-sm">
                                ⚙️ 規格設定
                            </button>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">車格數值</span>
                            <input type="number" id="parkingSpaces" class="input-field readonly" readonly>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">收費方式</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="billingMethod" value="fixed" checked><span>固定費率</span></label>
                                <label class="radio-label"><input type="radio" name="billingMethod" value="tou"><span>尖離峰</span></label>
                            </div>
                        </div>
                        <div id="fixedRateSection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">每度電收費 (元)</span>
                            <input type="number" id="chargeFeePerKwh" class="input-field" value="10" step="0.1">
                        </div>
                        <div id="touRateSection" class="hidden-section space-y-4">
                             <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text font-bold text-indigo-600">尖離峰均價</span>
                                <input type="text" id="avgTouRate" class="input-field readonly font-bold text-indigo-600" readonly>
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">尖峰費率 (元)</span><input type="number" id="peakRate" class="input-field" value="12" step="0.1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">離峰費率 (元)</span><input type="number" id="offPeakRate" class="input-field" value="8" step="0.1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">假日費率 (元)</span><input type="number" id="holidayRate" class="input-field" value="10" step="0.1">
                            </div>
                            <div class="flex items-center gap-4 mt-2">
                                <div id="touPieChartContainer" class="w-24 h-24 flex-shrink-0">
                                    <canvas id="touPieChart"></canvas>
                                </div>
                                <div class="flex-grow space-y-2">
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="peakUsageRatio" class="text-sm font-medium">尖峰 %</label>
                                        <input type="number" id="peakUsageRatio" data-tou="peak" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="offPeakUsageRatio" class="text-sm font-medium">離峰 %</label>
                                        <input type="number" id="offPeakUsageRatio" data-tou="offpeak" class="input-field col-span-2 tou-ratio-input" value="80" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="holidayUsageRatio" class="text-sm font-medium">假日 %</label>
                                        <input type="number" id="holidayUsageRatio" data-tou="holiday" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">營收估算方式</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byCars" checked><span>依車次</span></label>
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byKwh"><span>依度數</span></label>
                            </div>
                        </div>
                        <div id="carsPerDaySection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">每日車次/槍</span><input type="number" id="carsPerGunPerDay" class="input-field" value="3">
                        </div>
                        <div id="kwhPerMonthSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                           <span class="label-text">每月度數/槍</span><input type="number" id="kwhPerGunPerMonth" class="input-field" value="2700">
                        </div>
                        <div id="avgKwhPerCarSection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">每車平均充電度數 (kWh)</span>
                            <input type="number" id="avgKwhPerCar" class="input-field" value="30">
                        </div>
                        <hr class="border-gray-200"/>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">需求年增率 (%)</span><input type="number" id="demandGrowthRate" class="input-field" value="20">
                        </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">預計營運期 (年)</span><input type="number" id="operationYears" class="input-field" value="15" min="1">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">預估成本</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">台電平均電費</span><input type="number" id="taipowerFee" class="input-field" value="4" step="0.1">
                        </div>
                        <div id="salvageValueGroup" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">設備總殘值</span><input type="number" id="salvageValueTotal" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">折舊年期</span><input type="number" id="depreciationYears" class="input-field" value="5" min="1">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">站點相關成本 (其它)</h2>
                    <div class="space-y-4">
                        <div>
                            <span class="label-text mb-3 block">租金成本</span>
                            <div class="flex flex-wrap gap-3 mb-3">
                                <label class="radio-label"><input type="radio" name="rentMethod" value="bySpace" checked><span>依車格</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="byLand"><span>依土地</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="none"><span>無</span></label>
                            </div>
                            <div id="rentBySpaceSection" class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">車格租金/月</span><input type="number" id="rentPerSpace" class="input-field" value="3000">
                            </div>
                            <div id="rentByLandSection" class="hidden-section grid grid-cols-2 items-center gap-4">
                               <span class="label-text">土地租金/月</span><input type="number" id="rentPerLand" class="input-field" value="15000">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="summary-card">
                        <div class="summary-label">總投資額</div>
                        <div id="totalInvestment" class="summary-value">NT$ 0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">預計回收年限</div>
                        <div id="paybackPeriod" class="summary-value">N/A</div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5" id="pnlChartTitle">充電淨利圖表</h2>
                    <div class="flex-grow h-80">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5">累積損益與回收年限</h2>
                    <div class="flex-grow h-80">
                        <canvas id="cumulativePnlChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <div class="card">
                <h2 class="text-2xl font-bold text-gray-800 mb-5">充電收支/年</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="table-cell text-left">年度</th>
                                <th class="table-cell">總營收</th>
                                <th class="table-cell">總成本</th>
                                <th class="table-cell">充電淨利</th>
                                <th class="table-cell">累積稅前淨利</th>
                            </tr>
                        </thead>
                        <tbody id="pnlTableBody" class="bg-white divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <!-- Calculation Explanation Section -->
                <div class="mt-8 pt-5 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">計算方式說明</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li><strong>總投資額：</strong> 包含設備總成本、建置工程費、線路補助費、技師費、配電盤費、電錶費用(僅DC樁)。(可於管理公式中勾選調整)</li>
                        <li><strong>總營收：</strong> 依選擇的營收估算方式（依車次或依度數）計算，並考慮需求年增率。</li>
                        <li><strong>總成本：</strong> 包含台電電費(含電損)、金流手續費、維運客服、租金、保險、勞務、網路、電子發票、維修備品、延保、TDX上傳費及設備折舊等。 (可於管理公式中勾選調整)</li>
                        <li><strong>充電淨利：</strong> 總營收減去總成本。</li>
                        <li><strong>累積稅前淨利：</strong> 每年充電淨利的累加，從初始投資額開始計算。</li>
                        <li><strong>預計回收年限：</strong> 累積稅前淨利首次轉為正值的年度。</li>
                    </ul>
                    <div class="mt-4 text-right">
                        <button id="openManagementModalBtn" class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out shadow-sm">
                            🔑 管理計算公式
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Specs Modal -->
    <div id="specsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">設備規格與價格設定</h3>
                <button id="closeSpecsModalBtn" class="modal-close-btn">&times;</button>
            </div>
            
            <div id="specsPasswordInputSection" class="space-y-4">
                <div class="grid grid-cols-2 items-center gap-4">
                    <span class="label-text">輸入密碼</span>
                    <input type="password" id="specsPassword" class="input-field" placeholder="預設密碼: 0000">
                </div>
                <div class="text-center">
                    <button id="specsLoginBtn">登入</button>
                </div>
                <div id="specsMessage" class="modal-message"></div>
            </div>

            <div id="specsContentSection" class="hidden-section">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border-collapse">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left w-[20%]">規格名稱</th>
                                <th class="p-3 text-left w-[15%]">組件</th>
                                <th class="p-3 text-right w-[20%]">設備成本(未稅)</th>
                                <th class="p-3 text-right w-[20%]">設備成本 (含稅)</th>
                                <th class="p-3 text-right w-[20%]">預估殘值</th>
                            </tr>
                        </thead>
                        <tbody id="specsModalTableBody">
                            <!-- Data will be populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 text-right">
                    <button id="saveSpecsBtn">儲存並關閉</button>
                </div>

                <hr class="my-6 border-gray-200"/>

                <h4 class="text-xl font-bold text-gray-800 mb-3 mt-6">修改規格設定密碼</h4>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">舊密碼</span>
                        <input type="password" id="oldSpecsPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">新密碼</span>
                        <input type="password" id="newSpecsPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">確認新密碼</span>
                        <input type="password" id="confirmNewSpecsPassword" class="input-field">
                    </div>
                    <div class="text-center">
                        <button id="changeSpecsPasswordBtn" class="bg-green-600 hover:bg-green-700">確認儲存新密碼</button>
                    </div>
                    <div id="specsPasswordChangeMessage" class="modal-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">管理計算公式</h3>
                <button id="closeManagementModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div id="passwordInputSection" class="space-y-4">
                <div class="grid grid-cols-2 items-center gap-4">
                    <span class="label-text">輸入密碼</span>
                    <input type="password" id="managementPassword" class="input-field" placeholder="預設密碼: 0000">
                </div>
                <div class="text-center">
                    <button id="loginManagementBtn">登入</button>
                </div>
                <div id="managementMessage" class="modal-message"></div>
            </div>

            <div id="formulasSection" class="hidden-section space-y-6 mt-6">
                <h4 class="text-xl font-bold text-gray-800 mb-3">詳細計算參數</h4>
                <div id="formulaContainer" class="space-y-4">
                    <!-- All rows will be generated here by JS -->
                </div>
                <div class="mt-6 text-center">
                    <button id="saveFormulasBtn" class="bg-blue-600 hover:bg-blue-700">儲存計算參數</button>
                </div>

                <hr class="my-6 border-gray-200"/>

                <h4 class="text-xl font-bold text-gray-800 mb-3">修改密碼</h4>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">舊密碼</span>
                        <input type="password" id="oldPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">新密碼</span>
                        <input type="password" id="newPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">確認新密碼</span>
                        <input type="password" id="confirmNewPassword" class="input-field">
                    </div>
                    <div class="text-center">
                        <button id="changePasswordBtn" class="bg-green-600 hover:bg-green-700">確認儲存新密碼</button>
                    </div>
                    <div id="passwordChangeMessage" class="modal-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Definitions ---
        let deviceSpecs = {
            '7': { name: 'AC 7kW Smart', cost: 31395, power: 7, salvage: 5000, type: 'AC' },
            '30': { name: 'DC 30kW', cost: 325500, power: 30, salvage: 50000, type: 'DC' },
            '120': { name: 'DC 120kW', cost: 850500, power: 120, salvage: 150000, type: 'DC' },
            '180': { name: 'DC 180kW', cost: 997500, power: 180, salvage: 200000, type: 'DC' },
            '360': { 
                name: 'DC 360kW', 
                power: 360, // Power per cabinet
                cabinetCost: 1575000, 
                terminalCost: 504000, 
                cabinetSalvage: 300000, 
                terminalSalvage: 50000, 
                type: 'DC_360' 
            }
        };

        let pnlChart = null;
        let cumulativePnlChart = null;
        let touPieChart = null;
        let DOMElements = {}; 
        let currentManagementPassword = '0000';
        let currentSpecsPassword = '0000';
        let isAdjustingTou = false; // Flag to prevent recursion in TOU adjustment

        let calculationParams = {
            // Initial Investment
            deviceCost: { value: 0, label: '設備總成本', unit: '元', description: '所有充電樁的含稅總成本。', enabled: true, category: 'investment', readonly: true },
            constructionCost: { value: 500000, label: '建置工程費', unit: '元', description: '場地土木、基礎、裝修等工程費用(一次性)。', enabled: true, category: 'investment' },
            lineSubsidyPerKw: { value: 550, label: '線路補助費/kW', unit: '元', description: '台電線補費，每kW收取的一次性費用。', enabled: true, category: 'investment' },
            technicianFee: { value: 150000, label: '技師費', unit: '元', description: '台電外包技師費用(一次性)。', enabled: true, category: 'investment' },
            distributionPanelFee: { value: 300000, label: '配電盤費', unit: '元', description: '高壓或低壓配電盤費用(一次性)。', enabled: true, category: 'investment' },
            meterFeeBase: { value: 12000, label: '電錶費用(基本)', unit: '元', description: '台電電表基本費用(僅DC樁, 一次性)。', enabled: true, category: 'investment' },
            meterFeePerGun: { value: 1400, label: '電錶費用/槍', unit: '元', description: '每增加一槍的電表費用(僅DC樁, 一次性)。', enabled: true, category: 'investment' },
            taxRate: { value: 0.05, label: '營業稅率', unit: '%', description: '設備購買及相關服務的營業稅率。', enabled: true, category: 'investment' },
            
            // Annual Costs
            maintenanceFee: { value: 37000, label: '維運&客服/年', unit: '元', description: '年度場域維護與線上客服費用。', enabled: true, category: 'annual' },
            transactionFeeRate: { value: 0.03, label: '金流費率', unit: '%', description: '支付給金流服務商的每筆交易手續費率。', enabled: true, category: 'annual' },
            insuranceFee: { value: 8500, label: '意外保險費/年', unit: '元', description: '場域年度意外險費用。', enabled: true, category: 'annual' },
            electronicInvoiceFee: { value: 0.05, label: '電子發票費率', unit: '%', description: '每筆交易的電子發票成本，為總營收的百分比。', enabled: true, category: 'annual' },
            repairPartsRate: { value: 0.01, label: '維修備品(資本支出%)/年', unit: '%', description: '年度維修備品費用，為設備含稅總成本的百分比。', enabled: true, category: 'annual' },
            extendedWarrantyPerPile: { value: 1000, label: '保固延保(樁)/年', unit: '元', description: '每支充電樁的年度延長保固費用。', enabled: true, category: 'annual' },
            laborCost: { value: 60000, label: '勞務成本/年', unit: '元', description: '年度人力、巡檢等相關勞務成本。', enabled: true, category: 'annual' },
            internetFee: { value: 500, label: '網路費/月', unit: '元', description: '場域每月的網路通訊費用。', enabled: true, category: 'annual' },
            tdxUploadFee: { value: 299, label: 'TDX上傳費(槍/月)', unit: '元', description: '每支槍每月上傳資料至交通部TDX平台的費用。', enabled: true, category: 'annual' },
            powerLossRate: { value: 0.05, label: '電損%', unit: '%', description: '電力在傳輸和轉換過程中的損耗率。', enabled: true, category: 'annual' },
        };
        
        // Separate object for TOU ratios to manage them easily
        let touRatios = {
            peak: { value: 0.1, label: '尖峰用電比例' },
            offpeak: { value: 0.8, label: '離峰用電比例' },
            holiday: { value: 0.1, label: '假日用電比例' }
        };

        /**
         * Caches all necessary DOM elements for quick access.
         */
        function cacheDOMElements() {
            const ids = [
                'devicePowerSelect', 'pileCountGroup', 'parkingSpaces', 'openSpecsModalBtn',
                'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'avgTouRate', 'carsPerGunPerDay', 'kwhPerGunPerMonth',
                'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 'taipowerFee',
                'salvageValueTotal', 'depreciationYears', 'salvageValueGroup',
                'fixedRateSection', 'touRateSection', 'carsPerDaySection', 'kwhPerMonthSection', 'avgKwhPerCarSection',
                'rentPerSpace', 'rentPerLand', 'rentBySpaceSection', 'rentByLandSection',
                'totalInvestment', 'paybackPeriod', 'pnlChartTitle', 'pnlTableBody',
                'pnlChart', 'cumulativePnlChart', 'touPieChart', 'touPieChartContainer',
                'peakUsageRatio', 'offPeakUsageRatio', 'holidayUsageRatio',
                // Specs Modal
                'specsModal', 'closeSpecsModalBtn', 'specsPasswordInputSection', 'specsPassword', 'specsLoginBtn', 'specsMessage',
                'specsContentSection', 'specsModalTableBody', 'saveSpecsBtn', 'oldSpecsPassword', 'newSpecsPassword', 'confirmNewSpecsPassword',
                'changeSpecsPasswordBtn', 'specsPasswordChangeMessage',
                // Management Modal
                'managementModal', 'openManagementModalBtn', 'closeManagementModalBtn', 'passwordInputSection', 'managementPassword',
                'loginManagementBtn', 'managementMessage', 'formulasSection', 'formulaContainer', 'saveFormulasBtn',
                'oldPassword', 'newPassword', 'confirmNewPassword', 'changePasswordBtn', 'passwordChangeMessage'
            ];
            ids.forEach(id => {
                if(id) DOMElements[id] = document.getElementById(id);
            });
            
            // Cache radio buttons by name
            DOMElements.billingMethodRadios = document.querySelectorAll('input[name="billingMethod"]');
            DOMElements.revenueMethodRadios = document.querySelectorAll('input[name="revenueMethod"]');
            DOMElements.rentMethodRadios = document.querySelectorAll('input[name="rentMethod"]');
            DOMElements.touRatioInputs = document.querySelectorAll('.tou-ratio-input');
        }

        /**
         * Formats a number into a currency string (e.g., NT$ 1,234,567).
         * @param {number} value The number to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(value) {
            if (isNaN(value)) return 'N/A';
            return new Intl.NumberFormat('zh-TW', { 
                style: 'currency', 
                currency: 'TWD', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0 
            }).format(value);
        }
        
        /**
         * Formats a number with thousand separators.
         * @param {number | string} num The number to format.
         * @returns {string} The formatted number string.
         */
        function formatNumberWithCommas(num) {
            if (num === null || num === undefined) return '';
            const parts = num.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }


        /**
         * Saves data (specs, params, passwords) to localStorage.
         */
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('chargingStation_deviceSpecs', JSON.stringify(deviceSpecs));
                localStorage.setItem('chargingStation_calcParams', JSON.stringify(calculationParams));
                localStorage.setItem('chargingStation_mgmtPwd', currentManagementPassword);
                localStorage.setItem('chargingStation_specsPwd', currentSpecsPassword);
            } catch (e) {
                console.error("Failed to save data to localStorage:", e);
            }
        }

        /**
         * Loads data from localStorage on page startup.
         */
        function loadDataFromLocalStorage() {
            try {
                const storedSpecs = localStorage.getItem('chargingStation_deviceSpecs');
                if (storedSpecs) deviceSpecs = JSON.parse(storedSpecs);

                const storedParams = localStorage.getItem('chargingStation_calcParams');
                if (storedParams) {
                    // Merge stored params with defaults to prevent errors if new params are added
                    const defaultParams = JSON.parse(JSON.stringify(calculationParams)); // Deep copy
                    const loadedParams = JSON.parse(storedParams);
                    calculationParams = {...defaultParams, ...loadedParams};
                }


                const storedMgmtPwd = localStorage.getItem('chargingStation_mgmtPwd');
                if (storedMgmtPwd) currentManagementPassword = storedMgmtPwd;

                const storedSpecsPwd = localStorage.getItem('chargingStation_specsPwd');
                if (storedSpecsPwd) currentSpecsPassword = storedSpecsPwd;
            } catch (e) {
                console.error("Failed to load data from localStorage. Using defaults.", e);
                // Reset to defaults if data is corrupted
                saveDataToLocalStorage();
            }
        }

        /**
         * Gets all user inputs from the DOM and returns them as a structured object.
         * @returns {object} An object containing all parsed input values.
         */
        function getInputs() {
            const selectedPower = DOMElements.devicePowerSelect.value;
            const spec = deviceSpecs[selectedPower];
            const inputs = {
                selectedPower: selectedPower,
                billingMethod: document.querySelector('input[name="billingMethod"]:checked').value,
                revenueMethod: document.querySelector('input[name="revenueMethod"]:checked').value,
                rentMethod: document.querySelector('input[name="rentMethod"]:checked').value,
                chargeFeePerKwh: parseFloat(DOMElements.chargeFeePerKwh.value) || 0,
                peakRate: parseFloat(DOMElements.peakRate.value) || 0,
                offPeakRate: parseFloat(DOMElements.offPeakRate.value) || 0,
                holidayRate: parseFloat(DOMElements.holidayRate.value) || 0,
                carsPerGunPerDay: parseFloat(DOMElements.carsPerGunPerDay.value) || 0,
                kwhPerGunPerMonth: parseFloat(DOMElements.kwhPerGunPerMonth.value) || 0,
                avgKwhPerCar: parseFloat(DOMElements.avgKwhPerCar.value) || 0,
                demandGrowthRate: (parseFloat(DOMElements.demandGrowthRate.value) || 0) / 100,
                operationYears: parseInt(DOMElements.operationYears.value) || 1,
                taipowerFee: parseFloat(DOMElements.taipowerFee.value) || 0,
                depreciationYears: parseInt(DOMElements.depreciationYears.value) || 1,
                rentPerSpace: parseFloat(DOMElements.rentPerSpace.value) || 0,
                rentPerLand: parseFloat(DOMElements.rentPerLand.value) || 0,
            };

            // Handle 360kW specific inputs
            if (spec.type === 'DC_360') {
                const cabinetCountInput = document.getElementById('cabinetCount');
                const terminalCountInput = document.getElementById('terminalCount');
                inputs.cabinetCount = cabinetCountInput ? parseInt(cabinetCountInput.value) || 1 : 1;
                inputs.terminalCount = terminalCountInput ? parseInt(terminalCountInput.value) || 1 : 1;
                inputs.pileCount = inputs.terminalCount;
            } else {
                const pileCountInput = document.getElementById('pileCount');
                inputs.pileCount = pileCountInput ? parseInt(pileCountInput.value) || 1 : 1;
            }
            inputs.parkingSpaces = parseInt(DOMElements.parkingSpaces.value) || 0;

            return inputs;
        }
        
        /**
         * For DC360kW, automatically adjusts cabinet count based on terminals.
         */
        function handleTerminalCountChange() {
            const terminalInput = document.getElementById('terminalCount');
            const cabinetInput = document.getElementById('cabinetCount');
            if (!terminalInput || !cabinetInput) return;

            const terminalCount = parseInt(terminalInput.value) || 0;
            const requiredCabinets = Math.ceil(terminalCount / 6);
            cabinetInput.value = requiredCabinets > 0 ? requiredCabinets : 1;
            
            calculateAndDisplay();
        }

        /**
         * Updates the UI based on the selected device power, especially for the 360kW case.
         */
        function updateDeviceSpecificUI() {
            const selectedPower = DOMElements.devicePowerSelect.value;
            const spec = deviceSpecs[selectedPower];
            const pileCountGroup = DOMElements.pileCountGroup;

            // Clear previous dynamic inputs
            pileCountGroup.innerHTML = '';

            if (spec.type === 'DC_360') {
                // Create inputs for cabinets and terminals
                pileCountGroup.innerHTML = `
                    <span class="label-text">終端槍數</span>
                    <input type="number" id="terminalCount" class="input-field" value="2" min="1">
                    <span class="label-text">機櫃數</span>
                    <input type="number" id="cabinetCount" class="input-field readonly" value="1" min="1" readonly>
                `;
                // Add event listeners to the new inputs
                document.getElementById('terminalCount').addEventListener('input', handleTerminalCountChange);
            } else {
                // Create standard pile count input
                pileCountGroup.innerHTML = `
                    <span id="pileCountLabel" class="label-text">樁數</span>
                    <input type="number" id="pileCount" class="input-field" value="1" min="1">
                `;
                // Add event listener to the new input
                document.getElementById('pileCount').addEventListener('input', calculateAndDisplay);
            }
            updateParkingSpaces();
            updateStaticFields();
        }

        /**
         * Updates the read-only parking spaces field based on pile/terminal count.
         */
        function updateParkingSpaces() {
            const selectedPower = DOMElements.devicePowerSelect.value;
            const spec = deviceSpecs[selectedPower];
            let pileCount = 0;

            if (spec.type === 'DC_360') {
                const terminalInput = document.getElementById('terminalCount');
                if (terminalInput) pileCount = parseInt(terminalInput.value) || 0;
            } else {
                const pileInput = document.getElementById('pileCount');
                if (pileInput) pileCount = parseInt(pileInput.value) || 0;
            }

            // New logic: 1 pile = 2 spaces for all DC, 1 for AC
            if (spec.type.startsWith('DC')) {
                DOMElements.parkingSpaces.value = pileCount * 2;
            } else { // AC
                DOMElements.parkingSpaces.value = pileCount;
            }
        }

        /**
         * Updates read-only fields like device cost and salvage value based on selections.
         */
        function updateStaticFields() {
            const selectedPower = DOMElements.devicePowerSelect.value;
            const spec = deviceSpecs[selectedPower];
            
            let totalSalvage;
            if (spec.type === 'DC_360') {
                const cabinetCount = parseInt(document.getElementById('cabinetCount')?.value) || 1;
                const terminalCount = parseInt(document.getElementById('terminalCount')?.value) || 1;
                totalSalvage = spec.cabinetSalvage * cabinetCount + spec.terminalSalvage * terminalCount;
            } else {
                const pileCount = parseInt(document.getElementById('pileCount')?.value) || 1;
                totalSalvage = spec.salvage * pileCount;
            }
            DOMElements.salvageValueTotal.value = Math.round(totalSalvage);
        }
        
        /**
         * Main calculation function. Gathers inputs, computes financials, and updates the UI.
         */
        function calculateAndDisplay() {
            const inputs = getInputs();
            const spec = deviceSpecs[inputs.selectedPower];
            const p = calculationParams;

            // --- 1. Calculate Initial Investment ---
            const tax = p.taxRate.enabled ? p.taxRate.value : 0;
            let totalDeviceCostUntaxed, totalDeviceCostTaxed, totalSalvageValue;
            
            if (spec.type === 'DC_360') {
                totalDeviceCostUntaxed = (spec.cabinetCost * inputs.cabinetCount) + (spec.terminalCost * inputs.terminalCount);
                totalSalvageValue = (spec.cabinetSalvage * inputs.cabinetCount) + (spec.terminalSalvage * inputs.terminalCount);
            } else {
                totalDeviceCostUntaxed = spec.cost * inputs.pileCount;
                totalSalvageValue = spec.salvage * inputs.pileCount;
            }
            totalDeviceCostTaxed = totalDeviceCostUntaxed * (1 + tax);

            let totalPower = 0;
            if (spec.type === 'DC_360') {
                totalPower = spec.power * inputs.cabinetCount;
            } else {
                totalPower = spec.power * inputs.pileCount;
            }

            const deviceCostForInvestment = p.deviceCost.enabled ? totalDeviceCostTaxed : 0;
            const constructionFee = p.constructionCost.enabled ? p.constructionCost.value : 0;
            const lineSubsidyCost = p.lineSubsidyPerKw.enabled ? p.lineSubsidyPerKw.value * totalPower : 0;
            const technicianCost = p.technicianFee.enabled ? p.technicianFee.value : 0;
            const panelCost = p.distributionPanelFee.enabled ? p.distributionPanelFee.value : 0;
            
            let meterCost = 0;
            if (spec.type.startsWith('DC')) {
                const meterBase = p.meterFeeBase.enabled ? p.meterFeeBase.value : 0;
                const meterPerGun = p.meterFeePerGun.enabled ? p.meterFeePerGun.value : 0;
                meterCost = meterBase + (meterPerGun * inputs.pileCount);
            }

            const totalInitialInvestment = deviceCostForInvestment + constructionFee + lineSubsidyCost + technicianCost + panelCost + meterCost;

            // --- 2. Calculate Annual P&L ---
            let annualData = [];
            let cumulativePnl = -totalInitialInvestment;
            let paybackPeriod = '無法回收';
            let paybackYearFound = false;

            for (let year = 1; year <= inputs.operationYears; year++) {
                // a. Calculate Annual Revenue
                const demandMultiplier = Math.pow(1 + inputs.demandGrowthRate, year - 1);
                let totalKwhPerYear, totalTransactionsPerYear;

                if (inputs.revenueMethod === 'byCars') {
                    totalTransactionsPerYear = inputs.carsPerGunPerDay * inputs.pileCount * 365 * demandMultiplier;
                    totalKwhPerYear = totalTransactionsPerYear * inputs.avgKwhPerCar;
                } else { // byKwh
                    totalKwhPerYear = inputs.kwhPerGunPerMonth * inputs.pileCount * 12 * demandMultiplier;
                    totalTransactionsPerYear = (inputs.avgKwhPerCar > 0) ? totalKwhPerYear / inputs.avgKwhPerCar : 0;
                }

                let annualRevenue = 0;
                if (inputs.billingMethod === 'fixed') {
                    annualRevenue = totalKwhPerYear * inputs.chargeFeePerKwh;
                } else { // tou
                    const peakKwh = totalKwhPerYear * touRatios.peak.value;
                    const offPeakKwh = totalKwhPerYear * touRatios.offpeak.value;
                    const holidayKwh = totalKwhPerYear * touRatios.holiday.value;
                    annualRevenue = (peakKwh * inputs.peakRate) + (offPeakKwh * inputs.offPeakRate) + (holidayKwh * inputs.holidayRate);
                }

                // b. Calculate Annual Costs
                const powerLoss = p.powerLossRate.enabled ? p.powerLossRate.value : 0;
                const electricityCost = totalKwhPerYear * (1 + powerLoss) * inputs.taipowerFee;
                const transactionCost = p.transactionFeeRate.enabled ? annualRevenue * p.transactionFeeRate.value : 0;
                const maintenanceCost = p.maintenanceFee.enabled ? p.maintenanceFee.value : 0;
                const insuranceCost = p.insuranceFee.enabled ? p.insuranceFee.value : 0;
                const labor = p.laborCost.enabled ? p.laborCost.value : 0;
                const internet = p.internetFee.enabled ? p.internetFee.value * 12 : 0;
                const tdxUpload = p.tdxUploadFee.enabled ? p.tdxUploadFee.value * inputs.pileCount * 12 : 0;
                const invoiceCost = p.electronicInvoiceFee.enabled ? annualRevenue * p.electronicInvoiceFee.value : 0;
                const repairPartsCost = p.repairPartsRate.enabled ? totalDeviceCostTaxed * p.repairPartsRate.value : 0;
                const warrantyCost = p.extendedWarrantyPerPile.enabled ? p.extendedWarrantyPerPile.value * inputs.pileCount : 0;
                
                let rentCost = 0;
                if (inputs.rentMethod === 'bySpace') {
                    rentCost = inputs.rentPerSpace * inputs.parkingSpaces * 12;
                } else if (inputs.rentMethod === 'byLand') {
                    rentCost = inputs.rentPerLand * 12;
                }

                const annualDepreciation = (year <= inputs.depreciationYears && inputs.depreciationYears > 0) 
                    ? (totalDeviceCostTaxed - totalSalvageValue) / inputs.depreciationYears 
                    : 0;

                const totalAnnualCost = electricityCost + transactionCost + maintenanceCost + insuranceCost + labor + internet + tdxUpload + invoiceCost + repairPartsCost + warrantyCost + rentCost + annualDepreciation;
                
                // c. Calculate P&L
                const annualPnl = annualRevenue - totalAnnualCost;
                cumulativePnl += annualPnl;

                if (cumulativePnl >= 0 && !paybackYearFound) {
                    const prevCumulativePnl = cumulativePnl - annualPnl;
                    // Fractional year calculation
                    const fraction = prevCumulativePnl !== cumulativePnl ? Math.abs(prevCumulativePnl) / (cumulativePnl - prevCumulativePnl) : 0;
                    paybackPeriod = `${year - 1 + parseFloat(fraction.toFixed(1))} 年`;
                    paybackYearFound = true;
                }

                annualData.push({
                    year: year,
                    revenue: annualRevenue,
                    cost: totalAnnualCost,
                    pnl: annualPnl,
                    cumulativePnl: cumulativePnl,
                });
            }

            // --- 3. Update UI ---
            DOMElements.totalInvestment.textContent = formatCurrency(totalInitialInvestment);
            DOMElements.paybackPeriod.textContent = paybackPeriod;
            updatePnlTable(annualData);
            updatePnlChart(annualData);
            updateCumulativePnlChart(annualData, totalInitialInvestment);
            updateStaticFields();
            updateParkingSpaces();
        }

        /**
         * Populates the P&L table with annual financial data.
         * @param {Array<object>} annualData - The array of annual financial results.
         */
        function updatePnlTable(annualData) {
            const tbody = DOMElements.pnlTableBody;
            tbody.innerHTML = '';
            annualData.forEach(data => {
                const row = `
                    <tr>
                        <td class="table-cell table-cell-year">第 ${data.year} 年</td>
                        <td class="table-cell text-green-600">${formatCurrency(data.revenue)}</td>
                        <td class="table-cell text-red-600">${formatCurrency(data.cost)}</td>
                        <td class="table-cell font-semibold ${data.pnl >= 0 ? 'text-blue-600' : 'text-orange-600'}">${formatCurrency(data.pnl)}</td>
                        <td class="table-cell font-bold ${data.cumulativePnl >= 0 ? 'text-indigo-700' : 'text-pink-700'}">${formatCurrency(data.cumulativePnl)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        /**
         * Initializes or updates the annual P&L chart.
         * @param {Array<object>} annualData - The array of annual financial results.
         */
        function updatePnlChart(annualData) {
            const labels = annualData.map(d => `第 ${d.year} 年`);
            const revenueData = annualData.map(d => d.revenue);
            const costData = annualData.map(d => d.cost);
            const pnlData = annualData.map(d => d.pnl);

            if (pnlChart) {
                pnlChart.data.labels = labels;
                pnlChart.data.datasets[0].data = revenueData;
                pnlChart.data.datasets[1].data = costData;
                pnlChart.data.datasets[2].data = pnlData;
                pnlChart.update();
            } else {
                const ctx = DOMElements.pnlChart.getContext('2d');
                pnlChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '總營收',
                                data: revenueData,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                                order: 2
                            },
                            {
                                label: '總成本',
                                data: costData,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1,
                                order: 2
                            },
                            {
                                label: '充電淨利',
                                data: pnlData,
                                backgroundColor: 'rgba(22, 163, 74, 0.8)',
                                borderColor: 'rgba(22, 163, 74, 1)',
                                type: 'line',
                                fill: false,
                                tension: 0.2,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}`
                                }
                            }
                        }
                    }
                });
            }
        }
        
        /**
         * Initializes or updates the cumulative P&L chart.
         * @param {Array<object>} annualData - The array of annual financial results.
         * @param {number} initialInvestment - The total initial investment cost.
         */
        function updateCumulativePnlChart(annualData, initialInvestment) {
            const labels = ['初始投資', ...annualData.map(d => `第 ${d.year} 年`)];
            const data = [-initialInvestment, ...annualData.map(d => d.cumulativePnl)];

            if (cumulativePnlChart) {
                cumulativePnlChart.data.labels = labels;
                cumulativePnlChart.data.datasets[0].data = data;
                cumulativePnlChart.update();
            } else {
                const ctx = DOMElements.cumulativePnlChart.getContext('2d');
                cumulativePnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '累積稅前淨利',
                            data: data,
                            fill: {
                                target: 'origin',
                                above: 'rgba(59, 130, 246, 0.2)',  // Light Blue
                                below: 'rgba(239, 68, 68, 0.2)'   // Light Red
                            },
                            borderColor: (context) => {
                                const index = context.dataIndex;
                                const value = context.dataset.data[index];
                                return value >= 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(239, 68, 68, 1)';
                            },
                            pointBackgroundColor: (context) => {
                                const index = context.dataIndex;
                                const value = context.dataset.data[index];
                                return value >= 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(239, 68, 68, 1)';
                            },
                            tension: 0.1,
                            pointRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: value => formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}`
                                }
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 0,
                                        yMax: 0,
                                        borderColor: 'rgb(55, 65, 81)',
                                        borderWidth: 2,
                                        borderDash: [6, 6],
                                        label: {
                                            content: '損益兩平',
                                            enabled: true,
                                            position: 'end',
                                            backgroundColor: 'rgba(55, 65, 81, 0.7)',
                                            color: 'white',
                                            font: {
                                                weight: 'bold'
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        /**
         * Initializes or updates the TOU (Time-of-Use) pie chart.
         */
        function updateTouPieChart() {
            const data = [
                touRatios.peak.value * 100,
                touRatios.offpeak.value * 100,
                touRatios.holiday.value * 100
            ];
            
            if (touPieChart) {
                touPieChart.data.datasets[0].data = data;
                touPieChart.update();
            } else {
                const ctx = DOMElements.touPieChart.getContext('2d');
                touPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['尖峰', '離峰', '假日'],
                        datasets: [{
                            data: data,
                            backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.label}: ${context.raw.toFixed(1)}%`
                                }
                            }
                        }
                    }
                });
            }
            updateAvgTouRate();
        }
        
        /**
         * Updates the average TOU rate display.
         */
        function updateAvgTouRate() {
            const peakRate = parseFloat(DOMElements.peakRate.value) || 0;
            const offPeakRate = parseFloat(DOMElements.offPeakRate.value) || 0;
            const holidayRate = parseFloat(DOMElements.holidayRate.value) || 0;
            
            const avgRate = (peakRate * touRatios.peak.value) + 
                            (offPeakRate * touRatios.offpeak.value) + 
                            (holidayRate * touRatios.holiday.value);
            
            DOMElements.avgTouRate.value = `NT$ ${avgRate.toFixed(2)}`;
        }

        /**
         * Adjusts TOU ratios to ensure they sum to 100%.
         * @param {HTMLElement} changedInput - The input element that was changed.
         */
        function adjustTouRatios(changedInput) {
            if (isAdjustingTou) return;
            isAdjustingTou = true;

            let total = 0;
            DOMElements.touRatioInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            if (total !== 100) {
                const diff = 100 - total;
                const otherInputs = Array.from(DOMElements.touRatioInputs).filter(el => el !== changedInput);
                
                if (otherInputs.length > 0) {
                    const firstOther = otherInputs[0];
                    let newValue = (parseFloat(firstOther.value) || 0) + diff;
                    newValue = Math.max(0, Math.min(100, newValue)); // Clamp between 0 and 100
                    firstOther.value = newValue.toFixed(0);
                }
                
                let finalTotal = 0;
                DOMElements.touRatioInputs.forEach(input => {
                    finalTotal += parseFloat(input.value) || 0;
                });
                if (finalTotal !== 100) {
                    const lastInput = DOMElements.touRatioInputs[DOMElements.touRatioInputs.length - 1];
                    let lastValue = (parseFloat(lastInput.value) || 0) + (100 - finalTotal);
                    lastInput.value = Math.max(0, Math.min(100, lastValue)).toFixed(0);
                }
            }
            
            touRatios.peak.value = (parseFloat(DOMElements.peakUsageRatio.value) || 0) / 100;
            touRatios.offpeak.value = (parseFloat(DOMElements.offPeakUsageRatio.value) || 0) / 100;
            touRatios.holiday.value = (parseFloat(DOMElements.holidayUsageRatio.value) || 0) / 100;

            isAdjustingTou = false;
            updateTouPieChart();
            calculateAndDisplay();
        }

        /**
         * Toggles the visibility of UI sections based on radio button selections.
         */
        function toggleSections() {
            const billingMethod = document.querySelector('input[name="billingMethod"]:checked').value;
            DOMElements.fixedRateSection.style.display = billingMethod === 'fixed' ? 'grid' : 'none';
            DOMElements.touRateSection.style.display = billingMethod === 'tou' ? 'block' : 'none';

            const revenueMethod = document.querySelector('input[name="revenueMethod"]:checked').value;
            DOMElements.carsPerDaySection.style.display = revenueMethod === 'byCars' ? 'grid' : 'none';
            DOMElements.avgKwhPerCarSection.style.display = revenueMethod === 'byCars' ? 'grid' : 'none';
            DOMElements.kwhPerMonthSection.style.display = revenueMethod === 'byKwh' ? 'grid' : 'none';

            const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;
            DOMElements.rentBySpaceSection.style.display = rentMethod === 'bySpace' ? 'grid' : 'none';
            DOMElements.rentByLandSection.style.display = rentMethod === 'byLand' ? 'grid' : 'none';
        }

        /**
         * Sets up all event listeners for the application.
         */
        function setupEventListeners() {
            // Main input fields
            const inputsToWatch = [
                'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'carsPerGunPerDay', 'kwhPerGunPerMonth',
                'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 'taipowerFee', 'depreciationYears',
                'rentPerSpace', 'rentPerLand'
            ];
            inputsToWatch.forEach(id => {
                if(DOMElements[id]) DOMElements[id].addEventListener('input', calculateAndDisplay);
            });
            DOMElements.devicePowerSelect.addEventListener('change', () => {
                updateDeviceSpecificUI();
                calculateAndDisplay();
            });

            // Radio buttons
            DOMElements.billingMethodRadios.forEach(radio => radio.addEventListener('change', () => { toggleSections(); calculateAndDisplay(); }));
            DOMElements.revenueMethodRadios.forEach(radio => radio.addEventListener('change', () => { toggleSections(); calculateAndDisplay(); }));
            DOMElements.rentMethodRadios.forEach(radio => radio.addEventListener('change', () => { toggleSections(); calculateAndDisplay(); }));
            
            // TOU Ratio inputs
            DOMElements.touRatioInputs.forEach(input => input.addEventListener('change', (e) => adjustTouRatios(e.target)));

            // Modals
            setupModalListeners('specs', DOMElements.openSpecsModalBtn, DOMElements.closeSpecsModalBtn, DOMElements.specsModal, DOMElements.specsLoginBtn, DOMElements.specsPassword, DOMElements.specsPasswordInputSection, DOMElements.specsContentSection, DOMElements.specsMessage, () => currentSpecsPassword, populateSpecsModal);
            setupModalListeners('management', DOMElements.openManagementModalBtn, DOMElements.closeManagementModalBtn, DOMElements.managementModal, DOMElements.loginManagementBtn, DOMElements.managementPassword, DOMElements.passwordInputSection, DOMElements.formulasSection, DOMElements.managementMessage, () => currentManagementPassword, populateFormulasModal);

            // Modal Save Buttons
            DOMElements.saveSpecsBtn.addEventListener('click', saveSpecsAndClose);
            DOMElements.saveFormulasBtn.addEventListener('click', saveFormulasAndRecalculate);
            
            // Modal Password Change
            DOMElements.changePasswordBtn.addEventListener('click', () => changePassword('management'));
            DOMElements.changeSpecsPasswordBtn.addEventListener('click', () => changePassword('specs'));
        }
        
        /**
         * Generic function to set up listeners for a modal.
         */
        function setupModalListeners(type, openBtn, closeBtn, modal, loginBtn, passwordInput, passSection, contentSection, messageEl, getPassword, onLoginSuccess) {
            openBtn.addEventListener('click', () => {
                modal.style.display = 'flex';
                passSection.style.display = 'block';
                contentSection.style.display = 'none';
                passwordInput.value = '';
                passwordInput.focus();
                hideModalMessage(messageEl);
                if(type === 'management') {
                    populateFormulasModal(); // Recalculate device cost when opening
                }
            });
            
            const closeModal = () => modal.style.display = 'none';
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            const loginAction = () => {
                if (passwordInput.value === getPassword()) {
                    passSection.style.display = 'none';
                    contentSection.style.display = 'block';
                    onLoginSuccess();
                } else {
                    showModalMessage(messageEl, '密碼錯誤', 'error');
                }
            };
            
            loginBtn.addEventListener('click', loginAction);
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    loginAction();
                }
            });

            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
                if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.closest('#formulaContainer')) {
                    e.preventDefault();
                    DOMElements.saveFormulasBtn.click();
                }
            });
        }
        
        // --- Modal Specific Functions ---

        function showModalMessage(element, text, type = 'success') {
            element.textContent = text;
            element.className = `modal-message ${type}`;
            element.style.display = 'block';
        }

        function hideModalMessage(element) {
            element.style.display = 'none';
        }

        function populateSpecsModal() {
            const tbody = DOMElements.specsModalTableBody;
            tbody.innerHTML = '';
            const tax = calculationParams.taxRate.enabled ? calculationParams.taxRate.value : 0;

            Object.keys(deviceSpecs).forEach(key => {
                const spec = deviceSpecs[key];
                if (spec.type === 'DC_360') {
                    tbody.innerHTML += `
                        <tr class="bg-gray-50">
                            <td rowspan="2" class="p-3 align-top font-semibold">${spec.name}</td>
                            <td class="p-3">機櫃 (${spec.power}kW)</td>
                            <td class="p-3"><input type="number" class="modal-table-input" data-key="${key}" data-prop="cabinetCost" value="${spec.cabinetCost}"></td>
                            <td class="p-3 text-right">${formatCurrency(spec.cabinetCost * (1 + tax))}</td>
                            <td class="p-3"><input type="number" class="modal-table-input" data-key="${key}" data-prop="cabinetSalvage" value="${spec.cabinetSalvage}"></td>
                        </tr>
                        <tr class="bg-gray-50 border-b border-gray-300">
                            <td class="p-3">終端槍</td>
                            <td class="p-3"><input type="number" class="modal-table-input" data-key="${key}" data-prop="terminalCost" value="${spec.terminalCost}"></td>
                            <td class="p-3 text-right">${formatCurrency(spec.terminalCost * (1 + tax))}</td>
                            <td class="p-3"><input type="number" class="modal-table-input" data-key="${key}" data-prop="terminalSalvage" value="${spec.terminalSalvage}"></td>
                        </tr>`;
                } else {
                    tbody.innerHTML += `
                        <tr class="border-b border-gray-200">
                            <td class="p-3 font-semibold">${spec.name} (${spec.power}kW ${spec.type})</td>
                            <td class="p-3">-</td>
                            <td class="p-3"><input type="number" class="modal-table-input" data-key="${key}" data-prop="cost" value="${spec.cost}"></td>
                            <td class="p-3 text-right">${formatCurrency(spec.cost * (1 + tax))}</td>
                            <td class="p-3"><input type="number" class="modal-table-input" data-key="${key}" data-prop="salvage" value="${spec.salvage}"></td>
                        </tr>`;
                }
            });
        }

        function saveSpecsAndClose() {
            const inputs = DOMElements.specsModalTableBody.querySelectorAll('input');
            inputs.forEach(input => {
                const key = input.dataset.key;
                const prop = input.dataset.prop;
                if (deviceSpecs[key] && prop) {
                    deviceSpecs[key][prop] = parseFloat(input.value) || 0;
                }
            });
            saveDataToLocalStorage();
            DOMElements.specsModal.style.display = 'none';
            calculateAndDisplay();
        }
        
        function populateFormulasModal() {
            const container = DOMElements.formulaContainer;
            container.innerHTML = '';
            
            // Dynamically calculate current total device cost
            const inputs = getInputs();
            const spec = deviceSpecs[inputs.selectedPower];
            const tax = calculationParams.taxRate.enabled ? calculationParams.taxRate.value : 0;
            let totalDeviceCostTaxed;
            if (spec.type === 'DC_360') {
                totalDeviceCostTaxed = ((spec.cabinetCost * inputs.cabinetCount) + (spec.terminalCost * inputs.terminalCount)) * (1 + tax);
            } else {
                totalDeviceCostTaxed = (spec.cost * inputs.pileCount) * (1 + tax);
            }
            calculationParams.deviceCost.value = totalDeviceCostTaxed;

            Object.keys(calculationParams).forEach(key => {
                const param = calculationParams[key];
                const isPercent = param.unit === '%';
                const valueForDisplay = isPercent ? param.value * 100 : param.value;
                const readonlyAttr = param.readonly ? 'readonly' : '';
                const inputClass = param.readonly ? 'modal-table-input readonly' : 'modal-table-input';

                const row = `
                    <div class="formula-item">
                        <input type="checkbox" id="check_${key}" data-key="${key}" class="formula-item-checkbox" ${param.enabled ? 'checked' : ''}>
                        <label for="check_${key}" class="formula-item-label">${param.label}</label>
                        <div class="formula-item-input-group">
                            <input type="text" id="input_${key}" data-key="${key}" class="${inputClass}" value="${formatNumberWithCommas(valueForDisplay)}" ${readonlyAttr} oninput="this.value = formatNumberWithCommas(this.value.replace(/,/g, ''))">
                            <span class="text-gray-600">${param.unit}</span>
                        </div>
                        <p class="formula-item-description">${param.description}</p>
                    </div>
                `;
                container.innerHTML += row;
            });
        }

        function saveFormulasAndRecalculate() {
            const inputs = DOMElements.formulaContainer.querySelectorAll('input[type="text"]');
            const checkboxes = DOMElements.formulaContainer.querySelectorAll('input[type="checkbox"]');
            
            inputs.forEach(input => {
                const key = input.dataset.key;
                if (calculationParams[key] && !calculationParams[key].readonly) {
                    const isPercent = calculationParams[key].unit === '%';
                    let value = parseFloat(input.value.replace(/,/g, '')) || 0;
                    calculationParams[key].value = isPercent ? value / 100 : value;
                }
            });

            checkboxes.forEach(checkbox => {
                const key = checkbox.dataset.key;
                if (calculationParams[key]) {
                    calculationParams[key].enabled = checkbox.checked;
                }
            });
            
            saveDataToLocalStorage();
            showModalMessage(DOMElements.managementMessage, '計算參數已儲存', 'success');
            setTimeout(() => hideModalMessage(DOMElements.managementMessage), 2000);
            calculateAndDisplay();
        }

        function changePassword(type) {
            const oldPwdInput = (type === 'management') ? DOMElements.oldPassword : DOMElements.oldSpecsPassword;
            const newPwdInput = (type === 'management') ? DOMElements.newPassword : DOMElements.newSpecsPassword;
            const confirmPwdInput = (type === 'management') ? DOMElements.confirmNewPassword : DOMElements.confirmNewSpecsPassword;
            const messageEl = (type === 'management') ? DOMElements.passwordChangeMessage : DOMElements.specsPasswordChangeMessage;
            const currentPassword = (type === 'management') ? currentManagementPassword : currentSpecsPassword;

            if (oldPwdInput.value !== currentPassword) {
                showModalMessage(messageEl, '舊密碼不正確', 'error');
                return;
            }
            if (!newPwdInput.value || newPwdInput.value.length < 4) {
                showModalMessage(messageEl, '新密碼長度至少需要4個字元', 'error');
                return;
            }
            if (newPwdInput.value !== confirmPwdInput.value) {
                showModalMessage(messageEl, '新密碼與確認密碼不相符', 'error');
                return;
            }

            if (type === 'management') {
                currentManagementPassword = newPwdInput.value;
            } else {
                currentSpecsPassword = newPwdInput.value;
            }
            
            saveDataToLocalStorage();
            showModalMessage(messageEl, '密碼已成功更新', 'success');
            oldPwdInput.value = '';
            newPwdInput.value = '';
            confirmPwdInput.value = '';
            setTimeout(() => hideModalMessage(messageEl), 2000);
        }

        /**
         * Initializes the application when the DOM is fully loaded.
         */
        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            loadDataFromLocalStorage();

            // Populate device power select dropdown
            const select = DOMElements.devicePowerSelect;
            Object.keys(deviceSpecs).forEach(power => {
                const option = document.createElement('option');
                option.value = power;
                option.textContent = deviceSpecs[power].name;
                select.appendChild(option);
            });
            select.value = '120'; // Set a default value

            setupEventListeners();
            updateDeviceSpecificUI(); // Initial setup for the default device
            toggleSections();
            updateTouPieChart();
            calculateAndDisplay(); // Initial calculation
        });

    </script>
</body>
</html>
