<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å……é›»ç«™æŠ•è³‡æ•ˆç›Šåˆ†æ (å°ˆæ¥­ç‰ˆ v4.4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .input-field {
            background-color: white; 
            color: #1f2937; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            padding: 0.65rem 0.85rem; 
            text-align: center;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); 
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); 
        }
        .input-field.readonly {
            background-color: #e5e7eb; 
            color: #6b7280; 
            cursor: not-allowed;
        }
        .label-text {
            font-weight: 600; 
            color: #374151; 
        }
        .card {
            background-color: white;
            border-radius: 1rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            padding: 2rem; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .summary-card {
            background: linear-gradient(135deg, #4f46e5, #3b82f6); 
            color: white;
            border-radius: 1rem; 
            padding: 2rem; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .summary-value {
            font-size: 1.75rem; 
            font-weight: 800;
            line-height: 1.2;
            margin-top: 0.25rem; 
        }
        .summary-label {
            font-size: 2.25rem; 
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 700; 
            margin-bottom: 0.25rem; 
        }
        .table-header { 
            background-color: #f3f4f6; 
            color: #374151; 
            font-weight: 700; 
        }
        .table-cell { 
            padding: 0.9rem 1.2rem; 
            text-align: right; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .table-cell-year { 
            font-weight: 700; 
            color: #1f2937; 
            text-align: left; 
        }
        #pnlTableBody tr:nth-child(even), #kwhStatsTableBody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        #pnlTableBody tr.pnl-row:hover, #kwhStatsTableBody tr:hover {
            background-color: #eff6ff; 
            transition: background-color 0.2s ease;
        }
        #pnlTableBody tr.pnl-row {
            cursor: pointer;
        }
        .details-row td {
            padding: 0;
            background-color: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .details-container {
            padding: 1.5rem;
            max-width: 48rem;
            margin: auto;
        }
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem 2.5rem;
        }
        .details-section h4 {
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .details-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            align-items: baseline;
            font-size: 0.875rem;
            padding: 0.3rem 0;
        }
        .details-item span:first-child {
            color: #6b7280;
            text-align: left;
        }
        .details-item span:last-child {
            color: #1f2937;
            font-weight: 500;
            text-align: right;
        }

        .radio-label { 
            display: inline-flex; 
            align-items: center; 
            cursor: pointer; 
            margin-right: 1.25rem; 
            user-select: none; 
        }
        .radio-label input { display: none; }
        .radio-label span { 
            padding: 0.4rem 1rem; 
            border-radius: 9999px; 
            background-color: #e5e7eb; 
            color: #4b5563; 
            transition: all 0.2s ease; 
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .radio-label input:checked + span { 
            background-color: #4f46e5; 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 2px 5px 0 rgba(79, 70, 229, 0.3); 
        }
        .hidden-section { display: none; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out forwards; 
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem; 
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            animation: slideIn 0.3s ease-out forwards; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: #1f2937; }
        .modal-close-btn { 
            background: none; border: none; 
            font-size: 1.5rem;
            cursor: pointer; 
            color: #6b7280; transition: color 0.2s ease;
            line-height: 1;
        }
        .modal-close-btn:hover { color: #374151; }
        .modal-table-input { 
            width: 100%; text-align: right; padding: 0.4rem; 
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            background-color: #f9fafb; 
        }
        .modal-table-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .modal-content button {
            background-color: #4f46e5; 
            color: white;
            padding: 0.75rem 1.75rem; 
            border-radius: 0.6rem; 
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
            cursor: pointer;
        }
        .modal-content button:hover {
            background-color: #4338ca; 
            transform: translateY(-1px); 
        }
        .modal-content button:active {
            transform: translateY(0);
        }
        .modal-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
            display: none; 
        }
        .modal-message.error {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .modal-message.success {
            background-color: #d1fae5;
            color: #10b981;
        }
        .password-section-compact {
            font-size: 0.9rem;
        }
        .password-section-compact .grid {
            gap: 0.5rem 1rem;
        }
        .password-section-compact .input-field {
            padding: 0.5rem 0.75rem;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Compact Modal Styles */
        #specsModal th, #specsModal td {
            padding: 0.6rem 0.8rem;
            font-size: 0.875rem;
        }
        #specsModal .modal-table-input {
            padding: 0.3rem 0.4rem;
            font-size: 0.875rem;
        }
        .formula-item {
            padding-bottom: 0.75rem;
            gap: 0.5rem 1rem;
            align-items: center;
        }
        .formula-item-label {
            font-size: 0.9rem;
        }
        .formula-item-description {
            font-size: 0.8rem;
            margin-left: 0;
        }
        .formula-item-input-group {
            margin-top: 0;
        }
        .formula-item-checkbox {
            margin-top: 0;
        }
        #kwhTableIcon.rotate-180 {
            transform: rotate(180deg);
        }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-800 leading-tight">å……é›»ç«™æŠ•è³‡æ•ˆç›Šåˆ†æ</h1>
            <p class="text-xl text-gray-600 mt-3">äº’å‹•å¼æç›Šè©•ä¼°å·¥å…· (å°ˆæ¥­ç‰ˆ v4.4)</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">è¨­ç½®åƒæ•¸(è¼¸å…¥å€)</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-2">
                            <span class="label-text col-span-1">è¨­å‚™åŠŸç‡</span>
                            <select id="devicePowerSelect" class="input-field col-span-2"></select>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button id="openSpecsModalBtn" class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out shadow-sm">
                                âš™ï¸ è¦æ ¼è¨­å®š
                            </button>
                        </div>
                        <div id="pileCountGroup" class="grid grid-cols-2 items-center gap-4">
                            <!-- This will be dynamically populated -->
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è»Šæ ¼æ•¸å€¼</span>
                            <input type="number" id="parkingSpaces" class="input-field readonly" readonly>
                        </div>
                         <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è¨­å‚™è²»ç”¨</span>
                            <input type="text" id="equipmentCostDisplayMain" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è¨­å‚™æ®˜å€¼</span>
                            <input type="text" id="salvageValueDisplay" class="input-field readonly" readonly>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">æ”¶è²»æ–¹å¼</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="billingMethod" value="fixed" checked><span>å›ºå®šè²»ç‡</span></label>
                                <label class="radio-label"><input type="radio" name="billingMethod" value="tou"><span>å°–é›¢å³°</span></label>
                            </div>
                        </div>
                        <div id="fixedRateSection" class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æ¯åº¦é›»æ”¶è²» (å…ƒ)</span>
                            <input type="number" id="chargeFeePerKwh" class="input-field" value="10" step="0.1">
                        </div>
                        <div id="touRateSection" class="hidden-section space-y-4">
                             <div class="grid grid-cols-2 items-center gap-4">
                                 <span class="label-text font-bold text-indigo-600">å°–é›¢å³°å‡åƒ¹</span>
                                 <input type="text" id="avgTouRate" class="input-field readonly font-bold text-indigo-600" readonly>
                             </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">å°–å³°è²»ç‡ (å…ƒ)</span><input type="number" id="peakRate" class="input-field" value="12" step="0.1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">é›¢å³°è²»ç‡ (å…ƒ)</span><input type="number" id="offPeakRate" class="input-field" value="8" step="0.1">
                            </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                                <span class="label-text">å‡æ—¥è²»ç‡ (å…ƒ)</span><input type="number" id="holidayRate" class="input-field" value="10" step="0.1">
                            </div>
                            <div class="flex items-center gap-4 mt-2">
                                <div id="touPieChartContainer" class="w-24 h-24 flex-shrink-0">
                                    <canvas id="touPieChart"></canvas>
                                </div>
                                <div class="flex-grow space-y-2">
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="peakUsageRatio" class="text-sm font-medium">å°–å³° %</label>
                                        <input type="number" id="peakUsageRatio" data-tou="peak" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="offPeakUsageRatio" class="text-sm font-medium">é›¢å³° %</label>
                                        <input type="number" id="offPeakUsageRatio" data-tou="offpeak" class="input-field col-span-2 tou-ratio-input" value="80" min="0" max="100">
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2">
                                        <label for="holidayUsageRatio" class="text-sm font-medium">å‡æ—¥ %</label>
                                        <input type="number" id="holidayUsageRatio" data-tou="holiday" class="input-field col-span-2 tou-ratio-input" value="10" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200"/>
                        <div>
                            <span class="label-text mb-3 block">ç‡Ÿæ”¶ä¼°ç®—æ–¹å¼</span>
                            <div class="flex flex-wrap gap-3">
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byCars" checked><span>ä¾è»Šæ¬¡</span></label>
                                <label class="radio-label"><input type="radio" name="revenueMethod" value="byKwh"><span>ä¾åº¦æ•¸</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æ¯æ—¥è»Šæ¬¡/æ§</span><input type="text" id="carsPerGunPerDay" class="input-field" value="3">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                           <span class="label-text">æ¯æœˆåº¦æ•¸/æ§</span><input type="text" id="kwhPerGunPerMonth" class="input-field" value="2,700">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æ¯è»Šå¹³å‡å……é›»åº¦æ•¸ (kWh)</span>
                            <input type="number" id="avgKwhPerCar" class="input-field" value="30">
                        </div>
                        <hr class="border-gray-200"/>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">éœ€æ±‚å¹´å¢ç‡ (%)</span><input type="number" id="demandGrowthRate" class="input-field" value="20">
                        </div>
                            <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">é è¨ˆç‡Ÿé‹æœŸ (å¹´)</span><input type="number" id="operationYears" class="input-field" value="15" min="1">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">å»ºç½®æˆæœ¬(é ä¼°)</h2>
                    <div class="space-y-4">
                         <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">æŠ˜èˆŠæ”¤æå¹´é™</span><input type="number" id="depreciationYears" class="input-field" value="5" min="1">
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è¨­å‚™æˆæœ¬(æ‰£é™¤æ®˜å€¼)</span>
                            <input type="text" id="depreciableCostDisplay" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">è«‹é›»(é ä¼°)</span>
                            <input type="text" id="taipowerCostDisplay" class="input-field readonly" readonly>
                        </div>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text">å·¥ç¨‹(é ä¼°)</span>
                            <input type="text" id="constructionCostInput" class="input-field" value="500,000">
                        </div>
                        <hr class="border-gray-200 my-2"/>
                        <div class="grid grid-cols-2 items-center gap-4">
                            <span class="label-text font-bold">ç¸½è¨ˆ</span>
                            <input type="text" id="totalInitialCostDisplay" class="input-field readonly font-bold" readonly>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5 pb-3 border-b border-gray-200">ç«™é»ç›¸é—œæˆæœ¬ (å…¶å®ƒ)</h2>
                    <div class="space-y-4">
                        <div>
                            <span class="label-text mb-3 block">ç§Ÿé‡‘æˆæœ¬</span>
                            <div class="flex flex-wrap gap-3 mb-3">
                                <label class="radio-label"><input type="radio" name="rentMethod" value="bySpace" checked><span>ä¾è»Šæ ¼</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="byLand"><span>ä¾åœŸåœ°</span></label>
                                <label class="radio-label"><input type="radio" name="rentMethod" value="none"><span>ç„¡</span></label>
                            </div>
                            <div class="space-y-4">
                                <div id="rentBySpaceSection" class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">è»Šæ ¼ç§Ÿé‡‘/æœˆ</span><input type="text" id="rentPerSpace" class="input-field" value="500">
                                </div>
                                <div id="rentByLandSection" class="grid grid-cols-2 items-center gap-4">
                                    <span class="label-text">åœŸåœ°ç§Ÿé‡‘/æœˆ</span><input type="text" id="rentPerLand" class="input-field" value="15,000">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="summary-card">
                        <div class="summary-label">ç¸½æŠ•è³‡é¡</div>
                        <div id="totalInvestment" class="summary-value">NT$ 0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">é è¨ˆå›æ”¶å¹´é™</div>
                        <div id="paybackPeriod" class="summary-value">N/A</div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5" id="pnlChartTitle">å……é›»æ·¨åˆ©åœ–è¡¨</h2>
                    <div class="flex-grow h-80">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-5">ç´¯ç©æç›Šèˆ‡å›æ”¶å¹´é™</h2>
                    <div class="flex-grow h-80">
                        <canvas id="cumulativePnlChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 space-y-8">
            <div class="card">
                <div class="flex justify-between items-center cursor-pointer" id="toggleKwhTableBtn">
                    <h2 class="text-2xl font-bold text-gray-800">é ä¼°å……é›»åº¦æ•¸</h2>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium text-gray-500">å–®ä½ï¼škWh</span>
                        <button class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg id="kwhTableIcon" class="w-6 h-6 text-gray-600 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="kwhTableContainer" class="overflow-hidden transition-all duration-500 ease-in-out" style="max-height: 0px;">
                    <div class="overflow-x-auto rounded-lg border border-gray-200 mt-5">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header">
                                <tr>
                                    <th class="table-cell text-left">å¹´åº¦</th>
                                    <th class="table-cell">å……é›»åº¦æ•¸/æ—¥ (å¹³å‡)</th>
                                    <th class="table-cell">å……é›»åº¦æ•¸/æœˆ (å¹³å‡)</th>
                                    <th class="table-cell">å……é›»åº¦æ•¸/å¹´</th>
                                </tr>
                            </thead>
                            <tbody id="kwhStatsTableBody" class="bg-white divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl font-bold text-gray-800">å……é›»æ”¶æ”¯/å¹´</h2>
                    <span class="text-sm font-medium text-gray-500">å–®ä½ï¼šå…ƒ</span>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="table-cell text-left">å¹´åº¦</th>
                                <th class="table-cell">ç¸½ç‡Ÿæ”¶</th>
                                <th class="table-cell">ç¸½æˆæœ¬</th>
                                <th class="table-cell">å……é›»æ·¨åˆ©</th>
                                <th class="table-cell">ç´¯ç©ç¨…å‰æ·¨åˆ©</th>
                            </tr>
                        </thead>
                        <tbody id="pnlTableBody" class="bg-white divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
                <!-- Calculation Explanation Section -->
                <div class="mt-8 pt-5 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">è¨ˆç®—æ–¹å¼èªªæ˜</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li><strong>ç¸½æŠ•è³‡é¡ï¼š</strong> å»ºç½®å……é›»ç«™æ‰€éœ€çš„æ‰€æœ‰åˆæœŸèŠ±è²»ã€‚</li>
                        <li><strong>ç¸½ç‡Ÿæ”¶ï¼š</strong> ä¾æ“šæ‚¨é¸æ“‡çš„ã€Œä¾è»Šæ¬¡ã€æˆ–ã€Œä¾åº¦æ•¸ã€æ¨¡å‹ï¼Œä¸¦è¨ˆå…¥ã€Œéœ€æ±‚å¹´å¢ç‡ã€å¾Œçš„å¹´åº¦æ”¶å…¥ã€‚</li>
                        <li><strong>ç¸½æˆæœ¬ï¼š</strong> å¹´åº¦ç‡Ÿé‹æ‰€éœ€çš„æ‰€æœ‰é–‹éŠ·ï¼ŒåŒ…å«é›»è²»ã€ç¶­è­·ã€ç§Ÿé‡‘ã€é‡‘æµã€ä¿éšªåŠè¨­å‚™æŠ˜èˆŠç­‰ã€‚</li>
                        <li><strong>å……é›»æ·¨åˆ©ï¼š</strong> å¹´åº¦çš„ã€Œç¸½ç‡Ÿæ”¶ã€æ¸›å»ã€Œç¸½æˆæœ¬ã€ã€‚</li>
                        <li><strong>ç´¯ç©ç¨…å‰æ·¨åˆ©ï¼š</strong> å¾ã€Œç¸½æŠ•è³‡é¡ã€ï¼ˆè² å€¼ï¼‰é–‹å§‹ï¼Œé€å¹´ç´¯åŠ ã€Œå……é›»æ·¨åˆ©ã€å¾Œçš„æ•¸å€¼ã€‚</li>
                        <li><strong>é è¨ˆå›æ”¶å¹´é™ï¼š</strong> ã€Œç´¯ç©ç¨…å‰æ·¨åˆ©ã€ç”±è² è½‰æ­£çš„å¹´åº¦ã€‚</li>
                    </ul>
                    <div class="mt-4 text-right">
                        <button id="openManagementModalBtn" class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out shadow-sm">
                            ğŸ”‘ ç®¡ç†è¨ˆç®—å…¬å¼
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Specs Modal -->
    <div id="specsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¨­å‚™è¦æ ¼èˆ‡åƒ¹æ ¼è¨­å®š</h3>
                <button id="closeSpecsModalBtn" class="modal-close-btn">&times;</button>
            </div>
            
            <div id="specsPasswordInputSection" class="space-y-4 password-section-compact">
                <div class="grid grid-cols-2 items-center gap-4">
                    <span class="label-text">è¼¸å…¥å¯†ç¢¼</span>
                    <input type="password" id="specsPassword" class="input-field" placeholder="é è¨­å¯†ç¢¼: 0000">
                </div>
                <div class="text-center">
                    <button id="specsLoginBtn">ç™»å…¥</button>
                </div>
                <div id="specsMessage" class="modal-message"></div>
            </div>

            <div id="specsContentSection" class="hidden">
                <div class="flex justify-between items-center mb-5">
                    <h4 class="text-xl font-bold text-gray-800">åƒ¹æ ¼è¨­å®š</h4>
                    <span class="text-sm font-medium text-gray-500">å–®ä½ï¼šå…ƒ</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border-collapse">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 text-left w-[20%]">è¦æ ¼åç¨±</th>
                                <th class="p-3 text-left w-[15%]">çµ„ä»¶</th>
                                <th class="p-3 text-right w-[20%]">è¨­å‚™æˆæœ¬(æœªç¨…)</th>
                                <th class="p-3 text-right w-[15%]">è¨­å‚™æˆæœ¬ (å«ç¨…)</th>
                                <th class="p-3 text-right w-[15%]">é ä¼°æ®˜å€¼ %</th>
                                <th class="p-3 text-right w-[15%]">é ä¼°æ®˜å€¼</th>
                            </tr>
                        </thead>
                        <tbody id="specsModalTableBody">
                            <!-- Data will be populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 text-right">
                    <button id="saveSpecsBtn">å„²å­˜ä¸¦é—œé–‰</button>
                </div>

                <hr class="my-6 border-gray-200"/>

                <h4 class="text-xl font-bold text-gray-800 mb-3 mt-6">ä¿®æ”¹è¦æ ¼è¨­å®šå¯†ç¢¼</h4>
                <div class="space-y-4 password-section-compact">
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">èˆŠå¯†ç¢¼</span>
                        <input type="password" id="oldSpecsPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">æ–°å¯†ç¢¼</span>
                        <input type="password" id="newSpecsPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">ç¢ºèªæ–°å¯†ç¢¼</span>
                        <input type="password" id="confirmNewSpecsPassword" class="input-field">
                    </div>
                    <div class="text-center">
                        <button id="changeSpecsPasswordBtn" class="bg-green-600 hover:bg-green-700">ç¢ºèªå„²å­˜æ–°å¯†ç¢¼</button>
                    </div>
                    <div id="specsPasswordChangeMessage" class="modal-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç®¡ç†è¨ˆç®—å…¬å¼</h3>
                <button id="closeManagementModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div id="passwordInputSection" class="space-y-4 password-section-compact">
                <div class="grid grid-cols-2 items-center gap-4">
                    <span class="label-text">è¼¸å…¥å¯†ç¢¼</span>
                    <input type="password" id="managementPassword" class="input-field" placeholder="é è¨­å¯†ç¢¼: 0000">
                </div>
                <div class="text-center">
                    <button id="loginManagementBtn">ç™»å…¥</button>
                </div>
                <div id="managementMessage" class="modal-message"></div>
            </div>

            <div id="formulasSection" class="hidden">
                <h4 class="text-xl font-bold text-gray-800 mb-3">è©³ç´°è¨ˆç®—åƒæ•¸</h4>
                <div id="formulaContainer" class="space-y-4">
                    <!-- All rows will be generated here by JS -->
                </div>
                <div class="mt-6 text-center">
                    <button id="saveFormulasBtn" class="bg-blue-600 hover:bg-blue-700">å„²å­˜è¨ˆç®—åƒæ•¸</button>
                </div>

                <hr class="my-6 border-gray-200"/>

                <h4 class="text-xl font-bold text-gray-800 mb-3">ä¿®æ”¹å¯†ç¢¼</h4>
                <div class="space-y-4 password-section-compact">
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">èˆŠå¯†ç¢¼</span>
                        <input type="password" id="oldPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">æ–°å¯†ç¢¼</span>
                        <input type="password" id="newPassword" class="input-field">
                    </div>
                    <div class="grid grid-cols-2 items-center gap-4">
                        <span class="label-text">ç¢ºèªæ–°å¯†ç¢¼</span>
                        <input type="password" id="confirmNewSpecsPassword" class="input-field">
                    </div>
                    <div class="text-center">
                        <button id="changeSpecsPasswordBtn" class="bg-green-600 hover:bg-green-700">ç¢ºèªå„²å­˜æ–°å¯†ç¢¼</button>
                    </div>
                    <div id="passwordChangeMessage" class="modal-message"></div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Data Definitions ---
    let deviceSpecs = {
        '7': { name: 'AC 7kW Smart', cost: 31395, power: 7, type: 'AC' },
        '30': { name: 'DC 30kW', cost: 325500, power: 30, type: 'DC' },
        '120': { name: 'DC 120kW', cost: 850500, power: 120, type: 'DC' },
        '180': { name: 'DC 180kW', cost: 997500, power: 180, type: 'DC' },
        '360': { 
            name: 'DC 360kW', 
            power: 360, // Power per cabinet
            cabinetCost: 1575000, 
            terminalCost: 504000, 
            type: 'DC_360' 
        }
    };
    
    // Initialize salvage values to 10% of cost
    Object.values(deviceSpecs).forEach(spec => {
        if (spec.type === 'DC_360') {
            spec.cabinetSalvage = spec.cabinetCost * 0.1;
            spec.terminalSalvage = spec.terminalCost * 0.1;
        } else {
            spec.salvage = spec.cost * 0.1;
        }
    });


    let pnlChart = null;
    let cumulativePnlChart = null;
    let touPieChart = null;
    let DOMElements = {}; 
    let currentManagementPassword = '0000';
    let currentSpecsPassword = '0000';
    let isAdjustingTou = false; // Flag to prevent recursion in TOU adjustment
    let currentResults = {}; // To store the latest calculation results for details expansion
    let previousRentPerSpace = 500;
    let previousRentPerLand = 15000;

    let calculationParams = {
        // Initial Investment
        deviceCost: { value: 0, label: 'è¨­å‚™ç¸½æˆæœ¬', unit: 'å…ƒ', description: 'æ‰€æœ‰å……é›»æ¨çš„å«ç¨…ç¸½æˆæœ¬ã€‚', enabled: true, category: 'investment', readonly: true },
        constructionCost: { value: 500000, label: 'å»ºç½®å·¥ç¨‹è²»', unit: 'å…ƒ', description: 'å ´åœ°åœŸæœ¨ã€åŸºç¤ã€è£ä¿®ç­‰å·¥ç¨‹è²»ç”¨(ä¸€æ¬¡æ€§)ã€‚', enabled: true, category: 'investment', readonly: true },
        lineSubsidyPerKw: { value: 550, label: 'ç·šè·¯è£œåŠ©è²»/kW', unit: 'å…ƒ', description: 'å°é›»ç·šè£œè²»ï¼Œæ¯kWæ”¶å–çš„ä¸€æ¬¡æ€§è²»ç”¨ã€‚', enabled: true, category: 'investment' },
        technicianFee: { value: 150000, label: 'æŠ€å¸«è²»', unit: 'å…ƒ', description: 'å°é›»å¤–åŒ…æŠ€å¸«è²»ç”¨(ä¸€æ¬¡æ€§)ã€‚', enabled: true, category: 'investment' },
        distributionPanelFee: { value: 300000, label: 'é…é›»ç›¤è²»', unit: 'å…ƒ', description: 'é«˜å£“æˆ–ä½å£“é…é›»ç›¤è²»ç”¨(ä¸€æ¬¡æ€§)ã€‚', enabled: true, category: 'investment' },
        meterFeeBase: { value: 12000, label: 'é›»éŒ¶è²»ç”¨(åŸºæœ¬)', unit: 'å…ƒ', description: 'å°é›»é›»è¡¨åŸºæœ¬è²»ç”¨(åƒ…DCæ¨, ä¸€æ¬¡æ€§)ã€‚', enabled: true, category: 'investment' },
        meterFeePerGun: { value: 1400, label: 'é›»éŒ¶è²»ç”¨/æ§', unit: 'å…ƒ', description: 'æ¯å¢åŠ ä¸€æ§çš„é›»è¡¨è²»ç”¨(åƒ…DCæ¨, ä¸€æ¬¡æ€§)ã€‚', enabled: true, category: 'investment' },
        taxRate: { value: 0.05, label: 'ç‡Ÿæ¥­ç¨…ç‡', unit: '%', description: 'è¨­å‚™è³¼è²·åŠç›¸é—œæœå‹™çš„ç‡Ÿæ¥­ç¨…ç‡ã€‚', enabled: true, category: 'investment' },
        
        // Annual Costs
        taipowerFee: { value: 4, label: 'å°é›»å¹³å‡é›»è²»', unit: 'å…ƒ', description: 'å‘å°é›»è³¼é›»çš„æ¯åº¦å¹³å‡æˆæœ¬ã€‚', enabled: true, category: 'annual' },
        electricalTechnicianFee: { value: 15000, label: 'ç”¨é›»æŠ€è¡“äººå“¡/å¹´', unit: 'å…ƒ', description: 'æ¯å¹´æ”¶å–ä¸€æ¬¡æŠ€å¸«æª¢å®šè²»ã€‚', enabled: true, category: 'annual' },
        maintenanceFee: { value: 37000, label: 'ç¶­é‹&å®¢æœ/å¹´', unit: 'å…ƒ', description: 'å¹´åº¦å ´åŸŸç¶­è­·èˆ‡ç·šä¸Šå®¢æœè²»ç”¨ã€‚', enabled: true, category: 'annual' },
        transactionFeeRate: { value: 0.03, label: 'é‡‘æµè²»%', unit: '%', description: 'æ”¯ä»˜çµ¦é‡‘æµæœå‹™å•†çš„æ¯ç­†äº¤æ˜“æ‰‹çºŒè²»ç‡ã€‚', enabled: true, category: 'annual' },
        insuranceFee: { value: 8500, label: 'æ„å¤–ä¿éšªè²»/å¹´', unit: 'å…ƒ', description: 'å ´åŸŸå¹´åº¦æ„å¤–éšªè²»ç”¨ã€‚', enabled: true, category: 'annual' },
        electronicInvoiceFeePerTransaction: { value: 1.2, label: 'é›»å­ç™¼ç¥¨/å¼µ', unit: 'å…ƒ', description: 'æ¯ç­†äº¤æ˜“çš„é›»å­ç™¼ç¥¨æˆæœ¬ã€‚', enabled: true, category: 'annual' },
        repairPartsRate: { value: 0.01, label: 'è¨­å‚™ç¶­è­·%/å¹´', unit: '%', description: 'å¹´åº¦ç¶­ä¿®å‚™å“è²»ç”¨ï¼Œç‚ºè¨­å‚™å«ç¨…ç¸½æˆæœ¬çš„ç™¾åˆ†æ¯”ã€‚', enabled: true, category: 'annual' },
        extendedWarrantyPerPile: { value: 1000, label: 'ä¿å›ºå»¶ä¿(æ¨)/å¹´', unit: 'å…ƒ', description: 'æ¯æ”¯å……é›»æ¨çš„å¹´åº¦å»¶é•·ä¿å›ºè²»ç”¨ã€‚', enabled: true, category: 'annual' },
        laborCost: { value: 60000, label: 'å‹å‹™æˆæœ¬/å¹´', unit: 'å…ƒ', description: 'å¹´åº¦äººåŠ›ã€å·¡æª¢ç­‰ç›¸é—œå‹å‹™æˆæœ¬ã€‚', enabled: true, category: 'annual' },
        internetFee: { value: 500, label: 'ç¶²è·¯è²»/æœˆ', unit: 'å…ƒ', description: 'å ´åŸŸæ¯æœˆçš„ç¶²è·¯é€šè¨Šè²»ç”¨ã€‚', enabled: true, category: 'annual' },
        tdxUploadFee: { value: 299, label: 'TDXä¸Šå‚³è²»(æ§/æœˆ)', unit: 'å…ƒ', description: 'æ¯æ”¯æ§æ¯æœˆä¸Šå‚³è³‡æ–™è‡³äº¤é€šéƒ¨TDXå¹³å°çš„è²»ç”¨ã€‚', enabled: true, category: 'annual' },
        powerLossRate: { value: 0.05, label: 'é›»æ%/å¹´', unit: '%', description: 'é›»åŠ›åœ¨å‚³è¼¸å’Œè½‰æ›éç¨‹ä¸­çš„æè€—ç‡ã€‚', enabled: true, category: 'annual' },
    };
    
    // Separate object for TOU ratios to manage them easily
    let touRatios = {
        peak: { value: 0.1, label: 'å°–å³°ç”¨é›»æ¯”ä¾‹' },
        offpeak: { value: 0.8, label: 'é›¢å³°ç”¨é›»æ¯”ä¾‹' },
        holiday: { value: 0.1, label: 'å‡æ—¥ç”¨é›»æ¯”ä¾‹' }
    };

    /**
     * Caches all necessary DOM elements for quick access.
     */
    function cacheDOMElements() {
        const ids = [
            'devicePowerSelect', 'pileCountGroup', 'parkingSpaces', 'openSpecsModalBtn',
            'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'avgTouRate', 'carsPerGunPerDay', 'kwhPerGunPerMonth',
            'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 'taipowerFee',
            'totalInitialCostDisplay', 'constructionCostInput', 'taipowerCostDisplay', 'equipmentCostDisplayMain', 'salvageValueDisplay', 'depreciableCostDisplay',
            'depreciationYears',
            'fixedRateSection', 'touRateSection',
            'rentPerSpace', 'rentPerLand', 'rentBySpaceSection', 'rentByLandSection',
            'totalInvestment', 'paybackPeriod', 'pnlChartTitle', 'pnlTableBody', 'pnlChart', 'cumulativePnlChart', 'touPieChart',
            'touPieChartContainer', 'peakUsageRatio', 'offPeakUsageRatio', 'holidayUsageRatio',
            'kwhStatsTableBody', 'toggleKwhTableBtn', 'kwhTableIcon', 'kwhTableContainer',
            // Modals
            'specsModal', 'closeSpecsModalBtn', 'specsPasswordInputSection', 'specsPassword', 'specsLoginBtn', 'specsMessage',
            'specsContentSection', 'specsModalTableBody', 'saveSpecsBtn', 'oldSpecsPassword', 'newSpecsPassword', 'confirmNewSpecsPassword',
            'changeSpecsPasswordBtn', 'specsPasswordChangeMessage',
            'managementModal', 'closeManagementModalBtn', 'passwordInputSection', 'managementPassword', 'loginManagementBtn', 'managementMessage',
            'formulasSection', 'formulaContainer', 'saveFormulasBtn', 'oldPassword', 'newPassword', 'confirmNewPassword',
            'changePasswordBtn', 'passwordChangeMessage', 'openManagementModalBtn'
        ];
        ids.forEach(id => DOMElements[id] = document.getElementById(id));
    }

    /**
     * Attaches event listeners to all interactive elements.
     */
    function setupEventListeners() {
        const inputs = [
            'chargeFeePerKwh', 'peakRate', 'offPeakRate', 'holidayRate', 'carsPerGunPerDay', 'kwhPerGunPerMonth',
            'avgKwhPerCar', 'demandGrowthRate', 'operationYears', 'depreciationYears',
            'rentPerSpace', 'rentPerLand', 'peakUsageRatio', 'offPeakUsageRatio', 'holidayUsageRatio',
            'constructionCostInput'
        ];
        inputs.forEach(id => {
            if (DOMElements[id]) {
                DOMElements[id].addEventListener('input', calculateAndDisplayResults);
            }
        });
        DOMElements.devicePowerSelect.addEventListener('change', () => {
            updatePileCountUI();
            calculateAndDisplayResults();
        });

        document.querySelectorAll('input[name="billingMethod"]').forEach(radio => {
            radio.addEventListener('change', updateUIVisibility);
        });
        document.querySelectorAll('input[name="revenueMethod"]').forEach(radio => {
            radio.addEventListener('change', updateUIVisibility);
        });
        document.querySelectorAll('input[name="rentMethod"]').forEach(radio => {
            radio.addEventListener('change', updateUIVisibility);
        });
        
        // TOU Ratio Inputs - Special handling
        document.querySelectorAll('.tou-ratio-input').forEach(input => {
            input.addEventListener('input', handleTouRatioChange);
        });
        
        DOMElements.toggleKwhTableBtn.addEventListener('click', () => {
            const container = DOMElements.kwhTableContainer;
            const icon = DOMElements.kwhTableIcon;
            icon.classList.toggle('rotate-180');
            if (container.style.maxHeight && container.style.maxHeight !== '0px') {
                container.style.maxHeight = '0px';
            } else {
                container.style.maxHeight = container.scrollHeight + 'px';
            }
        });
        
        const formatableInputs = ['kwhPerGunPerMonth', 'rentPerSpace', 'rentPerLand', 'constructionCostInput'];
        formatableInputs.forEach(id => {
             if (DOMElements[id]) {
                DOMElements[id].addEventListener('blur', (e) => {
                    const value = getNumericValue(id, null);
                    if (value !== null) {
                        e.target.value = value.toLocaleString('en-US');
                    }
                });
            }
        });

        // Modals
        setupModalListeners();
    }
    
    /**
     * Handles changes in TOU ratio inputs to ensure they sum to 100.
     */
    function handleTouRatioChange(e) {
        if (isAdjustingTou) return; // Prevent recursive calls
        isAdjustingTou = true;

        const changedInput = e.target;
        const changedKey = changedInput.dataset.tou;
        let changedValue = getNumericValue(changedInput.id, 0, 100) / 100;

        let otherInputs = Array.from(document.querySelectorAll('.tou-ratio-input')).filter(el => el !== changedInput);
        let otherTotal = otherInputs.reduce((sum, el) => sum + getNumericValue(el.id) / 100, 0);

        let currentTotal = changedValue + otherTotal;

        if (currentTotal > 1) {
            let overflow = currentTotal - 1;
            // Distribute the overflow reduction proportionally among other inputs
            for (let input of otherInputs) {
                let currentValue = getNumericValue(input.id) / 100;
                if (currentValue > 0) {
                     let reduction = (currentValue / otherTotal) * overflow;
                     let newValue = Math.max(0, currentValue - reduction);
                     input.value = (newValue * 100).toFixed(0);
                }
            }
        }
        
        // Final check to ensure total is exactly 100
        let finalTotal = Array.from(document.querySelectorAll('.tou-ratio-input')).reduce((sum, el) => sum + getNumericValue(el.id), 0);
        let diff = 100 - finalTotal;

        if (diff !== 0) {
            // Add the difference to the largest value that is not the one being changed
            let inputsToAdjust = Array.from(document.querySelectorAll('.tou-ratio-input')).filter(el => el !== changedInput);
            if (inputsToAdjust.length === 0) inputsToAdjust = [changedInput]; // Fallback if only one input
            
            inputsToAdjust.sort((a, b) => getNumericValue(b.id) - getNumericValue(a.id));
            let largestInput = inputsToAdjust[0];
            largestInput.value = Math.min(100, Math.max(0, getNumericValue(largestInput.id) + diff));
        }

        isAdjustingTou = false;
        calculateAndDisplayResults();
    }


    /**
     * Sets up listeners for all modal interactions.
     */
    function setupModalListeners() {
        // Specs Modal
        if (DOMElements.openSpecsModalBtn) DOMElements.openSpecsModalBtn.addEventListener('click', () => openModal(DOMElements.specsModal));
        if (DOMElements.closeSpecsModalBtn) DOMElements.closeSpecsModalBtn.addEventListener('click', () => closeModal(DOMElements.specsModal));
        if (DOMElements.specsLoginBtn) DOMElements.specsLoginBtn.addEventListener('click', handleSpecsLogin);
        if (DOMElements.specsPassword) DOMElements.specsPassword.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSpecsLogin(); });
        if (DOMElements.saveSpecsBtn) DOMElements.saveSpecsBtn.addEventListener('click', saveSpecsAndClose);
        if (DOMElements.changeSpecsPasswordBtn) DOMElements.changeSpecsPasswordBtn.addEventListener('click', changeSpecsPassword);

        // Management Modal
        if (DOMElements.openManagementModalBtn) DOMElements.openManagementModalBtn.addEventListener('click', () => openModal(DOMElements.managementModal));
        if (DOMElements.closeManagementModalBtn) DOMElements.closeManagementModalBtn.addEventListener('click', () => closeModal(DOMElements.managementModal));
        if (DOMElements.loginManagementBtn) DOMElements.loginManagementBtn.addEventListener('click', handleManagementLogin);
        if (DOMElements.managementPassword) DOMElements.managementPassword.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleManagementLogin(); });
        if (DOMElements.saveFormulasBtn) DOMElements.saveFormulasBtn.addEventListener('click', saveFormulasAndClose);
        if (DOMElements.changePasswordBtn) DOMElements.changePasswordBtn.addEventListener('click', changeManagementPassword);
        
        // ESC key to close modals
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (DOMElements.specsModal && DOMElements.specsModal.style.display === 'flex') {
                    closeModal(DOMElements.specsModal);
                }
                if (DOMElements.managementModal && DOMElements.managementModal.style.display === 'flex') {
                    closeModal(DOMElements.managementModal);
                }
            }
        });
    }

    /**
     * Initializes the UI components, populates dropdowns, and sets default states.
     */
    function initializeUI() {
        // Populate device power select
        Object.keys(deviceSpecs).forEach(power => {
            const option = document.createElement('option');
            option.value = power;
            option.textContent = deviceSpecs[power].name;
            DOMElements.devicePowerSelect.appendChild(option);
        });

        // Set initial state
        DOMElements.devicePowerSelect.value = '120'; // Default selection
        
        initializeCharts();
        updatePileCountUI();
        populateFormulasModal();
        updateUIVisibility(); // This triggers the first calculation
    }

    /**
     * Updates the UI sections' visibility based on user selections.
     */
    function updateUIVisibility() {
        const billingMethod = document.querySelector('input[name="billingMethod"]:checked').value;
        if (billingMethod === 'fixed') {
            DOMElements.fixedRateSection.style.display = 'grid';
            DOMElements.touRateSection.style.display = 'none';
        } else { // tou
            DOMElements.fixedRateSection.style.display = 'none';
            DOMElements.touRateSection.style.display = 'block';
        }

        const revenueMethod = document.querySelector('input[name="revenueMethod"]:checked').value;
        DOMElements.carsPerGunPerDay.readOnly = revenueMethod === 'byKwh';
        DOMElements.kwhPerGunPerMonth.readOnly = revenueMethod === 'byCars';
        DOMElements.carsPerGunPerDay.classList.toggle('readonly', revenueMethod === 'byKwh');
        DOMElements.kwhPerGunPerMonth.classList.toggle('readonly', revenueMethod === 'byCars');
        
        const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;
        DOMElements.rentPerSpace.readOnly = rentMethod === 'byLand' || rentMethod === 'none';
        DOMElements.rentPerLand.readOnly = rentMethod === 'bySpace' || rentMethod === 'none';
        DOMElements.rentPerSpace.classList.toggle('readonly', rentMethod === 'byLand' || rentMethod === 'none');
        DOMElements.rentPerLand.classList.toggle('readonly', rentMethod === 'bySpace' || rentMethod === 'none');
        
        if(rentMethod === 'none'){
            DOMElements.rentPerSpace.value = 0;
            DOMElements.rentPerLand.value = 0;
        } else if (rentMethod === 'bySpace') {
            DOMElements.rentPerSpace.value = previousRentPerSpace;
        } else if (rentMethod === 'byLand') {
            DOMElements.rentPerLand.value = previousRentPerLand;
        }

        calculateAndDisplayResults();
    }
    
    /**
     * Dynamically creates the UI for setting pile/cabinet/terminal counts based on the selected device.
     */
    function updatePileCountUI() {
        const power = DOMElements.devicePowerSelect.value;
        const spec = deviceSpecs[power];
        const container = DOMElements.pileCountGroup;
        container.innerHTML = ''; // Clear previous inputs

        if (spec.type === 'DC_360') {
            container.className = 'grid grid-cols-1 items-center gap-4';
            container.innerHTML = `
                <div class="grid grid-cols-2 items-center gap-2">
                    <span class="label-text">èƒ½æºæ«ƒ</span>
                    <input type="number" id="cabinetCount" class="input-field readonly" value="1" readonly>
                </div>
                <div class="grid grid-cols-2 items-center gap-2">
                    <span class="label-text">å……é›»æ¨(çµ‚ç«¯æ©Ÿ)</span>
                    <input type="number" id="terminalCount" class="input-field" value="2" min="1">
                </div>
            `;
            document.getElementById('terminalCount').addEventListener('input', calculateAndDisplayResults);
        } else {
            container.className = 'grid grid-cols-2 items-center gap-4';
            container.innerHTML = `
                <span class="label-text">å……é›»æ¨æ•¸é‡</span>
                <input type="number" id="pileCount" class="input-field" value="1" min="1">
            `;
            document.getElementById('pileCount').addEventListener('input', calculateAndDisplayResults);
        }
    }

    /**
     * Gathers all inputs from the form.
     * @returns {object} An object containing all parsed input values.
     */
    function getInputs() {
        const power = DOMElements.devicePowerSelect.value;
        const spec = deviceSpecs[power];
        let pileCount = 0, gunCount = 0, cabinetCount = 0, parkingSpaces = 0;

        if (spec.type === 'DC_360') {
            gunCount = getNumericValue('terminalCount', 1);
            cabinetCount = Math.ceil(gunCount / 6);
            pileCount = gunCount; // For cost calculation purposes, each terminal is a "pile"
            parkingSpaces = gunCount * 2;
        } else {
            pileCount = getNumericValue('pileCount', 1);
            if (spec.type === 'DC' && spec.power > 30) {
                gunCount = pileCount * 2;
            } else {
                gunCount = pileCount;
            }
            parkingSpaces = gunCount;
        }

        const billingMethod = document.querySelector('input[name="billingMethod"]:checked').value;
        const revenueMethod = document.querySelector('input[name="revenueMethod"]:checked').value;
        const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;

        return {
            power,
            spec,
            pileCount,
            gunCount,
            cabinetCount,
            parkingSpaces,
            billingMethod,
            chargeFeePerKwh: getNumericValue('chargeFeePerKwh'),
            peakRate: getNumericValue('peakRate'),
            offPeakRate: getNumericValue('offPeakRate'),
            holidayRate: getNumericValue('holidayRate'),
            revenueMethod,
            carsPerGunPerDay: getNumericValue('carsPerGunPerDay'),
            kwhPerGunPerMonth: getNumericValue('kwhPerGunPerMonth'),
            avgKwhPerCar: getNumericValue('avgKwhPerCar'),
            demandGrowthRate: getNumericValue('demandGrowthRate') / 100,
            operationYears: getNumericValue('operationYears', 1),
            depreciationYears: getNumericValue('depreciationYears', 1),
            rentMethod,
            rentPerSpace: getNumericValue('rentPerSpace'),
            rentPerLand: getNumericValue('rentPerLand'),
            touRatios: {
                peak: getNumericValue('peakUsageRatio') / 100,
                offpeak: getNumericValue('offPeakUsageRatio') / 100,
                holiday: getNumericValue('holidayUsageRatio') / 100,
            }
        };
    }

    /**
     * Main calculation function. Gathers inputs, computes all financial metrics, and triggers display updates.
     */
    function calculateAndDisplayResults() {
        const rentMethod = document.querySelector('input[name="rentMethod"]:checked').value;
        if (rentMethod === 'bySpace') {
            previousRentPerSpace = getNumericValue('rentPerSpace');
        } else if (rentMethod === 'byLand') {
            previousRentPerLand = getNumericValue('rentPerLand');
        }
    
        calculationParams.constructionCost.value = getNumericValue('constructionCostInput');
        const inputs = getInputs();
        
        if (inputs.spec.type === 'DC_360') {
            document.getElementById('cabinetCount').value = inputs.cabinetCount;
        }
        
        // Linked Inputs Calculation
        if (inputs.revenueMethod === 'byCars') {
            const calculatedKwh = inputs.carsPerGunPerDay * inputs.avgKwhPerCar * 30; // Approx 30 days
            DOMElements.kwhPerGunPerMonth.value = Math.round(calculatedKwh).toLocaleString('en-US');
        } else { // byKwh
            const calculatedCars = inputs.avgKwhPerCar > 0 ? (inputs.kwhPerGunPerMonth / 30) / inputs.avgKwhPerCar : 0;
            DOMElements.carsPerGunPerDay.value = calculatedCars.toFixed(1);
        }

        if (inputs.rentMethod === 'bySpace') {
            const calculatedLandRent = inputs.rentPerSpace * inputs.parkingSpaces;
            DOMElements.rentPerLand.value = Math.round(calculatedLandRent).toLocaleString('en-US');
        } else if (inputs.rentMethod === 'byLand') {
            const calculatedSpaceRent = inputs.parkingSpaces > 0 ? inputs.rentPerLand / inputs.parkingSpaces : 0;
            DOMElements.rentPerSpace.value = Math.round(calculatedSpaceRent).toLocaleString('en-US');
        }


        const results = {
            annualData: [],
            totalInvestment: 0,
            paybackPeriod: 'N/A',
        };
        let avgChargeFee = 0;

        // --- Step 1: Calculate Initial Investment ---
        const taxRate = calculationParams.taxRate.enabled ? calculationParams.taxRate.value : 0;
        let totalDeviceCostUntaxed = 0;
        let totalSalvageValue = 0;

        if (inputs.spec.type === 'DC_360') {
            totalDeviceCostUntaxed = (inputs.cabinetCount * inputs.spec.cabinetCost) + (inputs.gunCount * inputs.spec.terminalCost);
            totalSalvageValue = (inputs.cabinetCount * inputs.spec.cabinetSalvage) + (inputs.gunCount * inputs.spec.terminalSalvage);
        } else {
            totalDeviceCostUntaxed = inputs.pileCount * inputs.spec.cost;
            totalSalvageValue = inputs.pileCount * inputs.spec.salvage;
        }
        
        const totalDeviceCostTaxed = totalDeviceCostUntaxed * (1 + taxRate);
        calculationParams.deviceCost.value = totalDeviceCostTaxed;

        let totalInvestment = 0;
        if(calculationParams.deviceCost.enabled) totalInvestment += totalDeviceCostTaxed;
        
        const totalPowerKw = inputs.spec.type === 'DC_360' ? inputs.cabinetCount * inputs.spec.power : inputs.pileCount * inputs.spec.power;
        
        if(calculationParams.constructionCost.enabled) totalInvestment += calculationParams.constructionCost.value;
        if(calculationParams.lineSubsidyPerKw.enabled) totalInvestment += calculationParams.lineSubsidyPerKw.value * totalPowerKw;
        if(calculationParams.technicianFee.enabled) totalInvestment += calculationParams.technicianFee.value;
        if(calculationParams.distributionPanelFee.enabled) totalInvestment += calculationParams.distributionPanelFee.value;
        
        if (inputs.spec.type.startsWith('DC')) {
            if(calculationParams.meterFeeBase.enabled) totalInvestment += calculationParams.meterFeeBase.value;
            if(calculationParams.meterFeePerGun.enabled) totalInvestment += calculationParams.meterFeePerGun.value * inputs.gunCount;
        }

        results.totalInvestment = totalInvestment;

        // --- Step 2: Calculate Annual P&L & Stats ---
        let cumulativePnl = -totalInvestment;
        let paybackFound = false;

        for (let year = 1; year <= inputs.operationYears; year++) {
            let totalKwhSold = 0;
            let numberOfTransactions = 0;
            const demandMultiplier = Math.pow(1 + inputs.demandGrowthRate, year - 1);

            if (inputs.revenueMethod === 'byCars') {
                numberOfTransactions = getNumericValue('carsPerGunPerDay') * inputs.gunCount * 365 * demandMultiplier;
                totalKwhSold = numberOfTransactions * inputs.avgKwhPerCar;
            } else { // byKwh
                totalKwhSold = getNumericValue('kwhPerGunPerMonth') * inputs.gunCount * 12 * demandMultiplier;
                if (inputs.avgKwhPerCar > 0) {
                    numberOfTransactions = totalKwhSold / inputs.avgKwhPerCar;
                }
            }

            let revenue = 0;
            if (inputs.billingMethod === 'fixed') {
                avgChargeFee = inputs.chargeFeePerKwh;
                revenue = totalKwhSold * avgChargeFee;
            } else { // TOU
                avgChargeFee = (inputs.peakRate * inputs.touRatios.peak) +
                               (inputs.offPeakRate * inputs.touRatios.offpeak) +
                               (inputs.holidayRate * inputs.touRatios.holiday);
                revenue = totalKwhSold * avgChargeFee;
            }
            
            let annualCost = 0;
            const powerLossRate = calculationParams.powerLossRate.enabled ? calculationParams.powerLossRate.value : 0;
            const electricityCost = totalKwhSold * (calculationParams.taipowerFee.enabled ? calculationParams.taipowerFee.value : 0) * (1 + powerLossRate);
            annualCost += electricityCost;

            if(calculationParams.electricalTechnicianFee.enabled) annualCost += calculationParams.electricalTechnicianFee.value;
            if(calculationParams.transactionFeeRate.enabled) annualCost += revenue * calculationParams.transactionFeeRate.value;
            if(calculationParams.maintenanceFee.enabled) annualCost += calculationParams.maintenanceFee.value;
            if(calculationParams.insuranceFee.enabled) annualCost += calculationParams.insuranceFee.value;
            if(calculationParams.electronicInvoiceFeePerTransaction.enabled) annualCost += numberOfTransactions * calculationParams.electronicInvoiceFeePerTransaction.value;
            if(calculationParams.repairPartsRate.enabled) annualCost += totalDeviceCostTaxed * calculationParams.repairPartsRate.value;
            if(calculationParams.extendedWarrantyPerPile.enabled) annualCost += inputs.pileCount * calculationParams.extendedWarrantyPerPile.value;
            if(calculationParams.laborCost.enabled) annualCost += calculationParams.laborCost.value;
            if(calculationParams.internetFee.enabled) annualCost += calculationParams.internetFee.value * 12;
            if(calculationParams.tdxUploadFee.enabled) annualCost += calculationParams.tdxUploadFee.value * inputs.gunCount * 12;

            let rentCost = 0;
            if (inputs.rentMethod === 'bySpace') {
                rentCost = getNumericValue('rentPerSpace') * inputs.parkingSpaces * 12;
            } else if (inputs.rentMethod === 'byLand') {
                rentCost = getNumericValue('rentPerLand') * 12;
            }
            annualCost += rentCost;

            const depreciation = (year <= inputs.depreciationYears) ? (totalDeviceCostTaxed - totalSalvageValue) / inputs.depreciationYears : 0;
            annualCost += depreciation;

            const pnl = revenue - annualCost;
            cumulativePnl += pnl;

            const details = {
                revenue: {
                    'å……é›»ç¸½åº¦æ•¸ (kWh)': totalKwhSold,
                    'å¹³å‡æ¯åº¦æ”¶è²»': avgChargeFee,
                    'ç¸½ç‡Ÿæ”¶': revenue
                },
                costs: {
                    'å°é›»é›»è²»': electricityCost,
                    [calculationParams.electricalTechnicianFee.label]: calculationParams.electricalTechnicianFee.enabled ? calculationParams.electricalTechnicianFee.value : 0,
                    [calculationParams.transactionFeeRate.label]: calculationParams.transactionFeeRate.enabled ? revenue * calculationParams.transactionFeeRate.value : 0,
                    [calculationParams.maintenanceFee.label]: calculationParams.maintenanceFee.enabled ? calculationParams.maintenanceFee.value : 0,
                    [calculationParams.insuranceFee.label]: calculationParams.insuranceFee.enabled ? calculationParams.insuranceFee.value : 0,
                    [calculationParams.electronicInvoiceFeePerTransaction.label]: calculationParams.electronicInvoiceFeePerTransaction.enabled ? numberOfTransactions * calculationParams.electronicInvoiceFeePerTransaction.value : 0,
                    [calculationParams.repairPartsRate.label]: calculationParams.repairPartsRate.enabled ? totalDeviceCostTaxed * calculationParams.repairPartsRate.value : 0,
                    [calculationParams.extendedWarrantyPerPile.label]: calculationParams.extendedWarrantyPerPile.enabled ? inputs.pileCount * calculationParams.extendedWarrantyPerPile.value : 0,
                    [calculationParams.laborCost.label]: calculationParams.laborCost.enabled ? calculationParams.laborCost.value : 0,
                    'ç¶²è·¯è²»': calculationParams.internetFee.enabled ? calculationParams.internetFee.value * 12 : 0,
                    'TDXä¸Šå‚³è²»': calculationParams.tdxUploadFee.enabled ? calculationParams.tdxUploadFee.value * inputs.gunCount * 12 : 0,
                    'ç§Ÿé‡‘': rentCost,
                    'æŠ˜èˆŠ': depreciation
                }
            };

            results.annualData.push({
                year,
                revenue,
                cost: annualCost,
                pnl,
                cumulativePnl,
                kwhPerYear: totalKwhSold,
                kwhPerMonth: totalKwhSold / 12,
                kwhPerDay: totalKwhSold / 365,
                details
            });

            if (cumulativePnl >= 0 && !paybackFound) {
                const prevCumulativePnl = results.annualData[year - 2]?.cumulativePnl || -totalInvestment;
                const pnlCurrentYear = pnl;
                const fractionOfYear = pnlCurrentYear > 0 ? (-prevCumulativePnl / pnl) : 0;
                results.paybackPeriod = `${(year - 1 + fractionOfYear).toFixed(1)} å¹´`;
                paybackFound = true;
            }
        }
        
        updateDisplay(inputs, results, totalSalvageValue, avgChargeFee);
    }
    
    /**
     * Updates all display elements (cards, charts, table) with the calculated results.
     */
    function updateDisplay(inputs, results, totalSalvageValue, avgChargeFee) {
        currentResults = results;
        DOMElements.totalInvestment.textContent = formatCurrency(results.totalInvestment);
        DOMElements.paybackPeriod.textContent = results.paybackPeriod;
        
        DOMElements.parkingSpaces.value = inputs.parkingSpaces;
        DOMElements.avgTouRate.value = formatCurrency(avgChargeFee, 2);

        // Update kWh stats table
        const kwhTableBody = DOMElements.kwhStatsTableBody;
        kwhTableBody.innerHTML = '';
        results.annualData.forEach(data => {
            const row = `
                <tr>
                    <td class="table-cell table-cell-year">ç¬¬ ${data.year} å¹´</td>
                    <td class="table-cell text-green-600 font-semibold">${data.kwhPerDay.toLocaleString('en-US', {maximumFractionDigits: 1})}</td>
                    <td class="table-cell text-blue-600 font-semibold">${data.kwhPerMonth.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                    <td class="table-cell text-red-600 font-semibold">${data.kwhPerYear.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                </tr>
            `;
            kwhTableBody.insertAdjacentHTML('beforeend', row);
        });

        const tableBody = DOMElements.pnlTableBody;
        tableBody.innerHTML = '';
        results.annualData.forEach(data => {
            const row = document.createElement('tr');
            row.className = 'pnl-row';
            row.dataset.year = data.year;
            row.innerHTML = `
                <td class="table-cell table-cell-year">ç¬¬ ${data.year} å¹´</td>
                <td class="table-cell">${formatCurrency(data.revenue, 0, false, true)}</td>
                <td class="table-cell">${formatCurrency(data.cost, 0, false, true)}</td>
                <td class="table-cell ${data.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(data.pnl, 0, false, true)}</td>
                <td class="table-cell font-semibold ${data.cumulativePnl >= 0 ? 'text-blue-600' : 'text-orange-600'}">${formatCurrency(data.cumulativePnl, 0, false, true)}</td>
            `;
            tableBody.appendChild(row);
        });
        
        tableBody.querySelectorAll('.pnl-row').forEach(row => {
            row.addEventListener('click', (e) => {
                const year = parseInt(e.currentTarget.dataset.year);
                const existingDetailsRow = tableBody.querySelector(`.details-row[data-year="${year}"]`);

                tableBody.querySelectorAll('.details-row').forEach(dr => {
                    if (dr !== existingDetailsRow) {
                        dr.remove();
                    }
                });

                if (existingDetailsRow) {
                    existingDetailsRow.remove();
                } else {
                    const yearData = currentResults.annualData.find(d => d.year === year);
                    if (yearData && yearData.details) {
                        const detailsHtml = createDetailsHtml(yearData.details);
                        const newRow = document.createElement('tr');
                        newRow.className = 'details-row';
                        newRow.dataset.year = year;
                        newRow.innerHTML = `<td colspan="5">${detailsHtml}</td>`;
                        e.currentTarget.after(newRow);
                    }
                }
            });
        });
        
        // Update Initial Cost Breakdown
        const { enabled: lineSubsidyEnabled, value: lineSubsidyValue } = calculationParams.lineSubsidyPerKw;
        const { enabled: techFeeEnabled, value: techFeeValue } = calculationParams.technicianFee;
        const { enabled: panelFeeEnabled, value: panelFeeValue } = calculationParams.distributionPanelFee;
        const totalPowerKw = inputs.spec.type === 'DC_360' ? inputs.cabinetCount * inputs.spec.power : inputs.pileCount * inputs.spec.power;

        const equipmentCost = calculationParams.deviceCost.value;
        const depreciableCost = equipmentCost - totalSalvageValue;
        const taipowerCost = (lineSubsidyEnabled ? lineSubsidyValue * totalPowerKw : 0) + 
                               (techFeeEnabled ? techFeeValue : 0) + 
                               (panelFeeEnabled ? panelFeeValue : 0);
        const constructionCost = calculationParams.constructionCost.value;
        const totalInitialCost = depreciableCost + taipowerCost + constructionCost;

        DOMElements.equipmentCostDisplayMain.value = Math.round(equipmentCost).toLocaleString('en-US');
        DOMElements.salvageValueDisplay.value = Math.round(totalSalvageValue).toLocaleString('en-US');
        DOMElements.taipowerCostDisplay.value = Math.round(taipowerCost).toLocaleString('en-US');
        DOMElements.constructionCostInput.value = constructionCost.toLocaleString('en-US');
        DOMElements.totalInitialCostDisplay.value = Math.round(totalInitialCost).toLocaleString('en-US');
        DOMElements.depreciableCostDisplay.value = Math.round(depreciableCost).toLocaleString('en-US');


        updateCharts(inputs, results);
    }
    
    function createDetailsHtml(details) {
        let revenueHtml = '<h4>ç¸½ç‡Ÿæ”¶ç´°é …</h4>';
        revenueHtml += `<div class="details-item"><span>å……é›»ç¸½åº¦æ•¸ (kWh)</span><span>${details.revenue['å……é›»ç¸½åº¦æ•¸ (kWh)'].toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
        revenueHtml += `<div class="details-item"><span>å¹³å‡æ¯åº¦æ”¶è²»</span><span>${formatCurrency(details.revenue['å¹³å‡æ¯åº¦æ”¶è²»'], 2, false, true)}</span></div>`;
        revenueHtml += `<div class="details-item"><span>ç¸½ç‡Ÿæ”¶</span><span>${formatCurrency(details.revenue['ç¸½ç‡Ÿæ”¶'], 0, false, true)}</span></div>`;

        let costsHtml = '<h4>ç¸½æˆæœ¬ç´°é …</h4>';
        Object.entries(details.costs).forEach(([key, value]) => {
            if (value > 0) { // Only show costs that are not zero
                costsHtml += `<div class="details-item"><span>${key.replace('/å¹´', '').replace('/æœˆ','').replace('/å¼µ','').replace('%','')}</span><span>${formatCurrency(value, 0, false, true)}</span></div>`;
            }
        });

        return `
            <div class="details-container">
                <div class="details-grid">
                    <div class="details-section">${revenueHtml}</div>
                    <div class="details-section">${costsHtml}</div>
                </div>
            </div>
        `;
    }

    /**
     * Initializes all Chart.js charts.
     */
    function initializeCharts() {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { grid: { display: false } },
                y: {
                    ticks: {
                        callback: value => formatCurrency(value, 0, true)
                    }
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}`
                    }
                }
            }
        };

        pnlChart = new Chart(DOMElements.pnlChart, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, beginAtZero: false }}}
        });

        cumulativePnlChart = new Chart(DOMElements.cumulativePnlChart, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, beginAtZero: false }}}
        });
        
        touPieChart = new Chart(DOMElements.touPieChart, {
            type: 'doughnut',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: context => `${context.label}: ${context.raw}%`
                        }
                    }
                }
            }
        });
    }

    /**
     * Updates chart data and re-renders them.
     */
    function updateCharts(inputs, results) {
        if (!pnlChart || !cumulativePnlChart || !touPieChart) return;

        const labels = results.annualData.map(d => `ç¬¬ ${d.year} å¹´`);
        
        pnlChart.data.labels = labels;
        pnlChart.data.datasets = [
            { type: 'bar', label: 'ç¸½ç‡Ÿæ”¶', data: results.annualData.map(d => d.revenue), backgroundColor: 'rgba(75, 192, 192, 0.6)' },
            { type: 'bar', label: 'ç¸½æˆæœ¬', data: results.annualData.map(d => d.cost), backgroundColor: 'rgba(255, 159, 64, 0.6)' },
            { type: 'line', label: 'å……é›»æ·¨åˆ©', data: results.annualData.map(d => d.pnl), borderColor: 'rgba(153, 102, 255, 1)', backgroundColor: 'rgba(153, 102, 255, 0.2)', fill: false, tension: 0.1 }
        ];
        pnlChart.update();

        const cumulativeData = [-results.totalInvestment, ...results.annualData.map(d => d.cumulativePnl)];
        cumulativePnlChart.data.labels = ['æŠ•è³‡é¡', ...labels];
        cumulativePnlChart.data.datasets = [{
            label: 'ç´¯ç©ç¨…å‰æ·¨åˆ©',
            data: cumulativeData,
            borderColor: 'rgba(54, 162, 235, 1)',
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointRadius: 4,
            tension: 0.1,
            fill: true,
            backgroundColor: (context) => {
                const chart = context.chart;
                const {ctx, chartArea, scales} = chart;
                if (!chartArea || chartArea.height <= 0) return null;
                
                const scale = scales.y;
                if (scale.min >= 0) return 'rgba(219, 234, 254, 0.6)';
                if (scale.max <= 0) return 'rgba(254, 226, 226, 0.6)';

                const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                const zero = scale.getPixelForValue(0);
                
                if (!isFinite(zero)) return 'rgba(219, 234, 254, 0.6)';

                const zeroPoint = (zero - chartArea.top) / chartArea.height;
                const clampedZeroPoint = Math.max(0, Math.min(1, zeroPoint));

                if (!isFinite(clampedZeroPoint)) return 'rgba(219, 234, 254, 0.6)';

                gradient.addColorStop(0, 'rgba(219, 234, 254, 0.6)');
                gradient.addColorStop(clampedZeroPoint, 'rgba(219, 234, 254, 0.6)');
                gradient.addColorStop(clampedZeroPoint, 'rgba(254, 226, 226, 0.6)');
                gradient.addColorStop(1, 'rgba(254, 226, 226, 0.6)');
                
                return gradient;
            },
        }];
        cumulativePnlChart.update();
        
        if (inputs.billingMethod === 'tou') {
            DOMElements.touPieChartContainer.style.display = 'block';
            touPieChart.data.labels = ['å°–å³°', 'é›¢å³°', 'å‡æ—¥'];
            touPieChart.data.datasets = [{
                data: [
                    (inputs.touRatios.peak * 100).toFixed(0),
                    (inputs.touRatios.offpeak * 100).toFixed(0),
                    (inputs.touRatios.holiday * 100).toFixed(0)
                ],
                backgroundColor: ['#ef4444', '#3b82f6', '#10b981']
            }];
            touPieChart.update();
        } else {
            DOMElements.touPieChartContainer.style.display = 'none';
        }
    }
    
    // --- Modal Logic ---

    function openModal(modal) {
        modal.style.display = 'flex';
    }

    function closeModal(modal) {
        modal.style.display = 'none';
        modal.querySelectorAll('input[type="password"]').forEach(input => input.value = '');
        modal.querySelectorAll('.modal-message').forEach(msg => {
            msg.style.display = 'none';
            msg.textContent = '';
        });
    }

    function showModalMessage(element, message, isError = true) {
        element.textContent = message;
        element.className = `modal-message ${isError ? 'error' : 'success'}`;
        element.style.display = 'block';
    }

    function handleSpecsLogin() {
        if (DOMElements.specsPassword.value === currentSpecsPassword) {
            DOMElements.specsPasswordInputSection.style.display = 'none';
            DOMElements.specsContentSection.classList.remove('hidden');
            populateSpecsModal();
        } else {
            showModalMessage(DOMElements.specsMessage, 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
        }
    }

    function populateSpecsModal() {
        const tableBody = DOMElements.specsModalTableBody;
        tableBody.innerHTML = '';
        const taxRate = calculationParams.taxRate.enabled ? calculationParams.taxRate.value : 0;

        Object.entries(deviceSpecs).forEach(([power, spec]) => {
            if (spec.type === 'DC_360') {
                const cabinetCostTaxed = spec.cabinetCost * (1 + taxRate);
                const terminalCostTaxed = spec.terminalCost * (1 + taxRate);
                const cabinetSalvagePercentage = spec.cabinetCost > 0 ? (spec.cabinetSalvage / spec.cabinetCost * 100).toFixed(1) : 10;
                const terminalSalvagePercentage = spec.terminalCost > 0 ? (spec.terminalSalvage / spec.terminalCost * 100).toFixed(1) : 10;

                const rowCabinet = `
                    <tr>
                        <td class="font-semibold align-middle" rowspan="2">${spec.name}</td>
                        <td class="align-middle">èƒ½æºæ«ƒ</td>
                        <td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="cabinetCost" value="${spec.cabinetCost.toLocaleString('en-US')}"></td>
                        <td class="text-right">${formatCurrency(cabinetCostTaxed, 0, false, true)}</td>
                        <td><input type="number" class="modal-table-input salvage-percent-input" data-cost-type="cabinetCost" data-power="${power}" value="${cabinetSalvagePercentage}"></td>
                        <td><input type="text" class="modal-table-input salvage-value-input" data-power="${power}" data-type="cabinetSalvage" value="${spec.cabinetSalvage.toLocaleString('en-US')}" readonly></td>
                    </tr>`;
                const rowTerminal = `
                    <tr>
                        <td class="align-middle">å……é›»æ¨(çµ‚ç«¯æ©Ÿ)</td>
                        <td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="terminalCost" value="${spec.terminalCost.toLocaleString('en-US')}"></td>
                        <td class="text-right">${formatCurrency(terminalCostTaxed, 0, false, true)}</td>
                        <td><input type="number" class="modal-table-input salvage-percent-input" data-cost-type="terminalCost" data-power="${power}" value="${terminalSalvagePercentage}"></td>
                        <td><input type="text" class="modal-table-input salvage-value-input" data-power="${power}" data-type="terminalSalvage" value="${spec.terminalSalvage.toLocaleString('en-US')}" readonly></td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', rowCabinet + rowTerminal);
            } else {
                const costTaxed = spec.cost * (1 + taxRate);
                const salvagePercentage = spec.cost > 0 ? (spec.salvage / spec.cost * 100).toFixed(1) : 10;
                const row = `
                    <tr>
                        <td class="font-semibold align-middle">${spec.name}</td>
                        <td class="align-middle">å……é›»æ¨</td>
                        <td><input type="text" class="modal-table-input cost-input" data-power="${power}" data-type="cost" value="${spec.cost.toLocaleString('en-US')}"></td>
                        <td class="text-right">${formatCurrency(costTaxed, 0, false, true)}</td>
                        <td><input type="number" class="modal-table-input salvage-percent-input" data-cost-type="cost" data-power="${power}" value="${salvagePercentage}"></td>
                        <td><input type="text" class="modal-table-input salvage-value-input" data-power="${power}" data-type="salvage" value="${spec.salvage.toLocaleString('en-US')}" readonly></td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            }
        });

        tableBody.querySelectorAll('.salvage-percent-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const percent = parseFloat(e.target.value) || 0;
                const row = e.target.closest('tr');
                if (!row) return;
                const costInput = row.querySelector('.cost-input');
                if (!costInput) return;
                const cost = parseFloat(costInput.value.replace(/,/g,'')) || 0;
                const salvageValueInput = row.querySelector('.salvage-value-input');
                if (salvageValueInput) {
                    salvageValueInput.value = Math.round((cost * percent) / 100).toLocaleString('en-US');
                }
            });
        });
        
        tableBody.querySelectorAll('.cost-input').forEach(input => {
            input.addEventListener('blur', (e) => {
                const value = parseFloat(e.target.value.replace(/,/g,'')) || 0;
                e.target.value = value.toLocaleString('en-US');
            });
        });
    }
    
    function saveSpecsAndClose() {
        const inputs = DOMElements.specsModalTableBody.querySelectorAll('input[data-power]');
        inputs.forEach(input => {
            const power = input.dataset.power;
            const type = input.dataset.type;
            if (deviceSpecs[power] && type) {
                deviceSpecs[power][type] = parseFloat(input.value.replace(/,/g,'')) || 0;
            }
        });
        saveDataToLocalStorage();
        calculateAndDisplayResults();
        closeModal(DOMElements.specsModal);
        DOMElements.specsPasswordInputSection.style.display = 'block';
        DOMElements.specsContentSection.classList.add('hidden');
    }

    function changeSpecsPassword() {
        const oldPass = DOMElements.oldSpecsPassword.value;
        const newPass = DOMElements.newSpecsPassword.value;
        const confirmPass = DOMElements.confirmNewSpecsPassword.value;

        if (oldPass !== currentSpecsPassword) {
            showModalMessage(DOMElements.specsPasswordChangeMessage, 'èˆŠå¯†ç¢¼ä¸æ­£ç¢ºã€‚');
            return;
        }
        if (!newPass || newPass.length < 4) {
            showModalMessage(DOMElements.specsPasswordChangeMessage, 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦4ä½æ•¸ã€‚');
            return;
        }
        if (newPass !== confirmPass) {
            showModalMessage(DOMElements.specsPasswordChangeMessage, 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç›¸ç¬¦ã€‚');
            return;
        }
        currentSpecsPassword = newPass;
        saveDataToLocalStorage();
        showModalMessage(DOMElements.specsPasswordChangeMessage, 'å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼', false);
    }

    function handleManagementLogin() {
        if (DOMElements.managementPassword.value === currentManagementPassword) {
            DOMElements.passwordInputSection.style.display = 'none';
            DOMElements.formulasSection.classList.remove('hidden');
            populateFormulasModal();
        } else {
            showModalMessage(DOMElements.managementMessage, 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
        }
    }

    function populateFormulasModal() {
        const container = DOMElements.formulaContainer;
        container.innerHTML = '';
        
        const categories = {
            investment: 'ç¸½æŠ•è³‡é¡é …ç›®',
            annual: 'å¹´åº¦æˆæœ¬é …ç›®'
        };

        Object.keys(categories).forEach(catKey => {
            const header = document.createElement('h5');
            header.className = 'text-lg font-bold text-indigo-700 mt-4 pb-2 border-b';
            header.textContent = categories[catKey];
            container.appendChild(header);

            Object.entries(calculationParams).forEach(([key, param]) => {
                if (param.category === catKey) {
                    const isPercentage = param.unit === '%';
                    const displayValue = isPercentage ? param.value * 100 : param.value;
                    const formattedValue = isPercentage ? displayValue : displayValue.toLocaleString('en-US', {maximumFractionDigits: 2});

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'formula-item grid grid-cols-1 md:grid-cols-12 items-center gap-2 border-b border-gray-100 pb-3';
                    
                    itemDiv.innerHTML = `
                        <div class="md:col-span-4 flex items-center">
                            <input type="checkbox" id="check_${key}" data-key="${key}" class="formula-item-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3" ${param.enabled ? 'checked' : ''} ${param.readonly ? 'disabled' : ''}>
                            <label for="check_${key}" class="formula-item-label font-medium text-gray-800">${param.label}</label>
                        </div>
                        <div class="md:col-span-5">
                            <p class="formula-item-description text-gray-500">${param.description}</p>
                        </div>
                        <div class="md:col-span-3 formula-item-input-group flex items-center">
                            <input type="text" id="input_${key}" data-key="${key}" value="${formattedValue}" class="modal-table-input flex-grow" ${param.readonly ? 'readonly' : ''}>
                            <span class="ml-2 text-gray-600 w-10 text-left">${param.unit}</span>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                }
            });
        });

        container.querySelectorAll('input[type="text"]').forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const key = e.target.dataset.key;
                    if (calculationParams[key] && !calculationParams[key].readonly) {
                         const isPercentage = calculationParams[key].unit === '%';
                        const numericValue = parseFloat(e.target.value.replace(/,/g, ''));
                        if (!isNaN(numericValue)) {
                            calculationParams[key].value = isPercentage ? numericValue / 100 : numericValue;
                            e.target.value = numericValue.toLocaleString('en-US');
                            saveDataToLocalStorage();
                            calculateAndDisplayResults();
                            
                            // Visual feedback
                            e.target.style.borderColor = '#10b981';
                            setTimeout(() => { e.target.style.borderColor = '#d1d5db'; }, 1000);
                        }
                    }
                }
            });
        });
        
        container.querySelectorAll('.formula-item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const key = e.target.dataset.key;
                if (calculationParams[key] && !calculationParams[key].readonly) {
                    calculationParams[key].enabled = e.target.checked;
                    saveDataToLocalStorage();
                    calculateAndDisplayResults();
                }
            });
        });
    }

    function saveFormulasAndClose() {
        const inputs = DOMElements.formulaContainer.querySelectorAll('input[type="text"]');
        const checkboxes = DOMElements.formulaContainer.querySelectorAll('input[type="checkbox"]');

        inputs.forEach(input => {
            const key = input.dataset.key;
            if (calculationParams[key] && !calculationParams[key].readonly) {
                const isPercentage = calculationParams[key].unit === '%';
                const numericValue = parseFloat(input.value.replace(/,/g, ''));
                if (!isNaN(numericValue)) {
                    calculationParams[key].value = isPercentage ? numericValue / 100 : numericValue;
                }
            }
        });

        checkboxes.forEach(checkbox => {
            const key = checkbox.dataset.key;
            if (calculationParams[key] && !calculationParams[key].readonly) {
                calculationParams[key].enabled = checkbox.checked;
            }
        });
        
        saveDataToLocalStorage();
        calculateAndDisplayResults();
        closeModal(DOMElements.managementModal);
        DOMElements.passwordInputSection.style.display = 'block';
        DOMElements.formulasSection.classList.add('hidden');
    }
    
    function changeManagementPassword() {
        const oldPass = DOMElements.oldPassword.value;
        const newPass = DOMElements.newPassword.value;
        const confirmPass = DOMElements.confirmNewSpecsPassword.value;

        if (oldPass !== currentManagementPassword) {
            showModalMessage(DOMElements.passwordChangeMessage, 'èˆŠå¯†ç¢¼ä¸æ­£ç¢ºã€‚');
            return;
        }
        if (!newPass || newPass.length < 4) {
            showModalMessage(DOMElements.passwordChangeMessage, 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦4ä½æ•¸ã€‚');
            return;
        }
        if (newPass !== confirmPass) {
            showModalMessage(DOMElements.passwordChangeMessage, 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç›¸ç¬¦ã€‚');
            return;
        }
        currentManagementPassword = newPass;
        saveDataToLocalStorage();
        showModalMessage(DOMElements.passwordChangeMessage, 'å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼', false);
    }

    // --- Helper & Persistence Functions ---
    
    function formatCurrency(value, precision = 0, shorthand = false, unitOnly = false) {
        if (isNaN(value)) return 'N/A';
        const numberString = value.toLocaleString('en-US', { minimumFractionDigits: precision, maximumFractionDigits: precision });
        if (unitOnly) return numberString;

        if (shorthand) {
            if (Math.abs(value) >= 1e6) return `NT$ ${(value / 1e6).toFixed(1)}M`;
            if (Math.abs(value) >= 1e3) return `NT$ ${(value / 1e3).toFixed(0)}K`;
        }
        return `NT$ ${numberString}`;
    }

    function getNumericValue(id, defaultValue = 0, max = Infinity) {
        const element = document.getElementById(id);
        if (!element) return defaultValue;
        const value = parseFloat(String(element.value).replace(/,/g, ''));
        return isNaN(value) ? defaultValue : Math.min(value, max);
    }

    function saveDataToLocalStorage() {
        const dataToSave = {
            deviceSpecs: deviceSpecs,
            calculationParams: calculationParams,
            currentManagementPassword: currentManagementPassword,
            currentSpecsPassword: currentSpecsPassword
        };
        localStorage.setItem('chargingStationAnalysisData', JSON.stringify(dataToSave));
    }

    function loadDataFromLocalStorage() {
        const savedData = localStorage.getItem('chargingStationAnalysisData');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            Object.assign(deviceSpecs, parsedData.deviceSpecs || {});
            Object.keys(calculationParams).forEach(key => {
                if(parsedData.calculationParams && parsedData.calculationParams[key]){
                    Object.assign(calculationParams[key], parsedData.calculationParams[key]);
                }
            });
            currentManagementPassword = parsedData.currentManagementPassword || '0000';
            currentSpecsPassword = parsedData.currentSpecsPassword || '0000';
        }
    }

    // --- App Initialization ---
    loadDataFromLocalStorage();
    cacheDOMElements();
    setupEventListeners();
    initializeUI();
});
</script>
</body>
</html>
